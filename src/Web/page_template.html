<?!= HtmlService.createHtmlOutputFromFile('Web/_shared_assets').getContent(); ?>

<style>
  /* Estilos espec√≠ficos de Plantilla de P√°gina */
</style>

<div class="min-h-screen">
  <div class="max-w-4xl mx-auto bg-slate-800 p-8 rounded-xl shadow-lg border border-slate-700">
    <h1 class="text-2xl font-bold text-white border-b-2 border-blue-500 pb-3 mb-4">
      <?=titulo ?>
    </h1>
    <p class="text-slate-300 leading-relaxed mb-6">
      <?=descripcion ?>
      <? if (codigo) { ?><b class="text-indigo-400">
        <?=codigo ?>
      </b>
      <? } ?>
    </p>
    <? if (mostrarDatePicker) {
    ?>
    <div class="bg-slate-900 border border-slate-700 p-6 rounded-lg mb-6 flex flex-wrap gap-4 items-end">
      <div class="flex flex-col gap-2"><label for="fecha-input" class="font-bold text-slate-400 text-sm">Selecciona la
          fecha: </label> <input type="date" id="fecha-input"
          class="bg-slate-800 text-white border border-slate-600 rounded px-3 py-2 outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition">
      </div> <button id="ejecutar-btn"
        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-md transition flex items-center gap-2 shadow-lg shadow-blue-500/20">
        <span class="material-icons text-sm">play_arrow</span> Ejecutar Proceso </button>
    </div>
    <? } ?>
    <div class="spinner hidden my-8 text-center text-blue-400 font-semibold">
      <div class="flex items-center justify-center gap-2"><span
          class="material-icons animate-spin">sync</span><span>Procesando datos...</span></div>
    </div>
    <div id="status-message" class="hidden p-4 rounded-lg font-medium mb-4"></div>
    < !-- DASHBOARD DE ESTAD√çSTICAS (GEN√âRICO) -->
      <div id="stats-dashboard" class="hidden grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-slate-900/50 border border-slate-700 p-3 rounded-lg flex flex-col items-center"><span
            class="text-emerald-400 text-xs font-bold uppercase tracking-wider mb-1">√âxitos</span>
          <div class="flex items-center gap-2"><span
              class="material-icons text-emerald-500 text-sm">check_circle</span><span id="stat-success"
              class="text-xl font-bold text-white">0</span></div>
        </div>
        <div class="bg-slate-900/50 border border-slate-700 p-3 rounded-lg flex flex-col items-center"><span
            class="text-red-400 text-xs font-bold uppercase tracking-wider mb-1">Errores</span>
          <div class="flex items-center gap-2"><span class="material-icons text-red-500 text-sm">error</span><span
              id="stat-error" class="text-xl font-bold text-white">0</span></div>
        </div>
        <div class="bg-slate-900/50 border border-slate-700 p-3 rounded-lg flex flex-col items-center"><span
            class="text-amber-400 text-xs font-bold uppercase tracking-wider mb-1">Avisos</span>
          <div class="flex items-center gap-2"><span class="material-icons text-amber-500 text-sm">warning</span><span
              id="stat-warning" class="text-xl font-bold text-white">0</span></div>
        </div>
        <div class="bg-slate-900/50 border border-slate-700 p-3 rounded-lg flex flex-col items-center"><span
            class="text-blue-400 text-xs font-bold uppercase tracking-wider mb-1">Info</span>
          <div class="flex items-center gap-2"><span class="material-icons text-blue-500 text-sm">info</span><span
              id="stat-info" class="text-xl font-bold text-white">0</span></div>
        </div>
      </div>
      < !-- FILTROS DE LOG -->
        <div id="log-filters" class="hidden flex flex-wrap gap-2 mb-3 items-center"><span
            class="text-slate-400 text-xs font-bold uppercase mr-2">Filtrar logs:</span><button data-filter="all"
            class="filter-chip active bg-blue-600 px-3 py-1 rounded-full text-xs font-bold transition">Todos</button><button
            data-filter="error"
            class="filter-chip bg-slate-700 px-3 py-1 rounded-full text-xs font-bold transition hover:bg-red-900/40">Errores</button><button
            data-filter="warning"
            class="filter-chip bg-slate-700 px-3 py-1 rounded-full text-xs font-bold transition hover:bg-amber-900/40">Avisos</button><button
            data-filter="success"
            class="filter-chip bg-slate-700 px-3 py-1 rounded-full text-xs font-bold transition hover:bg-emerald-900/40">√âxitos</button>
        </div>
        < !-- VISTA PREVIA DE DATOS (TABLA) -->
          <div id="data-preview-container"
            class="hidden mt-8 border border-slate-700 rounded-lg overflow-hidden bg-slate-900">
            <div class="bg-slate-800 p-4 border-b border-slate-700 flex justify-between items-center">
              <div class="font-bold text-slate-200 flex items-center gap-2 text-lg"><span
                  class="material-icons text-blue-400">table_view</span>Vista Previa de Datos </div><a
                id="drive-link-btn" href="#" target="_blank"
                class="hidden bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-bold py-2 px-4 rounded transition flex items-center gap-1"><span
                  class="material-icons text-sm">open_in_new</span>Abrir CSV en Drive </a>
            </div>
            <div class="overflow-x-auto max-h-[400px]">
              <table id="data-table" class="w-full text-sm text-left">
                < !-- JS llenar√° esto -->
              </table>
            </div>
          </div>
          < !-- ACCIONES EXTRA -->
            <div class="mt-6 flex gap-3 flex-wrap">
              <? if (mostrarBotonPrompt) { ?>
              <button id="copiar-btn"
                class="hidden bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded transition items-center gap-2">
                <span class="material-icons text-sm">content_copy</span>Copiar Prompt
              </button>
              <? } ?>

              ?><a id="openProductUrlButton" href="#" target="_blank"
                class="hidden bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded transition items-center gap-2"><span
                  class="material-icons text-sm">open_in_new</span>Ver Producto </a><a id="syncManualButton" href="#"
                target="_blank"
                class="hidden bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-4 rounded transition items-center gap-2"><span
                  class="material-icons text-sm">sync</span>Sincronizar Galer√≠a </a>
            </div>
            <div id="prompt-container"
              class="hidden mt-6 p-6 bg-slate-900 text-slate-300 rounded-lg border border-slate-700 max-h-[400px] overflow-y-auto font-mono text-sm leading-relaxed whitespace-pre-wrap word-break-break-word">
            </div>
            <div id="log-container"
              class="hidden mt-6 p-6 bg-slate-900 text-slate-200 rounded-lg border border-slate-700 max-h-[400px] overflow-y-auto font-mono text-xs leading-relaxed">
            </div>
            <div class="mt-8 text-center"><button id="retry-btn" onclick="location.reload()"
                class="hidden text-slate-500 hover:text-slate-300 transition text-sm flex items-center gap-1 mx-auto"><span
                  class="material-icons text-sm">refresh</span>Reintentar Ejecuci√≥n </button></div>
  </div>
  <script>
    const funcionParaLlamar = '<?= funcionParaLlamar ?>';
    const parametrosBase = JSON.parse('<?!= JSON.stringify(parametros) ?>');
    const fechaInicial = '<?= fechaInicial ?>';
    const mostrarBotonPrompt = <?!= mostrarBotonPrompt ?>;

    const statusElement = document.getElementById('status-message');
    const spinner = document.querySelector('.spinner');
    const logContainer = document.getElementById('log-container');
    const ejecutarBtn = document.getElementById('ejecutar-btn');
    const fechaInput = document.getElementById('fecha-input');
    const copiarBtn = document.getElementById('copiar-btn');
    const promptContainer = document.getElementById('prompt-container');
    const openUrlBtn = document.getElementById('openProductUrlButton');
    const syncManualBtn = document.getElementById('syncManualButton');
    const retryBtn = document.getElementById('retry-btn');

    // Dashboard & Filtros
    const statsDashboard = document.getElementById('stats-dashboard');
    const logFilters = document.getElementById('log-filters');

    const statElements = {
      success: document.getElementById('stat-success'),
      error: document.getElementById('stat-error'),
      warning: document.getElementById('stat-warning'),
      info: document.getElementById('stat-info')
    }

      ;

    // Elementos de Datos
    const dataPreviewContainer = document.getElementById('data-preview-container');
    const dataTable = document.getElementById('data-table');
    const driveLinkBtn = document.getElementById('drive-link-btn');

    document.addEventListener('DOMContentLoaded', () => {

      // Setup Filtros
      document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.addEventListener('click', () => {
          document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active', 'bg-blue-600'));
          document.querySelectorAll('.filter-chip').forEach(c => c.classList.add('bg-slate-700'));
          chip.classList.add('active', 'bg-blue-600');
          chip.classList.remove('bg-slate-700');
          const filter = chip.getAttribute('data-filter');
          applyLogFilter(filter);
        });
      });

      if (ejecutarBtn && fechaInput) {
        fechaInput.value = fechaInicial || new Date().toISOString().split('T')[0];

        ejecutarBtn.addEventListener('click', () => {
          const fechaSeleccionada = fechaInput.value;
          if (!fechaSeleccionada) return alert('Selecciona una fecha.');
          runMacro([...parametrosBase, fechaSeleccionada]);
        });
      }

      else {
        runMacro(parametrosBase);
      }

      if (copiarBtn) {
        copiarBtn.addEventListener('click', () => {
          navigator.clipboard.writeText(promptContainer.textContent).then(() => {
            const originalHTML = copiarBtn.innerHTML;
            copiarBtn.innerHTML = '<span class="material-icons text-sm">check</span> ¬°Copiado!';
            setTimeout(() => copiarBtn.innerHTML = originalHTML, 2000);
          });
        });
      }
    });

    function runMacro(parametros) {
      if (ejecutarBtn) ejecutarBtn.disabled = true;
      spinner.classList.remove('hidden');

      // Reset UI
      logContainer.classList.add('hidden');
      promptContainer.classList.add('hidden');
      statusElement.classList.add('hidden');
      dataPreviewContainer.classList.add('hidden');
      statsDashboard.classList.add('hidden');
      logFilters.classList.add('hidden');
      retryBtn.classList.add('hidden');

      if (copiarBtn) copiarBtn.classList.add('hidden');
      openUrlBtn.classList.add('hidden');
      syncManualBtn.classList.add('hidden');

      logContainer.innerHTML = '';
      dataTable.innerHTML = '';

      google.script.run.withSuccessHandler(response => {
        spinner.classList.add('hidden');
        if (ejecutarBtn) ejecutarBtn.disabled = false;
        retryBtn.classList.remove('hidden');

        if (response.success) {
          showStatus(response.message, 'success');

          // --- Renderizar Tabla de Datos ---
          if (response.data && Array.isArray(response.data) && response.data.length > 0) {
            renderDataTable(response.data);

            if (response.fileUrl) {
              driveLinkBtn.href = response.fileUrl;
              driveLinkBtn.classList.remove('hidden');
              driveLinkBtn.style.display = 'inline-flex';
            }

            else {
              driveLinkBtn.classList.add('hidden');
            }
          }

          if (mostrarBotonPrompt) showResults(response.logs);
          else showLogs(response.logs);

        }

        else {
          showStatus(response.message, 'error');
          showLogs(response.logs);
        }

      }).withFailureHandler(error => {
        spinner.classList.add('hidden');
        if (ejecutarBtn) ejecutarBtn.disabled = false;
        retryBtn.classList.remove('hidden');
        showStatus('Error cr√≠tico: ' + error.message, 'error');
        showLogs(['‚ùå ERROR FATAL: ' + error.message]);
      })[funcionParaLlamar].apply(null, parametros);
    }

    function renderDataTable(data) {
      if (!data || data.length === 0) return;

      // Encabezados (Fila 0)
      const thead = document.createElement('thead');
      const trHead = document.createElement('tr');
      trHead.className = "bg-slate-700 text-slate-300 sticky top-0";

      data[0].forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;
        th.className = "px-4 py-3 font-semibold uppercase text-xs tracking-wider border-b border-slate-600";
        trHead.appendChild(th);
      });
      thead.appendChild(trHead);
      dataTable.appendChild(thead);

      // Cuerpo
      const tbody = document.createElement('tbody');
      tbody.className = "text-slate-400";

      for (let i = 1; i < data.length; i++) {
        const tr = document.createElement('tr');
        tr.className = "border-b border-slate-700 hover:bg-slate-800 transition";

        data[i].forEach(cell => {
          const td = document.createElement('td');
          td.textContent = cell;
          td.className = "px-4 py-2";
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      }

      dataTable.appendChild(tbody);
      dataPreviewContainer.classList.remove('hidden');
    }

    function showStatus(message, type) {
      if (!message) {
        statusElement.classList.add('hidden');
        return;
      }

      statusElement.textContent = message;

      if (type === 'success') {
        statusElement.className = "p-4 rounded-lg font-medium mb-4 bg-emerald-900/30 text-emerald-400 border border-emerald-500/30";
      }

      else {
        statusElement.className = "p-4 rounded-lg font-medium mb-4 bg-red-900/30 text-red-400 border border-red-500/30";
      }

      statusElement.classList.remove('hidden');
    }

    function showResults(logs) {
      if (!logs || logs.length === 0) return;
      const promptText = logs.pop();
      promptContainer.textContent = promptText;
      promptContainer.classList.remove('hidden');

      if (copiarBtn) {
        copiarBtn.classList.remove('hidden');
        copiarBtn.style.display = 'inline-flex';
      }

      showLogs(logs);
    }

    function showLogs(logs) {
      if (!logs || logs.length === 0) return;
      logContainer.innerHTML = '';

      const counts = {
        success: 0, error: 0, warning: 0, info: 0
      }

        ;

      logs.forEach(log => {
        const div = document.createElement('div');
        div.className = 'log-entry transition-all duration-300';
        let type = 'info';

        // --- RENDERIZADO PROFESIONAL DE JSON Y OBJETOS ---
        if (typeof log === 'string' && (log.trim().startsWith('{') || log.trim().startsWith('[') || log.includes('--- üïµÔ∏è‚Äç‚ôÇÔ∏è RESPUESTA JSON COMPLETA'))) {
          try {
            let jsonContent = '';

            if (log.includes('--- üïµÔ∏è‚Äç‚ôÇÔ∏è RESPUESTA JSON COMPLETA')) {
              jsonContent = log.split('--- üïµÔ∏è‚Äç‚ôÇÔ∏è RESPUESTA JSON COMPLETA (Debug) ---')[1]?.split('--- üïµÔ∏è‚Äç‚ôÇÔ∏è FIN RESPUESTA JSON ---')[0]?.trim();
            }

            else {
              jsonContent = log.trim();
            }

            if (jsonContent) {
              const data = JSON.parse(jsonContent);
              const tableDiv = document.createElement('div');
              tableDiv.className = 'bg-slate-900/60 p-4 my-2 rounded-xl border border-blue-500/30 font-mono text-xs overflow-x-auto';

              let html = `<div class="font-bold text-blue-400 mb-2 border-b border-blue-500/20 pb-1 flex justify-between" > <span>üì¶ DETALLES DE RESPUESTA</span> <span class="text-[10px] opacity-60" >JSON parsed</span> </div> <table class="w-full text-left border-collapse" >`;

              for (const [key, value] of Object.entries(data)) {
                if (key === 'server_logs' || key === 'variations') continue; // Se omiten o manejan aparte
                const valStr = typeof value === 'object' ? JSON.stringify(value) : value;

                html += `<tr class="border-b border-slate-700/30 hover:bg-white/5" > <td class="py-1.5 pr-4 text-slate-400 align-top" >${key}:</td> <td class="py-1.5 text-blue-100 font-semibold" >${valStr}</td> </tr>`;
              }

              html += `</table>`;
              tableDiv.innerHTML = html;
              div.appendChild(tableDiv);
              logContainer.appendChild(div);
              return;
            }
          }

          catch (e) {
            console.warn('Fail to parse JSON in log:', e);
          }
        }

        // --- RENDERIZADO DE RESUMEN T√âCNICO ---
        if (typeof log === 'string' && log.includes('üõ†Ô∏è RESUMEN T√âCNICO:')) {
          const lines = log.split('\n').map(l => l.trim()).filter(Boolean);
          const summaryDiv = document.createElement('div');
          summaryDiv.className = 'bg-slate-800/80 border-l-4 border-blue-500 p-4 my-2 rounded-r-xl shadow-lg font-sans';

          let html = `<h4 class="text-blue-400 font-bold flex items-center gap-2 mb-2 text-sm uppercase tracking-wider" > <span class="text-lg" >üõ†Ô∏è</span> RESUMEN T√âCNICO </h4> <div class="flex flex-col gap-1 mt-2" >`;

          lines.forEach(line => {
            if (line.includes('RESUMEN T√âCNICO:')) return;

            if (line.startsWith('-')) {
              html += `<div class="pl-4 text-slate-300 text-[11px] leading-tight flex items-start gap-2 py-0.5" > <span class="text-blue-500/80 mt-1 flex-shrink-0" >‚óè</span> <span>${line.substring(1).trim()}</span> </div>`;
            }

            else {
              html += `<div class="font-bold text-slate-100 text-xs py-1 border-b border-white/5 last:border-0" >${line}</div>`;
            }
          });

          html += `</div>`;
          summaryDiv.innerHTML = html;
          div.appendChild(summaryDiv);
          logContainer.appendChild(div);
          return;
        }

        // L√≥gica de botones URL & Detecci√≥n de Tipo (Resto del log)
        if (typeof log === 'string') {

          // URLs
          if (log.includes('PRODUCT_URL:') || log.includes('URL del producto:')) {
            const url = log.match(/https?:\/\/\S+/);

            if (url) {
              openUrlBtn.href = url[0];
              openUrlBtn.classList.remove('hidden');
              openUrlBtn.style.display = 'inline-flex';
            }
          }

          if (log.includes('MANUAL_SYNC_URL:')) {
            const url = log.match(/https?:\/\/\S+/);

            if (url) {
              syncManualBtn.href = url[0];
              syncManualBtn.classList.remove('hidden');
              syncManualBtn.style.display = 'inline-flex';
            }
          }

          // Tipos
          if (log.includes('‚ùå') || log.includes('Error')) {
            type = 'error';
            div.classList.add('log-error');
          }

          else if (log.includes('‚úÖ') || log.includes('üéâ') || log.includes('√âxito')) {
            type = 'success';
            div.classList.add('log-success');
          }

          else if (log.includes('‚ÑπÔ∏è') || log.includes('üõ†Ô∏è')) {
            type = 'info';
            div.classList.add('log-info');

            if (log.includes('üõ†Ô∏è')) {
              div.classList.add('font-sans', 'bg-slate-800/40', 'border-l-2', 'border-blue-500', 'p-3', 'my-2', 'rounded-r-lg');
              div.style.whiteSpace = 'pre-wrap';
            }
          }

          else if (log.includes('‚ö†Ô∏è')) {
            type = 'warning';
            div.classList.add('log-warning');
          }

          // Indentaci√≥n de listas
          if (log.trim().startsWith('-') || log.trim().startsWith('‚Ü≥')) {
            div.classList.add('pl-6', 'opacity-80');
          }
        }

        counts[type]++;
        div.setAttribute('data-type', type);
        div.textContent = log;
        logContainer.appendChild(div);
      });

      // Actualizar Dashboard
      statElements.success.textContent = counts.success;
      statElements.error.textContent = counts.error;
      statElements.warning.textContent = counts.warning;
      statElements.info.textContent = counts.info;

      statsDashboard.classList.remove('hidden');
      logFilters.classList.remove('hidden');
      logContainer.classList.remove('hidden');
      logContainer.scrollTop = logContainer.scrollHeight;
    }

    function applyLogFilter(filter) {
      const entries = logContainer.querySelectorAll('.log-entry');

      entries.forEach(entry => {
        if (filter === 'all' || entry.getAttribute('data-type') === filter) {
          entry.style.display = 'block';
          entry.style.opacity = '1';
        }

        else {
          entry.style.display = 'none';
          entry.style.opacity = '0';
        }
      });
    }

  </script>