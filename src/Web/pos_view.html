<?!= HtmlService.createHtmlOutputFromFile('Web/_shared_assets').getContent(); ?>

<style>
  :root {
    --primary: #2563eb;
    --success: #059669;
    --bg-tpv: #f8fafc;
    --panel-tpv: #ffffff;
    --text-tpv: #1e293b;
  }

  /* El contenedor ra√≠z del fragmento TPV */
  #pos-root {
    display: flex;
    flex-direction: column;
    height: 100%;
    width: 100%;
    background-color: var(--bg-tpv);
    color: var(--text-tpv);
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    position: relative;
    overflow: hidden;
  }

  .tpv-main-layout {
    display: grid;
    grid-template-columns: 200px 1fr 450px;
    flex: 1;
    overflow: hidden;
  }

  .tpv-header {
    background: #1e293b;
    color: white;
    padding: 0.75rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #334155;
    z-index: 100;
  }

  .header-actions {
    display: flex;
    align-items: center;
    gap: 1.5rem;
  }

  .header-control-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem 0.75rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 0.75rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .header-label {
    font-size: 0.65rem;
    font-weight: 800;
    text-transform: uppercase;
    color: #94a3b8;
    letter-spacing: 0.05em;
  }

  .header-btn {
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-size: 0.75rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    border: 1px solid transparent;
  }

  .header-btn.outline {
    background: transparent;
    border-color: #334155;
    color: #cbd5e1;
  }

  .header-btn.outline:hover {
    background: rgba(255, 255, 255, 0.1);
    color: white;
  }

  .header-btn.primary {
    background: var(--primary);
    color: white;
  }

  .header-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
  }

  /* Icon-based sidebar buttons */
  .filter-btn-tpv {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.25rem;
    padding: 0.75rem 0.5rem;
    margin-bottom: 0.5rem;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 0.75rem;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .filter-btn-tpv i {
    font-size: 1.25rem;
    color: #64748b;
  }

  .filter-btn-tpv span {
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    color: #1e293b;
    text-align: center;
    line-height: 1.1;
    display: block;
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .advanced-filters-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    background: #f1f5f9;
    border-radius: 0.75rem;
    cursor: pointer;
    margin: 1.5rem 0 1rem 0;
    transition: all 0.2s;
  }

  .advanced-filters-header:hover {
    background: #e2e8f0;
  }

  .advanced-filters-header h3 {
    font-size: 0.7rem;
    font-weight: 800;
    text-transform: uppercase;
    color: #475569;
    margin: 0 !important;
  }

  #advanced-filters-content {
    display: none;
    border-left: 2px solid #e2e8f0;
    padding-left: 0.75rem;
    margin-left: 0.25rem;
  }

  #advanced-filters-content.open {
    display: block;
  }

  .filter-btn-tpv:hover {
    border-color: var(--primary);
    background: #f8fafc;
  }

  .filter-btn-tpv.active {
    background: var(--primary);
    border-color: var(--primary);
    box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2);
  }

  .filter-btn-tpv.active i,
  .filter-btn-tpv.active span {
    color: white;
  }

  /* Asegurar que los SVGs integrados escalen correctamente */
  .filter-btn-tpv div svg {
    width: 24px !important;
    height: 24px !important;
    max-width: 100%;
    max-height: 100%;
  }

  .filter-btn-tpv.active div svg {
    fill: white !important;
  }

  .filters-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem;
  }

  .col-sidebar-tpv {
    background: var(--panel-tpv);
    border-right: 1px solid #e2e8f0;
    padding: 1rem;
    overflow-y: auto;
  }

  .col-catalog-tpv {
    padding: 1rem;
    overflow-y: auto;
  }

  .col-cart-tpv {
    background: var(--panel-tpv);
    border-left: 1px solid #e2e8f0;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .header-tpv-strip {
    background: #1e293b;
    color: white;
    padding: 0.5rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
  }

  .btn-cat-tpv {
    width: 100%;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    border: 1px solid #e2e8f0;
    border-radius: 0.5rem;
    background: white;
    cursor: pointer;
    text-align: left;
    transition: all 0.2s;
  }

  .btn-cat-tpv.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
  }

  .product-grid-tpv {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 1rem;
  }

  .product-card {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 0.75rem;
    padding: 0.5rem;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }

  .product-card:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
  }

  .product-card .product-img-container {
    height: 120px;
  }

  .product-card .product-title {
    font-size: 0.75rem !important;
  }

  .product-card .product-price {
    font-size: 1rem !important;
  }

  /* Estilos para Botones de Variaciones (Estilo TPV Muestra) */
  .variant-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 10px;
  }

  .color-btn {
    padding: 10px 15px;
    border-radius: 8px;
    border: 2px solid transparent;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s;
    min-width: 60px;
    text-align: center;
  }

  .color-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .color-btn.active {
    border-color: var(--primary);
    box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
  }

  .size-btn-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
  }

  .size-btn {
    padding: 12px 18px;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
    background: white;
    cursor: pointer;
    font-weight: 700;
    transition: all 0.2s;
  }

  /* Modos de Venta */
  .tpv-main-layout.mode-qr {
    grid-template-columns: 1fr 400px;
  }

  .tpv-main-layout.mode-qr .col-sidebar-tpv,
  .tpv-main-layout.mode-qr .col-catalog-tpv {
    display: none;
  }

  /* QR scan input should remain visible */
  .tpv-main-layout.mode-qr #tpv-scan-container {
    display: flex !important;
  }

  .tpv-main-layout.mode-qr .col-cart-tpv {
    grid-column: 1 / 4;
    /* Fill whole main grid width */
    display: grid;
    grid-template-columns: 1fr 400px;
    height: 100%;
  }

  .tpv-main-layout.mode-qr .qr-checkout-panel {
    display: flex !important;
    flex-direction: column;
    background: #f8fafc;
    border-left: 1px solid #e2e8f0;
    padding: 1.25rem;
    overflow-y: auto;
    height: 100%;
  }

  .tpv-main-layout.mode-qr #tpv-sidebar-totals {
    display: none !important;
  }

  .tpv-main-layout.mode-qr .cart-main-content {
    display: flex;
    flex-direction: column;
    overflow: hidden;
    height: 100%;
  }

  .qr-checkout-panel {
    display: none;
  }

  /* Checkout Modal */
  .checkout-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.85);
    backdrop-filter: blur(8px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
  }

  .checkout-modal {
    background: white;
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    border-radius: 1.5rem;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
  }

  .checkout-header {
    padding: 1.5rem;
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .checkout-body {
    padding: 1.5rem;
    overflow-y: auto;
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 1.5rem;
  }

  .checkout-footer {
    padding: 1.25rem 1.5rem;
    background: #f8fafc;
    border-top: 1px solid #e2e8f0;
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
  }

  /* Payment Method Icons */
  .payment-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 0.75rem;
  }

  .payment-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.25rem;
    padding: 0.4rem;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
    height: auto;
    min-height: 50px;
  }

  .payment-btn i {
    font-size: 1rem;
  }

  .payment-btn span {
    font-size: 0.55rem;
    font-weight: 700;
    text-transform: uppercase;
    text-align: center;
    line-height: 1;
  }

  .payment-btn:hover {
    border-color: var(--primary);
    background: #f8fafc;
  }

  .payment-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
    box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.4);
  }

  .size-btn.in-stock {
    border-color: #059669;
    color: #059669;
  }

  .size-btn.out-of-stock {
    border-color: #ef4444;
    color: #ef4444;
    background: #fef2f2;
  }

  .size-btn:hover {
    background: #f8fafc;
  }

  .stock-label {
    font-size: 0.7rem;
    font-weight: 600;
    color: #64748b;
  }

  /* Estilo del Carrito (DataTable) */
  .cart-table-wrapper {
    flex: 1;
    overflow-y: auto;
    padding-bottom: 20px;
  }

  #cart-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
  }

  #cart-table th {
    background: #f8fafc;
    text-align: left;
    padding: 10px;
    border-bottom: 1px solid #e2e8f0;
    position: sticky;
    top: 0;
    z-index: 10;
  }

  #cart-table td {
    padding: 10px;
    border-bottom: 1px solid #f1f5f9;
  }

  .qty-input {
    width: 45px;
    padding: 4px;
    border: 1px solid #cbd5e1;
    border-radius: 4px;
    text-align: center;
  }

  .product-img-container {
    width: 100%;
    aspect-ratio: 1;
    border-radius: 0.5rem;
    background: #f1f5f9;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .product-img-container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .product-no-img {
    font-size: 2rem;
    color: #cbd5e1;
  }

  /* Sobrescribir loader para que sea local al contenedor */
  .tpv-internal-loader {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    backdrop-filter: blur(2px);
  }

  /* Ajustar modales para que no se pierdan */
  .tpv-modal {
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    z-index: 2000;
  }
</style>

<div id="pos-root">
  <!-- Loader Local (Inicia oculto) -->
  <div id="tpv-overlay-loader" class="tpv-internal-loader" style="display: none;">
    <div class="w-10 h-10 border-4 border-slate-200 border-t-blue-500 rounded-full animate-spin mb-3"></div>
    <p id="tpv-loader-msg" class="text-sm font-semibold text-slate-700">Cargando...</p>
  </div>

  <!-- El modal legacy fue eliminado para evitar conflictos de ID -->

  <header class="tpv-header">
    <div class="flex items-center gap-4">
      <div id="tpv-user-status"
        class="flex items-center gap-2 px-3 py-1.5 bg-slate-800 rounded-full border border-slate-700 text-xs font-semibold text-slate-300">
        <div class="w-2 h-2 rounded-full bg-slate-500"></div>
        <span>Conectando...</span>
      </div>
      <div id="tpv-sync-status" style="display: none;"
        class="flex items-center gap-2 px-3 py-1.5 bg-amber-500/10 text-amber-500 border border-amber-500/20 rounded-full text-xs font-bold animate-pulse">
        <i class="ph-bold ph-warning-circle"></i>
        <span><span id="sync-pending-count">0</span> Pendientes</span>
      </div>
    </div>

    <div class="header-actions">
      <!-- Selecci√≥n de Modo -->
      <div class="header-control-group">
        <span class="header-label">Vista</span>
        <div class="flex gap-1" id="tpv-mode-selector">
          <button class="header-btn outline active" id="btn-mode-buttons" onclick="setTpvMode('BOTONES DE FILTRADO')">
            <i class="ph-bold ph-grid-four"></i> Botones
          </button>
          <button class="header-btn outline" id="btn-mode-qr" onclick="setTpvMode('LECTOR QR')">
            <i class="ph-bold ph-qr-code"></i> Lector QR
          </button>
        </div>
      </div>

      <!-- Compra M√≠nima -->
      <div class="header-control-group">
        <span class="header-label">M√≠nima</span>
        <div class="flex gap-1" id="tpv-header-min-purchase">
          <button class="header-btn outline btn-min-qty" onclick="setSelectedMinPurchase(1)">1</button>
          <button class="header-btn outline btn-min-qty" onclick="setSelectedMinPurchase(3)">3</button>
          <button class="header-btn outline btn-min-qty" onclick="setSelectedMinPurchase(6)">6</button>
          <button class="header-btn outline btn-min-qty" onclick="setSelectedMinPurchase(12)">12</button>
        </div>
      </div>

      <!-- Refrescar -->
      <button class="header-btn primary" onclick="manualRefreshStock()">
        <i class="ph-bold ph-arrows-clockwise"></i> Refrescar Stock
      </button>
    </div>
  </header>

  <div class="tpv-main-layout">
    <!-- Sidebar: Filtros con Iconos -->
    <div class="col-sidebar-tpv">
      <style>
        @keyframes pulse {
          0% {
            opacity: 1;
          }

          50% {
            opacity: 0.6;
          }

          100% {
            opacity: 1;
          }
        }
      </style>
      <div id="categories-container"></div>
    </div>

    <!-- Cat√°logo -->
    <div class="col-catalog-tpv">
      <div style="margin-bottom: 1rem;">
        <input type="text" id="tpv-search" placeholder="üîç Buscar por modelo o SKU..."
          style="width: 100%; padding: 0.75rem 1rem; border-radius: 0.75rem; border: 1px solid #e2e8f0; outline: none;">
      </div>
      <div class="product-grid-tpv" id="product-grid"></div>
    </div>

    <!-- Carrito -->
    <div class="col-cart-tpv">
      <div class="cart-main-content">
        <div
          style="padding: 1rem; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; background: #f8fafc;">
          <span style="font-weight: 700; font-size: 0.9rem;">TICKET ACTUAL</span>
          <div id="tpv-scan-container" style="flex: 1; max-width: 300px; margin-left: 1rem;">
            <input type="text" id="tpv-scan-input" placeholder="üîç Escanear QR/Barras..."
              style="width: 100%; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #e2e8f0; font-size: 0.8rem; outline: none; border: 2px solid var(--primary);">
          </div>
        </div>

        <div id="modal-variations"
          style="display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(4px); align-items: center; justify-content: center; z-index: 1000;">
          <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-2xl w-full border border-slate-200">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
              <div>
                <h3 id="modal-product-title" style="font-size: 1.25rem; font-weight: 800; color: #1e293b;">Producto</h3>
                <p id="modal-product-subtitle" style="font-size: 0.875rem; color: #64748b;">Selecciona una variante para
                  agregar al carrito</p>
              </div>
              <button onclick="closeTpvModal()" class="text-slate-400 hover:text-slate-600 transition p-2">
                <i class="ph-bold ph-x text-2xl"></i>
              </button>
            </div>

            <div class="space-y-4">
              <div>
                <label class="text-[0.65rem] font-bold text-slate-500 uppercase tracking-wider">Colores
                  Disponibles</label>
                <div id="color-options" class="variant-grid"></div>
              </div>
              <div id="size-container" style="display: none;">
                <label class="text-[0.65rem] font-bold text-slate-500 uppercase tracking-wider">Talles y Stock</label>
                <div id="size-options" class="variant-grid"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="cart-table-wrapper">
          <table id="cart-table" class="display" style="width: 100%;">
            <thead>
              <tr>
                <th>Producto</th>
                <th>Color</th>
                <th>Talle</th>
                <th>Cant.</th>
                <th>Subtotal</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="cart-body"></tbody>
          </table>
        </div>
      </div>

      <!-- Sidebar Totals (Quick View - Only for Buttons Mode) -->
      <div id="tpv-sidebar-totals"
        style="background: #f8fafc; border-top: 1px solid #e2e8f0; padding: 1rem; display: flex; flex-direction: column; gap: 0.75rem;">
        <div style="display: flex; justify-content: space-between; font-size: 0.9rem; color: #64748b;">
          <span>Subtotal:</span> <span id="tpv-sidebar-subtotal" style="font-weight: 600;">$0</span>
        </div>
        <button onclick="openCheckoutModal()"
          style="width: 100%; padding: 1rem; background: var(--primary); color: white; border: none; border-radius: 0.75rem; font-weight: 800; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.4);">
          <i class="ph-bold ph-shopping-cart"></i> REGISTRAR VENTA
        </button>
      </div>

      <!-- QR Mode Checkout Panel (Visible instead of totals in QR mode) -->
      <div class="qr-checkout-panel">
        <h3
          style="font-size: 1.1rem; font-weight: 800; color: #1e293b; margin-bottom: 1.5rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 0.5rem;">
          Finalizar Venta</h3>

        <div class="space-y-4" style="flex: 1;">
          <div>
            <label
              style="font-size: 0.7rem; font-weight: 700; color: #64748b; text-transform: uppercase;">Cliente</label>
            <select id="qr-tpv-customer" class="w-full mt-1 p-2 rounded-xl border border-slate-200 bg-white text-sm">
              <option value="CLIENTE_GENERAL">Cliente General</option>
            </select>
          </div>

          <div>
            <label style="font-size: 0.7rem; font-weight: 700; color: #64748b; text-transform: uppercase;">M√©todo de
              Pago</label>
            <div id="qr-payment-methods-grid" class="payment-grid mt-2"
              style="grid-template-columns: repeat(3, 1fr); gap: 0.5rem;">
              <!-- Din√°mico -->
            </div>
            <select id="qr-tpv-payment-method" style="display: none;" onchange="updateTpvTotals()"></select>
          </div>

          <div id="qr-tpv-transfer-account-container" style="display: none;">
            <label style="font-size: 0.7rem; font-weight: 700; color: #64748b; text-transform: uppercase;">Cuenta
              Destino</label>
            <select id="qr-tpv-transfer-account"
              class="w-full mt-1 p-2 rounded-xl border border-slate-200 bg-white text-sm"></select>
          </div>

          <div>
            <label style="font-size: 0.7rem; font-weight: 700; color: #64748b; text-transform: uppercase;">Efectivo
              (Mixto)</label>
            <input type="number" id="qr-tpv-cash-amount" placeholder="0.00" oninput="updateTpvTotals()"
              class="w-full mt-1 p-2 rounded-xl border border-slate-200 bg-white text-lg font-bold text-success">
          </div>

          <div style="background: #f1f5f9; padding: 1rem; border-radius: 1rem; margin-top: 1rem;">
            <div id="qr-tpv-modal-products-row"
              style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 0.5rem;">
              <span class="text-slate-500">Monto Productos:</span> <span id="qr-tpv-modal-total-products"
                class="font-bold">$0</span>
            </div>
            <div id="qr-tpv-modal-minor-row"
              style="display: none; justify-content: space-between; font-size: 0.8rem; color: #f59e0b; margin-bottom: 0.5rem;">
              <span>Recargo Minorista:</span> <span id="qr-tpv-modal-minor-surcharge" class="font-bold">+$0</span>
            </div>
            <div id="qr-tpv-modal-cash-row"
              style="display: none; justify-content: space-between; font-size: 0.8rem; color: #ef4444; margin-bottom: 0.5rem;">
              <span>Pago Efectivo:</span> <span id="qr-tpv-modal-cash-discount" class="font-bold">-$0</span>
            </div>
            <div
              style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 0.5rem; border-top: 2px dashed #cbd5e1; padding-top: 0.5rem; font-weight: 800; color: #1e293b;">
              <span>Subtotal:</span> <span id="qr-tpv-modal-subtotal">$0</span>
            </div>
            <div id="qr-tpv-modal-payment-row"
              style="display: none; justify-content: space-between; font-size: 0.8rem; color: #2563eb; margin-bottom: 0.5rem;">
              <span>Recargo <span id="qr-pm-name"></span>:</span> <span id="qr-tpv-modal-payment-surcharge"
                class="font-bold">+$0</span>
            </div>
            <div style="text-align: right; border-top: 1px dashed #cbd5e1; padding-top: 0.5rem;">
              <p
                style="font-size: 0.65rem; color: #64748b; font-weight: 700; text-transform: uppercase; margin-bottom: 2px;">
                Total a Pagar</p>
              <p id="qr-tpv-modal-final-total"
                style="font-size: 1.75rem; font-weight: 950; color: var(--primary); line-height: 1;">$0</p>
            </div>
          </div>
        </div>

        <div style="margin-top: 1rem;">
          <label class="flex items-center gap-2 cursor-pointer mb-3">
            <input type="checkbox" id="qr-tpv-modal-deactivate-surcharge" onchange="updateTpvTotals()">
            <span style="font-size: 0.65rem; color: #64748b; font-weight: 700;">SIN RECARGO TRANSF.</span>
          </label>
          <button onclick="processCheckoutSale()"
            style="width: 100%; padding: 1rem; background: var(--success); color: white; border-radius: 0.75rem; font-weight: 800; border: none; cursor: pointer; box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.4);">
            REGISTRAR VENTA
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- CHECKOUT MODAL -->
<div id="checkout-modal" class="checkout-modal-overlay">
  <div class="checkout-modal">
    <div class="checkout-header">
      <h3 style="font-size: 1.25rem; font-weight: 800; color: #1e293b;">Finalizar Venta</h3>
      <button onclick="closeCheckoutModal()" class="text-slate-400 hover:text-slate-600 transition p-2">
        <i class="ph-bold ph-x text-2xl"></i>
      </button>
    </div>
    <div class="checkout-body">
      <!-- Izquierda: Configuraci√≥n -->
      <div class="space-y-6">
        <div>
          <label
            style="font-size: 0.75rem; font-weight: 700; color: #64748b; text-transform: uppercase;">Cliente</label>
          <select id="tpv-customer" class="w-full mt-1 p-3 rounded-xl border border-slate-200 bg-white text-sm">
            <option value="CLIENTE_GENERAL">Cliente General</option>
          </select>
        </div>

        <div>
          <label style="font-size: 0.75rem; font-weight: 700; color: #64748b; text-transform: uppercase;">M√©todo de
            Pago</label>
          <div id="payment-methods-grid" class="payment-grid mt-2">
            <!-- Se cargar√° din√°micamente -->
          </div>
          <select id="tpv-payment-method" style="display: none;" onchange="updateTpvTotals()"></select>
        </div>

        <div id="tpv-transfer-account-container" style="display: none;">
          <label style="font-size: 0.75rem; font-weight: 700; color: #64748b; text-transform: uppercase;">Cuenta de
            Destino</label>
          <select id="tpv-transfer-account"
            class="w-full mt-1 p-3 rounded-xl border border-slate-200 bg-white text-sm"></select>
        </div>

        <div style="display: flex; gap: 1rem;">
          <div style="flex: 1;">
            <label style="font-size: 0.75rem; font-weight: 700; color: #64748b; text-transform: uppercase;">Pago
              Efectivo (Mixto)</label>
            <input type="number" id="tpv-cash-amount" placeholder="0.00" oninput="updateTpvTotals()"
              class="w-full mt-1 p-3 rounded-xl border border-slate-200 bg-white text-lg font-bold text-success">
          </div>
        </div>
      </div>

      <!-- Derecha: Resumen -->
      <div
        style="background: #f1f5f9; padding: 1.5rem; border-radius: 1.25rem; display: flex; flex-direction: column; gap: 1rem;">
        <h4
          style="font-size: 0.8rem; font-weight: 700; color: #1e293b; text-transform: uppercase; border-bottom: 2px solid #e2e8f0; padding-bottom: 0.5rem;">
          Resumen de Pago</h4>

        <div class="space-y-3">
          <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
            <span class="text-slate-500">Monto Productos:</span> <span id="tpv-modal-total-products"
              class="font-bold">$0</span>
          </div>
          <div id="tpv-modal-minor-row"
            style="display: none; justify-content: space-between; font-size: 0.9rem; color: #f59e0b;">
            <span>Recargo Minorista:</span> <span id="tpv-modal-minor-surcharge" class="font-bold">+$0</span>
          </div>
          <div id="tpv-modal-cash-row"
            style="display: none; justify-content: space-between; font-size: 0.9rem; color: #ef4444;">
            <span>Pago Efectivo:</span> <span id="tpv-modal-cash-discount" class="font-bold">-$0</span>
          </div>

          <div
            style="display: flex; justify-content: space-between; font-size: 1rem; font-weight: 800; color: #1e293b; border-top: 2px dashed #cbd5e1; padding-top: 0.5rem;">
            <span>Subtotal:</span> <span id="tpv-modal-subtotal">$0</span>
          </div>

          <div id="tpv-modal-payment-row"
            style="display: none; justify-content: space-between; font-size: 0.9rem; color: #2563eb;">
            <span>Recargo Transf:</span> <span id="tpv-modal-payment-surcharge" class="font-bold">+$0</span>
          </div>
        </div>

        <div style="flex: 1;"></div>

        <div style="text-align: right;">
          <p style="font-size: 0.75rem; color: #64748b; font-weight: 700; text-transform: uppercase;">Total a Pagar
          </p>
          <p id="tpv-modal-final-total"
            style="font-size: 2.25rem; font-weight: 950; color: var(--primary); line-height: 1;">$0</p>
        </div>
      </div>
    </div>
    <div class="checkout-footer">
      <label class="flex items-center gap-2 cursor-pointer mr-auto">
        <input type="checkbox" id="tpv-modal-deactivate-surcharge" onchange="updateTpvTotals()">
        <span style="font-size: 0.7rem; color: #64748b; font-weight: 700;">SIN RECARGO TRANSFERENCIA</span>
      </label>
      <button onclick="closeCheckoutModal()"
        style="padding: 0.75rem 1.5rem; border-radius: 0.75rem; font-weight: 700; color: #64748b; border: none; background: transparent; cursor: pointer;">Cancelar</button>
      <button onclick="processCheckoutSale()"
        style="padding: 0.75rem 2rem; background: var(--success); color: white; border-radius: 0.75rem; font-weight: 800; border: none; cursor: pointer; box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.4);">CONFIRMAR
        Y PAGAR</button>
    </div>
  </div>
</div>
</div>
</div>
</div>

<script>
  (function () {
    try {
      console.log("üü¢ [TPV] Fragmento inicializado");
      let catalog = null;
      let posMetadata = null;
      let cart = [];
      let realStockCache = {
        map: {},
        lastUpdate: null
      };
      const CATALOG_URL = "<?!= CATALOG_URL ?>";

      let selectedMinPurchase = 1;
      let currentTpvFilters = {
        parent: 'ALL',
        cat: 'ALL',
        season: 'ALL',
        gender: 'ALL',
        brand: 'ALL',
        style: 'ALL',
        material: 'ALL'
      };

      const categoryIcons = {
        'BOXER': 'ph-pants',
        'BOBBY': 'ph-pants',
        'CALZA': 'ph-pants',
        'JOGGING': 'ph-pants',
        'PANTALON': 'ph-pants',
        'PANTAL√ìN': 'ph-pants',
        'SHORT': 'ph-pants',
        'SUETER': 'ph-t-shirt',
        'SU√âTER': 'ph-t-shirt',
        'CAMISETA': 'ph-t-shirt',
        'TOP': 'ph-selection-background',
        'MUSCULOSA': 'ph-user-focus',
        'REMERA': 'ph-t-shirt',
        'BUZO': 'ph-hoodie',
        'CAMPERAS': 'ph-coat',
        'ACCESORIOS': 'ph-watch',
        'DEFAULT': 'ph-tag'
      };

      const seasonIcons = {
        'INVIERNO': 'ph-snowflake',
        'VERANO': 'ph-sun',
        'PRIMAVERA': 'ph-flower',
        'OTO√ëO': 'ph-leaf',
        'CONTINUO': 'ph-arrows-clockwise',
        'DEFAULT': 'ph-calendar'
      };

      window.setTpvMode = function (mode) {
        if (!posMetadata) return;
        posMetadata.storeConfig.saleMode = mode;
        var mainLayout = document.querySelector('.tpv-main-layout');
        var btnQr = document.getElementById('btn-mode-qr');
        var btnBtn = document.getElementById('btn-mode-buttons');

        if (mode.toUpperCase().trim() === "LECTOR QR") {
          mainLayout.classList.add('mode-qr');
          if (btnQr) btnQr.classList.add('active');
          if (btnBtn) btnBtn.classList.remove('active');
          var si = document.getElementById('tpv-scan-input');
          if (si) si.focus();
        } else {
          mainLayout.classList.remove('mode-qr');
          if (btnQr) btnQr.classList.remove('active');
          if (btnBtn) btnBtn.classList.add('active');
        }
      };

      window.setSelectedMinPurchase = function (qty) {
        selectedMinPurchase = qty;
        document.querySelectorAll('.btn-min-qty').forEach(function (btn) {
          btn.classList.toggle('active', parseInt(btn.innerText) === qty);
        });
        updateTpvTotals();
      };

      // Ejecuci√≥n inmediata
      initTPV();

      window.openCheckoutModal = function () {
        if (cart.length === 0) {
          alert("El carrito est√° vac√≠o");
          return;
        }

        // Si es modo QR, no abrimos modal, sino que nos aseguramos de que el panel est√© listo
        var isQr = (posMetadata.storeConfig.saleMode || "").toUpperCase().trim() === "LECTOR QR";

        // Renderizar m√©todos de pago en ambos contenedores
        renderPaymentMethods('payment-methods-grid');
        renderPaymentMethods('qr-payment-methods-grid');

        if (isQr) {
          // En modo QR la UI ya est√° visible en el panel derecho
          console.log("Modo QR: El panel de checkout ya deber√≠a estar visible.");
          updateTpvTotals();
          return;
        }

        document.getElementById('checkout-modal').style.display = 'flex';
        updateTpvTotals();
      };

      function renderPaymentMethods(containerId) {
        const grid = document.getElementById(containerId);
        if (!grid) return;
        const allowed = (posMetadata.storeConfig && posMetadata.storeConfig.allowedPaymentMethods) || [];
        const methodsToRender = allowed.length > 0
          ? posMetadata.paymentMethods.filter(m => allowed.includes(m.id))
          : posMetadata.paymentMethods;

        grid.innerHTML = methodsToRender.map(function (m) {
          var icon = "ph-money";
          var idLower = m.id.toLowerCase();
          if (idLower.includes('transf')) icon = "ph-bank";
          if (idLower.includes('qr') || idLower.includes('mercado')) icon = "ph-qr-code";
          if (idLower.includes('tarjeta')) icon = "ph-credit-card";

          return (
            "<button class='payment-btn' data-id='" + m.id + "' onclick='setSelectedPaymentMethod(\"" + m.id + "\")'>" +
            "<i class='ph-bold " + icon + "'></i>" +
            "<span>" + m.id + "</span>" +
            "</button>"
          );
        }).join('');
      }

      window.closeCheckoutModal = function () {
        document.getElementById('checkout-modal').style.display = 'none';
      };

      window.setSelectedPaymentMethod = function (id) {
        document.querySelectorAll('.payment-btn').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.id === id);
        });
        document.getElementById('tpv-payment-method').value = id;
        document.getElementById('qr-tpv-payment-method').value = id;

        // Mostrar/Ocultar container de cuentas si es transferencia
        const m = posMetadata.paymentMethods.find(pm => pm.id === id);
        const container = document.getElementById('tpv-transfer-account-container');
        const qrContainer = document.getElementById('qr-tpv-transfer-account-container');
        const isTransfer = (m && m.id === 'Transferencia');

        if (container) container.style.display = isTransfer ? 'block' : 'none';
        if (qrContainer) qrContainer.style.display = isTransfer ? 'block' : 'none';

        updateTpvTotals();
      };

      async function initTPV() {
        try {
          console.log("üîç [TPV] Iniciando servicios...");
          showTpvLoader("üöÄ Sincronizando datos...");

          const userStr = sessionStorage.getItem('loggedInUser');
          const user = userStr ? JSON.parse(userStr) : null;
          const managedStore = user ? user.managedStore : null;
          const userEmail = user ? user.email : null;

          // A. Metadata
          google.script.run
            .withSuccessHandler(data => {
              if (data && data.success) {
                posMetadata = data;
                posMetadata.managedStoreId = managedStore;
                posMetadata.userEmail = userEmail;
                posMetadata.sellerId = sessionStorage.getItem('userPassword');

                // 1. Aplicar Modo de Venta
                var rawMode = (data.storeConfig && data.storeConfig.saleMode) || "BOTONES DE FILTRADO";
                setTpvMode(rawMode);

                // Listener persistente para QR (solo si el modo es Lector QR)
                // Removed aggressive focus listener that interfered with UI
                /*
                document.addEventListener('click', function () {
                  if (posMetadata && posMetadata.storeConfig) {
                    var currMode = (posMetadata.storeConfig.saleMode || "").toUpperCase().trim();
                    if (currMode === "LECTOR QR") {
                      var si = document.getElementById('tpv-scan-input');
                      if (si) si.focus();
                    }
                  }
                });
                */

                // 2. Cuentas de Transferencia
                const transSel = document.getElementById('tpv-transfer-account');
                const qrTransSel = document.getElementById('qr-tpv-transfer-account');
                if (data.transferAccounts) {
                  const options = data.transferAccounts.map(function (a) {
                    return "<option value='" + a.id + "'>" + a.alias + " - " + a.name + "</option>";
                  }).join('');
                  if (transSel) transSel.innerHTML = options;
                  if (qrTransSel) qrTransSel.innerHTML = options;
                }

                // 3. Clientes
                const custSel = document.getElementById('tpv-customer');
                const qrCustSel = document.getElementById('qr-tpv-customer');
                if (data.customers) {
                  const options = "<option value='CLIENTE_GENERAL'>Cliente General</option>" +
                    data.customers.map(function (c) { return "<option value='" + c.id + "'>" + c.name + "</option>"; }).join('');
                  if (custSel) custSel.innerHTML = options;
                  if (qrCustSel) qrCustSel.innerHTML = options;
                }

                // Initial Payments Render
                renderPaymentMethods('payment-methods-grid');
                renderPaymentMethods('qr-payment-methods-grid');
                setSelectedPaymentMethod('Efectivo');

                // 4. Configuraci√≥n de Compra M√≠nima
                if (data.storeConfig && data.storeConfig.minimumPurchase) {
                  setSelectedMinPurchase(data.storeConfig.minimumPurchase);
                } else {
                  setSelectedMinPurchase(1);
                }

                var statusEl = document.getElementById('tpv-user-status');
                if (statusEl) {
                  var dot = statusEl.querySelector('div');
                  var label = statusEl.querySelector('span');
                  if (dot) dot.className = "w-2 h-2 rounded-full bg-emerald-500";
                  if (label) label.innerText = (user ? user.name : 'Vendedor') + " listo";
                }
              }
            })
            .getInitialPosData(managedStore, sessionStorage.getItem('userPassword'));

          // C. Stock Cache (Nuevo: Emular TPV de Muestra)
          google.script.run
            .withSuccessHandler(data => {
              if (data && data.success) {
                realStockCache.map = data.stockMap;
                realStockCache.lastUpdate = new Date();
                console.log("üì¶ [Stock Cache] Sincronizado:", Object.keys(data.stockMap).length, "√≠tems");
              }
            })
            .getAllStockFromCache();

          // B. Cat√°logo
          try {
            var resp = await fetch(CATALOG_URL, { cache: 'no-store' });
            if (!resp.ok) throw new Error("HTTP " + resp.status);
            catalog = await resp.json();

            const userRole = (user ? user.role : '').toUpperCase();

            // Solo filtramos si NO es ADMIN y tiene una tienda asignada (Que no sea "TODAS")
            if (userRole !== 'ADMIN' && managedStore && managedStore !== "TODAS") {
              catalog.products = catalog.products.map(function (p) {
                var filtered = (p.variations || []).filter(function (v) { return String(v.store_id) === String(managedStore); });
                return Object.assign({}, p, { variations: filtered });
              }).filter(function (p) { return p.variations.length > 0; });
            }
          } catch (e) {
            console.warn("Fallo catalogo:", e);
          }

          if (catalog) {
            renderTpvUI();
            initCartDataTable();
            hideTpvLoader();
            initSyncWorker();
          }
        } catch (err) {
          console.warn("Fallo carga TPV:", err);
          hideTpvLoader();
        }
      }

      function initCartDataTable() {
        if ($.fn.DataTable.isDataTable('#cart-table')) return;
        $('#cart-table').DataTable({
          dom: 'Bfrtip',
          buttons: [
            {
              text: 'üì± WhatsApp',
              className: 'bg-green-500 text-white rounded px-2 py-1 text-xs',
              action: function (e, dt, node, config) {
                copyCartToWhatsApp();
              }
            }
          ],
          paging: false,
          searching: false,
          info: false,
          language: { emptyTable: "Sin productos" },
          columnDefs: [{ targets: 5, className: 'text-right' }]
        });
      }

      function copyCartToWhatsApp() {
        if (cart.length === 0) return alert("Carrito vac√≠o");
        var text = "*PRESUPUESTO HOSTINGSHOP*\n--------------------------\n";
        cart.forEach(function (i) {
          text += "‚Ä¢ " + i.model + " (" + i.color + "/" + i.size + ")\n  " + i.quantity + " x $" + i.price.toLocaleString() + " = $" + (i.price * i.quantity).toLocaleString() + "\n";
        });
        var total = document.getElementById('total-amount').innerText;
        text += "--------------------------\n*TOTAL: " + total + "*";

        navigator.clipboard.writeText(text).then(function () {
          alert("¬°Copiado al portapapeles para WhatsApp!");
        });
      }

      function showTpvLoader(msg) {
        const overlay = document.getElementById('tpv-overlay-loader');
        const text = document.getElementById('tpv-loader-msg');
        if (overlay && text) {
          text.innerText = msg;
          overlay.style.display = 'flex';
        }
      }

      function hideTpvLoader() {
        const overlay = document.getElementById('tpv-overlay-loader');
        if (overlay) overlay.style.display = 'none';
      }

      function renderTpvUI() {
        var catCont = document.getElementById('categories-container');
        if (!catCont) return;
        catCont.innerHTML = '';

        var createFilterGroup = function (title, items, filterKey, iconMap, isSvgMap) {
          var filteredItems = items.filter(Boolean);
          if (filteredItems.length === 0) return document.createElement('div');

          var group = document.createElement('div');
          group.style.marginBottom = '2rem';
          group.innerHTML = "<h3 style='font-size: 0.65rem; text-transform: uppercase; color: #94a3b8; margin-bottom: 0.75rem; font-weight: 800; letter-spacing: 0.1em;'>" + title + "</h3>";

          var grid = document.createElement('div');
          grid.className = "filters-grid";

          // Bot√≥n "Todos"
          var btnAll = document.createElement('button');
          var isAllActive = currentTpvFilters[filterKey] === 'ALL';
          btnAll.className = "filter-btn-tpv " + (isAllActive ? 'active' : '');

          if (isSvgMap) {
            btnAll.innerHTML = "<div style='width:24px; height:24px; display:flex; align-items:center; justify-content:center;'><i class='ph-bold ph-dots-three-outline'></i></div><span>Todos</span>";
          } else {
            btnAll.innerHTML = "<i class='ph-bold " + (iconMap.ALL || iconMap.DEFAULT) + "'></i><span>Todos</span>";
          }

          btnAll.onclick = function () {
            currentTpvFilters[filterKey] = 'ALL';
            applyTpvFilters();
            renderTpvUI();
          };
          grid.appendChild(btnAll);

          filteredItems.forEach(function (item) {
            var btn = document.createElement('button');
            var isActive = currentTpvFilters[filterKey] === item;
            btn.className = "filter-btn-tpv " + (isActive ? 'active' : '');

            if (isSvgMap && catalog.categorySvgs && catalog.categorySvgs[item.toUpperCase()]) {
              var svgCode = catalog.categorySvgs[item.toUpperCase()];
              btn.innerHTML = "<div style='width:24px; height:24px; display:flex; align-items:center; justify-content:center; fill: currentColor;'>" + svgCode + "</div><span>" + item + "</span>";
            } else {
              var iconClass = iconMap[item.toUpperCase()] || iconMap.DEFAULT;
              btn.innerHTML = "<i class='ph-bold " + iconClass + "'></i><span>" + item + "</span>";
            }

            btn.onclick = function () {
              currentTpvFilters[filterKey] = item;
              applyTpvFilters();
              renderTpvUI();
            };
            grid.appendChild(btn);
          });

          group.appendChild(grid);
          return group;
        };

        // 1. GRUPO PADRE
        var parents = [].concat(Array.from(new Set(catalog.products.map(function (p) { return p.parentCategory; })))).filter(Boolean).sort();
        catCont.appendChild(createFilterGroup('L√≠nea', parents, 'parent', categoryIcons));

        // 2. CATEGOR√çA (Con SVGs de la base de datos)
        var cats = [].concat(Array.from(new Set(catalog.products.map(function (p) { return p.categoryName; })))).filter(Boolean).sort();
        catCont.appendChild(createFilterGroup('Producto', cats, 'cat', categoryIcons, true));

        // 3. TEMPORADA
        var seasons = [].concat(Array.from(new Set(catalog.products.map(function (p) { return p.season; })))).filter(Boolean).sort();
        catCont.appendChild(createFilterGroup('Temporada', seasons, 'season', seasonIcons));

        // --- SECCI√ìN COLAPSABLE DE FILTROS AVANZADOS ---
        var hasAdv = true;
        var advHeader = document.createElement('div');
        advHeader.className = "advanced-filters-header";
        advHeader.innerHTML = "<h3>M√°s Filtros</h3><i class='ph-bold ph-caret-down'></i>";
        advHeader.onclick = function () {
          var content = document.getElementById('advanced-filters-content');
          var icon = this.querySelector('i');
          var isOpen = content.classList.toggle('open');
          icon.className = isOpen ? "ph-bold ph-caret-up" : "ph-bold ph-caret-down";
        };
        catCont.appendChild(advHeader);

        var advContent = document.createElement('div');
        advContent.id = "advanced-filters-content";

        // 4. G√âNERO
        var genders = [].concat(Array.from(new Set(catalog.products.map(function (p) { return p.gender; })))).filter(Boolean).sort();
        if (genders.length > 0) advContent.appendChild(createFilterGroup('G√©nero', genders, 'gender', { 'DEFAULT': 'ph-gender-intersex' }));

        // 5. MARCA
        var brands = [].concat(Array.from(new Set(catalog.products.map(function (p) { return p.brand; })))).filter(Boolean).sort();
        if (brands.length > 0) advContent.appendChild(createFilterGroup('Marca', brands, 'brand', { 'DEFAULT': 'ph-copyright' }));

        // 6. ESTILO 
        var styles = [].concat(Array.from(new Set(catalog.products.map(function (p) { return p.style; })))).filter(Boolean).sort();
        if (styles.length > 0) advContent.appendChild(createFilterGroup('Estilo', styles, 'style', { 'DEFAULT': 'ph-paint-brush' }));

        // 7. MATERIAL
        var materials = [].concat(Array.from(new Set(catalog.products.map(function (p) { return p.material; })))).filter(Boolean).sort();
        if (materials.length > 0) advContent.appendChild(createFilterGroup('Material', materials, 'material', { 'DEFAULT': 'ph-atom' }));

        catCont.appendChild(advContent);

        applyTpvFilters();
      }

      window.applyTpvFilters = function () {
        const filtered = catalog.products.filter(p => {
          const matchParent = currentTpvFilters.parent === 'ALL' || p.parentCategory === currentTpvFilters.parent;
          const matchCat = currentTpvFilters.cat === 'ALL' || p.categoryName === currentTpvFilters.cat;
          const matchSeason = currentTpvFilters.season === 'ALL' || p.season === currentTpvFilters.season;
          const matchGender = currentTpvFilters.gender === 'ALL' || p.gender === currentTpvFilters.gender;
          const matchBrand = currentTpvFilters.brand === 'ALL' || p.brand === currentTpvFilters.brand;
          const matchStyle = currentTpvFilters.style === 'ALL' || p.style === currentTpvFilters.style;
          const matchMaterial = currentTpvFilters.material === 'ALL' || p.material === currentTpvFilters.material;

          return matchParent && matchCat && matchSeason && matchGender && matchBrand && matchStyle && matchMaterial;
        });
        renderTpvProducts(filtered);
      };

      // Listeners SCAN y SEARCH
      const searchInput = document.getElementById('tpv-search');
      const scanInput = document.getElementById('tpv-scan-input');

      const handleEnter = (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          const code = normalizeScanCode(e.target.value);
          if (code.productId) handleProductAction(code);
          e.target.value = '';
        }
      };

      if (searchInput) {
        searchInput.onkeypress = handleEnter;
        searchInput.oninput = (e) => {
          const term = e.target.value.toLowerCase();
          if (term.length > 2) {
            const filtered = catalog.products.filter(p =>
              p.model.toLowerCase().includes(term) ||
              p.id.toLowerCase().includes(term)
            );
            renderTpvProducts(filtered);
          } else if (term.length === 0) {
            renderTpvProducts(catalog.products);
          }
        };
      }
      if (scanInput) {
        scanInput.onkeypress = handleEnter;
      }

      function normalizeScanCode(raw) {
        if (!raw) return { productId: null, color: null, size: null };
        let code = raw.trim();
        if (code.startsWith('+')) code = code.slice(1, -1);
        const parts = code.split('-');
        return { productId: parts[0], color: parts[1] || null, size: parts[2] || null };
      }

      function handleProductAction(scan) {
        const product = catalog.products.find(p => String(p.id).toLowerCase() === String(scan.productId).toLowerCase());
        if (!product) return alert("Producto no encontrado");

        if (scan.color && scan.size) {
          const v = product.variations.find(v => v.color === scan.color && v.size === scan.size);
          if (v) return addTpvToCart(product, v);
        }
        openTpvVariations(product, scan);
      }

      function renderTpvProducts(products) {
        var grid = document.getElementById('product-grid');
        if (!grid) return;
        grid.innerHTML = '';
        products.forEach(function (p) {
          var div = document.createElement('div');
          div.className = 'product-card';

          var imgHtml = p.image
            ? "<div class='product-img-container'><img src='" + p.image + "' alt='" + p.model + "' loading='lazy'></div>"
            : "<div class='product-img-container'><div class='product-no-img'>üëï</div></div>";

          div.innerHTML = imgHtml +
            "<div style='flex: 1;'>" +
            "<div class='product-title' style='font-weight: 700; font-size: 0.85rem; color: #1e293b; margin-bottom: 0.25rem; line-height: 1.2;'>" + p.model + "</div>" +
            "<div class='product-price' style='color: var(--primary); font-weight: 800; font-size: 1.1rem; margin-top: 5px;'>$" + p.price.toLocaleString() + "</div>" +
            "<div style='font-size: 0.65rem; color: #94a3b8; margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px;'>" + p.categoryName + "</div>" +
            "</div>";
          div.onclick = function () { openTpvVariations(p); };
          grid.appendChild(div);
        });
      }

      window.openTpvVariations = function (product, scan = null) {
        // AUTO-SELECCI√ìN: Si el producto tiene una sola variaci√≥n, la a√±adimos directo
        if (product.variations.length === 1) {
          addTpvToCart(product, product.variations[0]);
          return;
        }

        const modal = document.getElementById('modal-variations');
        document.getElementById('modal-product-title').innerText = product.model;

        const colorCont = document.getElementById('color-options');
        const sizeCont = document.getElementById('size-options');
        const sizeContainer = document.getElementById('size-container');

        colorCont.innerHTML = '';
        sizeCont.innerHTML = '';
        sizeContainer.style.display = 'none';

        const colors = [...new Set(product.variations.map(v => v.color))];
        colors.forEach(color => {
          const btn = document.createElement('button');
          btn.className = 'color-btn';
          btn.innerText = color;

          // APLICAR COLOR HEXADECIMAL (Desde BD_COLORES v√≠a masterData)
          if (catalog.colors && catalog.colors[color]) {
            const config = catalog.colors[color];
            const hex = config.hex.startsWith('#') ? config.hex : '#' + config.hex;
            btn.style.backgroundColor = hex;
            btn.style.color = getContrastColor(hex);
            btn.style.borderColor = 'rgba(0,0,0,0.1)';
          }

          // Aplicar color si existe en posMetadata (v√≠a masterData logic)
          btn.onclick = () => {
            document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderTpvSizes(product, color);
          };
          colorCont.appendChild(btn);
        });

        modal.style.display = 'flex';

        // Si ven√≠a de un scan con color parcial
        if (scan && scan.color) {
          const btn = Array.from(colorCont.children).find(b => b.innerText === scan.color);
          if (btn) btn.click();
        }
      };

      function renderTpvSizes(product, color) {
        const sizeCont = document.getElementById('size-options');
        document.getElementById('size-container').style.display = 'block';
        sizeCont.innerHTML = '';

        const variants = product.variations.filter(v => v.color === color);
        variants.forEach(v => {
          const wrapper = document.createElement('div');
          wrapper.className = 'size-btn-wrapper';

          const varId = v.variation_id;
          const currentStock = (realStockCache.map && realStockCache.map[varId] !== undefined)
            ? realStockCache.map[varId]
            : 0;

          const btn = document.createElement('button');
          btn.className = `size-btn ${currentStock > 0 ? 'in-stock' : 'out-of-stock'}`;
          btn.innerText = v.size;

          if (currentStock <= 0) {
            btn.disabled = true;
            btn.style.opacity = '0.5';
            btn.style.cursor = 'not-allowed';
          } else {
            btn.onclick = () => {
              addTpvToCart(product, v);
              btn.style.transform = 'scale(0.95)';
              setTimeout(() => btn.style.transform = 'scale(1)', 100);
            };
          }

          const label = document.createElement('span');
          label.className = 'stock-label';
          label.innerText = `S: ${currentStock}`;

          wrapper.appendChild(btn);
          wrapper.appendChild(label);
          sizeCont.appendChild(wrapper);
        });
      }

      window.manualRefreshStock = function () {
        const btn = document.getElementById('tpv-manual-refresh');
        const oldText = btn.innerText;
        btn.innerText = "‚åõ ACTUALIZANDO...";
        btn.disabled = true;

        google.script.run
          .withSuccessHandler(data => {
            if (data.success) {
              realStockCache.map = data.stockMap;
              realStockCache.lastUpdate = new Date();
              console.log("‚úÖ Stock actualizado manualmente.");
              // Si el modal est√° abierto, refrescar talle
              const activeColorBtn = document.querySelector('.color-btn.active');
              if (activeColorBtn) {
                const modalTitle = document.getElementById('modal-product-title').innerText;
                const product = catalog.products.find(p => p.model === modalTitle);
                if (product) renderTpvSizes(product, activeColorBtn.innerText);
              }
            }
            btn.innerText = oldText;
            btn.disabled = false;
          })
          .withFailureHandler(() => {
            btn.innerText = oldText;
            btn.disabled = false;
          })
          .manualRefreshStockCache();
      };

      window.closeTpvModal = function () {
        document.getElementById('modal-variations').style.display = 'none';
      };

      window.filterTpvCat = function (catId, event) {
        document.querySelectorAll('.btn-cat-tpv').forEach(b => b.classList.remove('active'));
        if (event && event.target) event.target.classList.add('active');

        if (catId === 'ALL') {
          renderTpvProducts(catalog.products);
        } else {
          const filtered = catalog.products.filter(p => p.category_id === catId);
          renderTpvProducts(filtered);
        }
      };

      function addTpvToCart(product, variation) {
        const varId = variation.variation_id;
        const available = (realStockCache.map && realStockCache.map[varId] !== undefined) ? realStockCache.map[varId] : 0;

        const existing = cart.find(i => i.variation_id === varId);
        const currentInCart = existing ? existing.quantity : 0;

        if (currentInCart + 1 > available) {
          alert("No hay suficiente stock disponible (" + available + ")");
          return;
        }

        if (existing) {
          existing.quantity += 1;
        } else {
          cart.push({
            variation_id: varId,
            product_id: product.id,
            model: product.model,
            color: variation.color,
            size: variation.size,
            price: product.price,
            quantity: 1,
            categoryName: product.categoryName
          });
        }
        renderTpvCart();
        console.log("üõí A√±adido:", product.model, variation.color, variation.size);
      }

      function renderTpvCart() {
        const dt = $('#cart-table').DataTable();
        dt.clear();

        cart.forEach(function (item, index) {
          dt.row.add([
            "<div style='font-weight:600'>" + item.model + "</div>",
            item.color,
            item.size,
            "<input type='number' class='qty-input' value='" + item.quantity + "' onchange='updateTpvQty(" + index + ", this.value)'>",
            "$" + (item.price * item.quantity).toLocaleString(),
            "<button onclick='removeTpvItem(" + index + ")' style='color:#ef4444;background:none;border:none;cursor:pointer'><i class='ph-bold ph-trash'></i></button>"
          ]);
        });

        dt.draw();
        updateTpvTotals();
      }

      window.updateTpvQty = function (index, val) {
        const item = cart[index];
        const newQty = parseInt(val) || 1;
        const available = (realStockCache.map && realStockCache.map[item.variation_id] !== undefined) ? realStockCache.map[item.variation_id] : 0;

        if (newQty > available) {
          alert("Stock insuficiente. M√°ximo disponible: " + available);
          item.quantity = available;
        } else {
          item.quantity = newQty;
        }
        renderTpvCart();
      };

      window.updateTpvTotals = function () {
        if (!catalog || !posMetadata) return;

        var isQr = (posMetadata.storeConfig.saleMode || "").toUpperCase().trim() === "LECTOR QR";

        // A. C√°lculos Base
        const montoProductos = cart.reduce((acc, i) => acc + (i.price * i.quantity), 0);
        const totalUnits = cart.reduce((acc, i) => acc + i.quantity, 0);

        // B. Recargo Minorista
        let minorSurcharge = 0;
        const storeSurcharge = (posMetadata.storeConfig && posMetadata.storeConfig.minorSurcharge) ? posMetadata.storeConfig.minorSurcharge : 0;
        const noMinorSurchargeId = isQr ? 'qr-tpv-modal-deactivate-minor-surcharge' : 'tpv-modal-deactivate-minor-surcharge';
        const noMinorSurcharge = document.getElementById(noMinorSurchargeId)?.checked || false;

        if (totalUnits > 0 && totalUnits < selectedMinPurchase && !noMinorSurcharge) {
          if (storeSurcharge > 0) {
            minorSurcharge = storeSurcharge * totalUnits;
          } else {
            minorSurcharge = cart.reduce((acc, item) => {
              const product = catalog.products.find(p => p.id === item.product_id);
              const productSurcharge = (product && product.minor_surcharge) ? product.minor_surcharge : 0;
              return acc + (productSurcharge * item.quantity);
            }, 0);
          }
        }

        // C. Pago Mixto y Subtotal Neto (F√≥rmula AppSheet)
        const cashInputId = isQr ? 'qr-tpv-cash-amount' : 'tpv-cash-amount';
        const cashAmount = parseFloat(document.getElementById(cashInputId).value) || 0;
        const subtotalNeto = Math.max(0, montoProductos + minorSurcharge - cashAmount);

        // D. Recargo Medio de Pago (Sobre Subtotal Neto)
        const methodId = isQr ? 'qr-tpv-payment-method' : 'tpv-payment-method';
        const method = document.getElementById(methodId).value || 'Efectivo';
        const noPaymentSurchargeId = isQr ? 'qr-tpv-modal-deactivate-surcharge' : 'tpv-modal-deactivate-surcharge';
        const noPaymentSurcharge = document.getElementById(noPaymentSurchargeId)?.checked || false;
        let paymentSurcharge = 0;

        if (method !== 'Efectivo' && !noPaymentSurcharge) {
          const m = posMetadata.paymentMethods.find(pm => pm.id === method);
          const percent = m ? m.percent : 0;
          paymentSurcharge = subtotalNeto * percent;
        }

        const totalFinal = subtotalNeto + paymentSurcharge;

        // E. Sincronizaci√≥n UI - SIDEBAR
        document.getElementById('tpv-sidebar-subtotal').innerText = '$' + montoProductos.toLocaleString();

        // F. Sincronizaci√≥n UI - MODAL & QR PANEL
        if (isQr) {
          const qrPre = 'qr-';
          const qrPreModal = 'qr-tpv-modal-';

          document.getElementById(qrPreModal + 'total-products').innerText = '$' + montoProductos.toLocaleString();

          const modalMinorRow = document.getElementById(qrPreModal + 'minor-row');
          if (modalMinorRow) {
            modalMinorRow.style.display = minorSurcharge > 0 ? 'flex' : 'none';
            document.getElementById(qrPreModal + 'minor-surcharge').innerText = '+$' + minorSurcharge.toLocaleString();
          }

          const modalCashRow = document.getElementById(qrPreModal + 'cash-row');
          if (modalCashRow) {
            modalCashRow.style.display = cashAmount > 0 ? 'flex' : 'none';
            document.getElementById(qrPreModal + 'cash-discount').innerText = '-$' + cashAmount.toLocaleString();
          }

          document.getElementById(qrPreModal + 'subtotal').innerText = '$' + subtotalNeto.toLocaleString();

          const modalPayRow = document.getElementById(qrPreModal + 'payment-row');
          if (modalPayRow) {
            modalPayRow.style.display = paymentSurcharge > 0 ? 'flex' : 'none';
            document.getElementById('qr-pm-name').innerText = method;
            document.getElementById(qrPreModal + 'payment-surcharge').innerText = '+$' + Math.round(paymentSurcharge).toLocaleString();
          }
          document.getElementById(qrPreModal + 'final-total').innerText = '$' + Math.round(totalFinal).toLocaleString();
        } else if (document.getElementById('checkout-modal').style.display === 'flex') {
          document.getElementById('tpv-modal-total-products').innerText = '$' + montoProductos.toLocaleString();

          const modalMinorRow = document.getElementById('tpv-modal-minor-row');
          if (modalMinorRow) {
            modalMinorRow.style.display = minorSurcharge > 0 ? 'flex' : 'none';
            document.getElementById('tpv-modal-minor-surcharge').innerText = '+$' + minorSurcharge.toLocaleString();
          }

          const modalCashRow = document.getElementById('tpv-modal-cash-row');
          if (modalCashRow) {
            modalCashRow.style.display = cashAmount > 0 ? 'flex' : 'none';
            document.getElementById('tpv-modal-cash-discount').innerText = '-$' + cashAmount.toLocaleString();
          }

          document.getElementById('tpv-modal-subtotal').innerText = '$' + subtotalNeto.toLocaleString();

          const modalPayRow = document.getElementById('tpv-modal-payment-row');
          if (modalPayRow) {
            modalPayRow.style.display = paymentSurcharge > 0 ? 'flex' : 'none';
            document.getElementById('tpv-modal-payment-surcharge').innerText = '+$' + Math.round(paymentSurcharge).toLocaleString();
          }

          document.getElementById('tpv-modal-final-total').innerText = '$' + Math.round(totalFinal).toLocaleString();
        }
      };

      window.removeTpvItem = function (index) {
        cart.splice(index, 1);
        renderTpvCart();
      };

      window.processCheckoutSale = function () {
        var isQr = (posMetadata.storeConfig.saleMode || "").toUpperCase().trim() === "LECTOR QR";
        const pre = isQr ? 'qr-' : '';
        const preModal = isQr ? 'qr-tpv-modal-' : 'tpv-modal-';

        const confirmMsg = document.getElementById(preModal + 'final-total').innerText;
        if (!confirm("¬øConfirmar venta por " + confirmMsg + "?")) return;

        const subtotalProductos = cart.reduce((acc, i) => acc + (i.price * i.quantity), 0);
        const method = document.getElementById(pre + 'tpv-payment-method').value;
        const customerId = document.getElementById(pre + 'tpv-customer').value;
        const cashAmount = parseFloat(document.getElementById(pre + 'tpv-cash-amount').value) || 0;
        const transferAccountId = (method === 'Transferencia') ? document.getElementById(pre + 'tpv-transfer-account').value : '';

        // Recuperar c√°lculos finales ya procesados por updateTpvTotals
        const minorSurcharge = parseFloat(document.getElementById(preModal + 'minor-surcharge')?.innerText.replace('$', '').replace('+', '').replace('.', '').trim()) || 0;
        const paymentSurcharge = parseFloat(document.getElementById(preModal + 'payment-surcharge').innerText.replace('$', '').replace('+', '').replace('.', '').trim()) || 0;
        const finalTotal = parseFloat(document.getElementById(preModal + 'final-total').innerText.replace('$', '').replace('.', '').trim()) || 0;
        const subtotalNeto = parseFloat(document.getElementById(preModal + 'subtotal').innerText.replace('$', '').replace('.', '').trim()) || 0;

        // OBJETO DE VENTA
        var saleData = {
          saleId: "TPV-" + Date.now(),
          storeId: posMetadata.managedStoreId || "TIENDA_PRINCIPAL",
          userId: posMetadata.sellerId || "SISTEMA",
          customerId: customerId,
          cashRegisterId: posMetadata.activeCashRegisterId,
          isMixedPayment: cashAmount > 0,
          paymentMethod: method,
          transferAccountId: transferAccountId,
          deactivateSurcharge: document.getElementById(pre + 'tpv-modal-deactivate-surcharge').checked,
          totalProductAmount: subtotalProductos,
          cashPaymentAmount: cashAmount,
          subtotal: subtotalNeto,
          minorSurcharge: minorSurcharge,
          transferSurcharge: paymentSurcharge,
          totalAmount: Math.round(finalTotal),
          minimumPurchaseAmount: selectedMinPurchase,
          cart: [].concat(cart),
          timestamp: new Date().toISOString()
        };

        // PERSISTENCIA
        saveToLocalQueue(saleData);

        // IMPRESI√ìN OPTIMISTA
        try {
          var printData = generateTicketLocal(saleData);
          sendToTpvPrinter(printData);
        } catch (e) {
          console.warn("Fallo impresion:", e);
        }

        // LIMPIEZA
        closeCheckoutModal();
        finishTpvSale(false);
        syncLocalQueue();
      };

      function generateTicketLocal(sale) {
        if (!catalog || !catalog.stores) throw new Error("Cat√°logo no disponible para impresi√≥n");
        const store = catalog.stores[sale.storeId] || { name: "SHOP", address: "", phone: "" };
        const settings = posMetadata.printSettings || { copias: 1, sonido: "0", marketing: "" };

        let t = "";
        t += "^^" + store.name.toUpperCase() + "\n";
        t += (store.address || "") + "\n";
        t += "Telefono: " + (store.phone || "") + "\n";
        t += "--------------------------------\n";
        t += "Codigo de Venta: " + sale.saleId + "\n";

        const now = new Date();
        const d = now.toLocaleDateString('es-AR');
        const h = now.toLocaleTimeString('es-AR', { hour12: false });
        t += "Fecha y Hora: " + d + " " + h + "\n";
        t += "Cliente: CLIENTE GENERAL\n";
        t += "--------------------------------\n";

        sale.cart.forEach(function (item) {
          t += item.quantity + " x " + item.product_id + " " + item.color + " " + item.size + " $" + (item.price * item.quantity).toLocaleString() + "\n";
        });
        t += "\n";

        if (sale.isMixedPayment) {
          t += "--------------------------------\n";
          t += "*** PAGO MIXTO ***\n";
          t += "::Monto Productos: " + sale.totalProductAmount.toLocaleString() + "\n";
          if (sale.minorSurcharge > 0) t += "::Recargo Minorista: +" + sale.minorSurcharge.toLocaleString() + "\n";
          t += "::Pago Efectivo: -" + sale.cashPaymentAmount.toLocaleString() + "\n";
          t += "--------------------------------\n";
          t += "::Subtotal: " + sale.subtotal.toLocaleString() + "\n";
          if (sale.transferSurcharge > 0) t += "::Recargo " + sale.paymentMethod + ": +" + Math.round(sale.transferSurcharge).toLocaleString() + "\n";
          t += "--------------------------------\n";
          t += "::RESTANTE A PAGAR:\n";
          t += "^^::" + sale.totalAmount.toLocaleString() + "\n";
        } else {
          t += "--------------------------------\n";
          t += "::Monto Productos: " + sale.totalProductAmount.toLocaleString() + "\n";
          if (sale.minorSurcharge > 0) t += "::Recargo Minorista: +" + sale.minorSurcharge.toLocaleString() + "\n";
          t += "--------------------------------\n";
          t += "::Subtotal: " + sale.subtotal.toLocaleString() + "\n";
          if (sale.transferSurcharge > 0) t += "::Recargo " + sale.paymentMethod + ": +" + Math.round(sale.transferSurcharge).toLocaleString() + "\n";
          t += "\n";
          t += "::TOTAL A PAGAR:\n";
          t += "^^::" + sale.totalAmount.toLocaleString() + "\n";
        }

        t += "--------------------------------\n";
        t += "Pago: " + sale.paymentMethod + "\n";

        // Datos transferencia si aplica
        if (sale.paymentMethod === "Transferencia" && sale.transferAccountId) {
          if (posMetadata.transferAccounts) {
            const acc = posMetadata.transferAccounts.find(a => String(a.id) === String(sale.transferAccountId));
            if (acc) t += "Alias: " + (acc.alias || "") + "\n";
          }
        }

        t += "\n     GRACIAS POR SU COMPRA      ";

        return {
          printer_ip: posMetadata.printerIp || "127.0.0.1",
          venta_id: sale.saleId,
          qr_info: store.qrData || "",
          copias: settings.copias || 1,
          sonido: settings.sonido || "0",
          abrir_caja: (sale.paymentMethod === "Efectivo" || sale.isMixedPayment) ? "1" : "0",
          marketing: (sale.totalAmount >= (settings.minCupon || 0)) ? (settings.marketing || "") : "",
          texto_ticket: t
        };
      }

      function saveToLocalQueue(sale) {
        const queue = JSON.parse(localStorage.getItem('tpv_offline_queue') || "[]");
        queue.push(sale);
        localStorage.setItem('tpv_offline_queue', JSON.stringify(queue));
        updateSyncUI();
      }

      function updateSyncUI() {
        const queue = JSON.parse(localStorage.getItem('tpv_offline_queue') || "[]");
        const el = document.getElementById('tpv-sync-status');
        const countEl = document.getElementById('sync-pending-count');
        if (queue.length > 0) {
          el.style.display = 'block';
          countEl.innerText = queue.length;
        } else {
          el.style.display = 'none';
        }
      }

      let isSyncing = false;
      async function syncLocalQueue() {
        if (isSyncing) return;
        const queue = JSON.parse(localStorage.getItem('tpv_offline_queue') || "[]");
        if (queue.length === 0) return;

        isSyncing = true;
        console.log("üîÑ Tentativa de sincronizaci√≥n de", queue.length, "ventas...");

        const currentSale = queue[0];

        google.script.run
          .withSuccessHandler(res => {
            isSyncing = false;
            if (res.success) {
              console.log("‚úÖ Venta sincronizada:", currentSale.saleId);
              const newQueue = JSON.parse(localStorage.getItem('tpv_offline_queue') || "[]");
              newQueue.shift(); // Eliminar la procesada
              localStorage.setItem('tpv_offline_queue', JSON.stringify(newQueue));

              if (res.updatesMap) {
                Object.assign(realStockCache.map, res.updatesMap);
              }

              updateSyncUI();
              if (newQueue.length > 0) setTimeout(syncLocalQueue, 1000);
            } else {
              console.warn("Fallo sincronizacion servidor:", res.message);
            }
          })
          .withFailureHandler(err => {
            isSyncing = false;
            console.warn("‚ö†Ô∏è Fallo de red detectado, venta permanece en cola.");
          })
          .processSale(currentSale);
      }

      function initSyncWorker() {
        updateSyncUI();
        setInterval(syncLocalQueue, 30000); // Cada 30 seg
      }

      // Se elimin√≥ handleTpvPrinting por redundancia

      async function sendToTpvPrinter(p) {
        console.log("üåê [Printer] Enviando comando a:", p.printer_ip);

        const params = new URLSearchParams({
          id: p.venta_id,
          texto: p.texto_ticket,
          qr: p.qr_info,
          copias: p.copias,
          sonido: p.sonido,
          caja: p.abrir_caja,
          extra: p.marketing
        });

        const url = "http://" + p.printer_ip + ":8000/print_ticket?" + params.toString();

        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(function () { controller.abort(); }, 5000);

          await fetch(url, {
            mode: 'no-cors',
            cache: 'no-cache',
            signal: controller.signal
          });

          clearTimeout(timeoutId);
          console.log("‚úÖ [Printer] Comando enviado");
        } catch (e) {
          console.warn("‚ùå [Printer] Fallo al enviar ticket:", e.message);
          google.script.run.logErrorFromFrontend("Fallo impresion TPV: " + e.message);
        }
      }

      function getContrastColor(hexcolor) {
        if (!hexcolor) return "#000000";
        var hex = hexcolor.replace("#", "");
        var r = parseInt(hex.substr(0, 2), 16);
        var g = parseInt(hex.substr(2, 2), 16);
        var b = parseInt(hex.substr(4, 2), 16);
        var yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
        return (yiq >= 128) ? '#000000' : '#ffffff';
      }

      function finishTpvSale(showAlert = true) {
        if (showAlert) alert("¬°Venta completada!");
        cart = [];

        // Resetear campos del modal
        const payMethod = document.getElementById('tpv-payment-method');
        if (payMethod) payMethod.value = "Efectivo";

        const cashAmount = document.getElementById('tpv-cash-amount');
        if (cashAmount) cashAmount.value = "";

        const noSurcharge = document.getElementById('tpv-modal-deactivate-surcharge');
        if (noSurcharge) noSurcharge.checked = false;

        renderTpvCart();
        hideTpvLoader();
      }
    } catch (e) {
      console.error("TPV_Fail_Critical:", e);
    }
  })();
</script>