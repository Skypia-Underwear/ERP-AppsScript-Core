{
    "content": "<?php\n/**\n * API Receptora de Imgenes desde Google Apps Script.\n * VERSIN 2.3 - Aade soporte para PORTADA (set_post_thumbnail) y mantiene la lgica de duplicados.\n */\n\ndefine('WP_USE_THEMES', false);\nrequire_once(__DIR__ . '/wp-load.php');\n\n$clave_secreta_definida = 'CASTFER2025';\n\n// --- VALIDACIN DE MTODO Y CLAVE ---\nif ($_SERVER['REQUEST_METHOD'] !== 'POST') {\n    http_response_code(405);\n    die(json_encode(['status' => 'error', 'message' => 'Solo se aceptan peticiones POST.']));\n}\n\n$api_key = $_POST['apiKey'] ?? '';\nif ($api_key !== $clave_secreta_definida) {\n    http_response_code(403);\n    die(json_encode(['status' => 'error', 'message' => 'Clave API no vlida.']));\n}\n\n// --- PARMETROS PRINCIPALES ---\n$sku        = isset($_POST['sku']) ? sanitize_file_name($_POST['sku']) : null;\n$fileName   = isset($_POST['fileName']) ? sanitize_file_name($_POST['fileName']) : null;\n$imageData  = $_POST['imageData'] ?? null;\n$is_cover   = isset($_POST['is_cover']) && $_POST['is_cover'] === 'true'; // NUEVO CAMPO\n\nif (!$sku || !$fileName || !$imageData) {\n    http_response_code(400);\n    die(json_encode(['status' => 'error', 'message' => 'Faltan datos (sku, fileName o imageData).']));\n}\n\n// --- RUTAS Y ARCHIVOS ---\n$upload_dir_info = wp_upload_dir();\n$base_path = $upload_dir_info['basedir'] . '/productos/';\n$sku_path = $base_path . $sku . '/';\n$file_path = $sku_path . $fileName;\n\n// === 1. Crear carpeta si no existe ===\nif (!file_exists($sku_path)) {\n    if (!wp_mkdir_p($sku_path)) {\n        http_response_code(500);\n        die(json_encode(['status' => 'error', 'message' => 'No se pudo crear la carpeta del SKU: ' . $sku]));\n    }\n}\n\n// === 2. Evitar duplicado ===\nif (file_exists($file_path)) {\n    http_response_code(200);\n    $product_url = obtener_url_producto_por_sku($sku);\n    die(json_encode([\n        'status' => 'skip',\n        'message' => \"La imagen '$fileName' ya existe. Se omite subida.\",\n        'product_url' => $product_url\n    ]));\n}\n\n// === 3. Guardar el archivo en la carpeta del producto ===\n$decoded_image = base64_decode($imageData);\nif ($decoded_image === false) {\n    http_response_code(400);\n    die(json_encode(['status' => 'error', 'message' => 'Los datos no son Base64 vlidos.']));\n}\n\nif (file_put_contents($file_path, $decoded_image) === false) {\n    http_response_code(500);\n    die(json_encode(['status' => 'error', 'message' => 'Error al guardar la imagen local.']));\n}\n\n// === 4. Registrar el archivo en la biblioteca de medios de WordPress ===\n$file_url = $upload_dir_info['baseurl'] . '/productos/' . $sku . '/' . $fileName;\n\nrequire_once(ABSPATH . 'wp-admin/includes/image.php');\nrequire_once(ABSPATH . 'wp-admin/includes/file.php');\nrequire_once(ABSPATH . 'wp-admin/includes/media.php');\n\n$attachment = [\n    'guid'           => $file_url,\n    'post_mime_type' => mime_content_type($file_path),\n    'post_title'     => preg_replace('/\\.[^.]+$/', '', basename($fileName)),\n    'post_content'   => '',\n    'post_status'    => 'inherit'\n];\n\n$attachment_id = wp_insert_attachment($attachment, $file_path);\nif (!is_wp_error($attachment_id)) {\n    $attach_data = wp_generate_attachment_metadata($attachment_id, $file_path);\n    wp_update_attachment_metadata($attachment_id, $attach_data);\n}\n\n// === 5. Asociar imagen al producto ===\n$product_id = wc_get_product_id_by_sku($sku);\nif ($product_id && !is_wp_error($attachment_id)) {\n\n    // Si la imagen es portada, definir como destacada\n    if ($is_cover) {\n        set_post_thumbnail($product_id, $attachment_id);\n        error_log(\"? Imagen marcada como PORTADA para SKU {$sku}: {$fileName}\");\n    } else {\n        // Si no es portada, agregarla a la galera sin duplicar\n        $gallery = get_post_meta($product_id, '_product_image_gallery', true);\n        $gallery_ids = $gallery ? explode(',', $gallery) : [];\n        if (!in_array($attachment_id, $gallery_ids)) {\n            $gallery_ids[] = $attachment_id;\n            update_post_meta($product_id, '_product_image_gallery', implode(',', $gallery_ids));\n        }\n    }\n}\n\n// === 6. Retornar URL del producto ===\n$product_url = obtener_url_producto_por_sku($sku);\n\nhttp_response_code(200);\necho json_encode([\n    'status' => 'success',\n    'message' => \"Imagen '$fileName' subida exitosamente.\",\n    'product_url' => $product_url,\n    'is_cover' => $is_cover\n]);\n\n/**\n * Funcin auxiliar: busca la URL del producto por su SKU (slug o campo personalizado).\n */\nfunction obtener_url_producto_por_sku($sku) {\n    if (!function_exists('wc_get_product_id_by_sku')) {\n        return null;\n    }\n\n    $product_id = wc_get_product_id_by_sku($sku);\n    if ($product_id) {\n        return get_permalink($product_id);\n    }\n\n    // Si no se encuentra por SKU, intentar buscar por slug\n    $producto = get_page_by_path($sku, OBJECT, 'product');\n    if ($producto) {\n        return get_permalink($producto->ID);\n    }\n\n    return null;\n}\n?>"
}