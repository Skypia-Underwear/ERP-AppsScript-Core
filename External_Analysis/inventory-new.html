<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Inventario ERP</title>

    <!-- =================================================================
         INICIO DE _shared_assets.html (Incrustado para la vista previa) 
         ================================================================= -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: { main: '#0f172a', secondary: '#1e293b', accent: '#6366f1' }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --bg-main: #0f172a;
            --bg-secondary: #1e293b;
            --accent: #6366f1;
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
    </style>
    <!-- =================================================================
         FIN DE _shared_assets.html 
         ================================================================= -->

    <!-- DataTables -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link href="https://cdn.datatables.net/v/dt/dt-2.0.3/rg-1.5.0/datatables.min.css" rel="stylesheet">
    <script src="https://cdn.datatables.net/v/dt/dt-2.0.3/rg-1.5.0/datatables.min.js"></script>

    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-main);
            color: #e2e8f0;
        }

        /* Tema DataTables Premium ERP */
        .dataTables_wrapper {
            color: #cbd5e1 !important;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        table.dataTable {
            border-collapse: collapse !important;
            width: 100% !important;
            font-size: 0.85rem;
            margin-top: 0 !important;
            margin-bottom: 0 !important;
        }

        table.dataTable thead th {
            border-bottom: 1px solid #334155 !important;
            background-color: var(--bg-main) !important;
            color: #94a3b8 !important;
            text-transform: uppercase;
            font-size: 0.65rem;
            letter-spacing: 0.05em;
            padding: 12px 16px;
            border-top: none !important;
        }

        table.dataTable tbody tr {
            background-color: var(--bg-secondary) !important;
            border-bottom: 1px solid rgba(51, 65, 85, 0.5) !important;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        table.dataTable tbody tr:hover {
            background-color: #334155 !important;
        }

        table.dataTable tbody tr.selected {
            background-color: rgba(99, 102, 241, 0.1) !important;
            border-left: 3px solid var(--accent) !important;
        }

        /* Agrupador de DataTables (RowGroup) */
        table.dataTable tr.dtrg-group td {
            background-color: var(--bg-main) !important;
            color: #e2e8f0 !important;
            font-weight: 600 !important;
            font-size: 0.85rem !important;
            padding: 10px 16px !important;
            border-bottom: 1px solid #334155 !important;
            border-top: 1px solid #334155 !important;
        }

        .dt-info {
            color: #94a3b8 !important;
            font-size: 0.8rem;
        }

        .dt-paging {
            padding-top: 0.5rem;
        }

        .dt-paging button {
            color: #cbd5e1 !important;
            border-radius: 0.5rem !important;
            padding: 0.3rem 0.6rem !important;
            margin: 0 2px;
        }

        .dt-paging button:hover,
        .dt-paging button.current {
            background: #334155 !important;
            border-color: transparent !important;
            color: #fff !important;
        }

        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Estilos Tarjetas Categor칤as y Productos */
        .category-card {
            transition: all 0.2s ease;
        }

        .category-card.active {
            border-color: var(--accent) !important;
            background-color: rgba(99, 102, 241, 0.1);
            color: #fff;
            box-shadow: inset 0 0 10px rgba(99, 102, 241, 0.2);
        }

        .category-svg-container svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0px 2px 4px rgba(0, 0, 0, 0.4));
            transition: transform 0.2s ease;
        }

        .category-card:hover .category-svg-container svg {
            transform: scale(1.1);
        }

        .product-card {
            transition: all 0.2s ease;
        }

        .product-card.active {
            border-color: var(--accent);
            background-color: rgba(99, 102, 241, 0.1);
            box-shadow: inset 0 0 0 1px var(--accent);
        }

        /* Ocultar definitivamente controles nativos de DataTables que se ven en la captura */
        .dt-layout-row:first-child,
        .dataTables_length,
        .dataTables_filter,
        .dt-length,
        .dt-search {
            display: none !important;
        }

        /* Terminal Logs */
        #console-output {
            background-color: rgba(2, 6, 23, 0.5);
            font-family: 'Consolas', monospace;
            font-size: 0.75rem;
            line-height: 1.6;
        }

        .log-line {
            border-bottom: 1px solid rgba(30, 41, 59, 0.5);
            padding: 6px 0;
        }

        .log-error {
            color: #f87171;
        }

        .log-success {
            color: #4ade80;
        }

        .log-info {
            color: #60a5fa;
        }

        .custom-scroll::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 3px;
        }
    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden text-slate-200 relative">

    <!-- ==========================================
         1. HEADER & BUSCADOR GLOBAL (Potenciado)
         ========================================== -->
    <header class="border-b border-slate-800 px-6 py-3 flex justify-between items-center flex-shrink-0 z-20"
        style="background-color: var(--bg-secondary);">

        <!-- Logo y Status (Izquierda) -->
        <div class="flex items-center gap-4 w-1/4">
            <div class="p-2 rounded-lg text-white flex items-center justify-center"
                style="background-color: var(--accent); box-shadow: 0 4px 14px 0 rgba(99, 102, 241, 0.39);">
                <i class="ph-bold ph-stack text-xl"></i>
            </div>
            <div class="hidden md:block">
                <h1 class="text-base font-bold text-white tracking-wide whitespace-nowrap">ERP Dashboard</h1>
                <p class="text-[10px] text-slate-400 flex items-center gap-1">
                    <span class="relative flex h-1.5 w-1.5"><span
                            class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span><span
                            class="relative inline-flex rounded-full h-1.5 w-1.5 bg-emerald-500"></span></span>
                    <span id="last-sync-label">Sincronizando con GitHub...</span>
                </p>
            </div>
        </div>

        <!-- Buscador Central -->
        <div class="flex-grow max-w-2xl mx-4">
            <div
                class="bg-slate-900 rounded-xl border border-slate-700 p-1.5 flex items-center shadow-inner focus-within:border-[var(--accent)] transition-colors">
                <i class="ph-bold ph-magnifying-glass text-slate-500 ml-3 text-lg"></i>
                <input type="text" id="custom-sku-search"
                    placeholder="Buscar categor칤a, producto, temporada, material o c칩digo..."
                    class="w-full bg-transparent border-none text-white px-3 py-1 outline-none text-sm font-medium placeholder-slate-500">
                <div
                    class="px-2 py-0.5 bg-slate-800 rounded border border-slate-600 text-[10px] text-slate-400 font-mono mr-1 hidden sm:block shadow-sm">
                    Ctrl+K</div>
            </div>
        </div>

        <!-- Acciones Mantenimiento (Derecha) -->
        <div class="flex items-center justify-end gap-2 w-auto min-w-[25%]">

            <!-- Bot칩n de Sincronizaci칩n Contextual de Producto (Oculto inicialmente) -->
            <button id="btn-sync-product" onclick="runProductAudit()" title="Sincronizar Producto Seleccionado"
                class="hidden p-2 border border-blue-500/50 hover:bg-blue-600 text-blue-400 hover:text-white rounded-lg transition bg-blue-900/20 shadow-[0_0_10px_rgba(59,130,246,0.2)] flex items-center gap-2">
                <i class="ph-bold ph-arrows-clockwise text-lg"></i>
                <span class="text-xs font-bold hidden xl:block">Sincronizar</span>
            </button>
            <div id="divider-sync" class="hidden w-px h-6 bg-slate-700 mx-1"></div>

            <!-- Auditor칤a Global (Proceso Pesado) -->
            <button onclick="runGlobalAudit()" title="Auditor칤a Global (Peligro: Proceso Pesado)"
                class="p-2 border border-red-500/50 hover:bg-red-600 text-red-400 hover:text-white rounded-lg transition bg-red-900/20 shadow-[0_0_10px_rgba(239,68,68,0.1)]">
                <i class="ph-bold ph-globe-hemisphere-east text-lg"></i>
            </button>

            <!-- Modal Bartender -->
            <button onclick="runBartender()" title="Generar Etiquetas Bartender"
                class="p-2 border border-slate-700 hover:bg-slate-700 text-slate-300 rounded-lg transition bg-slate-800">
                <i class="ph-bold ph-barcode text-lg text-purple-400"></i>
            </button>

            <div class="w-px h-6 bg-slate-700 mx-1"></div>

            <button onclick="toggleLogs()" id="btn-toggle-logs"
                class="px-3 py-1.5 border border-slate-700 hover:bg-slate-700 text-slate-300 text-xs font-medium rounded-lg transition flex items-center gap-2 bg-slate-800">
                <i class="ph-bold ph-terminal-window"></i> <span class="hidden xl:block">Logs</span>
            </button>
        </div>
    </header>

    <!-- ==========================================
         2. ESPACIO DE TRABAJO PRINCIPAL
         ========================================== -->
    <div class="flex-grow flex overflow-hidden p-4 gap-4">

        <!-- ==========================================
             PANEL IZQUIERDO: Carruseles y Cat치logo (60%)
             ========================================== -->
        <div class="w-3/5 flex flex-col rounded-xl border border-slate-700 shadow-xl overflow-hidden relative"
            style="background-color: var(--bg-secondary);">

            <!-- 2.1 HEADER DE CATEGOR칈AS (Horizontal) -->
            <div class="flex flex-col border-b border-slate-700 bg-slate-900/50 z-10 flex-shrink-0">
                <div class="px-5 py-2.5 flex justify-between items-center border-b border-slate-800/50">
                    <h3 class="font-bold text-white text-sm flex items-center gap-2 uppercase tracking-wide">
                        <i class="ph-fill ph-squares-four text-blue-400"></i> Filtros de Cat치logo
                    </h3>
                </div>

                <div class="px-4 py-2 flex items-center gap-2">
                    <button
                        onclick="document.getElementById('category-carousel').scrollBy({left:-200, behavior:'smooth'})"
                        class="p-1.5 bg-slate-800 hover:bg-slate-700 rounded-lg border border-slate-600 text-slate-400 transition hidden md:block">
                        <i class="ph-bold ph-caret-left"></i>
                    </button>

                    <div id="category-carousel"
                        class="flex-grow overflow-x-auto no-scrollbar flex gap-3 snap-x scroll-smooth">
                        <p class="text-xs text-slate-500 italic p-2">Cargando categor칤as...</p>
                    </div>

                    <button
                        onclick="document.getElementById('category-carousel').scrollBy({left:200, behavior:'smooth'})"
                        class="p-1.5 bg-slate-800 hover:bg-slate-700 rounded-lg border border-slate-600 text-slate-400 transition hidden md:block">
                        <i class="ph-bold ph-caret-right"></i>
                    </button>
                </div>
            </div>

            <!-- 2.2 츼REA DE DATOS (Split Productos Vertical y Tabla) -->
            <div class="flex-grow flex overflow-hidden">

                <!-- Columna Izquierda: Grid de Productos (Vertical) -->
                <div class="w-[110px] flex-shrink-0 border-r border-slate-700/80 bg-slate-900/20 flex flex-col z-0">
                    <div class="p-2 border-b border-slate-700/50 flex justify-center items-center bg-slate-800/50">
                        <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Modelos</span>
                    </div>
                    <div id="product-carousel" class="flex-grow overflow-y-auto custom-scroll p-2 flex flex-col gap-2">
                        <p class="text-[10px] text-slate-500 italic text-center py-4">Cargando productos...</p>
                    </div>
                </div>

                <!-- Columna Derecha: Tabla y KPIs -->
                <div class="flex-grow flex flex-col overflow-hidden bg-slate-800/10">

                    <!-- Fila de Filtros de Tienda y KPIs Integrada sobre la tabla -->
                    <div
                        class="p-3 border-b border-slate-700/50 bg-slate-800/30 flex justify-between items-center flex-shrink-0">

                        <div class="flex items-center gap-3">
                            <span class="text-[10px] font-bold text-slate-400 uppercase flex items-center gap-2">
                                <i class="ph-fill ph-table text-blue-400 text-sm"></i> Detalles
                            </span>

                            <!-- Botones P칤ldora para Filtrar Tienda en Tabla -->
                            <div class="flex gap-1 bg-slate-900 rounded-lg p-1 border border-slate-700 overflow-x-auto no-scrollbar"
                                id="table-store-filters">
                                <button
                                    class="store-filter-btn active px-3 py-1 text-[10px] font-bold rounded-md transition-colors bg-slate-700 text-white shadow-sm"
                                    data-store="">Todas</button>
                                <!-- Se inyectan din치micamente -->
                            </div>
                        </div>

                        <div class="flex gap-4">
                            <div class="flex items-center gap-2">
                                <span class="text-[9px] text-slate-500 uppercase font-bold">Variaciones:</span>
                                <span
                                    class="text-[11px] font-black text-white bg-slate-700 px-2 py-0.5 rounded shadow-sm"
                                    id="kpi-variations">0</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-[9px] text-red-500 uppercase font-bold">Agotados:</span>
                                <span
                                    class="text-[11px] font-black text-red-400 bg-red-500/10 border border-red-500/20 px-2 py-0.5 rounded shadow-sm"
                                    id="kpi-alerts">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla de Cat치logo -->
                    <div class="flex-grow p-4 overflow-auto custom-scroll">
                        <table id="catalogTable" class="w-full text-left">
                            <thead>
                                <tr>
                                    <!-- 8 Columnas Ocultas para B칰squeda Robusta -->
                                    <th>Cat</th>
                                    <th>SKU</th>
                                    <th>Store</th>
                                    <th>Brand</th>
                                    <th>Season</th>
                                    <th>Gender</th>
                                    <th>Style</th>
                                    <th>Material</th>

                                    <!-- Columnas Visibles -->
                                    <th>Variaci칩n</th>
                                    <th>Entradas</th>
                                    <th>Salidas</th>
                                    <th>V. Web</th>
                                    <th>V. Local</th>
                                    <th>Stock</th>
                                </tr>
                            </thead>
                            <tbody><!-- Renderizado Din치mico --></tbody>
                        </table>
                    </div>

                </div>
            </div>
        </div>

        <!-- ==========================================
             PANEL DERECHO: Matriz de Edici칩n (40%)
             ========================================== -->
        <div class="w-2/5 flex flex-col gap-4">

            <div class="flex-grow flex flex-col rounded-xl border border-slate-700 shadow-xl overflow-hidden relative"
                style="background-color: var(--bg-secondary);">

                <!-- Header de la Matriz & Tienda -->
                <div class="px-5 py-4 border-b border-slate-700/60 flex flex-col gap-4 z-10 bg-slate-900/30">

                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <h3 class="font-bold text-white text-sm flex items-center gap-2 uppercase tracking-wide">
                                <i class="ph-fill ph-grid-four text-emerald-400"></i> Matriz de Stock
                            </h3>
                            <span id="active-sku-badge"
                                class="hidden text-[10px] px-2 py-0.5 rounded text-white font-mono font-bold shadow-sm"
                                style="background-color: var(--accent);"></span>
                        </div>
                        <button id="btn-save-matrix" onclick="saveMatrixChanges()"
                            class="px-4 py-2 text-white text-xs rounded-lg font-bold transition shadow-lg flex items-center gap-2 opacity-50 cursor-not-allowed"
                            style="background-color: var(--accent);" disabled>
                            <i class="ph-bold ph-floppy-disk text-sm"></i> Guardar Cambios
                        </button>
                    </div>

                    <!-- Filtro Multitienda Matriz -->
                    <div
                        class="flex items-center gap-2 bg-slate-800 border border-slate-700 px-4 py-2.5 rounded-xl w-full focus-within:border-[var(--accent)] transition-colors shadow-inner">
                        <i class="ph-fill ph-storefront text-slate-400 text-lg"></i>
                        <select id="filter-store" onchange="refreshMatrixFromStore()"
                            class="bg-transparent text-sm text-white outline-none cursor-pointer font-medium flex-grow">
                            <option value="ALL">游끽 Todas (Modo Consolidado / Solo Lectura)</option>
                            <!-- Llenado din치mico -->
                        </select>
                    </div>
                </div>

                <!-- Contenedor Matriz -->
                <div class="flex-grow p-4 overflow-auto custom-scroll relative" id="matrix-container">
                    <!-- Estado Vac칤o -->
                    <div id="matrix-empty-state"
                        class="absolute inset-0 flex flex-col items-center justify-center text-slate-500 space-y-4 animate-fade-in">
                        <div class="p-6 rounded-full border border-slate-700/50"
                            style="background-color: var(--bg-main);">
                            <i class="ph-thin ph-hand-tap text-5xl text-slate-400"></i>
                        </div>
                        <p class="text-sm font-medium tracking-wide text-center px-6">Selecciona una tarjeta de producto
                            o fila en la tabla<br>para visualizar o editar la matriz.</p>
                    </div>

                    <div id="matrix-content" class="hidden w-full animate-fade-in"></div>
                </div>
            </div>

        </div>
    </div>

    <!-- ==========================================
         3. MODAL BARTENDER EN DOS PASOS
         ========================================== -->
    <div id="bartender-modal"
        class="fixed inset-0 bg-slate-950/80 z-[100] hidden flex-col items-center justify-center backdrop-blur-sm p-4">
        <div
            class="bg-slate-800 rounded-xl border border-slate-700 w-full max-w-5xl max-h-[90vh] flex flex-col shadow-2xl overflow-hidden animate-fade-in">
            <!-- Header -->
            <div class="px-6 py-4 border-b border-slate-700 bg-slate-900/50 flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-bold text-white flex items-center gap-2">
                        <i class="ph-bold ph-barcode text-purple-400"></i> Generador Bartender CSV
                    </h2>
                    <p class="text-slate-400 text-xs" id="bartender-modal-subtitle">Paso 1: Configura los par치metros de
                        extracci칩n.</p>
                </div>
                <button onclick="closeModal()"
                    class="p-2 hover:bg-slate-700 rounded-full transition text-slate-400 hover:text-white">
                    <i class="ph-bold ph-x text-xl"></i>
                </button>
            </div>

            <!-- Body: Step 1 (Setup de extracci칩n) -->
            <div id="bartender-setup-container" class="p-6 flex flex-col gap-6 bg-slate-800">
                <div class="bg-slate-900/50 border border-slate-700 p-5 rounded-xl shadow-inner">
                    <h3 class="text-sm font-bold text-white mb-4 flex items-center gap-2">
                        <i class="ph-bold ph-funnel text-blue-400"></i> Selecciona el origen de los datos
                    </h3>
                    <div class="flex flex-col gap-4">
                        <label
                            class="flex items-center gap-3 text-sm text-slate-300 cursor-pointer p-2 hover:bg-slate-800 rounded-lg transition-colors border border-transparent hover:border-slate-700">
                            <input type="radio" name="bt_source" value="selected" id="bt_source_selected"
                                class="w-4 h-4 accent-purple-500">
                            <span>Solo el producto seleccionado: <span id="bt-selected-sku-label"
                                    class="font-mono text-blue-400 font-bold bg-slate-900 px-2 py-0.5 rounded border border-slate-700 shadow-sm">Ninguno</span></span>
                        </label>
                        <label
                            class="flex items-center gap-3 text-sm text-slate-300 cursor-pointer p-2 hover:bg-slate-800 rounded-lg transition-colors border border-transparent hover:border-slate-700">
                            <input type="radio" name="bt_source" value="filtered" id="bt_source_filtered"
                                class="w-4 h-4 accent-purple-500" checked>
                            <span>Productos visibles en la tabla (Aplica filtro y buscador actual)</span>
                        </label>
                        <label
                            class="flex items-center gap-3 text-sm text-slate-300 cursor-pointer p-2 hover:bg-slate-800 rounded-lg transition-colors border border-transparent hover:border-slate-700">
                            <input type="radio" name="bt_source" value="all" id="bt_source_all"
                                class="w-4 h-4 accent-purple-500">
                            <span>Todo el cat치logo completo (Atenci칩n: Proceso Pesado)</span>
                        </label>
                    </div>
                </div>
                <div class="flex justify-end">
                    <button onclick="processBartenderData()"
                        class="px-6 py-2.5 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-500 transition shadow-lg shadow-blue-500/30 flex items-center gap-2">
                        <i class="ph-bold ph-gear"></i> Extraer y Generar Tabla
                    </button>
                </div>
            </div>

            <!-- Body: Step 2 (Table Container de edici칩n) -->
            <div id="bartender-table-container"
                class="hidden flex-grow overflow-auto p-4 custom-scroll bg-slate-900/30 text-sm relative">
                <!-- Se inyecta la tabla o el loader din치micamente -->
            </div>

            <!-- Footer final (Oculto durante el Step 1) -->
            <div id="bartender-footer"
                class="hidden px-6 py-4 border-t border-slate-700 bg-slate-900/50 flex justify-end items-center gap-3">
                <button onclick="closeModal()"
                    class="px-6 py-2 bg-slate-700 text-white rounded-lg font-medium hover:bg-slate-600 transition">
                    Descartar
                </button>
                <button onclick="downloadBartenderCSV()"
                    class="px-6 py-2 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-500 transition shadow-lg shadow-purple-500/30 flex items-center gap-2">
                    <i class="ph-bold ph-cloud-arrow-up text-lg"></i> Procesar y Actualizar BD
                </button>
            </div>
        </div>
    </div>

    <!-- TERMINAL DE LOGS -->
    <div id="logs-panel"
        class="fixed bottom-0 left-0 right-0 h-48 border-t border-slate-700 shadow-[0_-10px_40px_rgba(0,0,0,0.5)] transform translate-y-full transition-transform duration-300 z-50 flex flex-col"
        style="background-color: var(--bg-secondary);">
        <div class="px-4 py-2 border-b border-slate-800 flex justify-between items-center"
            style="background-color: var(--bg-main);">
            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">
                <i class="ph-bold ph-terminal-window"></i> Terminal de Sistema
            </span>
            <div class="flex gap-4">
                <button onclick="clearConsole()"
                    class="text-[10px] font-medium text-slate-500 hover:text-white transition">Limpiar</button>
                <button onclick="toggleLogs()"
                    class="text-[10px] font-medium text-slate-500 hover:text-white transition"><i
                        class="ph-bold ph-x text-sm"></i></button>
            </div>
        </div>
        <div id="console-output" class="p-4 flex-grow custom-scroll overflow-y-auto">
            <p class="text-slate-600 italic font-medium">Esperando instrucciones...</p>
        </div>
    </div>

    <script>
        /* =================================================================
           VARIABLES GLOBALES Y FUNCIONES BASE
        ================================================================= */
        let tableInstance = null;
        let catalogData = [];
        let currentSelectedSKU = null;
        let originalMatrixData = {};
        let globalJsonCache = null;
        let currentCategoryFilter = '';

        // Helper para mantener actualizados los KPIs
        function updateGlobalKPIs(data) {
            let alerts = 0;
            if (data && data.length > 0) {
                data.forEach(item => { if (parseInt(item.stock) <= 0) alerts++; });
            }

            const kpiVars = document.getElementById('kpi-variations');
            const kpiAlerts = document.getElementById('kpi-alerts');
            if (kpiVars) kpiVars.innerText = data ? data.length : 0;
            if (kpiAlerts) kpiAlerts.innerText = alerts;
        }

        $(document).ready(function () {
            initApp();

            // Buscador Global (Filtra DataTables, Categor칤as y Productos)
            $('#custom-sku-search').on('keyup', function () {
                const searchTerm = this.value.toLowerCase();

                // 1. Filtrar DataTables
                if (tableInstance) tableInstance.search(searchTerm).draw();

                // 2. Filtrar Carrusel de Productos
                buildProductCarousel(currentCategoryFilter, searchTerm);

                // 3. Filtrar Carrusel de Categor칤as
                filterCategoryCarouselVisuals(searchTerm);
            });

            // Atajo teclado Ctrl+K
            document.addEventListener('keydown', function (e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    document.getElementById('custom-sku-search').focus();
                }
            });
        });

        async function initApp() {
            log("Conectando con repositorio central...", "info");
            document.getElementById('last-sync-label').innerText = "Consumiendo API JSON...";

            try {
                const url = "https://raw.githubusercontent.com/Skypia-Underwear/api-tienda/main/skypia-underwear-catalog-tpv.json";
                const response = await fetch(url);

                if (!response.ok) throw new Error("Fallo en la respuesta de la red");
                globalJsonCache = await response.json();

                populateStoreSelector(globalJsonCache.stores);
                buildCategoryCarousel(globalJsonCache.categories);
                buildProductCarousel('');

                catalogData = flattenCatalogData(globalJsonCache.products);
                initDataTables(catalogData);
                updateGlobalKPIs(catalogData);

                const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                document.getElementById('last-sync-label').innerText = `Sincronizado: ${time}`;
                log(`Cat치logo listo para operar.`, "success");

            } catch (error) {
                log("Error cr칤tico al consumir el JSON: " + error.message, "error");
                document.getElementById('last-sync-label').innerText = "Error de Conexi칩n";
                document.getElementById('last-sync-label').classList.add("text-red-400");
            }
        }

        /* =================================================================
           CONSTRUCCI칍N DE FILTROS DE TIENDA Y DATOS
        ================================================================= */
        function populateStoreSelector(storesObj) {
            const select = document.getElementById('filter-store');
            select.innerHTML = '<option value="ALL">游끽 Todas (Modo Consolidado / Solo Lectura)</option>';

            const container = document.getElementById('table-store-filters');
            container.innerHTML = '<button class="store-filter-btn active px-3 py-1 text-[10px] font-bold rounded-md transition-colors bg-slate-700 text-white shadow-sm" data-store="">Todas</button>';

            if (storesObj) {
                Object.keys(storesObj).forEach(key => {
                    const storeName = storesObj[key].name;

                    const opt = document.createElement('option');
                    opt.value = storeName;
                    opt.textContent = `游늸 ${storeName} (Editable)`;
                    select.appendChild(opt);

                    const btn = document.createElement('button');
                    btn.className = 'store-filter-btn px-3 py-1 text-[10px] font-bold rounded-md transition-colors text-slate-400 hover:text-white border border-transparent hover:border-slate-600';
                    btn.dataset.store = storeName;
                    btn.textContent = storeName;
                    container.appendChild(btn);
                });
            }

            document.querySelectorAll('.store-filter-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    document.querySelectorAll('.store-filter-btn').forEach(b => {
                        b.classList.remove('bg-slate-700', 'text-white', 'shadow-sm', 'border-slate-500');
                        b.classList.add('text-slate-400', 'border-transparent');
                    });
                    this.classList.remove('text-slate-400', 'border-transparent');
                    this.classList.add('bg-slate-700', 'text-white', 'shadow-sm', 'border-slate-500');

                    const storeName = this.dataset.store;
                    if (tableInstance) {
                        tableInstance.column(2).search(storeName ? `^${storeName}$` : '', true, false).draw();
                    }

                    document.getElementById('filter-store').value = storeName === "" ? "ALL" : storeName;
                    refreshMatrixFromStore();
                });
            });
        }

        function flattenCatalogData(productsArray) {
            let flattened = [];
            productsArray.forEach(p => {
                if (p.variations && Array.isArray(p.variations)) {
                    p.variations.forEach(v => {
                        flattened.push({
                            sku: p.id,
                            name: p.model,
                            store: v.store_id,
                            brand: p.brand || '',
                            season: p.season || '',
                            gender: p.gender || '',
                            style: p.style || '',
                            material: p.material || '',
                            category: p.categoryName || '',
                            color: v.color,
                            talle: v.size,
                            variation_id: v.variation_id,

                            // MOCK METRICAS
                            entradas: Math.floor(Math.random() * 50),
                            salidas: Math.floor(Math.random() * 10),
                            ventas_web: Math.floor(Math.random() * 20),
                            ventas_local: Math.floor(Math.random() * 40),
                            stock: Math.floor(Math.random() * 30)
                        });
                    });
                }
            });
            return flattened;
        }

        function getBadgeStyle(colorName) {
            if (!globalJsonCache || !globalJsonCache.colors || !globalJsonCache.colors[colorName]) return `background-color: var(--bg-main); color: #e2e8f0;`;
            const colorData = globalJsonCache.colors[colorName];
            if (colorData.hex.includes('-')) {
                const parts = colorData.hex.split('-');
                return `background: linear-gradient(135deg, #${parts[0]} 0%, #${parts[1]} 100%); color: ${colorData.textEdge}; border-color: transparent;`;
            }
            return `background-color: #${colorData.hex}; color: ${colorData.textEdge}; border-color: rgba(255,255,255,0.1);`;
        }

        /* =================================================================
           1. CARRUSEL CATEGOR칈AS
        ================================================================= */
        function buildCategoryCarousel(categories) {
            const container = document.getElementById('category-carousel');
            container.innerHTML = '';

            let html = `
            <div onclick="filterCategory('', this)" data-category="" class="category-card active snap-start flex-shrink-0 flex flex-col items-center justify-center w-[70px] h-[70px] rounded-xl border border-accent bg-slate-800 cursor-pointer hover:bg-slate-700 relative overflow-hidden group shadow-sm">
                <div class="w-7 h-7 mb-1 opacity-70 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                    <i class="ph-bold ph-squares-four text-2xl text-slate-300"></i>
                </div>
                <span class="text-[8px] font-bold text-center px-1 uppercase tracking-wide truncate w-full z-10 text-white transition-colors">Todas</span>
            </div>
        `;

            if (categories && categories.length > 0) {
                categories.forEach(cat => {
                    html += `
                    <div onclick="filterCategory('${cat.name}', this)" data-category="${cat.name}" class="category-card snap-start flex-shrink-0 flex flex-col items-center justify-center w-[70px] h-[70px] rounded-xl border border-slate-700 bg-slate-800 cursor-pointer hover:bg-slate-700 relative overflow-hidden group shadow-sm">
                        <div class="w-7 h-7 mb-1 opacity-70 group-hover:opacity-100 transition-opacity category-svg-container flex items-center justify-center">
                            ${cat.svg}
                        </div>
                        <span class="text-[8px] font-bold text-center px-1 uppercase tracking-wide truncate w-full z-10 text-slate-400 group-hover:text-white transition-colors">${cat.name}</span>
                    </div>
                `;
                });
            }
            container.innerHTML = html;
        }

        function filterCategoryCarouselVisuals(searchTerm) {
            if (!globalJsonCache || !globalJsonCache.products) return;

            const matchedProducts = globalJsonCache.products.filter(p => {
                const searchString = `${p.id} ${p.model} ${p.brand || ''} ${p.season || ''} ${p.style || ''} ${p.material || ''} ${p.categoryName || ''}`.toLowerCase();
                return searchString.includes(searchTerm);
            });
            const matchedCategories = new Set(matchedProducts.map(p => p.categoryName));

            document.querySelectorAll('#category-carousel .category-card').forEach(card => {
                const catName = card.dataset.category;
                if (catName === '') {
                    card.style.display = 'flex';
                } else {
                    if (catName.toLowerCase().includes(searchTerm) || matchedCategories.has(catName)) {
                        card.style.display = 'flex';
                    } else {
                        card.style.display = 'none';
                    }
                }
            });
        }

        function filterCategory(catName, element = null) {
            currentCategoryFilter = catName;

            document.querySelectorAll('.category-card').forEach(c => {
                c.classList.remove('active', 'border-accent');
                c.classList.add('border-slate-700');
                const textSpan = c.querySelector('span');
                if (textSpan) { textSpan.classList.remove('text-white'); textSpan.classList.add('text-slate-400'); }
            });

            if (element) {
                element.classList.add('active', 'border-accent');
                element.classList.remove('border-slate-700');
                const textSpan = element.querySelector('span');
                if (textSpan) { textSpan.classList.add('text-white'); textSpan.classList.remove('text-slate-400'); }
            }

            if (tableInstance) {
                tableInstance.column(0).search(catName ? `^${catName}$` : '', true, false).draw();
                tableInstance.column(1).search('').draw();
            }

            const currentSearchTerm = document.getElementById('custom-sku-search').value.toLowerCase();
            buildProductCarousel(catName, currentSearchTerm);
        }

        function resetFilters() {
            const todasBtn = document.querySelector('#category-carousel .category-card[data-category=""]');
            if (todasBtn) filterCategory('', todasBtn);

            document.getElementById('custom-sku-search').value = '';
            filterCategoryCarouselVisuals('');

            if (tableInstance) {
                tableInstance.search('').draw();
                tableInstance.column(0).search('').draw();
                tableInstance.column(1).search('').draw();
            }
            buildProductCarousel('');

            document.getElementById('matrix-empty-state').classList.remove('hidden');
            document.getElementById('matrix-content').classList.add('hidden');

            document.getElementById('btn-sync-product').classList.add('hidden');
            document.getElementById('divider-sync').classList.add('hidden');

            currentSelectedSKU = null;
        }

        /* =================================================================
           2. LISTA DE PRODUCTOS 
        ================================================================= */
        function buildProductCarousel(categoryName, searchTerm = '') {
            const container = document.getElementById('product-carousel');
            container.innerHTML = '';

            if (!globalJsonCache || !globalJsonCache.products) return;

            let filteredProducts = globalJsonCache.products;

            if (categoryName !== '') {
                filteredProducts = filteredProducts.filter(p => p.categoryName === categoryName);
            }

            if (searchTerm !== '') {
                filteredProducts = filteredProducts.filter(p => {
                    const searchString = `${p.id} ${p.model} ${p.brand || ''} ${p.season || ''} ${p.style || ''} ${p.material || ''} ${p.categoryName || ''}`.toLowerCase();
                    return searchString.includes(searchTerm);
                });
            }

            if (filteredProducts.length === 0) {
                container.innerHTML = `<p class="text-[10px] text-slate-500 italic text-center py-4">No se encontraron modelos.</p>`;
                return;
            }

            filteredProducts.forEach(p => {
                const imgSrc = p.image && p.image !== "" ? p.image : "https://placehold.co/100x120/1e293b/94a3b8?text=Sin+Foto";
                const html = `
                <div onclick="selectProductFromGrid('${p.id}', this)" class="product-card flex-shrink-0 flex flex-col w-full h-[110px] rounded-lg border border-slate-700 bg-slate-800 cursor-pointer hover:border-slate-500 overflow-hidden relative group">
                    <div class="h-[75px] w-full bg-slate-900 overflow-hidden relative">
                        <img src="${imgSrc}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 group-hover:scale-110 transition-all duration-300" onerror="this.src='https://placehold.co/100x120/1e293b/94a3b8?text=No+Img'">
                    </div>
                    <div class="p-1 flex flex-col justify-center items-center flex-grow bg-slate-800 border-t border-slate-700">
                        <span class="text-[9px] font-bold text-white truncate w-full text-center leading-tight px-1">${p.model}</span>
                        <span class="text-[8px] text-slate-400 font-mono mt-0.5">${p.id}</span>
                    </div>
                </div>
            `;
                container.innerHTML += html;
            });
        }

        function selectProductFromGrid(sku, element) {
            document.querySelectorAll('.product-card').forEach(c => c.classList.remove('active', 'border-accent'));
            if (element) element.classList.add('active', 'border-accent');

            if (tableInstance) {
                tableInstance.column(1).search(`^${sku}$`, true, false).draw();
            }

            if (sku !== currentSelectedSKU) {
                currentSelectedSKU = sku;
                renderMatrix();

                document.getElementById('btn-sync-product').classList.remove('hidden');
                document.getElementById('divider-sync').classList.remove('hidden');
            }
        }


        /* =================================================================
           3. DATATABLES 
        ================================================================= */
        function initDataTables(data) {
            if (tableInstance) { tableInstance.destroy(); }

            tableInstance = $('#catalogTable').DataTable({
                data: data,
                layout: null,
                dom: 'rt<"flex justify-between items-center pt-3"ip>',
                columns: [
                    { data: 'category', visible: false }, // 0
                    { data: 'sku', visible: false },      // 1
                    { data: 'store', visible: false },    // 2 
                    { data: 'brand', visible: false },    // 3
                    { data: 'season', visible: false },   // 4
                    { data: 'gender', visible: false },   // 5
                    { data: 'style', visible: false },    // 6
                    { data: 'material', visible: false }, // 7

                    {
                        data: null, render: function (data, type, row) {
                            const style = getBadgeStyle(row.color);
                            return `<div class="flex gap-2 items-center">
                              <span class="px-2 py-0.5 rounded text-[10px] font-medium border border-slate-700 truncate max-w-[80px] shadow-sm" style="${style}">${row.color}</span> 
                              <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-slate-700 text-white shadow-sm border border-slate-600 min-w-[24px] text-center">${row.talle}</span>
                            </div>`;
                        }
                    },
                    { data: 'entradas', render: data => `<span class="text-[11px] text-blue-400 font-mono font-bold bg-blue-500/10 border border-blue-500/20 px-1.5 py-0.5 rounded shadow-inner">+${data}</span>` },
                    { data: 'salidas', render: data => `<span class="text-[11px] text-orange-400 font-mono font-bold bg-orange-500/10 border border-orange-500/20 px-1.5 py-0.5 rounded shadow-inner">-${data}</span>` },
                    { data: 'ventas_web', render: data => `<span class="text-[11px] text-purple-400 font-mono font-bold"><i class="ph-fill ph-globe text-[10px]"></i> ${data}</span>` },
                    { data: 'ventas_local', render: data => `<span class="text-[11px] text-teal-400 font-mono font-bold"><i class="ph-fill ph-storefront text-[10px]"></i> ${data}</span>` },
                    {
                        data: 'stock', render: function (data) {
                            if (data <= 0) return `<span class="text-red-400 font-bold bg-red-500/10 px-2 py-1.5 rounded text-[10px] shadow-sm border border-red-500/20">Agotado</span>`;
                            return `<span class="text-emerald-400 font-bold bg-emerald-500/10 px-2 py-1.5 rounded text-[10px] shadow-sm border border-emerald-500/20">${data} u.</span>`;
                        }
                    }
                ],
                order: [[1, 'asc']],
                rowGroup: {
                    dataSrc: function (row) {
                        let groupItems = data.filter(i => i.sku === row.sku);
                        const currentStore = document.querySelector('.store-filter-btn.active')?.dataset.store;
                        if (currentStore) { groupItems = groupItems.filter(i => i.store === currentStore); }

                        const totalSKU = groupItems.reduce((acc, curr) => acc + curr.stock, 0);
                        const tag = totalSKU <= 0 ? `<span class="text-red-400 text-[11px] ml-auto bg-red-900/20 px-2 py-0.5 rounded font-bold border border-red-500/20 shadow-inner">Agotado</span>` : `<span class="text-emerald-400 text-[11px] ml-auto bg-emerald-900/20 px-2 py-0.5 rounded font-bold border border-emerald-500/20 shadow-inner">Stock: ${totalSKU} u.</span>`;

                        return `<div class="flex items-center gap-2 w-full pr-4 py-0.5">
                              <i class="ph-fill ph-package text-blue-400 text-lg"></i> 
                              <span class="text-white font-bold tracking-wide text-xs uppercase">${row.brand} ${row.name}</span> 
                              <span class="text-slate-400 text-[10px] ml-2 font-mono font-normal bg-slate-800 border border-slate-600 px-1.5 py-0.5 rounded shadow-inner">${row.sku}</span>
                              ${tag}
                            </div>`;
                    }
                },
                language: {
                    emptyTable: "No se encontraron variaciones",
                    info: "Mostrando _START_ a _END_ de _TOTAL_ vars.",
                    infoEmpty: "",
                },
                pageLength: 50,
                createdRow: function (row, data) {
                    $(row).attr('data-sku', data.sku);
                }
            });

            tableInstance.on('draw', function () {
                const filteredData = tableInstance.rows({ search: 'applied' }).data().toArray();
                updateGlobalKPIs(filteredData);
            });

            $('#catalogTable tbody').on('click', 'tr', function () {
                if ($(this).hasClass('dtrg-group')) return;

                const sku = $(this).attr('data-sku');

                const productCards = document.querySelectorAll('.product-card');
                productCards.forEach(c => {
                    if (c.innerHTML.includes(sku)) {
                        selectProductFromGrid(sku, c);
                        c.scrollIntoView({ behavior: "smooth", block: "nearest" });
                    }
                });
            });
        }

        /* =================================================================
           4. MATRIZ DE EDICI칍N
        ================================================================= */
        function refreshMatrixFromStore() {
            if (currentSelectedSKU) renderMatrix();
        }

        function renderMatrix() {
            const sku = currentSelectedSKU;
            const storeFilter = document.getElementById('filter-store').value;
            const isConsolidated = storeFilter === 'ALL';

            const emptyState = document.getElementById('matrix-empty-state');
            const contentDiv = document.getElementById('matrix-content');

            emptyState.classList.add('hidden');
            contentDiv.classList.remove('animate-fade-in');
            void contentDiv.offsetWidth;
            contentDiv.classList.add('animate-fade-in');
            contentDiv.classList.remove('hidden');

            const badge = document.getElementById('active-sku-badge');
            badge.innerText = sku;
            badge.classList.remove('hidden');

            const btnSave = document.getElementById('btn-save-matrix');
            if (isConsolidated) {
                btnSave.disabled = true;
                btnSave.classList.add('opacity-50', 'cursor-not-allowed');
                btnSave.innerHTML = `<i class="ph-bold ph-lock-key text-sm"></i> Vista Lectura`;
            } else {
                btnSave.disabled = false;
                btnSave.classList.remove('opacity-50', 'cursor-not-allowed');
                btnSave.innerHTML = `<i class="ph-bold ph-floppy-disk text-sm"></i> Guardar Cambios`;
            }

            const productDataRaw = catalogData.filter(item => item.sku === sku);

            let processedData = [];
            if (isConsolidated) {
                const map = new Map();
                productDataRaw.forEach(item => {
                    const key = `${item.color}-${item.talle}`;
                    if (map.has(key)) { map.get(key).stock += item.stock; }
                    else { map.set(key, { ...item }); }
                });
                processedData = Array.from(map.values());
            } else {
                processedData = productDataRaw.filter(item => item.store === storeFilter);
            }

            const sizeOrder = ["Surtido", "XXS", "XS", "S", "M", "L", "XL", "XXL", "2XL", "3XL", "4XL", "5XL", "6XL"];
            const tallesUnicos = [...new Set(productDataRaw.map(i => i.talle))].sort((a, b) => {
                let indexA = sizeOrder.indexOf(a);
                let indexB = sizeOrder.indexOf(b);
                if (indexA === -1) indexA = 999;
                if (indexB === -1) indexB = 999;
                if (indexA !== indexB) return indexA - indexB;
                return a.localeCompare(b);
            });
            const coloresUnicos = [...new Set(productDataRaw.map(i => i.color))].sort();

            originalMatrixData = {};

            let html = `
            ${isConsolidated ? '<div class="mb-4 p-2 bg-blue-500/10 border border-blue-500/20 rounded-lg text-[10px] text-blue-400 text-center flex items-center justify-center gap-2"><i class="ph-fill ph-info"></i> Selecciona una tienda en el selector superior para editar el stock.</div>' : ''}
            <div class="rounded-xl border border-slate-700 overflow-hidden shadow-inner" style="background-color: var(--bg-main);">
            <table class="w-full text-sm text-left border-collapse">
                <thead class="bg-slate-900 border-b border-slate-700">
                    <tr>
                        <th class="px-4 py-3 border-r border-slate-700 text-slate-400 font-bold uppercase text-[10px] tracking-wider">Color \\ Talle</th>`;

            tallesUnicos.forEach(talle => {
                html += `<th class="px-2 py-3 text-slate-300 text-center font-bold uppercase text-[11px] tracking-wider min-w-[60px]">${talle}</th>`;
            });
            html += `</tr></thead><tbody class="divide-y divide-slate-800">`;

            coloresUnicos.forEach(color => {
                const badgeStyle = getBadgeStyle(color);
                html += `<tr class="hover:bg-slate-800/50 transition">
                        <td class="px-3 py-2 border-r border-slate-700 font-medium text-slate-300 bg-slate-900/50 text-xs">
                            <div class="px-2 py-1 rounded w-fit border border-slate-700 shadow-sm" style="${badgeStyle}">${color}</div>
                        </td>`;

                tallesUnicos.forEach(talle => {
                    const varData = processedData.find(i => i.color === color && i.talle === talle);

                    if (varData) {
                        const stockVal = varData.stock;
                        const isZero = stockVal <= 0;
                        const stockClass = isZero ? 'bg-red-900/10 text-red-400' : 'text-white';
                        const inputClass = isZero ? 'text-red-400' : 'text-white';
                        const inputId = `mat-${sku}-${color}-${talle}`;

                        originalMatrixData[inputId] = stockVal;
                        const readonlyAttr = isConsolidated ? 'readonly' : '';
                        const disableClass = isConsolidated ? 'opacity-70 cursor-not-allowed' : 'focus:border-[var(--accent)] focus:bg-slate-800';

                        html += `
                        <td class="px-2 py-2 text-center transition-colors ${stockClass}" id="td-${inputId}">
                            <input type="number" id="${inputId}" value="${stockVal}" ${readonlyAttr}
                                class="w-full h-9 text-center bg-transparent border border-transparent outline-none rounded-lg font-bold text-sm transition-all ${inputClass} ${disableClass}"
                                onchange="handleMatrixChange('${inputId}', ${stockVal})">
                        </td>`;
                    } else {
                        html += `<td class="px-2 py-2 text-center bg-slate-900/30"><span class="text-slate-600 font-bold text-xs">-</span></td>`;
                    }
                });
                html += `</tr>`;
            });

            html += `</tbody></table></div>`;
            contentDiv.innerHTML = html;
        }

        function handleMatrixChange(inputId, originalValue) {
            if (document.getElementById('filter-store').value === 'ALL') return;

            const input = document.getElementById(inputId);
            const td = document.getElementById(`td-${inputId}`);
            const newValue = parseInt(input.value) || 0;

            td.classList.remove('bg-emerald-900/20', 'bg-red-900/10', 'text-red-400', 'text-white');
            input.classList.remove('text-red-400', 'text-white', 'text-emerald-400');

            if (newValue !== originalValue) {
                td.classList.add('bg-emerald-900/20');
                input.classList.add('text-emerald-400');
            } else {
                if (originalValue <= 0) {
                    td.classList.add('bg-red-900/10');
                    input.classList.add('text-red-400');
                } else {
                    input.classList.add('text-white');
                }
            }
        }

        function saveMatrixChanges() {
            const storeFilter = document.getElementById('filter-store').value;
            if (storeFilter === 'ALL') return;

            const payload = [];
            for (const [inputId, originalValue] of Object.entries(originalMatrixData)) {
                const inputEl = document.getElementById(inputId);
                if (inputEl) {
                    const newValue = parseInt(inputEl.value) || 0;
                    if (newValue !== originalValue) {
                        const parts = inputId.split('-');
                        payload.push({ sku: parts[1], color: parts[2], talle: parts[3], store: storeFilter, oldStock: originalValue, newStock: newValue });
                    }
                }
            }

            if (payload.length === 0) {
                Swal.fire({ icon: 'info', title: 'Sin cambios', text: 'No has modificado ning칰n valor.', background: 'var(--bg-secondary)', color: '#fff', confirmButtonColor: 'var(--accent)' });
                return;
            }

            openLogsPanel();
            log(`Registrando ajustes para tienda: ${storeFilter}...`, "info");
            const btnSave = document.getElementById('btn-save-matrix');
            btnSave.innerHTML = `<i class="ph-bold ph-spinner animate-spin text-sm"></i> Guardando...`;

            setTimeout(() => {
                log(`Cambios aplicados exitosamente a ${storeFilter}.`, "success");
                Swal.fire({ icon: 'success', title: 'Stock Actualizado', text: 'Cambios registrados bajo LockService.', background: 'var(--bg-secondary)', color: '#fff', timer: 2000, showConfirmButton: false });

                payload.forEach(change => {
                    const dataIndex = catalogData.findIndex(i => i.sku === change.sku && i.color === change.color && i.talle === change.talle && i.store === change.store);
                    if (dataIndex > -1) catalogData[dataIndex].stock = change.newStock;
                });

                btnSave.innerHTML = `<i class="ph-bold ph-floppy-disk text-sm"></i> Guardar Cambios`;
                renderMatrix();
                if (tableInstance) { tableInstance.rows().invalidate().draw(false); }

            }, 1200);
        }

        /* =================================================================
           ACCIONES DE MANTENIMIENTO E INTEGRACIONES
        ================================================================= */
        function runGlobalAudit() {
            Swal.fire({
                title: '쮼jecutar Auditor칤a Global?',
                text: 'Este proceso es muy pesado y revisar치 todo el inventario, recalculando faltantes y limpiando registros hu칠rfanos.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#334155',
                confirmButtonText: 'S칤, ejecutar',
                cancelButtonText: 'Cancelar',
                background: 'var(--bg-secondary)',
                color: '#fff'
            }).then((result) => {
                if (result.isConfirmed) {
                    openLogsPanel();
                    log("Iniciando Proceso Inmunol칩gico (Auditor칤a Global). Por favor espere...", "info");

                    if (typeof google !== 'undefined' && google.script) {
                        google.script.run
                            .withSuccessHandler(function (result) {
                                log(result.message, result.success ? "success" : "error");
                            })
                            .withFailureHandler(function (error) {
                                log("Error de conexi칩n: " + error.message, "error");
                            })
                            .procesarAccionInventario('AUDITORIA_GLOBAL', 'ALL', new Date().toISOString());
                    } else {
                        setTimeout(() => log("Auditor칤a Global finalizada (Mock local).", "success"), 1500);
                    }
                }
            });
        }

        function runProductAudit() {
            if (!currentSelectedSKU) return;
            openLogsPanel();
            log(`Sincronizando variaciones forzadas para el producto: ${currentSelectedSKU}...`, "info");

            if (typeof google !== 'undefined' && google.script) {
                google.script.run
                    .withSuccessHandler(function (result) {
                        log(result.message, result.success ? "success" : "error");
                    })
                    .withFailureHandler(function (error) {
                        log("Error de conexi칩n: " + error.message, "error");
                    })
                    .procesarAccionInventario('AUDITORIA_SKU', currentSelectedSKU, new Date().toISOString());
            } else {
                setTimeout(() => log(`Producto ${currentSelectedSKU} sincronizado (Mock local).`, "success"), 1500);
            }
        }

        /* --- FLUJO BARTENDER --- */
        function runBartender() {
            openLogsPanel();
            log("Abriendo configurador de Bartender...", "info");

            const modal = document.getElementById('bartender-modal');
            const setupContainer = document.getElementById('bartender-setup-container');
            const tableContainer = document.getElementById('bartender-table-container');
            const footer = document.getElementById('bartender-footer');
            const subtitle = document.getElementById('bartender-modal-subtitle');
            const skuLabel = document.getElementById('bt-selected-sku-label');
            const radioSelected = document.getElementById('bt_source_selected');
            const radioFiltered = document.getElementById('bt_source_filtered');

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setupContainer.classList.remove('hidden');
            setupContainer.classList.add('flex');
            tableContainer.classList.add('hidden');
            footer.classList.add('hidden');
            footer.classList.remove('flex');
            subtitle.innerText = "Paso 1: Configura los par치metros de extracci칩n.";

            if (currentSelectedSKU) {
                skuLabel.innerText = currentSelectedSKU;
                radioSelected.disabled = false;
                radioSelected.checked = true;
            } else {
                skuLabel.innerText = "Ninguno";
                radioSelected.disabled = true;
                radioFiltered.checked = true;
            }
        }

        function processBartenderData() {
            openLogsPanel();
            log("Iniciando proceso de extracci칩n para Bartender...", "info");

            const setupContainer = document.getElementById('bartender-setup-container');
            const tableContainer = document.getElementById('bartender-table-container');
            const footer = document.getElementById('bartender-footer');
            const subtitle = document.getElementById('bartender-modal-subtitle');

            setupContainer.classList.add('hidden');
            setupContainer.classList.remove('flex');
            tableContainer.classList.remove('hidden');

            subtitle.innerText = "Paso 2: Edita las cantidades a imprimir y genera el CSV.";

            tableContainer.innerHTML = `
            <div class="absolute inset-0 flex flex-col items-center justify-center bg-slate-900/50 z-10">
                <i class="ph-bold ph-spinner animate-spin text-4xl text-purple-500 mb-3"></i>
                <span class="text-slate-300 font-medium">Procesando datos del ERP...</span>
            </div>
        `;

            const source = document.querySelector('input[name="bt_source"]:checked').value;
            let dataToProcess = [];

            if (source === 'selected') {
                dataToProcess = catalogData.filter(i => i.sku === currentSelectedSKU);
                log(`Extrayendo variaciones del producto ${currentSelectedSKU}.`, "info");
            } else if (source === 'filtered') {
                dataToProcess = tableInstance.rows({ search: 'applied' }).data().toArray();
                log(`Extrayendo variaciones del filtro actual.`, "info");
            } else {
                dataToProcess = catalogData;
                log(`Extrayendo cat치logo completo.`, "info");
            }

            setTimeout(() => {
                let html = `
                <table class="w-full text-left border-collapse border border-slate-700 shadow-lg" id="bt-export-table">
                    <thead class="sticky top-0 bg-slate-800 z-20">
                        <tr class="text-slate-300 shadow-sm">
                            <th class="p-3 border border-slate-700 uppercase text-[10px] font-bold tracking-wider">SKU Base</th>
                            <th class="p-3 border border-slate-700 uppercase text-[10px] font-bold tracking-wider">Variaci칩n</th>
                            <th class="p-3 border border-slate-700 uppercase text-[10px] font-bold tracking-wider text-center">Stock Actual</th>
                            <th class="p-3 border border-slate-700 uppercase text-[10px] font-bold tracking-wider text-center">Etiquetas a Imprimir</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-700/50">
            `;

                const renderData = dataToProcess.slice(0, 100);

                if (renderData.length === 0) {
                    html += `<tr><td colspan="4" class="p-4 text-center text-slate-400 italic">No hay datos para imprimir.</td></tr>`;
                } else {
                    renderData.forEach(i => {
                        const printQty = i.stock > 0 ? i.stock : 0;
                        html += `
                        <tr class="hover:bg-slate-800/80 transition-colors bg-slate-900/50 bt-row" data-sku="${i.sku}" data-color="${i.color}" data-talle="${i.talle}">
                            <td class="p-2 border-r border-slate-700 font-mono text-blue-400 text-xs font-bold pl-4">${i.sku}</td>
                            <td class="p-2 border-r border-slate-700">
                                <div class="flex items-center gap-2">
                                    <span class="px-2 py-0.5 rounded text-[10px] font-medium border border-slate-700" style="${getBadgeStyle(i.color)}">${i.color}</span>
                                    <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-slate-700 text-white">${i.talle}</span>
                                </div>
                            </td>
                            <td class="p-2 border-r border-slate-700 text-center text-slate-300 font-mono text-xs">${i.stock}</td>
                            <td class="p-2 text-center bg-slate-800">
                                <input type="number" value="${printQty}" class="bt-qty-input w-20 bg-slate-900 border border-slate-600 rounded-lg px-2 py-1 text-white outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition text-center font-bold">
                            </td>
                        </tr>
                    `;
                    });
                }
                html += '</tbody></table>';

                tableContainer.innerHTML = html;
                footer.classList.remove('hidden');
                footer.classList.add('flex');

                log("Vista previa de Bartender generada y lista para edici칩n.", "success");
            }, 800);
        }

        function closeModal() {
            document.getElementById('bartender-modal').classList.add('hidden');
            document.getElementById('bartender-modal').classList.remove('flex');
        }

        function downloadBartenderCSV() {
            openLogsPanel();
            log("Iniciando actualizaci칩n de BD Bartender y notificaciones...", "info");

            // Recolectar datos editados del DOM
            const rows = document.querySelectorAll('.bt-row');
            let payload = [];
            rows.forEach(row => {
                const qty = parseInt(row.querySelector('.bt-qty-input').value) || 0;
                if (qty > 0) {
                    payload.push({
                        sku: row.dataset.sku,
                        color: row.dataset.color,
                        talle: row.dataset.talle,
                        qty: qty
                    });
                }
            });

            closeModal();

            // Enviar al backend real
            if (typeof google !== 'undefined' && google.script) {
                log("Enviando configuraci칩n al servidor...", "info");
                google.script.run
                    .withSuccessHandler(function (result) {
                        log(result.message || "Procesamiento y notificaci칩n finalizados.", result.success ? "success" : "error");
                    })
                    .withFailureHandler(function (error) {
                        log("Error de conexi칩n: " + error.message, "error");
                    })
                    .procesarAccionInventario('BARTENDER', JSON.stringify(payload), new Date().toISOString());
            } else {
                // Mock local
                setTimeout(() => {
                    log(`Se procesar칤an ${payload.length} variaciones. Actualizando DB y enviando Telegram (Mock).`, "success");
                }, 1500);
            }
        }


        /* =================================================================
           UTILIDADES LOG Y UI
        ================================================================= */
        function openLogsPanel() {
            const panel = document.getElementById('logs-panel');
            const btn = document.getElementById('btn-toggle-logs');
            panel.classList.remove('translate-y-full');
            btn.style.backgroundColor = 'var(--accent)';
            btn.style.borderColor = 'var(--accent)';
            btn.style.color = 'white';
        }

        function toggleLogs() {
            const panel = document.getElementById('logs-panel');
            const btn = document.getElementById('btn-toggle-logs');
            if (panel.classList.contains('translate-y-full')) {
                openLogsPanel();
            } else {
                panel.classList.add('translate-y-full');
                btn.style.backgroundColor = 'var(--bg-main)';
                btn.style.borderColor = '#334155';
                btn.style.color = '#cbd5e1';
            }
        }

        function log(message, type = 'info') {
            const consoleDiv = document.getElementById('console-output');
            if (!consoleDiv) return;

            if (consoleDiv.innerHTML.includes('Esperando instrucciones...')) consoleDiv.innerHTML = '';
            const line = document.createElement('div');
            line.className = 'log-line font-medium';
            if (type === 'error' || message.includes('仇')) line.className += ' log-error';
            else if (type === 'success' || message.includes('九')) line.className += ' log-success';
            else line.className += ' log-info';
            line.innerHTML = `<span class="opacity-50">[${new Date().toLocaleTimeString()}]</span> <span class="ml-2">> ${message}</span>`;
            consoleDiv.appendChild(line);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        function clearConsole() {
            const consoleDiv = document.getElementById('console-output');
            if (consoleDiv) consoleDiv.innerHTML = '<p class="text-slate-600 italic font-medium">Esperando instrucciones...</p>';
        }

    </script>
</body>

</html>