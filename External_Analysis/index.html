<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html>
<html lang='en' xmlns='http://www.w3.org/1999/xhtml' xmlns:b='http://www.google.com/2005/gml/b'
    xmlns:data='http://www.google.com/2005/gml/data' xmlns:expr='http://www.google.com/2005/gml/expr'>

<head>
    <!-- Open Graph -->
    <meta content='Skypia Underwear' property='og:title' />
    <meta content='https://skypia-underwear.blogspot.com' property='og:url' />
    <meta content='website' property='og:type' />
    <meta content='Tienda de Ropa Nacional e Importada de la mejor Calidad y Precio, Envio a todo el Pais'
        property='og:description' />
    <meta
        content='https://cdn.filestackcontent.com/A96uIBVEaSfSGzSE1ZpmVz/border%3Dwidth%3A4%2Ccolor%3A1E90FFFF/shadow%3Dopacity%3A90%2Cvector%3A%5B4%2C4%5D%2Ccolor%3A1E90FFFF%2Cbackground%3AF0F8FFFF/resize%3Dwidth%3A545/cache=expiry:max/auto_image/https://www.appsheet.com/template/gettablefileurl?appName=TiendaOnlineBlogger-337846396&amp;tableName=Info%20Tienda&amp;fileName=Info%20Tienda_Images%2FSkypia%20Underwear.Logotipo.012135.png'
        property='og:image' />
    <meta content='Tienda de Ropa Nacional e Importada de la mejor calidad y precio.' name='description' />
    <meta content='text/html; charset=UTF-8' http-equiv='Content-Type' />
    <meta content='width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1, user-scalable=yes'
        name='viewport' />
    <b:skin version='1.3.0'>
        <![CDATA[
    ]]>
    </b:skin>

    <!-- CONFIGURACIÓN DE INSTALACIÓN ERP; buscar esto para configurar
         Solo este bloque se edita al instalar el tema en una nueva tienda.-->
    <script type='text/javascript'>
        //<![CDATA[

        // ── 1. APPS SCRIPT (ID del deployment de la macro/ERP) ───────────────
        var GAS_DEPLOYMENT_ID = 'AKfycbzss0AHtYrkWd1qp6dqCwA3tgvFA_8JaWL5kIVCUO4xnyYi2-TNvLPRD2E76eDRdz7T';
        var GAS_BASE_URL = 'https://script.google.com/macros/s/' + GAS_DEPLOYMENT_ID + '/';

        // ── 2. HOSTING / DONWEB ──────────────────────────────────────────────
        var DONWEB_BASE_URL = 'https://castfer.com.ar/';
        var DONWEB_READ_SCRIPT = 'leer_json_hostingshop.php';   // script lector ya existente en el server

        // ── 3. GITHUB ────────────────────────────────────────────────────────
        var GITHUB_USER = 'Skypia-Underwear';
        var GITHUB_REPO = 'api-tienda';
        var GITHUB_BRANCH = 'main';

        // ── 4. ARCHIVOS JSON DE ESTA TIENDA ──────────────────────────────────
        var BLOGGER_JSON_FILE = 'skypia-underwear-blogger-config.json';
        var TPV_JSON_FILE = 'skypia-underwear-catalog-tpv.json';

        // ── URLs construidas automáticamente (no editar debajo de esta línea) ─
        var url_final_venta = GAS_BASE_URL;   // alias de compatibilidad con código existente
        var DONWEB_BLOGGER_URL = DONWEB_BASE_URL + DONWEB_READ_SCRIPT + '?file=' + BLOGGER_JSON_FILE;
        var GITHUB_BLOGGER_URL = 'https://raw.githubusercontent.com/' + GITHUB_USER + '/' + GITHUB_REPO + '/' + GITHUB_BRANCH + '/' + BLOGGER_JSON_FILE;
        var DONWEB_TPV_URL = DONWEB_BASE_URL + DONWEB_READ_SCRIPT + '?file=' + TPV_JSON_FILE;
        var GITHUB_TPV_URL = 'https://raw.githubusercontent.com/' + GITHUB_USER + '/' + GITHUB_REPO + '/' + GITHUB_BRANCH + '/' + TPV_JSON_FILE;

        //]]>
    </script>

    <!-- CSS -->
    <title>Skypia Underwear</title>
    <link id='manifest' rel='manifest' />
    <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css' rel='stylesheet' />
    <link href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css' rel='stylesheet' />
    <link href='https://cdn.jsdelivr.net/npm/@fancyapps/ui@6.0/dist/fancybox/fancybox.css' rel='stylesheet' />
    <link href='https://cdn.datatables.net/1.13.1/css/jquery.dataTables.min.css' rel='stylesheet' />
    <link href='https://cdn.datatables.net/buttons/2.3.2/css/buttons.dataTables.min.css' rel='stylesheet' />
</head>
<style>
    .tiktok-button {
        display: inline-block;
        background-color: black;
        color: white;
        border: none;
        padding: 10px 20px;
        text-decoration: none;
        font-size: 16px;
        font-weight: bold;
        position: relative;
    }

    .tiktok-button i {
        color: white;
        margin-right: 5px;
    }

    .social-buttons {
        text-align: center;
    }

    .social-buttons .btn {
        margin: 1px;
    }

    .store-logo img {
        display: block;
        margin-left: auto;
        margin-right: auto;
    }

    .store-title {
        text-align: center;
        font-size: 32px;
        font-weight: bold;
        margin-top: 10px;
        color: #333;
        text-transform: uppercase;
    }

    .store-description {
        text-align: center;
        margin-top: 10px;
        font-weight: 700;
        color: #0d6efd;
        font-style: italic;
        margin-block-end: 15px;
    }

    .titulo-productos {
        display: block;
        text-align: center;
        font-size: 1.25em;
        font-weight: bold;
        font-family: serif;
        color: #333;
        padding: 10px 0;
        border-bottom: 1px solid #ddd;
        margin-top: -8px;
    }

    .loader-wrapper {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        flex-direction: column;
    }

    #carouselExampleSlidesOnly {
        display: flex;
        justify-content: normal;
        margin: auto;
        max-width: 100%;
        height: auto;
        padding: 5px;
        border: outset;
    }

    .flex-container {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        width: 100%;
    }

    .icon-container {
        justify-content: space-evenly;
    }

    .products-container {
        flex-direction: column;
        justify-content: flex-start;
    }

    .product {
        animation: product-move 2s ease-in-out infinite;
    }

    @keyframes product-move {
        0% {
            transform: translateY(-100px);
            opacity: 0;
        }

        50% {
            transform: translateY(0);
            opacity: 1;
        }

        100% {
            transform: translateY(100px);
            opacity: 0;
        }
    }

    .loading-text {
        margin-top: 20px;
        font-size: 1.4em;
        color: #34495e;
        font-weight: bold;
        animation: fade-in 2s ease-in-out infinite;
    }

    @keyframes fade-in {

        0%,
        100% {
            opacity: 0.5;
        }

        50% {
            opacity: 1;
        }
    }

    .db-icon,
    .database {
        animation: bounce 1.5s ease-in-out infinite;
    }

    @keyframes bounce {

        0%,
        100% {
            transform: translateY(0);
        }

        50% {
            transform: translateY(-8px);
        }
    }

    .tiendaonline {
        animation: pulse 2s ease-in-out infinite, glow 1.5s ease-in-out infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.1);
        }
    }

    @keyframes glow {

        0%,
        100% {
            filter: drop-shadow(0 0 5px rgba(255, 193, 7, 0.5));
        }

        50% {
            filter: drop-shadow(0 0 15px rgba(255, 193, 7, 1));
        }
    }

    .transfer-line {
        position: absolute;
        top: 50%;
        left: 50%;
        height: 3px;
        width: 0;
        background-color: #e67e22;
        animation: transfer 1.5s ease-in-out infinite;
    }

    @keyframes transfer {
        0% {
            width: 0;
            opacity: 0;
        }

        50% {
            width: 100px;
            opacity: 1;
        }

        100% {
            width: 0;
            opacity: 0;
        }
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
        background-color: #fff;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 600px;
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

    .close:hover,
    .close:focus {
        color: #000;
        text-decoration: none;
        cursor: pointer;
    }

    .whatsapp-floating-button {
        position: fixed;
        right: 20px;
        bottom: 120px;
        z-index: 100;
    }

    .total-compra-container {
        flex-direction: column;
        align-items: center;
        display: flex;
        padding: 2px;
        background-color: #ffffff;
        width: 100%;
        max-width: 466px;
        border-radius: 10px;
        box-shadow: 0px 2px 5px #ddd;
    }

    .total-compra {
        background-color: #fff;
        padding: 5px;
        margin-left: 5px;
        border-radius: 15px;
    }

    .total-compra-titulo {
        font-weight: bold;
    }

    .total-compra-valor {
        font-size: 17px;
        font-family: monospace;
        font-weight: 600;
        color: #d60939;
    }

    .accordion-body {
        padding: 0.35em;
    }

    @font-face {
        font-family: &#39;
        Pacifico&#39;
        ;
        font-style: normal;
        font-weight: 400;
        src: local(&#39; Pacifico Regular&#39; ), local(&#39; Pacifico-Regular&#39; ),
            url(https://fonts.gstatic.com/s/pacifico/v12/FwZY7-Qmy14u9lezJ-6H6MmBp0u-.woff2) format(&#39; woff2&#39; );
        font-display: swap;
    }


    .accordion-button:not(.collapsed) {
        color: #333;
        background-color: #F6F8FC;
    }

    .modal_pedido,
    .accordion-button.collapsed,
    .list-group-item {
        background-color: #fff;
    }

    .accordion-button:focus {
        z-index: 4;
        border-color: #F6F8FC !important;
        outline: none;
        box-shadow: 0 0 0 0.15rem rgba(0, 123, 255, 0.5);
    }

    .accordion-button:not(.collapsed)::after {
        background-image: url(&quot;data:image/svg+xml,%3csvg xmlns=&#39;http://www.w3.org/2000/svg&#39; viewBox=&#39;0 0 16 16&#39; fill=&#39;%23212529&#39;%3e%3cpath fill-rule=&#39;evenodd&#39; d=&#39;M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z&#39;/%3e%3c/svg%3e&quot;);
    }

    .categoria_nombre {
        font-size: 14px;
        font-weight: 700;
        text-align: center;
        display: flex;
        align-items: center;
        margin: 0 auto;
        cursor: pointer;
        padding-left: 30px;
        position: relative;
        text-transform: uppercase;
    }

    .contador_productos {
        font-size: 13px;
        font-weight: normal;
        color: #0a58ca;
        margin-left: 10px;
        /* Espacio entre el nombre y el contador */
    }

    .categoria_icono {
        position: absolute;
        left: 5px;
        top: 50%;
        transform: translateY(-50%);
        width: 50px;
        height: 50px;
        margin-right: 25px;
    }

    .categoria_icono svg {
        max-width: 50px;
        /* Ajustar el ancho máximo del SVG */
        max-height: 50px;
        /* Ajustar la altura máxima del SVG */
        width: auto;
        /* Escalar proporcionalmente */
        height: auto;
        /* Escalar proporcionalmente */
        margin-right: 10px;
        /* Espacio entre el SVG y el texto */
        display: inline-block;
        /* Asegura que el SVG se alinee correctamente */
        vertical-align: middle;
        /* Alinear verticalmente con el texto */
    }

    .categoria_contenedor {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        /* Alinea el contenido hacia la izquierda */
        gap: 10px;
        /* Espacio entre el icono y el texto */
        padding: 5px;
        /* Espaciado interno para mejor presentación */
    }

    .product-container {
        display: flex;
        flex-direction: column;
        align-items: start;
        padding: 5px;
    }

    .producto_id {
        font-size: 13px;
        color: #0fbb44;
    }

    .btn-secondary {
        color: #fff;
        background-color: #f86c00;
        border-color: #000;
    }

    .resultado-puntuacion {
        font-size: 11px;
        color: #1808f4;
        margin-block-end: auto;
    }

    .puntuacion {
        text-align: center;
        /* Centra todo el contenido dentro de .puntuacion */
        margin-top: 5px;
    }

    /* Contenedor de las estrellas */
    .estrellas {
        display: flex;
        /* Flexbox para control preciso */
        justify-content: center;
        /* Centra las estrellas horizontalmente */
        gap: 0.5rem;
        /* Espaciado entre las estrellas */
    }

    .estrella {
        cursor: pointer;
        /* Muestra un cursor clickeable */
        text-align: center;
        /* Opcional, en caso de más contenido dentro */
    }

    .estrella i {
        font-size: 1.5rem;
        /* Tamaño de las estrellas */
        color: #ccc;
        /* Color de estrellas vacías */
        transition: color 0.3s ease, transform 0.3s ease;
        /* Efectos suaves */
    }

    .estrella .fa-star {
        color: #f5a623;
        /* Color de estrellas llenas */
    }

    .estrella i:hover,
    .estrella i:hover~i {
        color: #ffcc00;
        /* Color al pasar el mouse */
        transform: scale(1.2);
        /* Aumenta el tamaño al hacer hover */
    }

    .estrella i:active {
        animation: bounce 0.3s ease;
        /* Efecto opcional de animación */
        transform: scale(1);
        /* Restablece el tamaño después del clic */
    }

    @keyframes bounce {

        0%,
        100% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.2);
        }
    }

    .btn-download-vcard {
        background-color: #007bff;
        color: #fff;
        padding: 10px 9px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        text-align: center;
    }

    .btn-download-vcard:hover {
        background-color: #0056b3;
    }

    .plato_nombre {
        font-size: 20px;
        font-weight: 700;
        font-style: italic;
        text-transform: uppercase;
        background: linear-gradient(to right, #001f3f 0%, #001f3f 100%, transparent 30%);
        -webkit-background-clip: text;
        text-shadow: 0 0 5px #001f3f;
        cursor: pointer;
        position: relative;
        margin-top: 5px;
        transition: color 0.3s, text-shadow 0.3s;
    }

    .plato_nombre:hover {
        color: #ff8c00;
        text-shadow: 0 0 10px #ff8c00;
    }

    .plato_nombre::after {
        content: &#39;
        &#39;
        ;
        position: absolute;
        width: 100%;
        height: 2px;
        background: #ff8c00;
        left: 0;
        bottom: -5px;
        transform: scaleX(0);
        transition: transform 0.3s ease;
    }


    .plato_nombre:hover::after {
        transform: scaleX(1);
    }

    .carrito-icono {
        display: inline-block;
        font-size: 18px;
        margin-left: 5px;
        transition: transform 0.3s ease;
    }

    .carrito-icono:hover {
        transform: scale(1.2) translateY(-3px);
    }

    .btn-group,
    .btn-group-vertical {
        position: relative;
        display: inline-flex;
        vertical-align: middle;
        flex-direction: row;
        flex-wrap: wrap;
        align-content: flex-start;
        justify-content: space-around;
        align-items: baseline;
    }

    .plato_descripcion {
        align-items: flex-start;
        display: flex;
        margin-top: 2px;
        margin-right: 2px;
        flex-direction: column;
        justify-content: center;
        font-size: 13px;
        font-family: math;
        border-bottom: inset;
        border-top: outset;
    }

    .agregar-carrito {
        cursor: pointer;
        color: #007bff;
        margin-right: 10px;
    }

    .plato_monto {
        background-color: initial;
        font-size: 15px;
        font-weight: 600;
        padding: 1px 0;
        color: #2F496E;
        display: inline-block;
    }

    .plato_boton {
        color: white;
        display: block;
        max-width: 80px;
    }

    .btn-dark {
        font-weight: 700;
        color: #fff;
        background-color: #060606;
        border-color: #212529;
    }

    .btn-danger {
        color: #fff;
        font-weight: 700;
        background-color: #ff0018;
        border-color: #dc3545;
    }

    .pagina_titulo {
        height: auto;
        display: flex;
        flex-direction: column;
        font-size: 13px;
        align-items: center;
        justify-content: space-between;
        flex-wrap: nowrap;
    }

    .pagina_titulo p {
        margin-bottom: 1px;
    }

    .review-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        margin-top: 5px;
    }

    .stars-list {
        padding: 0;
        margin: 0;
        list-style: none;
        display: flex;
        flex-direction: row-reverse;
        gap: 5px;
    }

    .stars-list a {
        text-decoration: none;
    }

    .star {
        cursor: pointer;
        font-size: 24px;
        transition: color 0.2s ease, transform 0.2s ease;
    }

    .star:hover,
    .star:hover~.star {
        color: #FFD700;
        transform: scale(1.2);
    }

    .star.selected {
        color: #FFD700;
    }

    .thanks-msg {
        font-size: 16px;
        color: green;
        display: none;
        margin-top: 10px;
    }

    /* Estilo para el contenedor del loader de Carrusel y Datos de tienda*/
    .loader-section {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 20px;
        height: 150px;
        /* Ajusta la altura según lo que necesites */
    }

    .loader-section p {
        margin-top: 10px;
        font-size: 16px;
        font-weight: bold;
        color: #333;
    }

    .spinner-border {
        width: 3rem;
        height: 3rem;
    }

    .pagina_descripcion {
        align-items: flex-start;
        line-height: 10px;
        display: flex;
        margin-top: 10px;
        flex-direction: column;
        justify-content: center;
        font-size: 14px;
    }

    .margen_0 {
        padding: 0.5rem 0.5rem !important;
    }

    /* Estilo para el contenedor del loader de Productos*/
    .loader-container {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        font-size: 16px;
        color: #333;
    }

    .spinner {
        border: 4px solid #f3f3f3;
        /* Fondo claro */
        border-top: 4px solid #3498db;
        /* Parte superior azul */
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 2s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .modal-content {
        font-size: 15px;
        background-color: #fff;
        margin: 5% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 100%;
        max-width: 800px;
    }

    .container-sm {
        max-width: 1200px;
        padding: 5px;
        margin-top: calc(80px + 1vh);
    }

    .input-group&gt;
    .form-control,
    .input-group&gt;

    .form-select {
        position: relative;
        flex: 1 1 auto;
        width: 25%;
        min-width: 0;
    }


    .detalle_titulo {
        background-color: #F6F8FC;
        font-size: 15px;
        font-weight: 500;
        padding: 5px 0;
        margin: 0;
        color: #222222;
        display: inline-block;
        flex-direction: column;
        text-align: center;
    }

    .detalle_contenido {
        font-size: 14px;
        font-weight: 600;
        padding: 1px 0;
        margin: 0;
        color: #323542;
        display: inline-block;
        flex-direction: column;
        text-align: left;
    }

    .detalle_contenido_2 {
        font-size: 15px;
        font-weight: 500;
        padding: 1px 0;
        margin: 0;
        color: #323542;
        display: inline-block;
        flex-direction: column;
        text-align: left;
    }

    body {
        background-color: #f4f4f4;
    }

    #navbarfooter {
        background-color: #fff;
    }

    .custom-width {
        width: 50%;
    }

    .label {
        display: initial !important;
    }

    .color-container {
        display: flex;
        max-height: 120px;
        gap: 2px;
        align-items: stretch;
        margin-bottom: 10px;
        stroke: black;
        stroke-width: 5px;
        stroke-opacity: 0.7;
        flex-wrap: wrap;
        flex-direction: row;
        align-content: space-around;
        justify-content: flex-start;
    }

    .color-container svg,
    .color-container div {
        display: inline-block;
        width: 20px;
        height: 20px;
        border-radius: 50%;
    }

    .color-container div {
        width: 20px;
        height: 20px;
        background: linear-gradient(to right, red, orange, yellow, green, blue, indigo, violet);
        border: 1px solid black;
    }

    .campo-extra {
        display: none;
    }

    #envio_section {
        display: none;
    }

    #checkbox_nuevo:checked~#envio_section {
        display: block;
    }

    /* Color para el ícono de carpeta (Drive) */
    .f-button[title*=&quot;
    Drive&quot;

    ] i {
        color: rgba(255, 255, 255, 0.9) !important;
        vertical-align: middle !important;
    }

    /* Imagen por defecto (modo lista, escritorio) */
    .image-parent {
        max-width: 200px;
        padding: 5px;
    }

    /* Vista compacta (en escritorio) */
    body[data-vista=&quot;
    compacta&quot;

    ] .image-parent {
        max-width: 100%;
    }

    /* Vista compacta (en celular) */
    @media (max-width: 468px) {
        body[data-vista=&quot;
        compacta&quot;

        ] .image-parent {
            max-width: 100%;
        }
    }

    /* Vista lista (en celular) &#8594; solo este afecta lo que pedís */
    @media (max-width: 468px) {
        body[data-vista=&quot;
        lista&quot;

        ] .image-parent {
            max-width: 50%;
        }
    }

    /* Estilo general para imágenes en el carrusel */
    .carousel-inner img {
        width: auto;
        height: auto;
        border-style: double;
        transition: transform 0.5s ease;
        cursor: url(&#39;data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICAgIDxjaXJjbGUgY3g9IjExIiBjeT0iMTEiIHI9IjcuNSIgc3R5bGU9ImZpbGw6bm9uZTtzdHJva2U6IzAwMDtzdHJva2Utd2lkdGg6MztzdHJva2UtbWl0ZXJsaW1pdDoyOyIgLz4KICAgIDxsaW5lIHgxPSIxMSIgeTE9IjgiIHgyPSIxMSIgeTI9IjE0IiBzdHlsZT0iZmlsbDpub25lO3N0cm9rZTojMDAwO3N0cm9rZS13aWR0aDozO3N0cm9rZS1saW5lY2FwOnJvdW5kOyIvPgogICAgPGxpbmUgeDE9IjgiIHkxPSIxMSIgeDI9IjE0IiB5Mj0iMTEiIHN0eWxlPSJmaWxsOm5vbmU7c3Ryb2tlOiMwMDA7c3Ryb2tlLXdpZHRoOjM7c3Ryb2tlLWxpbmVjYXA6cm91bmQ7Ii8+CiAgICA8cGF0aCBkPSJtMjEgMjEtNC4zNS00LjM1IiBzdHlsZT0iZmlsbDpub25lO3N0cm9rZTpjdXJyZW50Q29sb3I7c3Ryb2tlLXdpZHRoOjM7Ii8+Cjwvc3ZnPg==&#39;) 12 12, auto;
    }

    /* Media query para dispositivos de escritorio (computadoras) */
    @media (min-width: 900px) {
        .image-parent:hover .carousel-item img {
            transform: scale(1.5);
        }
    }

    .carousel-inner {
        position: relative;
        width: 100%;
        overflow: hidden;
        padding: 5px;
    }

    .carousel-caption {
        background-color: rgba(0, 0, 0, 0.7);
        color: #fff;
        font-size: small;
        border-radius: 8px;
        padding: 5px;
        position: relative;
        bottom: 0;
        left: 0;
        right: 0;
    }

    .img-thumbnail {
        padding: .25rem;
        background-color: #4d90fe;
        border: 1px solid #dc3545;
        border-radius: 0.25rem;
        max-width: 100%;
        height: auto;
    }

    /* Personalización del modal */
    #btn_cars {
        font-size: 20px;
        border-radius: 10%;
        transition: background-color 0.3s ease;
        /* Transición suave para el cambio de color */
    }

    #btn_cars i {
        font-size: 30px;
        transition: all 0.3s ease;
    }

    #btn_cars:hover i {
        transform: scale(1.1);
        /* Efecto de hover */
    }

    .filtro-activo {
        background-color: red;
        /* Color rojo cuando está activo */
    }

    .filtro-inactivo {
        background-color: transparent;
        /* Sin color de fondo cuando no hay filtro */
    }

    .modal-lg-custom {
        max-width: 900px;
        margin: 1.75rem auto;
    }

    /* Contenedor del input y botón */
    #filtro_producto {
        display: flex !important;
        /* Asegura que estén en una fila */
        align-items: center;
        /* Centra verticalmente */
        gap: 10px;
        /* Espaciado entre el input y el botón */
    }

    /* Estilos para el input */
    #filtro_producto input {
        flex-grow: 1;
        /* Permite que el input ocupe el espacio disponible */
        display: inline-block !important;
        /* Sobrescribe display:block */
        height: auto;
        /* Asegura una altura consistente */
    }

    /* Estilos para el botón */
    #filtro_producto button {
        display: inline-block !important;
        /* Sobrescribe display:block */
        white-space: nowrap;
        /* Evita que el texto se divida */
        height: auto;
        /* Asegura altura consistente */
    }

    .modal-body {
        padding: 10px;
        /* Espaciado interno */
    }

    .categoria-icono svg {
        width: 40px;
        height: 40px;
    }

    /* Ajustes para los botones de las categorías */
    #listadoCategorias {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        justify-content: space-between;
    }

    #listadoCategorias .list-group-item {
        flex: 1 1 calc(50% - 3px);
        text-align: center;
        padding: 2px;
        font-size: 1.9rem;
        border: 1px solid #ddd;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.2s;
    }

    #listadoCategorias .list-group-item:hover {
        background-color: #007bff;
        color: #fff;
        transform: scale(1.05);
    }

    /* Ajustes para pantallas más grandes */
    @media (min-width: 768px) {
        #listadoCategorias .list-group-item {
            flex: 1 1 calc(25% - 4px);
        }
    }

    .fancybox__caption {
        font-size: 35px !important;
        color: #fff;
        font-family: sans-serif;
        font-weight: 700;
        padding: 1px 10px !important;
        border-radius: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        box-sizing: border-box;
    }

    .f-carousel {
        --f-button-width: 38px;
        --f-button-height: 38px;
        --f-button-svg-width: 16px;
        --f-button-svg-height: 16px;
        --f-button-svg-stroke-width: 2.5;
        --f-button-color: rgb(71 85 105);
        --f-button-border-radius: 50%;
        --f-button-shadow: 0 6px 12px -2px rgb(50 50 93 / 25%), 0 3px 7px -3px rgb(0 00 / 30%);
        --f-button-bg: #fff;
        --f-button-hover-bg: #f9f9f9;
        --f-button-active-bg: #f0f0f0;
    }

    .list-group {
        display: flex;
        padding-left: 0;
        margin-bottom: 0;
        border-radius: .25rem;
        flex-wrap: wrap;
        align-content: space-around;
        justify-content: center;
        align-items: stretch;
        flex-direction: row;
    }

    /* Default for List View mainly */
    .list-group-item {
        flex: 1 1 400px;
        max-width: 1200px;
        box-shadow: 4px -4px 10px 0px rgba(0, 0, 0, 0.1);
        box-sizing: border-box;
        border-radius: 5px;
    }

    /* Override for Compact View Products ONLY */
    body[data-vista=&quot;
    compacta&quot;
    ] [id^=&quot;
    contenedor-productos-&quot;

    ] .list-group-item {
        flex: 0 0 auto !important;
        /* Let Bootstrap col- classes handle width */
        max-width: none !important;
        box-shadow: none !important;
    }

    .pedido_producto .list-group-item {
        flex: 1 1 calc(50% - 16px);
        box-shadow: 4px 5px 8px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        padding: 16px;
        background: #fff;
        margin-bottom: 16px;
    }

    .btn-toolbar {
        display: flex;
        flex-wrap: wrap;
        align-content: space-around;
        align-items: center;
        justify-content: center;
        flex-direction: column-reverse;
    }

    .list-group-item+.list-group-item {
        border-width: 2px 1px 2px;
    }

    @media (max-width: 768px) {
        .pedido_producto .list-group-item {
            flex: 1 1 100%;
        }
    }

    button.button-disabled {
        opacity: 0.5;
        pointer-events: none;
    }

    button.button-active {
        opacity: 1;
        pointer-events: auto;
    }

    table.dataTable.compact thead th,
    table.dataTable.compact thead td,
    table.dataTable.compact tfoot th,
    table.dataTable.compact tfoot td,
    table.dataTable.compact tbody th,
    table.dataTable.compact tbody td {
        padding: 1px;
        white-space: nowrap;
    }

    table.dataTable {
        width: 100% !important;
        table-layout: auto;
    }

    .dataTables_wrapper {
        padding: 5px;
        margin-bottom: 87px;
        border-bottom-style: inset;
    }

    @media (max-width: 768px) {
        table.dataTable {
            font-size: 14px;
        }
    }

    #tabla_pedido td,
    #tabla_pedido th {
        text-align: left;
        padding: 5px;
        table-layout: auto;
        margin: -0.25em 0;
    }

    button[onclick*=&quot;
    restar&quot;

    ] {
        background-color: #ff0000 !important;
        color: white !important;
        border: none !important;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    button[onclick*=&quot;
    restar&quot;

    ]:hover {
        background-color: #cc0000 !important;
    }

    button[onclick*=&quot;
    agregar&quot;

    ] {
        background-color: #0033a0 !important;
        color: white !important;
        border: none !important;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    button[onclick*=&quot;
    agregar&quot;

    ]:hover {
        background-color: #002366 !important;
    }


    .cliente-info {
        padding: 10px;
        background-color: rgb(0 0 0 / 5%);
        border-radius: 5px;
        margin-bottom: 10px;
    }

    .cliente-info p {
        margin: 5px 5px;
    }

    .total-info {
        padding: 10px;
        background-color: rgb(0 0 0 / 6%);
        border-radius: 5px;
        margin-top: 15px;
    }

    .detalle-vista-flex {
        display: flex !important;
        flex-wrap: wrap;
        padding-block: 5px;
        align-items: center;
        flex-direction: row;
        justify-content: space-around;
        align-content: center;
    }

    /* Estilo base de las estrellas */
    .estrella i {
        font-size: 19px;
        color: #ccc;
        /* Color de las estrellas vacías */
        transition: color 0.3s ease, transform 0.3s ease;
        cursor: pointer;
    }

    /* Estrellas llenas (valoradas) */
    .estrella .fa-star {
        color: #f5a623;
        /* Color de estrellas llenas */
    }

    /* Efecto de hover en las estrellas */
    .estrella i:hover,
    .estrella i:hover~i {
        color: #ffcc00;
        /* Color al pasar el mouse */
        transform: scale(1.2);
        /* Aumenta el tamaño al hacer hover */
    }

    /* Efecto de clic en las estrellas */
    .estrella i:active {
        animation: bounce 0.3s ease;
        transform: scale(1);
        /* Restablece el tamaño después del clic */
    }

    /* Detalle individual */
    .detalle-cantidad-item {
        padding-bottom: 2px;
    }

    /* Descripción centrada */
    .detalle-variedad {
        font-weight: bold;
        font-size: 14px;
        text-align: center;
    }

    /* Estilo adicional para el botón de carrito */
    .detalle-carrito {
        margin-top: 5px;
        text-align: center;
    }

    /* Estilo del contenedor principal para asegurarse que es relativo */
    .contenedor-producto {
        position: relative;
    }

    #closeAllAccordions {
        padding: 8px 8px;
        font-size: 14px;
        border-radius: 5px;
        transition: all 0.3s ease;
        display: inline-block;
        /* Permite que se ajuste al diseño del contenedor */
    }

    #closeAllAccordions i {
        margin-right: 5px;
    }

    /* Ajustes responsivos para dispositivos móviles */
    @media (max-width: 768px) {
        .d-flex .p-2.bd-highlight {
            flex-wrap: wrap;
            /* Permite que los elementos se ajusten en nuevas filas */
            justify-content: space-around;
            /* Distribuye los elementos en móviles */
        }

        #closeAllAccordions {
            margin-top: 0px;
            text-align: center;
        }
    }

    #spinner {
        position: absolute;
        top: 50%;
        left: 50%;
        z-index: 10;
        /* Asegúrate de que el spinner esté encima del icono */
        display: none;
    }

    #carouselCategorias {
        max-width: 180px;
        /* Define un ancho máximo para el carrusel */
        overflow: hidden;
        /* Oculta cualquier contenido que exceda los límites del contenedor */
        margin-right: 10px;
    }

    .carousel-categorias-inner {
        display: flex;
        /* Asegura que los elementos del carrusel se alineen en fila */
        flex-wrap: nowrap;
        /* Evita que los elementos se envuelvan en varias filas */
    }

    .highlight {
        background-color: yellow;
        animation: fade 2s ease-out;
    }

    @keyframes fade {
        0% {
            background-color: yellow;
        }

        100% {
            background-color: transparent;
        }
    }

    .resaltado {
        background-color: #ffeb3b;
        /* Amarillo claro */
        color: #000;
        /* Texto negro */
        border: 2px solid #ff9800;
        /* Borde naranja */
        transition: background-color 0.3s ease, border 0.3s ease;
        /* Transición suave */
    }

    /* --- ESTILOS REFACTORIZADOS Y UNIFICADOS PARA LAYOUT Y PRODUCTOS --- */

    /* 1. Estilos Base para Sidebars (Ahora para TODAS las pantallas) */
    /* Tomamos tu lógica móvil y la convertimos en el estilo por defecto */
    .filter-sidebar,
    .cart-sidebar {
        position: fixed;
        top: 0;
        width: 370px;
        /* Un ancho fijo y más manejable que el 50% en escritorio */
        max-width: 80%;
        /* Asegura que no ocupe demasiado en pantallas pequeñas */
        height: 100%;
        z-index: 1050;
        background-color: #f8f9fa;
        overflow-y: auto;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        transition: transform 0.3s ease-in-out;
        /* Usamos transform para mejor rendimiento */
    }

    .filter-sidebar {
        left: 0;
        transform: translateX(-100%);
        /* Oculta a la izquierda */
    }

    .cart-sidebar {
        right: 0;
        transform: translateX(100%);
        /* Oculta a la derecha */
    }

    /* Usamos tu clase &#39;.active&#39; para mostrar las sidebars */
    .filter-sidebar.active {
        transform: translateX(0);
    }

    .cart-sidebar.active {
        transform: translateX(0);
    }

    /* Tu overlay funciona perfecto, solo le añadimos la clase &#39;active&#39; */
    .overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        /* Un poco más oscuro para mejor contraste */
        z-index: 1049;
    }

    .overlay.active {
        display: block;
    }

    /* --- ESTILOS PARA BOTONES FLOTANTES Y DE CIERRE --- */

    /* Estilo base para ambos botones flotantes */
    .btn-flotante {
        position: fixed;
        top: 50%;
        /* Los posiciona en la mitad vertical */
        transform: translateY(-50%);
        /* Ajuste fino para centrado perfecto */
        z-index: 1030;
        /* Debajo de los overlays y sidebars */
        background-color: #0d6efd;
        /* Color primario de Bootstrap */
        color: white;
        padding: 12px 8px;
        cursor: pointer;
        display: flex;
        /* Para alinear el ícono y la flecha */
        flex-direction: column;
        align-items: center;
        gap: 8px;
        /* Espacio entre el icono y la flecha */
        font-size: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease-in-out;
    }

    /* Posición y bordes específicos para el botón de Filtros */
    #btn-flotante-filtros {
        left: 0;
        border-radius: 0 10px 10px 0;
        /* Bordes redondeados a la derecha */
    }

    /* Posición y bordes específicos para el botón de Carrito */
    #btn-flotante-carrito {
        right: 0;
        border-radius: 10px 0 0 10px;
        /* Bordes redondeados a la izquierda */
    }

    /* Efecto hover para los botones */
    .btn-flotante:hover {
        background-color: #0b5ed7;
        /* Un azul un poco más oscuro */
        padding-left: 12px;
        padding-right: 12px;
    }

    /* (Opcional pero recomendado) Oculta los botones flotantes cuando su sidebar está abierta */
    .filter-sidebar.active~#btn-flotante-filtros,
    .cart-sidebar.active~#btn-flotante-carrito {
        transform: translateX(200%) translateY(-50%);
        /* Los saca de la pantalla */
        opacity: 0;
    }

    #btn-flotante-filtros {
        transform-origin: left;
    }

    .filter-sidebar.active~#btn-flotante-filtros {
        transform: translateX(-200%) translateY(-50%);
    }


    /* Estilo para los botones de CIERRE DENTRO de las sidebars */
    .sidebar-close-btn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background-color: #e9ecef;
        /* Un gris claro */
        border: 1px solid #dee2e6;
        padding: 15px 5px;
        cursor: pointer;
        font-size: 18px;
        line-height: 1;
        transition: all 0.2s ease;
    }

    /* Posición específica para el botón de cierre de FILTROS */
    #sidebarFiltros .sidebar-close-btn {
        right: -29px;
        /* Lo saca un poco para que se vea como una pestaña */
        border-radius: 0 8px 8px 0;
        border-left: none;
    }

    /* Posición específica para el botón de cierre de CARRITO */
    #sidebarCarrito .sidebar-close-btn {
        left: -29px;
        /* Lo saca un poco para que se vea como una pestaña */
        border-radius: 8px 0 0 8px;
        border-right: none;
    }

    .sidebar-close-btn:hover {
        background-color: #dee2e6;
    }

    /* 2. Contenedor de Productos (Ahora ocupa el espacio liberado) */
    #contenedorProductos {
        width: 100%;
        /* Opcional: añade un ancho máximo para mantener la legibilidad en pantallas muy grandes */
        max-width: 1200px;
        margin: 0 auto;
        /* Centra el contenedor */
        padding: 20px 15px;
        /* Añade algo de espacio interno */
        transition: all 0.3s ease-in-out;
        /* Para una transición suave si fuera necesario */
    }


    /* 3. Grid Responsivo para Tarjetas de Producto (La clave para 3 columnas) */
    /* Este estilo se debe aplicar al contenedor DENTRO del accordion-body */
    .productos-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
        /* Espacio entre tarjetas */
    }

    .producto-card {
        /* Cálculo para 3 columnas, restando el espacio del gap */
        flex: 0 1 calc(33.333% - 1rem);
        min-width: 280px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    /* Media Queries para ajustar el número de columnas en pantallas más pequeñas */
    @media (max-width: 992px) {
        .producto-card {
            /* 2 columnas en tablets */
            flex-basis: calc(50% - 0.75rem);
        }
    }

    @media (max-width: 576px) {
        .productos-grid {
            gap: 1rem;
        }

        .producto-card {
            /* 1 columna en móviles */
            flex-basis: 100%;
        }
    }

    /* (Opcional) Mantén tus estilos de resaltado, funcionan perfecto */
    .producto-item.resaltado-filtro {
        border: 2px solid #ff9800;
        box-shadow: 0 0 10px rgba(255, 152, 0, 0.6);
        transform: scale(1.01);
    }

    .producto-item.no-coincide {
        opacity: 0.3;
        filter: grayscale(100%);
    }

    .resaltado-mini {
        animation: resaltarBloque 1.5s ease;
        background-color: #fff3cd !important;
        border: 2px solid #ffc107 !important;
        border-radius: 8px;
    }

    .boton-actualizado {
        animation: resaltarBloque 1.5s ease;
        background-color: #fff3cd !important;
        border: 2px solid #ffc107 !important;
        border-radius: 6px;
    }

    @keyframes resaltarBloque {
        0% {
            background-color: #fff3cd;
        }

        50% {
            background-color: #ffeeba;
        }

        100% {
            background-color: #fff3cd;
        }
    }

    @media (min-width: 768px) {
        .col-md-8 {
            flex: 0 0 auto;
            width: 72.666667%;
        }
    }

    .producto-item {
        transition: all 0.3s ease;
    }

    .producto-item.oculto {
        display: none !important;
    }


    #mostrarFooterBtn {
        display: none;
        position: fixed;
        bottom: 100px;
        /* un poco más arriba que el navbar oculto */
        left: 20px;
        z-index: 1050;
        background-color: #0d6efd;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 50px;
        font-size: 16px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    #navbarfooter.oculto {
        transform: translateY(100%);
        transition: transform 0.3s ease;
    }

    #navbarfooter.visible {
        transform: translateY(0);
        transition: transform 0.3s ease;
    }

    /* Estilo para pantallas grandes (PC, tablet) */
    .whatsapp-text {
        display: inline-block;
    }

    .whatsapp-text-small {
        display: none;
        /* Oculta el texto corto en pantallas grandes */
    }

    @media (max-width: 768px) {

        /* En pantallas pequeñas, se muestra solo el texto corto y el ícono */
        .whatsapp-text {
            display: none;
            /* Oculta el texto largo en dispositivos pequeños */
        }

        .whatsapp-text-small {
            display: inline-block;
            /* Muestra el texto corto */
            margin-right: -5px;
            margin-left: -5px;
        }

        .whatsapp-btn {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fa-whatsapp {
            margin-left: 2px;
            /* Ajusta el margen del ícono */
        }
    }

    .swal2-container {
        z-index: 99999 !important;
    }

    .sticker-container {
        position: relative;
        display: inline-block;
    }

    .sticker-container {
        position: relative;
        display: inline-block;
    }

    .sticker-portada {
        position: absolute;
        top: 8px;
        left: 8px;
        background-color: rgba(255, 215, 0, 0.9);
        /* dorado transparente */
        color: black;
        font-weight: bold;
        font-size: 0.8rem;
        padding: 2px 6px;
        border-radius: 5px;
        z-index: 10;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }

    /* Vista compacta */
    body[data-vista=&quot;
    compacta&quot;

    ] .producto-item:not(.compacto) {
        display: none !important;
    }

    body[data-vista=&quot;
    lista&quot;

    ] .producto-item.compacto {
        display: none !important;
    }

    .producto-item.compacto {
        display: block;
        text-align: center;
    }

    #accordionFlushExample {
        transition: opacity 0.3s ease-in-out;
    }

    #accordionFlushExample.fade-out {
        opacity: 0;
        pointer-events: none;
    }

    #accordionFlushExample.fade-in {
        opacity: 1;
        pointer-events: auto;
    }

    .btn.active {
        font-weight: bold;
        border-color: #0d6efd;
        background-color: #e7f1ff;
        color: #0d6efd;
    }

    #info-actualizacion {
        font-family: Arial, sans-serif;
        font-size: 16px;
        margin: 20px;
    }

    #btnActualizar {
        cursor: pointer;
        padding: 5px 10px;
        border: none;
        background-color: #28a745;
        color: white;
        border-radius: 4px;
        font-size: 16px;
    }

    #btnActualizar:hover {
        background-color: #218838;
    }

    .filtro-precio {
        width: 100%;
        /* Se adapta al ancho del contenedor */
        padding: 10px 15px;
        margin: 10px 0;
        background-color: #e0f2f1;
        /* color suave, puedes cambiar */
        color: #004d40;
        /* texto en verde oscuro */
        font-weight: 600;
        font-size: 14px;
        border-radius: 6px;
        box-sizing: border-box;
        /* para que padding no aumente el ancho */
        overflow: hidden;
        text-overflow: ellipsis;
        /* recorta texto si no cabe */
        font-family: &#39;
        Segoe UI&#39;
        ,
        Tahoma,
        Geneva,
        Verdana,
        sans-serif;
    }

    /* Estilos para el contenido del SweetAlert */

    /* Contenedor principal dentro del modal */
    .swal-product-details {
        text-align: left;
        padding: 0 10px;
        /* Un poco de espacio a los lados */
    }

    /* Título de cada sección (Talles, Colores) */
    .swal-section-title {
        font-weight: bold;
        color: #333;
        margin-bottom: 10px;
        border-bottom: 1px solid #eee;
        /* Línea sutil debajo del título */
        padding-bottom: 5px;
    }

    /* Contenedor de las &quot;píldoras&quot; (badges) */
    .swal-badges-container {
        display: flex;
        /* La clave para alinear los elementos */
        flex-wrap: wrap;
        /* Permite que los elementos pasen a la siguiente línea */
        gap: 8px;
        /* Espacio uniforme entre cada píldora */
    }

    /* Estilo base para las píldoras de Talle */
    .swal-badge-talle {
        background-color: #f0f0f0;
        color: #333;
        border: 1px solid #ddd;
        font-size: 0.9rem;
        padding: 6px 12px;
    }

    /* Estilo base para las píldoras de Color */
    .swal-badge-color {
        border: 1px solid #ccc;
        font-size: 0.9rem;
        padding: 6px 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    /* Línea divisoria */
    .swal-hr {
        margin: 20px 0;
        border: 0;
        border-top: 1px solid #eee;
    }

    /* Opcional: Hacer el modal un poco más ancho en móviles */
    .swal-wide {
        width: 90% !important;
    }

    /* Estilos corregidos para el encabezado del acordeón */

    /* El botón de Bootstrap ya es un flex container. Le damos espacio a nuestros elementos. */
    .accordion-button {
        align-items: center;
        /* Centra verticalmente el contenido */
    }

    /* Contenedor para el título principal y precio unitario */
    .accordion-title-wrapper {
        flex-grow: 1;
        /* &#161;CLAVE! Hace que este elemento ocupe todo el espacio sobrante. */
        display: flex;
        flex-direction: column;
        line-height: 1.2;
        margin-right: 1rem;
        /* Añade un espacio entre el título y el texto de compra mínima */
    }

    /* Contenedor para el texto de &quot;Compra mínima&quot; */
    .accordion-min-purchase {
        flex-shrink: 0;
        /* &#161;CLAVE! Evita que este elemento se encoja o se rompa en varias líneas. */
        text-align: right;
        font-size: 0.8em;
        color: #6c757d;
        /* Color gris &#39;text-muted&#39; de Bootstrap */
        line-height: 1.2;
        white-space: nowrap;
        /* Evita que el texto se parta en más líneas de las deseadas */
    }

    /* --- Estilos para el Mini Carrito Enriquecido --- */

    /* Contenedor principal de cada item en el carrito */
    .detalle-cantidad-item {
        display: flex;
        align-items: center;
        /* Centra verticalmente los elementos */
        gap: 10px;
        /* Espacio entre imagen, info y controles */
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
    }

    /* Estilo para la imagen del producto en el carrito */
    .carrito-item-imagen {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 8px;
        border: 1px solid #ddd;
    }

    /* Contenedor para la información del producto (nombre, precio) */
    .carrito-item-info {
        flex-grow: 1;
        /* Ocupa el espacio sobrante */
        display: flex;
        flex-direction: column;
        text-align: left;
        /* Alinea el texto a la izquierda */
    }

    .carrito-item-info .plato-descripcion {
        font-weight: bold;
        font-size: 0.9em;
        line-height: 1.2;
    }

    .carrito-item-info .precio-unitario {
        font-size: 0.8em;
        color: #6c757d;
        /* Color gris &#39;text-muted&#39; */
    }

    /* Contenedor para los botones de cantidad y el subtotal */
    .carrito-item-controles {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        /* Alinea los controles a la derecha */
    }

    /* Estilo para el subtotal de cada item */
    .subtotal-item {
        font-weight: bold;
        font-size: 0.9em;
        margin-top: 5px;
    }
</style>

<body>
    <aside class='sidebar-container container sidebar-invisible' role='complementary'>
        <b:section id='sidebar_bottom' />
    </aside>
    <div id='cookie-bar'
        style='position: fixed; bottom: 0; width: 100%; background-color: #1a1a1a; color: #ffffff; text-align: center; padding: 33px 0; z-index: 10000; display: none;'>
        Este sitio usa cookies para mejorar la experiencia de usuario.
        <button id='accept-cookies'
            style='margin-left: 10px; background-color: #4CAF50; color: white; border: none; padding: 10px;'>Aceptar</button>
        <a href='#' id='show-privacidad' style='margin-left: 10px; color: #4CAF50; text-decoration: none;'>Leer más</a>
    </div>
    <div class='modal' id='modal-privacidad' style='display: none;'>
        <div class='modal-content'>
            <span class='close'>&#215;</span>
            <h2>Política de Privacidad y Cookies</h2>
            <p>Este sitio utiliza cookies para mejorar la experiencia del usuario y para el análisis del tráfico web.
                Las cookies son pequeños archivos que se almacenan en su dispositivo para recordar sus preferencias y
                mejorar su experiencia en nuestra web.</p>
            <h3>&#191;Qué son las Cookies?</h3>
            <p>Las cookies son pequeños archivos de texto que se almacenan en su dispositivo cuando visita nuestro sitio
                web. Estas cookies ayudan a mejorar la funcionalidad y rendimiento de nuestro sitio, y permiten
                personalizar la experiencia del usuario.</p>
            <h3>&#191;Qué Cookies Usamos?</h3>
            <ul>
                <li><strong>Cookies de sesión:</strong> Estas cookies se eliminan cuando cierra su navegador y no
                    recopilan información personal.</li>
                <li><strong>Cookies de terceros:</strong> Como Google Analytics, YouTube (si incrustas videos), entre
                    otros. Estas cookies recopilan datos anónimos sobre cómo los visitantes interactúan con el sitio.
                </li>
            </ul>
            <h3>&#191;Cómo Puede Controlar las Cookies?</h3>
            <p>Puede desactivar el uso de cookies en cualquier momento ajustando la configuración de su navegador.</p>
        </div>
    </div>
    <div class='loader-wrapper'>
        <div class='loader-content'>
            <div class='icon-container'>
                <svg class='database' fill='#000000' height='220px' id='Layer_1' version='1.1' viewBox='0 0 508 508'
                    width='220px' xml:space='preserve' xmlns='http://www.w3.org/2000/svg'
                    xmlns:xlink='http://www.w3.org/1999/xlink'><text fill='black' font-family='Arial' font-size='55'
                        text-anchor='middle' x='50%' y='45'>HOSTINGSHOP</text>
                    <g id='SVGRepo_bgCarrier' stroke-width='0' />
                    <g id='SVGRepo_tracerCarrier' stroke-linecap='round' stroke-linejoin='round' />
                    <g id='SVGRepo_iconCarrier'>
                        <path
                            d='M198,155.8c0-1.2,0.8,0,2,0h104c1.2,0,2-1.2,2,0v8h168.4c17.2,0,27.6-18.8,27.6-34V82.2 c0-16.4-11.2-26-27.6-26H39.2c-16,0-33.2,9.2-33.2,26v47.6c0,16,16.4,34,33.2,34H198v-6L198,155.8L198,155.8z'
                            style='fill:#F4EFEF;' />
                        <path
                            d='M335.2,91.8H326h-32H118.8c-8,0-16.8,2.4-16.8,10v8.4c0,7.6,8.8,17.6,16.8,17.6h216.4 c7.6,0,10.8-10,10.8-17.6v-8.4C346,93.8,342.4,91.8,335.2,91.8z'
                            style='fill:#CDEEF9;' />
                        <path
                            d='M75.6,100.2c-0.8-5.6-8.8-10-11.6-11.6c-1.6-0.4-3.2-0.8-5.2-0.8c-9.6,0-17.6,8-17.6,17.6 s8,17.6,17.6,17.6s17.6-8,17.6-17.6c0-1.2-0.4-2.4-0.4-3.6C75.6,101.8,75.6,101,75.6,100.2z'
                            style='fill:#E8E3E3;' />
                        <g>
                            <path
                                d='M462.8,115.8c3.2,0,6.4-1.6,8.4-4c1.2-1.2,2.4-3.2,1.6-6c-1.2-7.2-8.8-10-10.4-10.4 c-5.6,0-10,4.8-10,10C452.8,111.4,457.2,115.8,462.8,115.8z'
                                style='fill:#61C2AB;' />
                            <path
                                d='M422.8,115.8c2.8,0,5.6-1.2,7.6-3.2c1.6-2,2.8-4.4,2.4-6.8c-0.8-8.8-6-10.4-8.8-10.4 c-0.4,0-0.8,0-0.8,0c-6,0-10.4,4.4-10.4,10C412.8,111.4,417.2,115.8,422.8,115.8z'
                                style='fill:#61C2AB;' />
                            <path
                                d='M382.8,115.8c2.8,0,5.6-1.2,7.6-3.2c1.6-2,2.4-4.4,2.4-6.8c-0.8-9.6-8.4-10.4-10-10.4 c-5.6,0-10.4,4.4-10.4,10C372.8,111.4,377.2,115.8,382.8,115.8z'
                                style='fill:#61C2AB;' />
                        </g>
                        <g>
                            <path
                                d='M118.8,275.8c-10,0-20.8-12.4-20.8-22v-8.4c0-10,10.4-13.6,20.8-13.6H198v-32H39.2 c-16,0-33.2,9.2-33.2,26v47.6c0,16.4,16.4,34,33.2,34h168.4l-26-32h-62.8V275.8z'
                                style='fill:#F4EFEF;' />
                            <path
                                d='M338.8,253.4l-38.4,54.4H474c17.2,0,27.6-18.8,27.6-34.4v-47.6c0-16.4-11.2-26-27.6-26H306v50 L338.8,253.4z'
                                style='fill:#F4EFEF;' />
                        </g>
                        <path
                            d='M118.8,235.8c-8,0-16.8,2.4-16.8,9.6v8.4c0,7.6,8.8,18,16.8,18H178l-13.6-17.6 c-0.4-0.4-0.4-0.8-0.4-1.6c0.4-0.8,1.2-0.8,2-0.8h28h4v-10v-6H118.8z'
                            style='fill:#CDEEF9;' />
                        <g>
                            <path
                                d='M335.2,235.8H326h-20v16h8h28c0.8,0,1.6-0.4,2,0c0.4,0.8,0.4,2-0.4,2.8L330,271.8h5.2 c7.6,0,10.8-10.4,10.8-18v-8.4C346,237.4,342.4,235.8,335.2,235.8z'
                                style='fill:#E8E3E3;' />
                            <path
                                d='M64,232.6c-1.6-0.4-3.6-0.8-5.2-0.8c-9.6,0-17.6,8-17.6,17.6s8,17.6,17.6,17.6s17.6-8,17.6-17.6 c0-1.6,0-3.6-0.8-5.2C72.4,236.2,64,232.6,64,232.6z'
                                style='fill:#E8E3E3;' />
                        </g>
                        <g>
                            <path
                                d='M462.8,259.8c2.8,0,6-1.2,7.6-3.2s2.4-4.4,2.4-6.4c-0.8-9.6-10-10.4-10.4-10.4c-5.6,0-10,4.4-10,10 C452.8,255.4,457.2,259.8,462.8,259.8z'
                                style='fill:#61C2AB;' />
                            <path
                                d='M422.8,259.8c3.2,0,6.4-1.6,8.4-4c1.2-1.2,2.4-3.2,1.6-6c-1.6-9.6-7.2-10.4-9.6-10.4 c-0.4,0-0.4,0-0.4,0c-6,0-10.4,4.4-10.4,10C412.8,255.4,417.2,259.8,422.8,259.8z'
                                style='fill:#61C2AB;' />
                            <path
                                d='M382.8,259.8c3.2,0,6.8-1.6,8.8-4c0.8-1.2,2-3.2,1.6-5.6c-2.4-10-8.8-10.4-10-10.4 c-5.6,0-10.4,4.4-10.4,10C372.8,255.4,377.2,259.8,382.8,259.8z'
                                style='fill:#61C2AB;' />
                        </g>
                        <path
                            d='M474.4,343.8H271.2l-15.6,18.4c-0.4,0.4-0.8,0.4-1.6,0.4s-1.2,0.4-1.6,0l-15.6-18.4H39.2 c-16,0-33.2,9.2-33.2,25.6v47.6c0,16.4,16.4,34.4,33.2,34.4h435.2c17.2,0,27.6-18.8,27.6-34.4v-47.6 C502,353,490.8,343.8,474.4,343.8z'
                            style='fill:#F4EFEF;' />
                        <path
                            d='M102,389.4v8.4c0,7.6,8.8,18,16.8,18h216.4c7.6,0,10.8-10.4,10.8-18v-8.4c0-8-3.6-9.6-10.8-9.6H326 h-32H118.8C110.4,379.8,102,382.2,102,389.4z'
                            style='fill:#CDEEF9;' />
                        <path
                            d='M75.6,387.8c-0.8-8-11.2-11.2-11.6-11.2c-1.6-0.4-3.6-0.8-5.6-0.8c-9.6,0-17.6,8-17.6,17.6 s8,17.6,17.6,17.6S76,403,76,393.4c0-1.2-0.4-2-0.4-3.2C76,389.4,75.6,388.6,75.6,387.8z'
                            style='fill:#E8E3E3;' />
                        <g>
                            <path
                                d='M462.8,383.4c-5.6,0-10,4.4-10,10s4.4,10,10,10c2.8,0,5.6-1.2,7.6-3.2c1.6-2,2.4-4.4,2.4-6.8 C472.4,383.8,464,383.4,462.8,383.4z'
                                style='fill:#61C2AB;' />
                            <path
                                d='M422.8,383.4c-5.6,0-10,4.4-10,10s4.4,10,10,10c2.8,0,5.6-1.2,7.2-3.2c2-2,2.8-4.4,2.8-6.8 C432.8,383.8,424,383.4,422.8,383.4z'
                                style='fill:#61C2AB;' />
                            <path
                                d='M382.8,383.4c-5.6,0-10,4.4-10,10s4.4,10,10,10c2.8,0,6-1.2,7.6-3.6c1.6-2,2.4-4,2.4-6.4 C392.4,383.8,383.2,383.4,382.8,383.4z'
                                style='fill:#61C2AB;' />
                        </g>
                        <path
                            d='M316,255.8h-12c-0.8,0-1.6-1.6-2-2.4c0,0,0-1.2,0-1.6v-86v-6H202v2v4v28v4v32v4v18c0,1.2-0.8,4-2,4 h-2h-6h-22l13.6,15.6l25.6,31.2l29.2,35.6l1.2,1.2l2,2.4l12,14.8l12-14.8l2-2.4l1.2-1.6l29.2-36l25.6-30.4l13.6-15.6L316,255.8 L316,255.8z'
                            style='fill:#54B265;' />
                        <path
                            d='M474.4,169.8H306c-2.4,0-4-1.6-4-4s1.6-4,4-4h168.4c15.2,0,25.6-16.4,25.6-32V82.2c0-14.8-10-24-25.6-24H39.2 C24,58.2,8,67.4,8,82.2v47.6c0,15.6,16,32,31.2,32H198c2.4,0,4,1.6,4,4s-1.6,4-4,4H39.2c-19.6,0-39.2-20-39.2-40V82.2 c0-20,20-32,39.2-32h435.2c20,0,33.6,12.8,33.6,32v47.6C508,149,494.4,169.8,474.4,169.8z' />
                        <path
                            d='M335.2,133.8H118.8c-10.8,0-18.8-8.4-18.8-19.6v-12.4c0-6,2.4-16,18.8-16H294c2.4,0,4,1.6,4,4s-1.6,4-4,4H118.8 c-10,0-10.8,4-10.8,8v12.4c0,6.8,4.4,11.6,10.8,11.6h216.4c7.6,0,8.8-7.2,8.8-11.6v-12.4c0-5.6-1.2-8-8.8-8H326c-2.4,0-4-1.6-4-4 s1.6-4,4-4h9.2c11.2,0,16.8,5.2,16.8,16v12.4C352,126.2,345.2,133.8,335.2,133.8z' />
                        <path
                            d='M58.8,129.4c-13.2,0-23.6-10.8-23.6-23.6S46,82.2,58.8,82.2c2.4,0,4.8,0.4,7.2,1.2c2,0.8,3.2,2.8,2.4,5.2 c-0.8,2-2.8,3.2-5.2,2.4c-1.6-0.4-3.2-0.8-4.8-0.8c-8.8,0-15.6,7.2-15.6,15.6s7.2,15.6,15.6,15.6S74,114.2,74,105.8 c0-1.6-0.4-3.2-0.8-4.8c-0.8-2,0.4-4.4,2.8-4.8c2-0.8,4.4,0.4,4.8,2.8c0.8,2.4,1.2,4.4,1.2,6.8C82.4,119,71.6,129.4,58.8,129.4z' />
                        <path
                            d='M462.8,121.8c-8.8,0-16-7.2-16-16s7.2-16,16-16c2.4,0,4,1.6,4,4s-1.6,4-4,4c-4.4,0-8,3.6-8,8s3.6,8,8,8s8-3.6,8-8 c0-2.4,1.6-4,4-4s4,1.6,4,4C479.2,114.6,472,121.8,462.8,121.8z' />
                        <path
                            d='M422.8,121.8c-8.8,0-16-7.2-16-16s7.2-16,16-16c2.4,0,4,1.6,4,4s-1.6,4-4,4c-4.4,0-8,3.6-8,8s3.6,8,8,8s8-3.6,8-8 c0-2.4,1.6-4,4-4s4,1.6,4,4C439.2,114.6,432,121.8,422.8,121.8z' />
                        <path
                            d='M382.8,121.8c-8.8,0-16-7.2-16-16s7.2-16,16-16c2.4,0,4,1.6,4,4s-1.6,4-4,4c-4.4,0-8,3.6-8,8s3.6,8,8,8s8-3.6,8-8 c0-2.4,1.6-4,4-4s4,1.6,4,4C399.2,114.6,391.6,121.8,382.8,121.8z' />
                        <path
                            d='M210,313.8H39.2c-19.6,0-39.2-20-39.2-40.4v-47.6c0-20.8,20-32,39.2-32H198c2.4,0,4,1.6,4,4s-1.6,4-4,4H39.2 c-15.2,0-31.2,8.4-31.2,24v47.6c0,15.6,16,32.4,31.2,32.4H210c2.4,0,4,1.6,4,4S212.4,313.8,210,313.8z' />
                        <path
                            d='M474.4,313.8H298c-2.4,0-4-1.6-4-4s1.6-4,4-4h176.4c15.2,0,25.6-16.8,25.6-32.4v-47.6c0-14.8-10-24-25.6-24H306 c-2.4,0-4-1.6-4-4s1.6-4,4-4h168.4c20.4,0,33.6,12.4,33.6,32v47.6C508,293,494.4,313.8,474.4,313.8z' />
                        <path
                            d='M182,277.8h-63.2c-10.8,0-18.8-8.4-18.8-20v-12.4c0-6,2.4-15.6,18.8-15.6H198c2.4,0,4,1.6,4,4s-1.6,4-4,4h-79.2 c-10,0-10.8,4-10.8,7.6v12.4c0,6,3.6,12,10.8,12H182c2.4,0,4,1.6,4,4S184.4,277.8,182,277.8z' />
                        <path
                            d='M335.2,277.8H330c-2.4,0-4-1.6-4-4s1.6-4,4-4h5.2c8,0,8.8-8.4,8.8-12v-12.4c0-5.6-1.2-7.6-8.8-7.6H326c-2.4,0-4-1.6-4-4 s1.6-4,4-4h9.2c11.2,0,16.8,5.2,16.8,15.6v12.4C352,269.8,345.2,277.8,335.2,277.8z' />
                        <path
                            d='M58.8,273.4c-13.2,0-23.6-10.8-23.6-23.6c0-13.2,10.8-23.6,23.6-23.6c2.4,0,4.8,0.4,7.2,1.2c2,0.8,3.2,2.8,2.4,5.2 c-0.8,2-2.8,3.2-5.2,2.4c-1.6-0.4-3.2-0.8-4.8-0.8c-8.8,0-15.6,7.2-15.6,15.6s7.2,15.6,15.6,15.6S74,258.2,74,249.8 c0-1.6-0.4-3.2-0.8-4.8c-0.8-2,0.4-4.4,2.8-4.8c2-0.8,4.4,0.4,4.8,2.8c0.8,2.4,1.2,4.4,1.2,6.8C82.4,263,71.6,273.4,58.8,273.4z' />
                        <path
                            d='M462.8,265.8c-8.8,0-16-7.2-16-16s7.2-16,16-16c2.4,0,4,1.6,4,4s-1.6,4-4,4c-4.4,0-8,3.6-8,8s3.6,8,8,8s8-3.6,8-8 c0-2.4,1.6-4,4-4s4,1.6,4,4C479.2,258.6,472,265.8,462.8,265.8z' />
                        <path
                            d='M422.8,265.8c-8.8,0-16-7.2-16-16s7.2-16,16-16c2.4,0,4,1.6,4,4s-1.6,4-4,4c-4.4,0-8,3.6-8,8s3.6,8,8,8s8-3.6,8-8 c0-2.4,1.6-4,4-4s4,1.6,4,4C439.2,258.6,432,265.8,422.8,265.8z' />
                        <path
                            d='M382.8,265.8c-8.8,0-16-7.2-16-16s7.2-16,16-16c2.4,0,4,1.6,4,4s-1.6,4-4,4c-4.4,0-8,3.6-8,8s3.6,8,8,8s8-3.6,8-8 c0-2.4,1.6-4,4-4s4,1.6,4,4C399.2,258.6,391.6,265.8,382.8,265.8z' />
                        <path
                            d='M474.4,457.8H39.2C20,457.8,0,437.4,0,417.4v-47.6c0-20.8,20-31.6,39.2-31.6H238c2.4,0,4,1.6,4,4s-1.6,4-4,4H39.2 C24,346.2,8,354.6,8,369.8v47.6c0,15.6,16,32.4,31.2,32.4h435.2c15.2,0,25.6-17.2,25.6-32.4v-47.6c0-14.8-9.6-23.6-25.6-23.6H270 c-2.4,0-4-1.6-4-4s1.6-4,4-4h204.4c20.4,0,33.6,12.4,33.6,31.6v47.6C508,437,494.4,457.8,474.4,457.8z' />
                        <path
                            d='M335.2,421.8H118.8c-10.8,0-18.8-8.8-18.8-20v-12.4c0-7.2,3.2-15.6,18.8-15.6H294c2.4,0,4,1.6,4,4s-1.6,4-4,4H118.8 c-10,0-10.8,3.6-10.8,7.6v12.4c0,6,3.6,12,10.8,12h216.4c8,0,8.8-8.4,8.8-12v-12.4c0-5.6-1.2-7.6-8.8-7.6H326c-2.4,0-4-1.6-4-4 s1.6-4,4-4h9.2c7.2,0,16.8,1.6,16.8,15.6v12.4C352,413.8,345.2,421.8,335.2,421.8z' />
                        <path
                            d='M58.8,417.4c-13.2,0-23.6-10.8-23.6-23.6s10.8-23.6,23.6-23.6c2.4,0,4.8,0.4,7.2,1.2c2,0.8,3.2,2.8,2.4,5.2 c-0.8,2-2.8,3.2-5.2,2.4c-1.6-0.4-3.2-0.8-4.8-0.8c-8.8,0-15.6,7.2-15.6,15.6c0,8.8,7.2,15.6,15.6,15.6S74,402.2,74,393.8 c0-1.6-0.4-3.2-0.8-4.8c-0.8-2,0.4-4.4,2.8-5.2c2-0.8,4.4,0.4,4.8,2.8c0.8,2.4,1.2,4.4,1.2,6.8C82.4,406.6,71.6,417.4,58.8,417.4z' />
                        <path
                            d='M462.8,409.4c-8.8,0-16-7.2-16-16s7.2-16,16-16c2.4,0,4,1.6,4,4s-1.6,4-4,4c-4.4,0-8,3.6-8,8s3.6,8,8,8s8-3.6,8-8 c0-2.4,1.6-4,4-4s4,1.6,4,4C479.2,402.2,472,409.4,462.8,409.4z' />
                        <path
                            d='M422.8,409.4c-8.8,0-16-7.2-16-16s7.2-16,16-16c2.4,0,4,1.6,4,4s-1.6,4-4,4c-4.4,0-8,3.6-8,8s3.6,8,8,8s8-3.6,8-8 c0-2.4,1.6-4,4-4s4,1.6,4,4C439.2,402.2,432,409.4,422.8,409.4z' />
                        <path
                            d='M382.8,409.4c-8.8,0-16-7.2-16-16s7.2-16,16-16c2.4,0,4,1.6,4,4s-1.6,4-4,4c-4.4,0-8,3.6-8,8s3.6,8,8,8s8-3.6,8-8 c0-2.4,1.6-4,4-4s4,1.6,4,4C399.2,402.2,391.6,409.4,382.8,409.4z' />
                        <path
                            d='M254,365.8c-1.2,0-2.4-0.4-3.2-1.6l-88-108c-0.8-1.2-1.2-2.8-0.4-4.4c0.8-1.2,2-2.4,3.6-2.4h30v-92c0-2.4,1.6-4,4-4h104 c2.4,0,4,1.6,4,4v92h34c1.6,0,2.8,0.8,3.6,2.4c0.8,1.2,0.4,3.2-0.4,4.4l-88,108C256.4,365.4,255.2,365.8,254,365.8z M174.4,257.8 l79.6,97.6l79.6-97.6H304c-2.4,0-4-1.6-4-4v-92h-96v92c0,2.4-1.6,4-4,4H174.4z' />
                    </g>
                </svg>
            </div>
            <div class='products-container'>
                <svg class='product' height='40' viewBox='0 0 24 24' width='40' xmlns='http://www.w3.org/2000/svg'>
                    <rect fill='#e67e22' height='14' rx='4' ry='4' width='14' x='5' y='5' />
                    <text fill='white' font-size='10' text-anchor='middle' x='12' y='17'>P1</text>
                </svg>
                <svg class='product' height='40' viewBox='0 0 24 24' width='40' xmlns='http://www.w3.org/2000/svg'>
                    <rect fill='#e67e22' height='14' rx='4' ry='4' width='14' x='5' y='5' />
                    <text fill='white' font-size='10' text-anchor='middle' x='12' y='17'>P2</text>
                </svg>
                <svg class='product' height='40' viewBox='0 0 24 24' width='40' xmlns='http://www.w3.org/2000/svg'>
                    <rect fill='#e67e22' height='14' rx='4' ry='4' width='14' x='5' y='5' />
                    <text fill='white' font-size='10' text-anchor='middle' x='12' y='17'>P3</text>
                </svg>
                <svg class='product' height='40' viewBox='0 0 24 24' width='40' xmlns='http://www.w3.org/2000/svg'>
                    <rect fill='#e67e22' height='14' rx='4' ry='4' width='14' x='5' y='5' />
                    <text fill='white' font-size='10' text-anchor='middle' x='12' y='17'>P4</text>
                </svg>
                <svg class='product' height='40' viewBox='0 0 24 24' width='40' xmlns='http://www.w3.org/2000/svg'>
                    <rect fill='#e67e22' height='14' rx='4' ry='4' width='14' x='5' y='5' />
                    <text fill='white' font-size='10' text-anchor='middle' x='12' y='17'>P5</text>
                </svg>
            </div>
            <svg class='tiendaonline' fill='#000000' height='220px' id='Layer_1' version='1.1'
                viewBox='0 0 426.917 426.917' width='220px' xml:space='preserve' xmlns='http://www.w3.org/2000/svg'
                xmlns:xlink='http://www.w3.org/1999/xlink'>
                <g id='SVGRepo_bgCarrier' stroke-width='0' />
                <g id='SVGRepo_tracerCarrier' stroke-linecap='round' stroke-linejoin='round' />
                <g id='SVGRepo_iconCarrier'>
                    <g>
                        <rect height='47.048' style='fill:#666666;' width='88' x='169.463' y='371.636' />
                        <path
                            d='M397.194,112.92v250.49c0,9.94-8.05,18-17.99,18H47.714c-9.94,0-18-8.06-18-18V112.92H397.194z'
                            style='fill:#808080;' />
                        <rect height='218.487' style='fill:#FFFFFF;' width='317.482' x='54.722' y='137.917' />
                        <g>
                            <rect height='18.707' style='fill:#CCCCCC;' width='290' x='68.463' y='220.368' />
                            <rect height='18.707' style='fill:#CCCCCC;' width='290' x='68.463' y='186.781' />
                            <rect height='18.707' style='fill:#CCCCCC;' width='290' x='68.463' y='321.13' />
                            <rect height='18.707' style='fill:#CCCCCC;' width='290' x='68.463' y='287.543' />
                            <rect height='18.707' style='fill:#CCCCCC;' width='290' x='68.463' y='253.956' />
                        </g>
                        <path
                            d='M397.194,112.92v250.49c0,9.94-8.05,18-17.99,18h-91.98 l-81.83-268.49L397.194,112.92L397.194,112.92z'
                            style='opacity:0.32;fill:#FFFFFF;enable-background:new ;' />
                        <path
                            d='M317.314,112.92v-0.56h-7.7v0.56h-279.9v93.36 c16.03,3.96,33.56,0.17,46.73-11.36h0.01l0.01,0.01c12.65,11.07,29.33,14.99,44.84,11.77v72.37c-19.18,1.93-34.15,18.11-34.15,37.8 c0,20.98,17.01,37.99,38,37.99c20.98,0,37.99-17.01,37.99-37.99c0-19.69-14.97-35.87-34.14-37.8v-74.6 c5.71-2.14,11.12-5.32,15.94-9.54l0.01-0.01c19.6,17.17,48.89,17.17,68.49,0l0.01,0.01c2.51,2.19,5.19,4.11,7.97,5.74v109.09 l-7.24,5.11l-14.47,10.24v56.3h51.12v-56.3l-21.71-15.35v-105.4c17.55,6.71,37.96,3.57,52.81-9.43l0.01-0.01l0.01,0.01 c8.04,7.04,17.7,11.19,27.66,12.45v76.24l-4.42,3.12l-10.79,7.64v74.352h38.12V294.38l-15.21-10.76v-75.84 c11.85-0.25,23.62-4.53,33.12-12.85l0.01-0.01l0.01,0.01c13.17,11.54,30.71,15.32,46.74,11.36v-93.37 C397.194,112.92,317.314,112.92,317.314,112.92z M134.535,296c0,5.18-4.2,9.38-9.38,9.38c-5.18,0-9.38-4.2-9.38-9.38 c0-3.8,2.27-7.08,5.53-8.55v6.41c0,2.12,1.72,3.85,3.85,3.85c2.12,0,3.85-1.73,3.85-3.85v-6.41 C132.264,288.92,134.535,292.2,134.535,296z M234.064,326.21c0,4.85-3.93,8.79-8.79,8.79s-8.79-3.94-8.79-8.79 c0-3.48,2.02-6.47,4.94-7.9v4.6c0,2.12,1.72,3.85,3.85,3.85c2.12,0,3.85-1.73,3.85-3.85v-4.6 C232.055,319.74,234.064,322.73,234.064,326.21z M320.025,295.2c0,3.62-2.94,6.56-6.56,6.56s-6.56-2.94-6.56-6.56 c0-2.19,1.07-4.11,2.71-5.31v2.38c0,2.12,1.72,3.85,3.85,3.85c2.12,0,3.85-1.73,3.85-3.85v-2.38 C318.954,291.09,320.025,293.01,320.025,295.2z'
                            style='opacity:0.32;fill:#333333;enable-background:new ;' />
                        <path
                            d='M323.619,426.917h-220.31c0-4.97,2.02-9.47,5.27-12.73c3.26-3.25,7.76-5.27,12.73-5.27h184.31 C315.559,408.917,323.619,416.977,323.619,426.917z'
                            style='fill:#808080;' />
                        <path
                            d='M323.619,426.917h-105.91l-5.49-18h93.4 C315.559,408.917,323.619,416.977,323.619,426.917z'
                            style='opacity:0.32;fill:#FFFFFF;enable-background:new ;' />
                        <g>
                            <g>
                                <path
                                    d='M213.463,307.037l-11.091,7.837l-14.465,10.233v75.052h51.112v-75.052L213.463,307.037z M213.463,335c-4.858,0-8.793-3.935-8.793-8.793s3.935-8.793,8.793-8.793s8.793,3.935,8.793,8.793S218.321,335,213.463,335z'
                                    style='fill:#FC7A51;' />
                            </g>
                            <path
                                d='M217.314,143v179.91c0,2.12-1.73,3.85-3.85,3.85c-2.13,0-3.85-1.73-3.85-3.85V143H217.314z'
                                style='fill:#29ABE2;' />
                            <path
                                d='M209.614,135.747h7.7v40.01 c-1.32-0.96-2.61-1.99-3.86-3.08l-0.01-0.01c-1.24,1.09-2.52,2.1-3.83,3.06V135.747z'
                                style='opacity:0.32;fill:#333333;enable-background:new ;' />
                            <g>
                                <g>
                                    <path
                                        d='M201.884,369.122c-4.151,0-7.529-3.377-7.529-7.529s3.377-7.529,7.529-7.529 c4.151,0,7.529,3.378,7.529,7.529S206.036,369.122,201.884,369.122z M201.884,357.268c-2.385,0-4.324,1.94-4.324,4.325 s1.94,4.325,4.324,4.325c2.385,0,4.325-1.94,4.325-4.325S204.269,357.268,201.884,357.268z'
                                        style='fill:#666666;' />
                                    <path
                                        d='M225.04,389.521c-4.151,0-7.529-3.378-7.529-7.529c0-4.152,3.378-7.529,7.529-7.529 s7.529,3.378,7.529,7.529C232.57,386.144,229.192,389.521,225.04,389.521z M225.04,377.667c-2.385,0-4.325,1.94-4.325,4.325 s1.94,4.325,4.325,4.325s4.325-1.94,4.325-4.325S227.425,377.667,225.04,377.667z'
                                        style='fill:#666666;' />
                                </g>
                                <rect height='38.223' style='fill:#666666;'
                                    transform='matrix(-0.9809 -0.1947 0.1947 -0.9809 350.5022 778.0496)' width='3.204'
                                    x='211.885' y='352.688' />
                            </g>
                        </g>
                        <g>
                            <path
                                d='M120.464,274.011c-20.984,0-37.994,17.011-37.994,37.994c0,20.984,17.011,37.994,37.994,37.994 s37.994-17.011,37.994-37.994C158.459,291.022,141.448,274.011,120.464,274.011z M120.464,300.523c-5.181,0-9.381-4.2-9.381-9.381 s4.2-9.381,9.381-9.381s9.381,4.2,9.381,9.381C129.846,296.323,125.646,300.523,120.464,300.523z'
                                style='fill:#F9DE58;' />
                            <path
                                d='M124.314,143v146c0,2.12-1.73,3.85-3.85,3.85c-2.13,0-3.85-1.73-3.85-3.85V143H124.314z'
                                style='fill:#86D359;' />
                            <path d='M116.614,149.667h7.7v47.99c-2.53,0.69-5.11,1.18-7.7,1.48 V149.667z'
                                style='opacity:0.32;fill:#333333;enable-background:new ;' />
                            <polygon
                                points='121.868,337.524 105.693,317.265 111.529,312.552 121.139,324.683 137.597,298.401 143.928,302.425 '
                                style='fill:#FFFFFF;' />
                        </g>
                        <g>
                            <g>
                                <path
                                    d='M306.464,276.037l-8.273,5.846l-10.79,7.633v74.356h38.126v-74.356L306.464,276.037z M306.464,296.896c-3.624,0-6.559-2.935-6.559-6.559s2.935-6.559,6.559-6.559s6.559,2.935,6.559,6.559 C313.024,293.96,310.088,296.896,306.464,296.896z'
                                    style='fill:#29ABE2;' />
                            </g>
                            <path
                                d='M310.314,107.5v179.91c0,2.12-1.73,3.85-3.85,3.85c-2.13,0-3.85-1.73-3.85-3.85V107.5H310.314z'
                                style='fill:#FC7A51;' />
                            <path d='M310.314,140.667v49.48c-2.59-0.3-5.17-0.79-7.7-1.47 v-48.01H310.314z'
                                style='opacity:0.32;fill:#333333;enable-background:new ;' />
                            <g>
                                <path
                                    d='M306.464,344.621h-7.734v-4.307h7.734c3.077,0,5.581-2.503,5.581-5.58s-2.504-5.58-5.581-5.58 c-5.452,0-9.887-4.435-9.887-9.887s4.436-9.888,9.887-9.888h7.734v4.307h-7.734c-3.077,0-5.58,2.503-5.58,5.58 s2.503,5.58,5.58,5.58c5.452,0,9.888,4.436,9.888,9.888C316.352,340.185,311.916,344.621,306.464,344.621z'
                                    style='fill:#666666;' />
                                <rect height='10.533' style='fill:#666666;' width='4.307' x='304.309' y='301' />
                                <rect height='10.533' style='fill:#666666;' width='4.307' x='304.309' y='342.467' />
                            </g>
                        </g>
                        <path
                            d='M416.187,153.894l-9.517-51.977l-6.85-37.39c-2.18-11.94-12.59-20.61-24.73-20.61H335.2h-60.87 h-60.87h-60.87H91.72h-39.9c-12.13,0-22.54,8.67-24.73,20.61l-6.85,37.39l-9.51,51.97c-1.979,10.813,4.192,21.519,14.588,25.09 c17.156,5.894,36.748,2.54,51.131-10.06h0.01l0.01,0.01c19.6,17.16,48.88,17.16,68.48,0l0.01-0.01c19.6,17.17,48.89,17.17,68.49,0 l0.01,0.01c19.6,17.16,48.88,17.16,68.48,0l0.01-0.01l0.01,0.01c19.59,17.17,48.88,17.17,68.48,0l0.01-0.01l0.01,0.01 c14.384,12.6,33.98,15.954,51.138,10.061C411.996,175.416,418.167,164.708,416.187,153.894z'
                            style='fill:#E6E6E6;' />
                        <path
                            d='M350.459,168.927l-0.01-0.01l-0.01,0.01c-19.6,17.17-48.89,17.17-68.48,0l-4.09-67.01l-3.54-58 h60.87l7.08,58L350.459,168.927z'
                            style='fill:#FC7A51;' />
                        <path
                            d='M213.459,43.917v125.01l-0.01-0.01c-19.6,17.17-48.89,17.17-68.49,0h-0.01l4.1-67l3.54-58 C152.589,43.917,213.459,43.917,213.459,43.917z'
                            style='fill:#FC7A51;' />
                        <path
                            d='M91.719,43.917l-7.09,58l-8.18,67c-14.384,12.601-33.976,15.954-51.131,10.06 c-10.397-3.572-16.567-14.277-14.588-25.09l9.51-51.97l6.85-37.39c2.19-11.94,12.6-20.61,24.73-20.61 C51.82,43.917,91.719,43.917,91.719,43.917z'
                            style='fill:#FC7A51;' />
                        <rect height='80' style='fill:#2BE0C6;' width='180' x='123.454' />
                        <rect height='56' style='fill:#E6E6E6;' width='156' x='135.459' y='12' />
                        <g>
                            <path
                                d='M183.264,32.967c-0.193-0.191-0.543-0.453-1.053-0.783c-0.508-0.33-1.127-0.653-1.855-0.97 c-0.729-0.315-1.52-0.584-2.371-0.805c-0.854-0.22-1.721-0.33-2.6-0.33c-1.568,0-2.736,0.289-3.506,0.866 c-0.771,0.578-1.156,1.39-1.156,2.435c0,0.604,0.145,1.107,0.434,1.505c0.289,0.399,0.709,0.75,1.258,1.053 c0.551,0.303,1.244,0.577,2.084,0.824c0.838,0.248,1.809,0.51,2.908,0.784c1.43,0.386,2.729,0.798,3.898,1.237 c1.168,0.44,2.158,0.99,2.969,1.65c0.813,0.66,1.438,1.45,1.877,2.372c0.439,0.921,0.66,2.056,0.66,3.402 c0,1.568-0.295,2.908-0.887,4.022c-0.592,1.113-1.389,2.015-2.393,2.702s-2.158,1.189-3.465,1.505 c-1.307,0.316-2.674,0.475-4.104,0.475c-2.201,0-4.373-0.33-6.518-0.99c-2.146-0.659-4.07-1.594-5.775-2.805l2.516-4.909 c0.248,0.248,0.695,0.571,1.342,0.97c0.645,0.399,1.408,0.798,2.289,1.196c0.879,0.399,1.855,0.736,2.928,1.011 c1.072,0.275,2.172,0.412,3.301,0.412c3.135,0,4.703-1.003,4.703-3.011c0-0.633-0.18-1.169-0.537-1.609 c-0.357-0.439-0.865-0.824-1.525-1.154s-1.459-0.633-2.393-0.908c-0.936-0.274-1.98-0.577-3.135-0.907 c-1.404-0.385-2.621-0.805-3.652-1.258c-1.031-0.454-1.891-0.99-2.578-1.609c-0.688-0.618-1.203-1.333-1.547-2.145 c-0.344-0.811-0.516-1.78-0.516-2.908c0-1.485,0.275-2.805,0.826-3.96c0.549-1.155,1.313-2.117,2.289-2.888 c0.977-0.77,2.109-1.354,3.402-1.753s2.682-0.599,4.168-0.599c2.063,0,3.959,0.324,5.691,0.97s3.244,1.409,4.537,2.289 L183.264,32.967z'
                                style='fill:#29ABE2;' />
                            <path
                                d='M199.433,25.295h5.033l11.137,29.287h-5.857l-2.723-7.301h-10.23l-2.682,7.301h-5.857 L199.433,25.295z M205.992,43.279l-4.043-11.509l-4.207,11.509H205.992z'
                                style='fill:#29ABE2;' />
                            <path d='M218.82,54.582V25.295h5.693v24.296h14.932v4.991H218.82z' style='fill:#29ABE2;' />
                            <path
                                d='M263.248,49.591v4.991h-20.336V25.295h19.965v4.991h-14.273v7.054h12.334v4.62h-12.334v7.631 H263.248z'
                                style='fill:#29ABE2;' />
                        </g>
                        <polygon points='123.458,80 112.101,43.917 123.458,43.917 '
                            style='opacity:0.32;fill:#333333;enable-background:new ;' />
                        <polygon points='303.458,80 314.816,43.917 303.458,43.917 '
                            style='opacity:0.32;fill:#333333;enable-background:new ;' />
                        <polygon points='303.454,0 303.454,80 236.414,80 212.035,0 '
                            style='opacity:0.32;fill:#FFFFFF;enable-background:new ;' />
                    </g>
                </g>
            </svg>
            <p class='loading-text'>Cargando productos...</p>
        </div>
    </div>
    <div class='container-sm'>
        <header class='navbar navbar-expand-lg navbar-dark bg-dark fixed-top'>
            <div class='container-fluid d-flex justify-content-between align-items-center' style='flex-basis: content;'>
                <!-- Logo y nombre de la tienda -->
                <a class='navbar-brand d-flex align-items-center' href='#pagina_titulo'>
                    <img alt='Logo' class='d-inline-block align-text-top' height='30'
                        src='https://importadorasaletodo.com/img/whatsapp-icon.svg' width='30' />
                    <span class='ms-2'>HostingShop</span>
                </a>
                <!-- Listado de categorías -->
                <div class='carousel slide' data-bs-ride='carousel' id='carouselCategorias' style='width: 190px;'>
                    <div class='carousel-categorias-inner' id='listadoCategoriasCarrusel' style='text-align: center;'>
                        <!-- Contenido dinámico será insertado aquí -->
                    </div>
                    <!-- Controles de navegación -->
                    <button class='carousel-control-prev d-none d-md-block' data-bs-slide='prev'
                        data-bs-target='#carouselCategorias' type='button'>
                        <span aria-hidden='true' class='carousel-control-prev-icon' />
                        <span class='visually-hidden'>Anterior</span>
                    </button>

                    <button class='carousel-control-next' data-bs-slide='next' data-bs-target='#carouselCategorias'
                        type='button'>
                        <span aria-hidden='true' class='carousel-control-next-icon' />
                        <span class='visually-hidden'>Siguiente</span>
                    </button>
                </div>
                <!-- Botón colapsable para el menú en dispositivos móviles -->
                <button aria-controls='navbarNavDropdown' aria-expanded='false' aria-label='Toggle navigation'
                    class='navbar-toggler' data-bs-target='#navbarNavDropdown' data-bs-toggle='collapse' type='button'>
                    <span class='navbar-toggler-icon' />
                </button>

                <!-- Botón de Carrito SOLO en móvil -->
                <button class='btn btn-primary d-md-none' onclick='toggleSidebarCarrito()' type='button'>
                    Mini <i class='fa fa-shopping-cart' />
                </button>

                <!-- Buscador -->
                <form class='d-flex align-items-center' onsubmit='buscarYResaltarProducto(); return false;'
                    role='search'>
                    <input aria-label='Buscar' class='form-control me-2' id='txt_search' placeholder='Buscar..'
                        style='width: 100%; max-width: 90px;' type='search' />
                    <button class='fa fa-search fa-2x' type='submit' />
                </form>

                <!-- Botón de Filtros SOLO en móvil -->
                <button class='btn btn-primary d-md-none me-2' onclick='toggleSidebarFiltros()' type='button'>
                    Filtro <i class='fa fa-bars' />
                </button>

                <!-- Menú de navegación -->
                <div class='collapse navbar-collapse text-center' id='navbarNavDropdown'
                    style='text-align: center; align-items: center;'>
                    <ul class='navbar-nav me-auto mb-2 mb-lg-0' id='navMenu' style='margin-bottom: 10px;'>
                        <li class='nav-item'>
                            <a class='nav-link' href='#productos-container' id='productos-link'>Productos</a>
                        </li>
                        <li class='nav-item'>
                            <a class='nav-link' href='javascript:void(0);' onclick='mostrar_pedido();'>Carrito</a>
                        </li>
                        <li class='nav-item'>
                            <a class='nav-link' href='#' id='vista360Link' target='_blank'>Vista 360&#176;</a>
                        </li>
                        <li class='nav-item'>
                            <a class='nav-link' href='#' id='correoLink'>Correo</a>
                        </li>
                        <li class='nav-item'>
                            <a class='nav-link' href='#' id='celularLink'>Celular:</a>
                        </li>
                        <li class='nav-item'>
                            <a class='nav-link' href='#' id='formularioClienteLink' target='_blank'>Formulario
                                Cliente</a>
                        </li>
                        <li class='nav-item'>
                            <a class='nav-link' href='#' id='catalogodriveLink' target='_blank'>Catálogo
                                Drive</a>
                        </li>
                    </ul>
                </div>
            </div>
        </header>
        <ul class='list-group list-group-flush principal'>
            <li class='list-group-item margen_0 titulo-seccion'>
                <ul class='list-group list-group-horizontal justify-content-center'>
                    <li class='list-group-item px-2 border-0'>
                        <!-- Loader para el título con texto -->
                        <span class='loader-section' id='title-loader' style='display: none;'>
                            <div class='spinner-border text-primary' role='status' />
                            <p>Cargando datos del Comercio...</p>
                        </span>
                        <span class='pagina_titulo' id='pagina_titulo' />
                    </li>
                </ul>
            </li>
            <li class='list-group-item margen_0'>
                <!-- Loader para el carrusel con texto -->
                <div class='loader-section' id='carousel-loader' style='display: none;'>
                    <div class='spinner-border text-primary' role='status' />
                    <p>Cargando Banner...</p>
                </div>

                <!-- Contenedor responsivo para el iframe -->
                &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; <div
                    style='width: 100%;height: 360px;overflow: hidden;position: relative;border-style: groove;'>
                    &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; <iframe allowfullscreen=''
                        loading='lazy' referrerpolicy='no-referrer-when-downgrade'
                        src='https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3283.0256931720983!2d-58.47131280000001!3d-34.628791!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x95bcc90e344d15a9%3A0x8acfceb05a3b1543!2sCast-Fer!5e0!3m2!1ses-419!2sar!4v1737034039329!5m2!1ses-419!2sar'
                        style='width: 100%; height: 100%; border: 0; position: absolute; top: 0; left: 0;'>
                        &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </iframe>
                    &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; </div>

                <!-- Contenedor del carrusel con clase única -->
                <div class='carousel slide position-relative banner-carousel' data-bs-ride='carousel'
                    id='carouselExampleSlidesOnly'>
                    <!-- Carrusel dinámico generado por el macro -->
                </div>
            </li>
            <!-- Contenedor de Categorías de Productos -->
            <li class='list-group-item margen_0 categorias-productos-container'>
                <div id='productos-container' style='display:none;'>
                    <div class='titulo-productos-container'>
                        <span class='titulo-productos'>PRODUCTOS POR CATEGORIA</span>

                        <div
                            class='acciones-productos d-flex flex-wrap gap-2 mt-2 justify-content-center align-items-baseline'>

                            <div class='filtro-categoria-padre-dropdown'>
                                <select class='form-select form-select-sm' id='filtroCategoriaPadre'
                                    onchange='filtrarPorCategoriaPadre(this.value)'>
                                    <option selected='selected' value=''>Todas las Categorías</option>
                                </select>
                            </div>
                            <div class='ordenar-dropdown'>
                                <select class='form-select form-select-sm' id='ordenProductos'
                                    onchange='ordenarProductos(this.value)'>
                                    <option value='desc'>Ordenar por más recientes</option>
                                    <option value='asc'>Ordenar por más antiguos</option>
                                    <option selected='selected' value='upd'>Ordenar por actualización reciente</option>
                                    <option value='updo'>Ordenar por actualización antigua</option>
                                </select>
                            </div>

                            <div class='modo-busqueda-dropdown'>
                                <select class='form-select form-select-sm' id='modoBusqueda'
                                    onchange='cambiarModoBusqueda(this.value)'>
                                    <option selected='selected' value='filtrar'>Filtrar productos</option>
                                    <option value='resaltar'>Resaltar productos</option>
                                </select>
                            </div>

                            <div class='d-flex gap-2'>
                                <button class='btn btn-sm btn-outline-primary active' id='vista-lista'>🗂 Vista
                                    Detallada</button>
                                <button class='btn btn-sm btn-outline-secondary' id='vista-compacta'>🔳 Vista
                                    Compacta</button>
                            </div>

                        </div>

                    </div>
                </div>
                <!-- Loader -->
                <div class='loader-container' id='loader-categorias'>
                    <span>Cargando categorías y productos...</span>
                    <div class='spinner' />
                </div>

                <!-- Layout principal -->
                <div class='row'
                    style='--bs-gutter-x: 0.5rem; align-content: center; align-items: stretch; flex-direction: row;'>

                    <!-- Barra lateral de Búsqueda -->
                    <aside class='filter-sidebar bg-light p-3 border rounded' id='sidebarFiltros'>
                        <button class='sidebar-close-btn' onclick='closeSidebarFiltros()'>
                            <span>&#9664;</span> </button>
                        <h4>Filtrado de productos</h4>

                        <!-- 📎 Botón Copiar Enlace -->
                        <button class='btn btn-sm btn-secondary mb-3 w-100' id='btn-copiar-url' style='display:none;'>
                            📎 Copiar Enlace
                        </button>

                        <hr />
                        <!-- Aquí se generarán dinámicamente los filtros -->
                    </aside>

                    <section class='col-12 col-md-8' id='contenedorProductos'>
                        <div class='accordion accordion-flush' id='accordionFlushExample' />
                    </section>

                    <!-- Barra lateral de Carrito -->
                    <aside class='cart-sidebar bg-light p-3 border rounded' id='sidebarCarrito'>
                        <button class='sidebar-close-btn' onclick='closeSidebarCarrito()'>
                            <span>&#9654;</span>
                        </button>

                        <h4 id='sidebarCarritoTitulo'>
                            Mini Carrito
                            <span class='badge bg-primary ms-2' id='carrito-item-contador'>0</span>
                        </h4>
                        <hr />

                        <div id='sidebarCarritoContenido'>
                        </div>

                        <div class='pt-3 mt-2 border-top' id='sidebarCarritoFooter' style='display: none;'>

                            <div class='mb-3' id='carrito_resumen_total'>
                            </div>

                            <button class='btn btn-success w-100 fw-bold' data-bs-target='#modalPedido'
                                data-bs-toggle='modal' type='button'>
                                Finalizar Pedido
                            </button>
                        </div>
                    </aside>
                </div>

                <!-- Overlay para filtros -->
                <div class='overlay' id='overlayFiltros' onclick='closeSidebarFiltros()' />

                <!-- Overlay para carrito -->
                <div class='overlay' id='overlayCarrito' onclick='closeSidebarCarrito()' />

                <div class='btn-flotante d-none d-md-flex' id='btn-flotante-filtros' onclick='toggleSidebarFiltros()'>
                    <i class='fa fa-bars' />
                    <span>&#9654;</span>
                </div>

                <div class='btn-flotante d-none d-md-flex' id='btn-flotante-carrito' onclick='toggleSidebarCarrito()'>
                    <span>&#9664;</span> <i class='fa fa-shopping-cart' />
                </div>

                <!-- Footer simple -->
                <div
                    style='height: 80px; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: #f4f4f4; color: #333; padding: 5px 10px;'>
                    <div style='font-size: 20px; font-weight: bold;'>
                        HOSTINGSHOP
                    </div>
                    <div id='info-actualizacion'
                        style='font-size: 0.9em; color: gray; margin-top: 4px; text-align: center;'>
                        Cargando información...
                    </div>
                </div>
                <div aria-hidden='true' aria-labelledby='modalBuscarLabel' class='modal fade' id='modalBuscar'
                    tabindex='-1'>
                    <div class='modal-dialog modal-lg-custom'>
                        <div class='modal-content'>
                            <button aria-label='Close' class='btn-close' data-bs-dismiss='modal' type='button' />
                            <div class='modal-header'>
                                <h5 class='modal-title' id='modalBuscarLabel'>Filtrar Productos por Categoría</h5>
                            </div>
                            <div class='modal-body'>

                                <div class='mb-3'>
                                    <label class='form-label' for='filtroModalCategoriaPadre'>Filtrar por Grupo:</label>
                                    <select class='form-select form-select-sm' id='filtroModalCategoriaPadre'
                                        onchange='filtrarModalPorCategoriaPadre(this.value)'>
                                        <option selected='selected' value=''>-- Mostrar Todas --</option>
                                    </select>
                                </div>
                                <hr />
                                <div class='d-flex flex-wrap gap-2' id='listadoCategorias'>
                                </div>

                            </div>
                            <div class='modal-footer'>
                                <button class='btn btn-outline-danger' id='btn_limpiar_filtros'
                                    onclick='limpiarFiltrosModal()' style='display: none;'>Limpiar Filtros</button>
                            </div>
                        </div>
                    </div>
                </div>
            </li>
        </ul>
        <div class='principal' id='espacio' />
        <div class='pedido_producto_container'>
            <!-- Separador visual -->
            <hr class='my-4' style='border-top: 2px dashed #ccc;' />
            <ul class='list-group list-group-flush pedido_producto'>
                <li class='list-group-item margen_0 detalle_contenido' id='detalle_pedido'>
                    <!-- Contenido dinámico del pedido -->
                </li>
            </ul>
        </div>
        <!-- Contenedor de acciones -->
        <div class='text-center bg-light py-3 rounded shadow-sm'>
            <!-- Botón para notificar pago -->
            <button class='btn btn-dark position-relative detalle_pedido_page mb-1' id='btn_pagar' type='button'>
                Notificar Pago
            </button>

            <!-- Mensaje cuando el pago ya fue notificado -->
            <span class='d-none text-success fw-bold' id='pago_notificado'>
                Pago Notificado
            </span>

            <!-- Botón para cancelar compra -->
            <button class='btn btn-danger position-relative detalle_pedido_page mb-1 d-none' id='btn_cancelar'
                type='button'>
                Cancelar Compra
            </button>

            <!-- Botón para editar compra -->
            <a class='btn btn-primary position-relative detalle_pedido_page mb-1 d-none' id='btn_editar'>
                Editar Compra
            </a>

            <!-- Mensaje alternativo si el pedido fue cancelado -->
            <div class='alert alert-warning mt-3 d-none' id='mensaje_cancelado' role='alert'>
                Tu pedido fue cancelado. Si aún estás interesado, puedes volver a intentarlo desde <a class='alert-link'
                    href='#productos-container'>nuestro catálogo</a>.
            </div>
        </div>

        <ul class='list-group list-group-flush detalle_pedido_page' id='pedido_parametro_producto'>
            <!-- Parámetros adicionales del pedido -->
        </ul>
    </div>
    <nav class='navbar fixed-bottom' id='navbarfooter'>
        <div class='mx-auto'>
            <div class='d-flex justify-content-center bd-highlight'>
                <a aria-label='Abrir WhatsApp' class='whatsapp-floating-button' href='#' onclick='abrir_whatsapp();'>
                    <img alt='' height='70' src='https://importadorasaletodo.com/img/whatsapp-icon.svg' width='70' />
                </a>
                <button class='btn btn-dark btn-sm' data-bs-target='#modalPedido' data-bs-toggle='modal' id='btn_nuevo'
                    type='button'>
                    <i class='fa fa-whatsapp' />
                    Clic aquí para Enviar pedido por WhatsApp
                </button>

                <button class='btn btn-danger btn-sm' data-bs-target='#modalPedido' data-bs-toggle='modal'
                    id='btn_edicion' type='button'>
                    <i class='fa fa-whatsapp' />
                    Enviar Pedido Editado por WhatsApp
                </button>
            </div>
            <div class='d-flex justify-content-center bd-highlight'>
                <div class='p-2 bd-highlight'>
                    <button aria-label='Buscar productos' class='btn btn-outline-dark position-relative' id='btn_cars'
                        onclick='mostrarFiltroYModal();' type='button'>
                        <i class='fa fa-filter' id='icon_filter' />
                        <div class='spinner-border text-primary position-absolute' id='spinner' role='status'
                            style='top: 4%; left: 8%; display: none; width: 2.5rem; height: 2.5rem; border-width: 0.3em;'>
                        </div>
                    </button>
                    <!-- Botón flotante -->
                    <button class='btn btn-danger btn-floating ms-2' id='closeAllAccordions' style='display: none;'>
                        <i class='fa fa-times' /> Cerrar
                    </button>
                </div>
                <div class='p-2 bd-highlight'>
                    <button class='btn btn-outline-dark position-relative' id='btn_regresar'
                        onclick='regresar_principal();' type='button'>
                        <i class='fa fa-undo fa-2x' />
                    </button>
                    <button aria-label='Mostrar pedido' class='btn btn-outline-dark position-relative' id='btn_cars2'
                        onclick='mostrar_pedido();' type='button'>
                        <i class='fa fa-shopping-cart fa-2x' />
                    </button>
                </div>
                <div class='p-2 bd-highlight total-compra'>
                    <div class='total-compra-container'>
                        <div class='total-compra-titulo'>Total de Compra</div>
                        <div class='total-compra-valor'>
                            <span class='venta_detalle_total'>0.0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    <button id='mostrarFooterBtn' onclick='mostrarFooter()'>Mostrar Menú <i class='fa fa-shopping-cart' /></button>
    <!-- Modal formulario de Pedido -->
    <div aria-hidden='true' aria-labelledby='modalPedidoLabel' class='modal fade' id='modalPedido' tabindex='-1'>
        <div class='modal-dialog modal-dialog-centered' role='document'>
            <div class='modal-content'>
                <form id='form_pedido'>
                    <div class='modal-header'>
                        <h5 class='modal-title' id='modalPedidoLabel'>Confirmación de Datos</h5>
                        <button aria-label='Close' class='btn-close' data-bs-dismiss='modal' type='button' />
                    </div>
                    <div class='modal-body'>
                        <div class='row'>
                            <div class='col-12 text-center mb-3'>
                                <div aria-label='Tipo de Cliente' class='btn-group' role='group'>
                                    <input autocomplete='off' class='btn-check' id='registro' name='tipo_cliente'
                                        type='radio' value='Registro' />
                                    <label class='btn btn-outline-primary' for='registro'> <i class='fa fa-user' />
                                        Registro </label>
                                    <input autocomplete='off' class='btn-check' id='validar' name='tipo_cliente'
                                        type='radio' value='Validar Datos' />
                                    <label class='btn btn-outline-success' for='validar'> <i
                                            class='fa fa-check-circle' /> Validar Datos </label>
                                    <input autocomplete='off' class='btn-check' id='sin_registro' name='tipo_cliente'
                                        type='radio' value='Sin Registro' />
                                    <label class='btn btn-outline-danger' for='sin_registro'> <i
                                            class='fa fa-user-times' /> Sin Registro </label>
                                </div>
                            </div>
                            <div class='col-6 small mb-3 campo-cliente' id='campo_correo' style='display:none;'>
                                <label class='form-label text-primary fw-bold' for='txt_correo'>
                                    <i class='fa fa-envelope' /> Correo Electrónico:
                                </label>
                                <input class='form-control form-control-sm border-primary shadow-sm' id='txt_correo'
                                    placeholder='Ingrese Correo Gmail' required='required' type='email' />
                                <small class='form-text text-muted'>
                                    <i class='fa fa-info-circle' /> Necesario para validar tu usuario.
                                </small>
                            </div>
                            <div class='col-6 small mb-3 campo-cliente' id='campo_nombre' style='display:none;'>
                                <label class='form-label text-primary fw-bold' for='txt_nombre'>
                                    <i class='fa fa-user' /> <span id='label_nombre'>ID de Cliente:</span>
                                </label>
                                <input class='form-control form-control-sm border-primary shadow-sm' id='txt_nombre'
                                    placeholder='Ingrese su ID' required='required' type='text' />
                                <small class='form-text text-muted' id='small_nombre'>
                                    <i class='fa fa-info-circle' /> Identificación necesaria.
                                </small>
                            </div>
                            <div class='col-6 small mb-3' id='campo_celular' style='display:none;'>
                                <label class='form-label text-primary fw-bold' for='txt_telefono'>
                                    <i class='fa fa-phone' /> Celular:
                                </label>
                                <input class='form-control form-control-sm border-primary shadow-sm' id='txt_telefono'
                                    placeholder='Ingrese su Celular (+54)' required='required' type='number' />
                                <small class='form-text text-muted'>
                                    <i class='fa fa-info-circle' /> Necesario para confirmar el pedido por WhatsApp.
                                </small>
                            </div>
                            <div class='col-6 small campo-extra mb-3' id='campo_rut' style='display:none;'>
                                <label class='form-label text-primary fw-bold' for='txt_rut'>
                                    <i class='fa fa-folder' /> Documento DNI o CUIT:
                                </label>
                                <input class='form-control form-control-sm border-primary shadow-sm' id='txt_rut'
                                    placeholder='Ingrese su CUIT' required='required' type='number' />
                                <small class='form-text text-muted'>
                                    <i class='fa fa-info-circle' /> Obligatorio para el rótulo de envío.
                                </small>
                            </div>

                            <div class='col-12 text-center mb-3' id='tipo_compra_section' required='required'
                                style='display:none;'>
                                <label class='form-label text-primary fw-bold'>
                                    <i class='fa fa-shopping-cart' /> Tipo de Compra:
                                </label>
                                <div aria-label='Tipo de Compra' class='btn-group' role='group'>
                                    <input autocomplete='off' class='btn-check' id='compra_envio' name='tipo_compra'
                                        type='radio' value='Envio' />
                                    <label class='btn btn-outline-primary shadow-sm' for='compra_envio'>
                                        <i class='fa fa-truck' /> Envío
                                    </label>
                                    <input autocomplete='off' class='btn-check' id='compra_retiro' name='tipo_compra'
                                        type='radio' value='Retiro' />
                                    <label class='btn btn-outline-success shadow-sm' for='compra_retiro'>
                                        <i class='fa fa-home' /> Retiro
                                    </label>
                                </div>
                            </div>

                            <div class='col-12 small campo-extra' id='campo_agencia' required='required'
                                style='display:none;'>
                                <div class='mb-3'>
                                    <label class='form-label text-primary fw-bold' for='txt_agencia'>
                                        <i class='fa fa-building' /> Agencia de Envío:
                                    </label>
                                    <select class='form-control form-control-sm border-primary shadow-sm'
                                        id='txt_agencia'>
                                        <option disabled='disabled' selected='selected' value=''>Seleccione una agencia
                                        </option>
                                        <!-- Opciones de agencia cargadas dinámicamente -->
                                    </select>
                                    <small class='form-text text-muted'>
                                        <i class='fa fa-info-circle' /> Especifique la agencia de su preferencia.
                                    </small>
                                </div>
                            </div>
                            <div class='col-12 text-center mb-3' id='tipo_envio_section' style='display:none;'>
                                <label>Tipo de Envío</label>
                                <div aria-label='Tipo de Envío' class='btn-group' role='group'>
                                    <input autocomplete='off' class='btn-check' id='envio_sucursal' name='tipo_envio'
                                        type='radio' value='Sucursal' />
                                    <label class='btn btn-outline-primary' for='envio_sucursal'>
                                        <i class='fa fa-building' /> Sucursal
                                    </label>
                                    <input autocomplete='off' class='btn-check' id='envio_domicilio' name='tipo_envio'
                                        type='radio' value='Domicilio' />
                                    <label class='btn btn-outline-primary' for='envio_domicilio'>
                                        <i class='fa fa-home' /> Domicilio
                                    </label>
                                </div>
                            </div>

                            <div class='col-12 small campo-extra' id='campo_provincia' style='display: none;'>
                                <div class='mb-3'>
                                    <label class='form-label' for='txt_provincia'><i class='fa fa-map-marker' />
                                        Provincia:</label>
                                    <select class='form-control form-control-sm' id='txt_provincia' required='required'>
                                        <option value=''>Cargando provincias...</option>
                                    </select>
                                </div>
                            </div>

                            <div class='col-12 small campo-extra' id='campo_municipio' style='display: none;'>
                                <div class='mb-3'>
                                    <label class='form-label' for='txt_municipio'><i class='fa fa-map' />
                                        Municipio:</label>
                                    <select class='form-control form-control-sm' disabled='disabled' id='txt_municipio'
                                        required='required'>
                                        <option value=''>Seleccione una provincia primero</option>
                                    </select>
                                </div>
                            </div>

                            <div class='col-6 small campo-extra' id='campo_localidad' style='display: none;'>
                                <div class='mb-3'>
                                    <label class='form-label' for='txt_localidad'><i class='fa fa-location-arrow' />
                                        Localidad:</label>
                                    <select class='form-control form-control-sm' disabled='disabled' id='txt_localidad'
                                        required='required'>
                                        <option value=''>Seleccione un municipio primero</option>
                                    </select>
                                </div>
                            </div>
                            <div class='col-6 small campo-extra' id='campo_codigo_postal' style='display: none;'>
                                <div class='mb-3'>
                                    <label class='form-label' for='txt_codigo_postal'>
                                        <i class='fa fa-envelope' /> Código Postal :
                                    </label>
                                    <input class='form-control form-control-sm' id='txt_codigo_postal'
                                        placeholder='Ingrese su Código Postal' required='required' type='number' />
                                </div>
                            </div>
                            <div class='col-6 small campo-extra campo-domicilio' id='campo_calle'
                                style='display: none;'>
                                <div class='mb-3'>
                                    <label class='form-label' for='txt_calle'>
                                        <i class='fa fa-road' /> Calle :
                                    </label>
                                    <input class='form-control form-control-sm' id='txt_calle'
                                        placeholder='Ingrese Calle' type='text' />
                                </div>
                            </div>
                            <div class='col-6 small campo-extra' id='campo_numero' style='display: none;'>
                                <div class='mb-3'>
                                    <label class='form-label' for='txt_numero'>
                                        <i class='fa fa-sort-numeric-asc' /> Número :
                                    </label>
                                    <input class='form-control form-control-sm' id='txt_numero'
                                        placeholder='Ingrese Número' required='required' type='number' />
                                </div>
                            </div>
                            <div class='col-6 small campo-extra campo-domicilio' id='campo_piso' style='display: none;'>
                                <div class='mb-3'>
                                    <label class='form-label' for='txt_piso'>
                                        <i class='fa fa-building' /> Piso (Opcional) :
                                    </label>
                                    <input class='form-control form-control-sm' id='txt_piso' placeholder='Ingrese Piso'
                                        type='number' />
                                </div>
                            </div>
                            <div class='col-6 small campo-extra campo-domicilio' id='campo_departamento'
                                style='display: none;'>
                                <div class='mb-3'>
                                    <label class='form-label' for='txt_departamento'>
                                        <i class='fa fa-cogs' /> Departamento (Opcional) :
                                    </label>
                                    <input class='form-control form-control-sm' id='txt_departamento'
                                        placeholder='Ingrese Departamento' type='text' />
                                </div>
                            </div>
                            <div class='col-12 small campo-extra campo-domicilio' id='campo_observacion'
                                style='display: none;'>
                                <div class='mb-3'>
                                    <label class='form-label' for='txt_observacion'>
                                        <i class='fa fa-pencil' /> Observación (Opcional) :
                                    </label>
                                    <textarea class='form-control form-control-sm' id='txt_observacion'
                                        placeholder='Ingrese Observación' rows='2' />
                                </div>
                            </div>
                            <div class='col-12 small campo-extra' id='direccion_tipo_envio_container'
                                style='display: none;'>
                                <div class='mb-3'>
                                    <label class='form-label' for='txt_direccion'>
                                        <i class='fa fa-map' /> Dirección :
                                    </label>
                                    <input class='form-control form-control-sm' id='txt_direccion'
                                        placeholder='Dirección completa' readonly='readonly' type='text' />
                                    <small class='form-text' id='direccion_tipo_envio' />
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Información importante -->
                    <div class='mb-3' id='campo_extra_container' style='display: none;'>
                        <label class='form-label'><strong>Información Importante:</strong></label>
                        <div class='form-text text-muted' id='detalle_campo_extra'>
                            Si necesitas modificar los Datos de Contacto o Ubigeo, elige la opción de
                            &quot;Registro&quot;.
                            Si eres un cliente registrado que Validó Datos y sus datos son correctos, solo confirma el
                            pedido.
                            En caso contrario, si todos los datos cargados previamente en el pedido editado son
                            correctos, confirma directamente.
                        </div>
                    </div>

                    <!-- Métodos de pago -->
                    <div class='mb-3' id='metodos_pago_container' style='display: none; text-align: center;'>
                        <label class='form-label'><strong>Elige Método de Pago:</strong></label>

                        <!-- Opciones como botones o radios -->
                        <div class='d-flex flex-wrap gap-2' id='metodos_pago_opciones'>
                            <!-- Se insertan dinámicamente -->
                        </div>

                        <!-- &#9989; Descripción del método seleccionado (dinámica por JS) -->
                        <div class='mt-3 small text-muted' id='descripcion_pago' style='display: none;'>
                            <!-- Se completa dinámicamente con JS -->
                        </div>

                        <!-- &#9989; Info transferencia (solo visible si se elige "Transferencia") -->
                        <div class='row mt-3' id='info_transferencia' style='display: none;'>
                            <!-- Columna 1: Datos -->
                            <div class='col-md-12'>
                                <div class='border p-2 rounded bg-light h-100'>
                                    <h6 class='text-primary mb-2'><i class='fa fa-university' /> Datos de Transferencia
                                    </h6>
                                    <small class='text-muted d-block mb-1'><strong>Alias:</strong> <span
                                            id='alias_transferencia' /></small>
                                    <small class='text-muted d-block mb-1'><strong>CBU:</strong> <span
                                            id='cbu_transferencia' /></small>
                                    <small class='text-muted d-block mb-1'><strong>Cuenta:</strong> <span
                                            id='cuenta_transferencia' /></small>
                                    <small class='text-muted d-block mb-2'><strong>Banco:</strong> <span
                                            id='banco_transferencia' /></small>
                                </div>
                            </div>

                            <!-- Columna 2: Nota / alerta -->
                            <div class='col-md-12'>
                                <div class='alert alert-warning small mb-0 h-100 d-flex align-items-center'
                                    role='alert'>
                                    <i class='fa fa-info-circle me-2' />
                                    <span>
                                        Recuerda compartir el comprobante luego de enviar los detalles del pedido al
                                        WhatsApp al
                                        <strong>Finalizar Pedido</strong>. Allí recibirás el link con el resumen de tu
                                        compra para confirmar el pago.
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Info de envío seleccionada -->
                    <div class='mb-3' id='info_envio_container' style='display: none; text-align: center;'>
                        <label class='form-label'><strong>Envío Seleccionado:</strong></label>
                        <div class='border rounded p-2 bg-light'>
                            <p class='mb-1'>Descripción: <span class='fw-bold text-uppercase text-primary'
                                    id='envio_agencia_descripcion' /></p>
                            <p class='mb-1'>Costo Envío a la Agencia: <span class='fw-bold text-success'
                                    id='envio_agencia_costo' /></p>
                            <p class='mb-0' id='envio_agencia_hora_label'>Hora Estimada de Entrega: <span
                                    class='text-muted' id='envio_agencia_hora' /></p>
                        </div>
                    </div>

                    <!-- Totales -->
                    <div class='mb-3' id='recargo_info' style='display: none; text-align: center;'>
                        <div class='border rounded p-3 bg-light shadow-sm'>
                            <div class='text-dark fs-6' id='recargo_valor'>
                                <!-- Aquí se inserta desde JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Botones -->
                    <div class='modal-footer'>
                        <button class='btn btn-outline-dark btn-sm' data-bs-dismiss='modal'
                            type='button'>Cancelar</button>
                        <button class='btn btn-primary btn-sm' id='btn_confirmar' type='submit'>Confirmar
                            Pedido</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Modal para Elegir una Variedad -->
    <div aria-hidden='true' aria-labelledby='modalProductoLabel' class='modal fade' id='modalProducto' tabindex='-1'>
        <div class='modal-dialog modal-dialog-centered' role='document'>
            <div class='modal-content modal_pedido'>
                <button aria-label='Close' class='btn-close' data-bs-dismiss='modal' type='button' />
                <div class='modal-body row'>
                    <div class='col-12 text-center mb-3'>
                        <span style='font-weight: bold; text-decoration: underline;'>LISTA DE VARIABLES</span>
                        <small class='form-text'>(Elige una variación)</small>
                    </div>
                    <!-- Contenedor dinámico para las opciones -->
                    <div class='col-12 text-center' id='detalle_modal_producto'>
                        <!-- El contenido dinámico generado con JS irá aquí -->
                    </div>
                    <!-- Botones de Cancelar y Aceptar -->
                    <div class='col-12 mt-3 d-flex justify-content-between'>
                        <button class='btn btn-secondary' onclick='cerrarModalvariable()'
                            type='button'>Cancelar</button>
                        <button class='btn btn-primary' id='btnAceptar' style='display:none;'
                            type='button'>Aceptar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery: sin defer, debe estar disponible globalmente primero -->
    <script src='https://code.jquery.com/jquery-3.6.0.min.js' />

    <!--  Bootstrap: puede tener defer -->
    <script crossorigin='anonymous' defer='defer'
        integrity='sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p'
        src='https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js' />

    <!-- Fancybox SIN defer -->
    <script src='https://cdn.jsdelivr.net/npm/@fancyapps/ui@6.0/dist/fancybox/fancybox.umd.js' />

    <!-- SweetAlert2: defer está bien -->
    <script defer='defer' src='https://cdn.jsdelivr.net/npm/sweetalert2@11' />

    <!-- DataTables y extensiones: defer también, ya que se usan después -->
    <script defer='defer' src='https://cdn.datatables.net/1.13.1/js/jquery.dataTables.min.js' />
    <script defer='defer' src='https://cdn.datatables.net/buttons/2.3.2/js/dataTables.buttons.min.js' />
    <script defer='defer' src='https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js' />
    <script defer='defer' src='https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js' />
    <script defer='defer' src='https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js' />
    <script defer='defer' src='https://cdn.datatables.net/buttons/2.3.2/js/buttons.html5.min.js' />
    <script defer='defer' src='https://cdn.datatables.net/buttons/2.3.2/js/buttons.print.min.js' />

    <!-- Elfsight: dejar como async -->
    <script async='async' src='https://static.elfsight.com/platform/platform.js' />

    <script type='text/javascript'>
        //<![CDATA[
        var operacion = "";
        var idpedido = "";
        var currentFormaPago = ""; // Variable global para controlar flujo según pago

        // Leer parámetros de la URL
        try {
            var params = new URLSearchParams(location.search);
            operacion = params.get("o") || "";
            idpedido = params.get("id") || "";

            console.log("id::" + idpedido);
            console.log("operacion::" + operacion);
        } catch (e) {
            console.error("Error al leer los parámetros:", e);
        }

        $(document).ready(function () {
            toggleUIForOperation(operacion);

            if (operacion === "" || operacion === "e") {
                inicializarVenta();
                listar_configuracion(idpedido, operacion);

                $('#form_pedido').submit(function (event) {
                    handleFormSubmit(event);
                });

                if (operacion === "e") {
                    $('label[for="sin_registro"]').html('<i class="fa fa-user-times"></i> Sin Modificar');

                    // Mostrar siempre el campo cuando operacion es "e"
                    $('#campo_extra_container').show();
                }
            } else {
                // Spinner en la sección de detalle
                $("#pedido_parametro_producto").html(`
    <div class="text-center my-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-2">Cargando detalle del pedido...</p>
    </div>
`);

                toggleLoader(true);
                makeAjaxCall(
                    `${url_final_venta}exec`,
                    { op: "cargar_venta", id: idpedido },
                    function (respuesta) {
                        // Ocultar loader si aplica
                        toggleLoader(false);

                        // ── GUARD: Verificación de Estado (Mejora 4) ────────────────
                        // Si ya está pagado/cancelado y estamos en ?o=p, redirigir a detalle
                        const estado = (respuesta.pedido.estado || "").toUpperCase();
                        const esFinalizado = ["PAGADO", "CANCELADO", "REVISION_MANUAL"].includes(estado);

                        if (operacion === "p" && esFinalizado) {
                            Swal.fire({
                                icon: estado === "PAGADO" ? "success" : "info",
                                title: estado === "PAGADO" ? "✅ Pago ya registrado" : `Estado: ${estado}`,
                                text: "Tu pedido ya fue procesado. Te redirigimos al historial.",
                                timer: 3000,
                                showConfirmButton: false
                            }).then(() => {
                                // Redirigir a vista detalle ?o=d
                                window.location.href = `${window.location.origin}${window.location.pathname}?o=d&id=${idpedido}`;
                            });
                            return;
                        }
                        // ────────────────────────────────────────────────────────────

                        cargar_detalle_pedido(operacion, JSON.stringify(respuesta.pedido));
                    }
                );

            }


            $('#btn_pagar').click(function () {
                // ── Nueva Lógica para Confirmar Visita (Pagos Presenciales) ──
                if (currentFormaPago && currentFormaPago !== "Transferencia") {
                    Swal.fire({
                        title: "¿Confirmar Visita?",
                        text: "Esto notificará que el cliente está realizando el pago presencial.",
                        icon: "question", showCancelButton: true,
                        confirmButtonText: "Sí, notificar"
                    }).then(result => {
                        if (!result.isConfirmed) return;
                        makeAjaxCall(
                            `${url_final_venta}exec`,
                            { op: "confirmar_pago_presencial", idpedido },
                            function (respuesta) {
                                Swal.fire("Éxito!", respuesta.message, "success");
                                if (respuesta.status === "0") {
                                    $('#btn_pagar').addClass('d-none');
                                    $('#pago_notificado').removeClass('d-none').text('✅ Visita Confirmada');
                                    $('#btn_cancelar').addClass('d-none');

                                    // Cambiar URL a ?o=d
                                    const newUrl = `${window.location.protocol}//${window.location.host}${window.location.pathname}?o=d&id=${idpedido}`;
                                    window.history.replaceState({ path: newUrl }, '', newUrl);

                                    // Recargar para actualizar vista
                                    setTimeout(() => location.reload(), 1500);
                                }
                            }
                        );
                    });
                    return;
                }

                // ── Lógica Original (Fallback / Otros casos) ──
                makeAjaxCall(
                    `${url_final_venta}exec`,
                    { op: "pagar", idpedido },
                    function (respuesta) {
                        Swal.fire("Éxito!", respuesta.message, "success");
                        if (respuesta.status === "0") {
                            $('#btn_pagar').addClass('d-none'); // Ocultar botón
                            $('#pago_notificado').removeClass('d-none'); // Mostrar texto
                            $('#btn_cancelar').removeClass('d-none'); // Mostrar botón cancelar
                            $('#btn_editar')
                                .removeClass('d-none')
                                .attr("href", `${window.location.origin}${window.location.pathname}?o=e&id=${idpedido}#productos-container`); // Mostrar botón editar

                            // 🔽 Hacer scroll al contenedor de productos
                            const productosSection = document.querySelector('#productos-container');
                            if (productosSection) {
                                productosSection.scrollIntoView({ behavior: 'smooth' });
                            }
                        }
                    }
                );
            });

            $('#btn_cancelar').click(function () {
                makeAjaxCall(
                    `${url_final_venta}exec`,
                    { op: "cancelar", idpedido },
                    function (respuesta) {
                        Swal.fire("Éxito!", respuesta.message, "success");

                        if (respuesta.status === "0") {
                            $('#btn_cancelar').addClass('d-none'); // Ocultar botón cancelar
                            $('#pago_notificado').text("Compra Cancelada"); // Actualizar texto

                            // Mostrar botón con nuevo texto y comportamiento
                            $('#btn_editar')
                                .removeClass('d-none')
                                .text("Volver al Catálogo") // o "Reintentar Compra"
                                .attr("href", `${window.location.origin}${window.location.pathname}#productos-container`)
                                .removeAttr("target") // Que se abra en la misma pestaña
                                .removeClass('btn-primary')
                                .addClass('btn-warning'); // Cambio visual para distinguir acción
                        }
                    }
                );
            });

            // ── HANDLER: Vista previa del comprobante ────────────────────────
            window.previsualizarComprobante = function (event) {
                const file = event.target.files[0];
                if (!file) return;
                const wrapper = document.getElementById('comprobante_preview_wrapper');
                const preview = document.getElementById('comprobante_preview');
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = e => { preview.src = e.target.result; wrapper.style.display = 'block'; };
                    reader.readAsDataURL(file);
                } else {
                    wrapper.style.display = 'none'; // PDF: sin preview
                }
            };

            // ── HANDLER: Confirmar Pago Presencial (Delegado) ────────────────
            $(document).on("click", "#btn_confirmar_efectivo", function () {
                Swal.fire({
                    title: "¿Confirmar pago?",
                    text: "Esto marcará el pedido para revisión manual del vendedor.",
                    icon: "question", showCancelButton: true,
                    confirmButtonText: "Sí, confirmar"
                }).then(result => {
                    if (!result.isConfirmed) return;

                    const btn = $(this);
                    btn.prop("disabled", true).text("⏳ Procesando...");

                    fetch(GAS_BASE_URL + "exec", {
                        method: "POST",
                        body: JSON.stringify({ op: "confirmar_pago_presencial", idpedido })
                    })
                        .then(r => r.json())
                        .then(resp => {
                            if (resp.status === "0") {
                                Swal.fire("✅ Registrado", resp.message, "success");

                                // Cambiar URL a ?o=d sin recargar
                                const newUrl = `${window.location.protocol}//${window.location.host}${window.location.pathname}?o=d&id=${idpedido}`;
                                window.history.replaceState({ path: newUrl }, '', newUrl);

                                btn.text("✓ Confirmado");
                                $("#btn_pagar, #btn_cancelar").addClass("d-none");

                                // Recargar página tras breve pausa para ver cambios
                                setTimeout(() => location.reload(), 1500);
                            } else {
                                Swal.fire("Error", resp.message, "error");
                                btn.prop("disabled", false).text("✅ Confirmar recepción de pago");
                            }
                        })
                        .catch(e => {
                            console.error(e);
                            Swal.fire("Error", "Error de conexión", "error");
                            btn.prop("disabled", false).text("✅ Confirmar recepción de pago");
                        });
                });
            });

            // ── HANDLER: Subir comprobante y verificar con IA ────────────────
            window.subirComprobante = function (pedidoId) {
                const fileInput = document.getElementById('comprobante_file');
                const resultDiv = document.getElementById('comprobante_resultado');
                const btn = document.getElementById('btn_subir_comprobante');

                if (!fileInput || !fileInput.files.length) {
                    Swal.fire('Atención', 'Seleccioná un archivo antes de verificar.', 'warning');
                    return;
                }

                const file = fileInput.files[0];
                const MAX_MB = 8;
                if (file.size > MAX_MB * 1024 * 1024) {
                    Swal.fire('Archivo muy grande', `Máximo ${MAX_MB} MB permitidos.`, 'warning');
                    return;
                }

                // Estado: cargando
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Verificando...';
                resultDiv.style.display = 'none';

                const reader = new FileReader();
                reader.onload = function (e) {
                    // Extraer base64 puro (sin el prefijo data:...;base64,)
                    const base64Full = e.target.result;
                    const base64Content = base64Full.split(',')[1] || base64Full;

                    const payload = {
                        op: 'pagar_con_comprobante',
                        idpedido: pedidoId,
                        fileData: {
                            fileName: file.name,
                            mimeType: file.type,
                            content: base64Content
                        }
                    };

                    // Llamada directa a GAS (fetch POST - no JSONP porque enviamos base64 grande)
                    fetch(GAS_BASE_URL + 'exec', {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    })
                        .then(r => r.json())
                        .then(resp => {
                            const verificado = resp.verified === true;
                            const icono = verificado ? '✅' : '⚠️';
                            const color = verificado ? 'success' : 'warning';
                            const estadoText = resp.nuevoEstado || (verificado ? 'PAGADO' : 'REVISIÓN MANUAL');

                            resultDiv.innerHTML = `
<div class="alert alert-${color} small mt-2 mb-0" role="alert">
  <strong>${icono} IA: ${estadoText}</strong><br>
  ${resp.message || ''}
  ${resp.aiReason ? '<br><em>' + resp.aiReason + '</em>' : ''}
</div>`;
                            resultDiv.style.display = 'block';

                            if (verificado) {
                                // 🔒 Ocultar botón de pago manual si ya fue verificado
                                // 🔒 Ocultar botón de pago manual si ya fue verificado
                                $('#btn_pagar').addClass('d-none');
                                $('#pago_notificado').removeClass('d-none').text('✅ Pago verificado por IA');

                                // Cambio de URL ?o=p -> ?o=d sin recargar
                                const newUrl = `${window.location.protocol}//${window.location.host}${window.location.pathname}?o=d&id=${idpedido}`;
                                window.history.replaceState({ path: newUrl }, '', newUrl);

                                // Ocultar card de subida
                                document.getElementById("comprobante_card").style.display = "none";
                            }

                            Swal.fire(verificado ? '✅ Pago Verificado' : '⚠️ Revisión necesaria', resp.message, verificado ? 'success' : 'warning');
                        })
                        .catch(err => {
                            console.error('[Comprobante] Error:', err);
                            Swal.fire('Error', 'No se pudo contactar al servidor. Intenta de nuevo.', 'error');
                        })
                        .finally(() => {
                            btn.disabled = false;
                            btn.innerHTML = '<i class="fa fa-magic"></i> Verificar con IA';
                        });
                };

                reader.onerror = () => Swal.fire('Error', 'No se pudo leer el archivo.', 'error');
                reader.readAsDataURL(file);
            };


            toggleLoader(false);

            // --- Attach Event Listener for Categoria Padre Filter ---
            const selectCategoriaPadre = document.getElementById('filtroCategoriaPadre');

            if (selectCategoriaPadre) {
                selectCategoriaPadre.addEventListener('change', function () {
                    // 'this.value' refers to the selected value of the dropdown
                    filtrarPorCategoriaPadre(this.value); // This CALLS the function
                });
                console.log("✅ Event listener attached to #filtroCategoriaPadre.");
            } else {
                console.error("❌ Could not find #filtroCategoriaPadre to attach listener.");
            }
        });



        function toggleUIForOperation(operacion) {
            if (operacion === "" || operacion === "e") {
                setupPrincipalUI(operacion);
            } else {
                setupDetalleUI(operacion);
            }
        }

        function setupPrincipalUI(operacion) {
            estaEnVistaDetalle = false; // 👉 Estamos fuera de la vista de detalle

            $("#navbarfooter").show();
            $(".detalle_pedido_page").hide();
            $(".principal").show();
            $(".pedido_producto").hide();
            $("#btn_cars").show();
            $("#btn_regresar").hide();
            $("#filtro_producto").hide();
            $("#mostrarFooterBtn").css("display", "block"); // 👉 Volvemos a mostrar el botón

            if (operacion === "e") {
                $("#btn_edicion").show();
                $("#btn_nuevo").hide();
            } else {
                $("#btn_edicion").hide();
                $("#btn_nuevo").show();
            }
        }

        function setupDetalleUI(operacion) {
            estaEnVistaDetalle = true; // 👉 Activar bandera

            $(".detalle_pedido_page").show();
            $("#navbarfooter").hide();
            $(".principal").hide();
            $(".pedido_producto").hide();

            $("#btn_pagar").toggle(operacion === "p");
            $("#mostrarFooterBtn").css("display", "none");

            if (operacion === "p") {
                $('#btn_editar')
                    .removeClass('d-none')
                    .attr("href", `${window.location.origin}${window.location.pathname}?o=e&id=${idpedido}#productos-container`);
            }
        }

        function ordenarVentaFinal(venta) {
            const esPublicoGeneral = !venta.nombre_entrega && !venta.correo_entrega;

            return {
                detalle: venta.detalle || [],
                op: venta.op || "venta",
                operacion: venta.operacion || "",
                id: venta.id || "",

                moneda: venta.moneda || "$",
                forma_pago: venta.forma_pago || "",
                recargo_pago: venta.recargo_pago || 0,
                recargo_valor: venta.recargo_valor || 0,
                total: venta.total || "0.00",

                cuenta_transferencia_id: venta.cuenta_transferencia_id || "",
                cuenta_transferencia_alias: venta.cuenta_transferencia_alias || "",
                cuenta_transferencia_banco: venta.cuenta_transferencia_banco || "",
                cuenta_transferencia_cbu: venta.cuenta_transferencia_cbu || "",
                cuenta_transferencia_nombre: venta.cuenta_transferencia_nombre || "",

                nombre_entrega: venta.nombre_entrega || (esPublicoGeneral ? "CLI001" : ""),
                rut_entrega: venta.rut_entrega || "",
                telefono_entrega: venta.telefono_entrega || "",
                correo_entrega: venta.correo_entrega || "",
                direccion_entrega: venta.direccion_entrega || "",

                agencia_entrega: venta.agencia_entrega || (esPublicoGeneral ? "RETIRO TIENDA" : ""),
                costo_agencia: venta.costo_agencia || 0,
                hora_entrega_agencia: venta.hora_entrega_agencia || "",

                url: venta.url || "",
                nombre_entrega_mostrado: venta.nombre_entrega_mostrado || (esPublicoGeneral ? "Público General (CLI001)" : "")
            };
        }


        function handleFormSubmit(event) {
            var venta = JSON.parse(localStorage.getItem('venta'));

            if (venta.detalle.length === 0) {
                Swal.fire("Warning!", "Debe agregar productos al pedido!", "warning");
                event.preventDefault();
                return false;
            } else {
                var config = JSON.parse(localStorage.getItem('configuracion_pagina'));

                // Añadir campos extra al objeto original
                Object.assign(venta, {
                    op: "venta",
                    operacion,
                    id: idpedido,
                    nombre_entrega: $('#txt_nombre').val(),
                    rut_entrega: $('#txt_rut').val(),
                    telefono_entrega: $('#txt_telefono').val(),
                    correo_entrega: $('#txt_correo').val(),
                    direccion_entrega: $('#txt_direccion').val(),
                    agencia_entrega: $('#txt_agencia').val(),
                    url: config.pagina_url,
                    item: {} // Limpiar item antes de enviar
                });

                // Ordenar las claves del objeto antes de enviarlo
                const venta_ordenada = ordenarVentaFinal(venta);

                makeAjaxCall(
                    `${url_final_venta}exec`,
                    venta_ordenada,
                    function (respuesta) {
                        postFormSubmitActions(respuesta);
                    }
                );
            }
        }


        function postFormSubmitActions(respuesta) {
            regresar_principal();
            inicializarVenta();
            total_pedido();
            $('#btn_cerrar').click();
            $("#form_pedido").trigger("reset");
            Swal.fire("Éxito!", respuesta.message, "success");

            if (respuesta.message_whatsapp) {
                redirectToWhatsApp(respuesta.message_whatsapp);
            }
        }

        function redirectToWhatsApp(message) {
            var config = JSON.parse(localStorage.getItem('configuracion_pagina'));
            window.location.href = `https://wa.me/${config.contactabilidad}?text=${encodeURIComponent(message)}`;
        }

        function toggleLoader(show = true) {
            $(".loader-wrapper")[show ? "fadeIn" : "fadeOut"]("slow");
        }

        function initializeMutationObserver() {
            const observer = new MutationObserver((mutationsList, observer) => {
                for (let mutation of mutationsList) {
                    if (mutation.type === 'childList') {
                        const swalCheckboxLabel = document.querySelector('.swal2-checkbox');
                        if (swalCheckboxLabel) {
                            swalCheckboxLabel.remove();
                            observer.disconnect();
                            break;
                        }
                    }
                }
            });
            observer.observe(document.body, { childList: true, subtree: true });
        }

        function makeAjaxCall(url, data, onSuccess, onError = null, method = "POST") {
            toggleLoader(true);
            $.ajax({
                url,
                jsonp: "callback",
                method,
                data: JSON.stringify(data),
                async: true,
                success: function (response) {
                    if (response.status === '0') {
                        onSuccess(response);
                    } else {
                        Swal.fire("Warning!", response.message, "warning");
                        if (onError) onError(response);
                    }
                },
                error: function (error) {
                    Swal.fire("Error!", "Ocurrió un problema con la conexión.", "error");
                    console.error(error);
                },
                complete: function () {
                    toggleLoader(false);
                }
            });
        }

        document.addEventListener("DOMContentLoaded", function () {
            const header = document.querySelector("header");
            const detallePedidoPage = document.querySelector("#pedido_parametro_producto");

            // Observa si la vista está visible
            const observer = new IntersectionObserver((entries) => {
                entries.forEach((entry) => {
                    if (entry.isIntersecting) {
                        header.style.display = "none"; // Oculta el header
                    } else {
                        header.style.display = "flex"; // Muestra el header
                    }
                });
            });

            if (detallePedidoPage) {
                observer.observe(detallePedidoPage);
            }
        });


        var currentFormaPago;
        function cargar_detalle_pedido(operacion, detalle) {
            var pedido = JSON.parse(detalle);

            // ── Lógica de Visibilidad de Botones (Refinamiento Mejora 4) ─────
            const estadoNorm = (pedido.estado || "").toUpperCase();

            // Actualizar variable global
            currentFormaPago = pedido.forma_pago;

            if (["PAGADO", "REVISION_MANUAL", "CANCELADO"].includes(estadoNorm)) {
                $('#btn_editar').addClass('d-none').removeAttr("href");
                $('#btn_cancelar').addClass('d-none');
                $('#btn_pagar').addClass('d-none');

                if (estadoNorm === "PAGADO") {
                    $('#pago_notificado').removeClass('d-none').text('✅ Pago verificado');
                }
            } else if (operacion === "p") {
                // Configurar botón principal según forma de pago
                if (currentFormaPago === "Transferencia") {
                    $('#btn_pagar').addClass('d-none'); // Se usa subida de comprobante
                } else {
                    $('#btn_pagar').removeClass('d-none').text("Confirmar Visita");
                }
            }
            // ─────────────────────────────────────────────────────────────────

            var detalle_pedido = `
    <div class="cliente-info border rounded p-4 bg-white shadow-sm mb-4">
      <h5 class="text-primary fw-bold mb-3">
        <i class="fa fa-shopping-cart me-2"></i>DETALLES DE LA VENTA
      </h5>
  `;

            const esClienteGeneral = pedido.nombre_entrega === "CLI001";
            const esRetiro = pedido.agencia_entrega === "RETIRO TIENDA";
            const nombreMostrar = esClienteGeneral ? "PÚBLICO GENERAL" : (pedido.nombre_entrega_mostrado || pedido.nombre_entrega);

            detalle_pedido += `<p><strong class="text-primary">👤 Nombre y Apellidos:</strong> ${nombreMostrar}</p>`;

            if (!esClienteGeneral) {
                detalle_pedido += `<p><strong class="text-primary">🆔 RUT:</strong> ${pedido.rut_entrega || "N/A"}</p>`;
                detalle_pedido += `<p><strong class="text-primary">📞 Teléfono:</strong> ${pedido.telefono_entrega || "N/A"}</p>`;
                detalle_pedido += `<p><strong class="text-primary">✉️ Correo:</strong> ${pedido.correo_entrega || "N/A"}</p>`;
                if (!esRetiro) {
                    detalle_pedido += `<p><strong class="text-primary">📍 Dirección:</strong> ${pedido.direccion_entrega || "N/A"}</p>`;
                }
            }

            detalle_pedido += `<p><strong class="text-primary">🏬 Agencia:</strong> ${pedido.agencia_entrega || "N/A"}</p>`;

            if (pedido.hora_entrega_agencia) {
                const hora = new Date(pedido.hora_entrega_agencia);
                const horaFormateada = hora.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });
                const etiquetaHora = esRetiro ? "⏰ Hora Límite de Retiro" : "⏰ Hora de Entrega";
                detalle_pedido += `<p><strong class="text-primary">${etiquetaHora}:</strong> ${horaFormateada}</p>`;
            }

            if (pedido.forma_pago === "Transferencia") {
                detalle_pedido += `
      <div class="cuenta-info border rounded bg-light p-3 my-3 shadow-sm">
        <h6 class="text-success fw-bold mb-3">
          <i class="fa fa-bank me-2"></i>💸 Datos de Transferencia
        </h6>
        <p><strong>🏷️ ID:</strong> ${pedido.cuenta_transferencia_id}</p>
        <p><strong>📛 Alias:</strong> ${pedido.cuenta_transferencia_alias}</p>
        <p><strong>🏦 Banco:</strong> ${pedido.cuenta_transferencia_banco}</p>
        <p><strong>🔢 CBU:</strong> ${pedido.cuenta_transferencia_cbu}</p>
        <p><strong>👤 Titular:</strong> ${pedido.cuenta_transferencia_nombre}</p>
      </div>
    `;
                // ── CARD DE COMPROBANTE CON IA ──────────────────────────────
                detalle_pedido += `
      <div class="comprobante-upload-card border rounded p-3 my-3 shadow-sm bg-white" id="comprobante_card">
        <h6 class="text-primary fw-bold mb-2">
          <i class="fa fa-upload me-2"></i>📎 Subir Comprobante de Pago
        </h6>
        <p class="small text-muted mb-2">
          Nuestra IA verificará tu comprobante automáticamente y actualizará el estado del pedido.
        </p>

        <!-- Preview de la imagen seleccionada -->
        <div id="comprobante_preview_wrapper" style="display:none; margin-bottom:10px; text-align:center;">
          <img id="comprobante_preview" alt="Vista previa"
               style="max-width:100%; max-height:220px; border-radius:8px; border:1px solid #dee2e6; box-shadow:0 1px 4px rgba(0,0,0,.1);" />
        </div>

        <div class="input-group mb-2">
          <input type="file" class="form-control form-control-sm" id="comprobante_file"
                 accept="image/jpeg,image/png,image/webp,image/gif,application/pdf"
                 onchange="previsualizarComprobante(event)" />
          <button class="btn btn-sm btn-primary" id="btn_subir_comprobante"
                  onclick="subirComprobante('${idpedido}')" type="button">
            <i class="fa fa-magic"></i> Verificar con IA
          </button>
        </div>

        <div id="comprobante_resultado" style="display:none;"></div>
      </div>
    `;
            } else if (operacion === "p" && pedido.forma_pago) {
                // ── CARD: Confirmación para Efectivo / Tarjetas / Otros ─────────────
                detalle_pedido += `
      <div class="comprobante-upload-card border rounded p-3 my-3 shadow-sm bg-white">
        <h6 class="text-dark fw-bold mb-2">
          💳 Confirmar Pago Presencial
        </h6>
        <p class="mb-1">Método seleccionado: <strong class="text-primary">${pedido.forma_pago}</strong></p>
        <p class="small text-muted mb-3">
          Si ya realizaste el pago por este medio, confirmalo aquí para que el vendedor lo verifique.
        </p>
        <button id="btn_confirmar_efectivo" class="btn btn-warning w-100 fw-bold">
          ✅ Confirmar recepción de pago
        </button>
        <div id="resultado_efectivo" style="display:none"></div>
      </div>
                `;
            }

            detalle_pedido += `
  <div class="importes border rounded bg-white p-3 shadow mt-4">`;

            const tituloImportes = pedido.forma_pago
                ? `🧾 Importes para ${pedido.forma_pago}`
                : `🧾 Resumen de Importes`;

            detalle_pedido += `
    <h6 class="text-dark fw-bold mb-3">
      <i class="fa fa-cash-register me-2"></i> ${tituloImportes}
    </h6>`;

            if (pedido.costo_agencia && Number(pedido.costo_agencia) > 0) {
                detalle_pedido += `<p><strong class="text-secondary">🚚 Costo de Envío:</strong> <span class="text-danger fw-bold">${formatMoneda(pedido.costo_agencia, pedido.moneda)}</span></p>`;
            }

            if (pedido.recargo_pago) {
                detalle_pedido += `<p><strong class="text-secondary">💳 Recargo (%):</strong> <span class="fw-bold text-warning">${pedido.recargo_pago}%</span></p>`;
            }

            if (pedido.recargo_valor) {
                detalle_pedido += `<p><strong class="text-secondary">💰 Recargo ($):</strong> <span class="fw-bold text-warning">${formatMoneda(pedido.recargo_valor, pedido.moneda)}</span></p>`;
            }

            if (pedido.total) {
                detalle_pedido += `<p><strong class="text-secondary">🔢 Total a Pagar:</strong> <span class="fw-bold text-success fs-5">${formatMoneda(pedido.total, pedido.moneda)}</span></p>`;
            }
            detalle_pedido += `</div></div>`;

            // Agrupación de productos
            var productosAgrupados = {};
            for (var i = 0; i < pedido.detalle.length; i++) {
                var producto = pedido.detalle[i];
                var nombreParts = producto.nombre.split(' (');
                var sku = nombreParts[0];
                var variedad = "Sin variedad", subvariedad = "Sin subvariedad", talle = "Sin talle";

                if (nombreParts[1]) {
                    var detalleParts = nombreParts[1].replace(')', '').split(' - ');
                    variedad = detalleParts[0] || "Sin variedad";
                    subvariedad = detalleParts[1] || "Sin subvariedad";
                    talle = detalleParts[2] || "Surt";
                }

                var clave = producto.codigo + sku;

                // 🔄 Obtener imagen portada o primera
                let imagenURL = "";
                if (Array.isArray(producto.imagen)) {
                    const portada = producto.imagen.find(img => img.portada && img.url);
                    const primera = producto.imagen.find(img => img.url);
                    imagenURL = portada?.url || primera?.url || "";
                }

                if (!productosAgrupados[clave]) {
                    productosAgrupados[clave] = {
                        nombre: sku,
                        codigo: producto.codigo,
                        imagen: imagenURL,
                        variedades: {}
                    };
                }

                if (!productosAgrupados[clave].variedades[variedad]) {
                    productosAgrupados[clave].variedades[variedad] = [];
                }

                productosAgrupados[clave].variedades[variedad].push({
                    subvariedad: subvariedad,
                    talle: talle,
                    cantidad: producto.cantidad,
                    precio: producto.precio
                });
            }

            // Generar HTML
            detalle_pedido += '<ul class="list-group">';
            for (var clave in productosAgrupados) {
                var prod = productosAgrupados[clave];
                detalle_pedido += '<li class="list-group-item d-flex flex-column">';
                detalle_pedido += `<div><div class="fw-bold">${prod.nombre} (Código: ${prod.codigo})</div>`;

                if (prod.imagen) {
                    detalle_pedido += `
      <a href="${prod.imagen}" data-fancybox="gallery" data-caption="${prod.nombre}">
        <img src="${prod.imagen}" class="img-thumbnail mb-2 border border-2 shadow-sm" style="max-width: 180px;">
      </a>`;
                }


                for (var variedad in prod.variedades) {
                    var detalles = prod.variedades[variedad];
                    var total = 0;
                    detalle_pedido += `<div class="mt-3"><h6>🎨 Variedad: ${variedad}</h6>`;
                    detalle_pedido += '<table class="table table-sm table-bordered table-striped table-hover text-center">';
                    detalle_pedido += '<thead><tr><th>Color</th><th>Talle</th><th>Cant.</th><th>Precio</th><th>Subtotal</th></tr></thead><tbody>';

                    for (var j = 0; j < detalles.length; j++) {
                        var item = detalles[j];
                        var subtotal = parseFloat(item.precio) * item.cantidad;
                        total += subtotal;

                        if (variedad === "Surtido") {
                            item.subvariedad = item.talle = "Surtido";
                        }

                        detalle_pedido += `<tr>
          <td>${item.subvariedad}</td>
          <td>${item.talle}</td>
          <td>${item.cantidad}</td>
          <td>${formatMoneda(item.precio, pedido.moneda)}</td>
          <td>${formatMoneda(subtotal.toFixed(2), pedido.moneda)}</td>
        </tr>`;
                    }

                    detalle_pedido += '</tbody></table>';
                    detalle_pedido += `<p class="text-end fw-bold text-primary">🧮 Total Variedad: ${formatMoneda(total.toFixed(2), pedido.moneda)}</p>`;
                    detalle_pedido += '</div>';
                }
                detalle_pedido += '</div></li>';
            }
            detalle_pedido += '</ul>';

            $("#pedido_parametro_producto").html(detalle_pedido);
        }

        const AppState = {
            productosCargados: false,
            lastScrollTop: 0,
            isProgrammaticScroll: false,
            estaEnVistaDetalle: false,
            detallesPedido: {}
        };

        // Utilidad para mejorar rendimiento (Throttle)
        function throttle(func, limit) {
            let lastFunc;
            let lastRan;
            return function () {
                const context = this;
                const args = arguments;
                if (!lastRan) {
                    func.apply(context, args);
                    lastRan = Date.now();
                } else {
                    clearTimeout(lastFunc);
                    lastFunc = setTimeout(function () {
                        if ((Date.now() - lastRan) >= limit) {
                            func.apply(context, args);
                            lastRan = Date.now();
                        }
                    }, limit - (Date.now() - lastRan));
                }
            }
        }

        // Variable global para almacenar los detalles del pedido (Mantenemos referencia por si acaso, pero usaremos AppState)
        // let detallesPedido = {}; // REFATORIZADO a AppState.detallesPedido

        // Función para guardar el estado actual de los detalles del pedido
        function guardarDetallesPedido() {
            const detallesGuardados = {};

            $(".detalle-cantidad-item").each(function () {
                const contenedor = $(this).closest(".detalle-cantidad");
                const id = contenedor.data("codigo");
                if (!id) return;

                const html = contenedor.html();
                if (!AppState.detallesPedido[id]) {
                    AppState.detallesPedido[id] = { html };
                }
            });

            localStorage.setItem("detallesPedido", JSON.stringify(AppState.detallesPedido));
        }


        // Función para restaurar los detalles guardados después de cargar productos
        function restaurarDetallesPedido() {
            for (const codigo in AppState.detallesPedido) {
                const detalle = document.getElementById(`detalle_cantidad_${codigo}`);
                const contenedor = document.getElementById(`contenedor_plegable_${codigo}`);
                const boton = document.getElementById(`toggle_button_${codigo}`);
                const datos = AppState.detallesPedido[codigo];

                if (detalle && datos) {
                    // Restaurar el contenido del detalle
                    detalle.innerHTML = datos.contenido;

                    if (contenedor) {
                        // Restaurar el estado del desplegable
                        if (datos.estadoDesplegable) {
                            $(contenedor).collapse('show');
                        } else {
                            $(contenedor).collapse('hide');
                        }
                    }

                    if (boton) {
                        // Restaurar el texto dinámico del botón
                        boton.innerHTML = datos.textoBoton;
                    }
                }
            }
        }

        // Función para Cookies
        document.addEventListener("DOMContentLoaded", () => {
            const setCookie = (name, value, days) => {
                const d = new Date();
                d.setTime(d.getTime() + days * 24 * 60 * 60 * 1000);
                document.cookie = `${name}=${value}; expires=${d.toUTCString()}; path=/`;
            };

            const getCookie = (name) => {
                const cookies = document.cookie.split(';').map(cookie => cookie.trim());
                const cookie = cookies.find(cookie => cookie.startsWith(`${name}=`));
                return cookie ? cookie.split('=')[1] : null;
            };

            const cookieBar = document.getElementById('cookie-bar');
            const acceptCookiesButton = document.getElementById('accept-cookies');

            if (!getCookie('cookiesAccepted')) {
                cookieBar.style.display = "block";

                acceptCookiesButton.onclick = () => {
                    setCookie('cookiesAccepted', 'true', 365);
                    cookieBar.style.display = "none";
                    console.log("Usuario ha aceptado las cookies.");
                    // Opcional: acá podrías llamar a cargar_productos() si querés cargar justo después
                    cargar_productos();
                };
            } else {
                console.log("Las cookies ya fueron aceptadas previamente.");
                // Forzar cargado de productos directamente si ya aceptó cookies
                cargar_productos();

            }

            const modal = document.getElementById('modal-privacidad');
            const closeModal = document.querySelector('.close');
            const showPrivacyButton = document.getElementById('show-privacidad');

            if (showPrivacyButton) {
                showPrivacyButton.addEventListener("click", (event) => {
                    event.preventDefault();
                    modal.style.display = "block";
                });
            }

            closeModal.addEventListener("click", () => {
                modal.style.display = "none";
            });

            window.addEventListener("click", (event) => {
                if (event.target === modal) {
                    modal.style.display = "none";
                }
            });
        });

        // Función de Review de Google optimizada
        function rateAndRedirect(event) {
            event.preventDefault();
            const reviewUrl = event.target.closest("a").href;
            window.open(reviewUrl, "_blank");

            const selectedStar = event.target;
            const stars = Array.from(selectedStar.parentElement.children).reverse();
            const indexSelected = stars.indexOf(selectedStar);

            stars.forEach((star, index) => {
                star.classList.toggle("selected", index <= indexSelected);
            });

            document.querySelector(".review-section p").style.display = "none";
            document.getElementById("thanksMsg").style.display = "block";
        }

        function highlightStars(event) {
            const selectedStar = event.target;
            const stars = Array.from(selectedStar.parentElement.children).reverse();
            const indexSelected = stars.indexOf(selectedStar);

            stars.forEach((star, index) => {
                star.classList.toggle("highlight", index <= indexSelected);
            });
        }

        function removeHighlight(event) {
            Array.from(event.target.parentElement.children).reverse()
                .forEach(star => star.classList.remove("highlight"));
        }

        window.onload = () => {
            const reviewParagraph = document.querySelector(".review-section p");
            const thanksMsg = document.getElementById("thanksMsg");
            const stars = document.querySelectorAll(".stars-list .star");

            if (reviewParagraph) {
                reviewParagraph.style.display = "block";
            }

            if (thanksMsg) {
                thanksMsg.style.display = "none";
            }

            stars.forEach(star => {
                star.classList.remove("selected", "highlight");
            });
        };

        //FUNCIONES DE NAVBAR DE PIE DE PAGINA
        function abrir_whatsapp() {
            var config = JSON.parse(localStorage.getItem('configuracion_pagina'));
            var mensaje = encodeURIComponent("Hola, quiero hacer un pedido.");
            window.open("https://wa.me/" + config.contactabilidad + "?text=" + mensaje, '_blank');
        }

        const navbarFooter = document.getElementById('navbarfooter');
        const mostrarFooterBtn = document.getElementById('mostrarFooterBtn');
        // Variables movidas a AppState: lastScrollTop, isProgrammaticScroll, estaEnVistaDetalle

        // Detectar dirección de scroll (OPTIMIZADO con throttle)
        window.addEventListener('scroll', throttle(function () {
            if (AppState.isProgrammaticScroll) return; // 🔥 IGNORAR si el scroll es programado

            let st = window.pageYOffset || document.documentElement.scrollTop;

            if (st > AppState.lastScrollTop) {
                // Bajando -> Ocultar footer
                ocultarFooter();
            } else if (st < AppState.lastScrollTop) {
                // Subiendo -> Mostrar footer
                mostrarFooter();
            }
            AppState.lastScrollTop = st <= 0 ? 0 : st; // Evitar scroll negativo
        }, 100), false);

        // Función para ocultar
        function ocultarFooter() {
            navbarFooter.classList.add('oculto');
            navbarFooter.classList.remove('visible');

            // 👉 Solo mostrar el botón si no estamos en la vista de detalle
            if (!AppState.estaEnVistaDetalle) {
                mostrarFooterBtn.style.display = 'block';
            } else {
                mostrarFooterBtn.style.display = 'none';
            }
        }


        // Función para mostrar
        function mostrarFooter() {
            navbarFooter.classList.remove('oculto');
            navbarFooter.classList.add('visible');
            mostrarFooterBtn.style.display = 'none';
        }

        // Helper: Guardar en LocalStorage con manejo robusto de errores
        function guardarConfiguracionEnLocal(respuesta) {
            try {
                localStorage.setItem('configuracion_pagina', JSON.stringify(respuesta));
                localStorage.setItem('configuracion_pagina_timestamp', Date.now());
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    console.warn("⚠️ QuotaExceededError: Limpiando localStorage y reintentando...");
                    localStorage.clear();
                    try {
                        localStorage.setItem('configuracion_pagina', JSON.stringify(respuesta));
                        localStorage.setItem('configuracion_pagina_timestamp', Date.now());
                    } catch (e2) {
                        console.error("❌ Error crítico guardando configuración:", e2);
                    }
                }
            }
        }

        // ─── FUENTES DE DATOS (en orden de prioridad) ────────────────────────────────
        // Las URLs vienen del bloque CONFIGURACIÓN DE INSTALACIÓN ERP en el <head>

        // Fuente 1: Servidor Primario (Donweb - más rápido, mismo hosting que el frontend)
        function cargarDesdeServidorPrimario() {
            return $.ajax({
                url: DONWEB_BLOGGER_URL,   // ← definida en <head>
                method: "GET",
                dataType: "json"
            });
        }

        // Fuente 2: GitHub Raw (respaldo externo, JSON estático público)
        function cargarDesdeGitHub() {
            return $.ajax({
                url: GITHUB_BLOGGER_URL,   // ← definida en <head>
                method: "GET",
                dataType: "json",
                cache: false
            });
        }

        // Fuente 3: Apps Script (emergencia - más lento, JSONP directo al ERP)
        function cargarDesdeAppsScript(idpedido) {
            return $.ajax({
                url: GAS_BASE_URL + "exec?op=configuracion&id=" + encodeURIComponent(idpedido),  // ← definida en <head>
                dataType: 'jsonp',
                jsonp: "callback"
            });
        }
        // ─── ORQUESTADOR PRINCIPAL ───────────────────────────────────────────────────
        function listar_configuracion(idpedido, operacion) {
            $("#carousel-loader").show();
            $("#title-loader").show();
            const finalizeUI = () => {
                $(".loader-wrapper").fadeOut("slow");
                $("#carousel-loader").hide();
                $("#title-loader").hide();
            };
            // 1. MODO EDICIÓN: Carga forzosa desde GAS (bypass de todo caché)
            if (operacion === "e") {
                console.log("🛠 Modo edición: Carga directa desde GAS");
                $(".loader-wrapper").fadeIn("slow", function () {
                    cargarDesdeAppsScript(idpedido)
                        .done((respuesta) => {
                            if (respuesta.status == '0') {
                                guardarConfiguracionEnLocal(respuesta);
                                procesarConfiguracion(respuesta, idpedido, operacion);
                            } else {
                                Swal.fire("Alerta!", respuesta.message || "Error desconocido", "warning");
                            }
                        })
                        .fail(() => Swal.fire("Error!", "Fallo carga desde GAS (Edición).", "error"))
                        .always(finalizeUI);
                });
                return;
            }
            // 2. MODO NORMAL: Verificar Caché local (6 min)
            const configuracionPaginaStr = localStorage.getItem('configuracion_pagina');
            const ultimaActualizacion = localStorage.getItem('configuracion_pagina_timestamp');
            const ahora = Date.now();
            const intervaloActualizacionMs = 6 * 60 * 1000;
            if (configuracionPaginaStr && ultimaActualizacion && (ahora - ultimaActualizacion) <= intervaloActualizacionMs) {
                console.log("⚡ Usando caché local");
                try {
                    const config = JSON.parse(configuracionPaginaStr);
                    procesarConfiguracion(config, idpedido, operacion);
                    return;
                } catch (e) {
                    console.warn("⚠️ Error parseando caché, recargando...");
                }
            }
            // 3. MODO NORMAL: Cascada de fuentes con fallback progresivo
            $("#loader-categorias span").text("Cargando Categorías y Productos...");
            $("#loader-categorias").show();
            $("#productos-container").hide();
            $(".loader-wrapper").fadeIn("slow", function () {
                console.time("configuracion");
                // Intento 1: Donweb (primario)
                cargarDesdeServidorPrimario()
                    .done((respuesta) => {
                        console.timeEnd("configuracion");
                        console.log("✅ [Fuente 1] Donweb OK");
                        guardarConfiguracionEnLocal(respuesta);
                        procesarConfiguracion(respuesta, idpedido, operacion);
                        finalizeUI();
                    })
                    .fail(() => {
                        console.warn("⚠️ [Fuente 1] Donweb falló → intentando GitHub...");
                        // Intento 2: GitHub (respaldo)
                        cargarDesdeGitHub()
                            .done((respuesta) => {
                                console.timeEnd("configuracion");
                                console.log("✅ [Fuente 2] GitHub OK");
                                guardarConfiguracionEnLocal(respuesta);
                                procesarConfiguracion(respuesta, idpedido, operacion);
                                finalizeUI();
                            })
                            .fail(() => {
                                console.warn("⚠️ [Fuente 2] GitHub falló → intentando GAS (emergencia)...");
                                // Intento 3: GAS (emergencia)
                                cargarDesdeAppsScript(idpedido)
                                    .done((respuesta) => {
                                        console.timeEnd("configuracion");
                                        console.log("✅ [Fuente 3] GAS OK");
                                        if (respuesta.status == '0') {
                                            guardarConfiguracionEnLocal(respuesta);
                                            procesarConfiguracion(respuesta, idpedido, operacion);
                                        } else {
                                            Swal.fire("Alerta!", respuesta.message || "Error en emergencia", "warning");
                                        }
                                    })
                                    .fail(() => {
                                        console.error("❌ Fallaron las 3 fuentes de datos");
                                        Swal.fire("Error Crítico", "No se pudo cargar la configuración de la tienda.", "error");
                                    })
                                    .always(finalizeUI);
                            });
                    });
            });
        }

        function procesarConfiguracion(respuesta, idpedido, operacion) {
            if (respuesta.aplicar_marca_agua === true && respuesta.pagina_tienda?.tienda_id) {
                document.body.classList.add('watermark-enabled');
                // Llamamos a la nueva función para que cree el CSS dinámico
                actualizarMarcaDeAgua(respuesta.pagina_tienda.tienda_id);
                console.log(`💧 Marca de agua [ACTIVADA] para: ${respuesta.pagina_tienda.tienda_id}.`);
            } else {
                document.body.classList.remove('watermark-enabled');
                console.log("💧 Marca de agua [DESACTIVADA].");
            }

            // ---- Parte 2: Construcción de la Página (Tu código original) ----
            if (respuesta.pagina_tienda) {
                const tienda = respuesta.pagina_tienda;

                window.abrirModalFormasPago = () => mostrarModalFormasPago(respuesta.formas_pago || [], respuesta.cuenta_transferencia_dia || {});
                window.abrirModalAgencias = () => mostrarModalAgencias(respuesta.contentagencia);

                const botonFormasPago = `<button class="btn btn-outline-primary btn-sm" onclick="abrirModalFormasPago()">Ver Formas de Pago</button>`;
                const botonAgencias = `<button class="btn btn-outline-success btn-sm" onclick="abrirModalAgencias()">Ver Agencias</button>`;

                const botonesMetodosAgencias = `
          <div style="text-align: center; margin: 20px 0;">
            ${botonFormasPago}
            ${botonAgencias}
          </div>
        `;

                const html = `
          <div class="store-title">${tienda.tienda_id}</div>
          <div class="store-description">${tienda.descripcion}</div>
          <table><tbody>
            <tr>
              <td style="width: 50%; text-align: left; padding: 2px;">
                <div class="store-logo">
                  <img alt="Logo de la tienda" class="d-md-block d-sm-block d-block" style="max-width: 100%; height: auto;" src="${tienda.logo_url}" />
                </div>
              </td>
              <td style="width: 50%; text-align: right; padding: 2px;">
                <div class="social-buttons">
                  ${tienda.redes_sociales?.facebook ? `<a class="btn btn-primary" style="margin-right: 5px;" href="${tienda.redes_sociales.facebook}" target="_blank"><i class="fa fa-facebook"></i> Facebook</a>` : ""}
                  ${tienda.redes_sociales?.tiktok ? `<a class="btn btn-dark" style="margin-right: 5px;" href="${tienda.redes_sociales.tiktok}" target="_blank"><i class="fa fa-video-camera"></i> TikTok</a>` : ""}
                  ${tienda.redes_sociales?.instagram ? `<a class="btn btn-danger" href="${tienda.redes_sociales.instagram}" target="_blank"><i class="fa fa-instagram"></i> Instagram</a>` : ""}
                </div>
                ${tienda.vcard_url ? `
                  <p class="download-vcard" style="margin-top: 10px;">
                    <button class="btn-download-vcard" onclick="window.open('${tienda.vcard_url}', '_blank')">📤 Descargar 📇VCARD de Contacto</button>
                  </p>` : ''}
              </td>
            </tr>
          </tbody></table>

          <div style="font-size: 14px; line-height: 1.5; margin-top: 10px;">
            ${tienda.direccion ? `<p class="direccion"><strong>🏪 Dirección: </strong><a href="https://maps.google.com/?q=${encodeURIComponent(tienda.direccion)}" target="_blank">${tienda.direccion}</a></p>` : ''}
            ${tienda.coordenadas ? `<p class="vista-360"><strong>👁️ Vista 360°: </strong><a href="https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${tienda.coordenadas}" target="_blank">Ver en Google Street View</a></p>` : ''}
            ${tienda.telefono ? `<p class="celular"><strong>📱 Celular: </strong><a href="tel:${tienda.telefono}">${tienda.telefono}</a></p>` : ''}
            ${tienda.correo ? `<p class="correo"><strong>📧 Correo: </strong><a href="mailto:${tienda.correo}">${tienda.correo}</a></p>` : ''}
            ${(tienda.horario?.apertura && tienda.horario?.cierre) ? `<p class="horario-atencion"><strong>🕢 Horario de Atención: </strong>${tienda.horario.apertura} a ${tienda.horario.cierre} de lunes a Viernes</p>` : ''}
            ${tienda.compra_minima ? `<p class="compra-minima"><strong>⚠ Compra Mínima: </strong>${tienda.compra_minima} prendas</p>` : ''}
            ${tienda.formularios?.cliente ? `<p class="formulario-cliente"><strong>📄 Formulario de Cliente: </strong><a href="${tienda.formularios.cliente}" target="_blank">Hacer Clic Aquí</a></p>` : ''}
            ${tienda.formularios?.catalogo_drive ? `<p class="catalogo-drive"><strong>📂 Catálogo Drive para Revendedores: </strong><a href="${tienda.formularios.catalogo_drive}" target="_blank">Hacer Clic Aquí</a></p>` : ''}

            ${botonesMetodosAgencias}

            ${tienda.google_review?.place_id ? `
              <div class="review-section">
                <p>¡Deja tu reseña en Google Maps!</p>
                <a href="https://search.google.com/local/writereview?placeid=${tienda.google_review.place_id}" target="_blank">
                  <ul class="stars-list">
                    <li class="star" data-value="1" onclick="rateAndRedirect(event)">★</li>
                    <li class="star" data-value="2" onclick="rateAndRedirect(event)">★</li>
                    <li class="star" data-value="3" onclick="rateAndRedirect(event)">★</li>
                    <li class="star" data-value="4" onclick="rateAndRedirect(event)">★</li>
                    <li class="star" data-value="5" onclick="rateAndRedirect(event)">★</li>
                  </ul>
                </a>
                <p class="thanks-msg" id="thanksMsg">¡Gracias por tu calificación!</p>
              </div>
            ` : ''}
          </div>
        `;

                $("#pagina_titulo").html(html);
            }

            if (respuesta.pagina_carrusel && Array.isArray(respuesta.pagina_carrusel)) {
                const placeholderURL = "https://placehold.co/800x436/0088f2/white?text=Cargando+Banner";
                let lstCarrusel = '<div class="carousel-inner">';
                respuesta.pagina_carrusel.forEach((banner, index) => {
                    const isActive = index === 0 ? 'active' : '';
                    const urlBanner = banner.url || placeholderURL;
                    const tituloBanner = banner.titulo || `Promoción ${index + 1}`;
                    const descBanner = banner.descripcion || '';
                    lstCarrusel += `
              <div class="carousel-item ${isActive}">
                <a href="${urlBanner}" data-fancybox="banners" data-caption="<div class='banner-caption'><strong>${tituloBanner}</strong><br>${descBanner}</div>">
                  <img src="${urlBanner}" class="d-block w-100" width="800" height="436" alt="${tituloBanner}" loading="lazy" onerror="this.src='${placeholderURL}'">
                </a>
              </div>`;
                });
                lstCarrusel += '</div>';
                $("#carouselExampleSlidesOnly").html(lstCarrusel);
            }

            let lstAgencia = '<option value="" selected>Seleccione</option>';
            if (respuesta.contentagencia && Array.isArray(respuesta.contentagencia)) {
                respuesta.contentagencia.forEach(agencia => {
                    lstAgencia += `<option value="${agencia.codigo}">${agencia.descripcion}</option>`;
                });
            }
            $("#txt_agencia").html(lstAgencia);
            // Guardar en localStorage ANTES de poblar el dropdown
            localStorage.setItem('configuracion_pagina', JSON.stringify(respuesta));
            localStorage.setItem('configuracion_pagina_timestamp', Date.now());

            try {
                const selectCategoriaPadre = document.getElementById('filtroCategoriaPadre');
                if (selectCategoriaPadre) {
                    const categoriasPadreOriginal = respuesta.content || [];
                    const nombresPadreUnicos = [...new Set(categoriasPadreOriginal.map(padre => padre.nombre_padre).filter(n => n))]
                        .sort((a, b) => a.localeCompare(b));

                    let opcionesHTML = `<option selected='selected' value=''>Todas las Categorías</option>`;

                    nombresPadreUnicos.forEach(nombrePadre => {
                        if (nombrePadre) {
                            const valueEscapado = nombrePadre.replace(/"/g, '"');
                            opcionesHTML += `<option value="${valueEscapado}">${nombrePadre}</option>`;
                        }
                    });

                    selectCategoriaPadre.innerHTML = opcionesHTML;
                    console.log("✔️ Dropdown de Categoría Padre poblado.");
                } else {
                    console.warn("⚠️ No se encontró el elemento #filtroCategoriaPadre");
                }
            } catch (error) {
                console.error("❌ Error al poblar el dropdown de Categoría Padre:", error);
            }
            // <<< --- FIN: Poblar Dropdown --- >>>

            // --- (Bloque para poblar el dropdown del MODAL - debe estar después) ---
            try {
                const selectModalCategoriaPadre = document.getElementById('filtroModalCategoriaPadre');
                if (selectModalCategoriaPadre) {
                    const categoriasPadreOriginal = respuesta.content || [];
                    const nombresPadreUnicos = [...new Set(categoriasPadreOriginal.map(padre => padre.nombre_padre).filter(n => n))]
                        .sort((a, b) => a.localeCompare(b));

                    let opcionesHTMLModal = `<option selected='selected' value=''>-- Mostrar Todas --</option>`;

                    nombresPadreUnicos.forEach(nombrePadre => {
                        if (nombrePadre) {
                            const valueEscapado = nombrePadre.replace(/"/g, '"');
                            opcionesHTMLModal += `<option value="${valueEscapado}">${nombrePadre}</option>`;
                        }
                    });

                    selectModalCategoriaPadre.innerHTML = opcionesHTMLModal;
                    console.log("✔️ Dropdown del Modal poblado.");
                } else {
                    console.warn("⚠️ No se encontró el elemento #filtroModalCategoriaPadre");
                }
            } catch (error) {
                console.error("❌ Error al poblar el dropdown del Modal:", error);
            }

            if (!AppState.productosCargados) {
                cargar_productos("", "");
                actualizarMenu();
                AppState.productosCargados = true;
            }

            if (respuesta.pedido && idpedido && operacion === "e") {
                respuesta.pedido.detalle.forEach(item => {
                    mostrar_cantidad_pedido(item.idcategoria, item.codigo, item.variante, item.precio, item.moneda, item.minima, item.cantidad);
                });
                setTimeout(() => {
                    respuesta.pedido.detalle.forEach(item => {
                        toggleDetalle(item.codigo);
                    });
                }, 300);
                $("#txt_nombre").val(respuesta.pedido.nombre_entrega || '');
                $("#txt_telefono").val(respuesta.pedido.telefono_entrega || '');
                $("#txt_direccion").val(respuesta.pedido.direccion_entrega || '');
                $("#txt_agencia").val(respuesta.pedido.agencia_entrega || '');
                $("#txt_rut").val(respuesta.pedido.rut_entrega || '');
                $("#txt_correo").val(respuesta.pedido.correo_entrega || '');
            }

            const fragmentoCategorias = generarListadoCategorias();
            const contenedor = document.getElementById('listadoCategorias');
            if (fragmentoCategorias && contenedor) {
                // Limpiamos antes de añadir para evitar duplicados si se llama varias veces
                contenedor.innerHTML = '';
                contenedor.appendChild(fragmentoCategorias);
            }

            generarListadoCategoriasCarrusel();
            cargarMetodosPagoYTransferencia(respuesta);

            $("#loader-categorias").hide();
            $("#productos-container").show();

            $(".loader-wrapper").fadeOut("slow");
            $("#carousel-loader").hide();
            $("#title-loader").hide();


            // ---- Parte 3: Inicialización Dinámica de Fancybox ----
            // Primero, definimos las listas de botones que usaremos
            let rightButtonsMobile = [];
            let rightButtonsDesktop = [];

            // Decidimos qué botones mostrar basándonos en el flag de la marca de agua
            if (respuesta.aplicar_marca_agua === true) {
                // MODO PROTEGIDO: Ocultamos los botones de descarga y Drive.
                rightButtonsMobile = ["close"];
                rightButtonsDesktop = ["slideshow", "zoom", "fullscreen", "close"];
            } else {
                // MODO PÚBLICO: Mostramos todos los botones.
                rightButtonsMobile = ["descargar", "drive", "close"];
                rightButtonsDesktop = ["descargar", "slideshow", "drive", "zoom", "fullscreen", "close"];
            }

            // Por seguridad, destruimos cualquier instancia previa de Fancybox antes de crear una nueva
            try {
                Fancybox.destroy();
            } catch (e) {
                // No pasa nada si no había una instancia previa
            }

            // Ahora sí, inicializamos Fancybox con la configuración correcta y dinámica
            Fancybox.bind('[data-fancybox]', {
                Images: {}, // Eliminamos 'protected: true', ahora lo manejamos con CSS
                Video: { autoplay: false },
                Carousel: {
                    Thumbs: false, // Mantenemos las miniaturas desactivadas por simplicidad
                    Toolbar: {
                        items: {
                            descargar: {
                                tpl: '<button class="f-button" title="Abrir imagen para descargar"><i class="fa fa-external-link"></i></button>',
                                click: () => {
                                    const fancyboxInstance = Fancybox.getInstance();
                                    if (fancyboxInstance) {
                                        const slide = fancyboxInstance.getSlide();
                                        if (slide && slide.src) { window.open(slide.src, '_blank'); }
                                    }
                                }
                            },
                            drive: {
                                tpl: '<button class="f-button" title="Abrir carpeta en Google Drive"><i class="fa fa-folder"></i></button>',
                                click: () => {
                                    const fancyboxInstance = Fancybox.getInstance();
                                    if (fancyboxInstance) {
                                        const slide = fancyboxInstance.getSlide();
                                        if (slide && slide.triggerEl) {
                                            const carpetaId = slide.triggerEl.dataset.carpetaId;
                                            if (carpetaId) { window.open(`https://drive.google.com/drive/folders/${carpetaId}`, '_blank'); }
                                            else { alert("ID de carpeta no encontrado."); }
                                        }
                                    }
                                },
                            },
                        },
                        display: {
                            left: ["infobar"],
                            middle: [],
                            right: rightButtonsMobile, // Usamos la variable para los botones de móvil
                        },
                    },
                    breakpoints: {
                        "(min-width: 768px)": {
                            Toolbar: {
                                display: {
                                    left: ["infobar"],
                                    middle: ["zoomIn", "zoomOut", "toggle1to1", "rotateCCW", "rotateCW", "flipX", "flipY"],
                                    right: rightButtonsDesktop, // Usamos la variable para los botones de PC
                                },
                            },
                        },
                    },
                }
            });
        }

        //===================================================================
        //== FUNCIÓN PARA CREAR LA MARCA DE AGUA DINÁMICA                  ==
        //===================================================================
        function actualizarMarcaDeAgua(nombreTienda) {
            // Elimina cualquier estilo de marca de agua anterior para evitar duplicados
            const estiloPrevio = document.getElementById('estilo-marca-agua');
            if (estiloPrevio) {
                estiloPrevio.remove();
            }

            // Codifica el nombre de la tienda para que sea seguro usarlo en una URL
            const nombreTiendaCodificado = encodeURIComponent(nombreTienda);

            // Creamos la regla de CSS con el nombre de la tienda inyectado en el SVG del centro
            const cssDinamico = `
        body.watermark-enabled .f-panzoom__wrapper::after {
            content: "";
            position: absolute;
            z-index: 9999;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background-image:
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='50' height='12.5' viewBox='0 0 50 12.5'%3E%3Ctext x='2.5' y='10' font-family='Arial' font-size='7.5' fill='white' fill-opacity='0.3' stroke='black' stroke-width='0.5'%3EHostingShop%3C/text%3E%3C/svg%3E"),
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='50' height='12.5' viewBox='0 0 50 12.5'%3E%3Ctext x='2.5' y='10' font-family='Arial' font-size='12' fill='white' fill-opacity='0.3' stroke='black' stroke-width='0.5'%3E${nombreTiendaCodificado}%3C/text%3E%3C/svg%3E"),
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='50' height='12.5' viewBox='0 0 50 12.5'%3E%3Ctext x='2.5' y='10' font-family='Arial' font-size='7.5' fill='white' fill-opacity='0.3' stroke='black' stroke-width='0.5'%3EHostingShop%3C/text%3E%3C/svg%3E"),
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='50' height='12.5' viewBox='0 0 50 12.5'%3E%3Ctext x='2.5' y='10' font-family='Arial' font-size='7.5' fill='white' fill-opacity='0.3' stroke='black' stroke-width='0.5'%3EHostingShop%3C/text%3E%3C/svg%3E"),
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='50' height='12.5' viewBox='0 0 50 12.5'%3E%3Ctext x='2.5' y='10' font-family='Arial' font-size='7.5' fill='white' fill-opacity='0.3' stroke='black' stroke-width='0.5'%3EHostingShop%3C/text%3E%3C/svg%3E");
            background-size: 75px 24px, 250px 35px, 75px 24px, 75px 24px, 75px 24px;
            background-repeat: no-repeat;
            background-position: top left, center, top right, bottom left, bottom right;
            opacity: 0.3;
        }
    `;

            // Creamos una etiqueta <style>, le ponemos el contenido y la añadimos al <head> del documento
            const styleTag = document.createElement('style');
            styleTag.id = 'estilo-marca-agua'; // Le damos un ID para poder encontrarla y borrarla después
            styleTag.innerHTML = cssDinamico;
            document.head.appendChild(styleTag);
        }

        //===================================================================
        //== FUNCIÓN PARA BLOQUEAR CLIC DERECHO (SOLO EN FANCYBOX v6)     ==
        //===================================================================

        // Escuchamos el evento 'contextmenu' (clic derecho) en toda la página
        document.addEventListener('contextmenu', function (e) {

            // Comprobamos si el clic se hizo DENTRO de un visor de Fancybox
            // ¡ESTE ES EL SELECTOR V6 QUE TE FALTABA!
            const isFancyboxClick = e.target.closest('.fancybox__container');

            // Comprobamos si las marcas de agua están activadas (según tu lógica)
            const isWatermarkEnabled = document.body.classList.contains('watermark-enabled');

            // Si el clic fue en Fancybox Y las marcas de agua están activas, bloqueamos el menú
            if (isFancyboxClick && isWatermarkEnabled) {
                e.preventDefault();
            }
        });

        function mostrarModalAgencias(agencias = []) {
            if (!agencias.length) {
                Swal.fire('Sin agencias', 'No hay agencias configuradas para esta tienda.', 'info');
                return;
            }

            let html = '<ul class="list-group">';

            agencias.forEach(agencia => {
                const hora = new Date(agencia.hora_entrega).toLocaleTimeString('es-AR', {
                    hour: '2-digit', minute: '2-digit'
                });

                const esRetiro = agencia.descripcion.trim().toUpperCase() === "RETIRO TIENDA";

                html += `
      <li class="list-group-item">
        <strong>🚚 ${agencia.descripcion}</strong><br/>
        <span style="color: #0d6efd; font-weight: bold;">💰 Costo Envío: ${agencia.moneda || '$'}${parseFloat(agencia.costo_envio || 0).toFixed(2)}</span><br/>
        <span style="color: #6c757d;">📍 Ubicación: ${agencia.ubicacion || 'No especificada'}</span><br/>
        ${agencia.cuit ? `<span style="color: #6c757d;">🆔 CUIT: ${agencia.cuit}</span><br/>` : ''}
        <small style="color: #6c757d;">
          ${esRetiro ? '🕒 Hora límite de retiro:' : '🕒 Hora estimada de entrega:'} ${hora}
        </small>
      </li>`;
            });

            html += '</ul>';

            Swal.fire({
                title: '🚚 Agencias de Envío',
                html: `<div style="max-height: 400px; overflow-y: auto;">${html}</div>`,
                showCloseButton: true,
                confirmButtonText: 'Cerrar',
                width: '50rem',
            });
        }

        function mostrarModalFormasPago(formasPago = [], cuentaTransferencia = null) {
            if (!formasPago.length) {
                Swal.fire('Sin datos', 'No hay formas de pago configuradas.', 'info');
                return;
            }

            const listaFormasPago = formasPago.map(fp => {
                const esPresupuesto = fp.nombre.trim().toUpperCase() === "PRESUPUESTO";
                const mensajePresupuesto = esPresupuesto
                    ? `<br/><span class="badge bg-warning text-dark" style="font-size: 0.8rem;"> Ideal para requisiciones. Recuerda descargar desde la vista de Carrito. </span>`
                    : '';
                return `
      <li style="margin-bottom: 12px;">
        <strong>🔹 ${fp.nombre.toUpperCase()}</strong>
        ${fp.recargo > 0
                        ? `<span style="color: red; font-weight: bold;"> - RECARGO ${fp.recargo}%</span>`
                        : `<span style="color: green; font-weight: bold;"> - SIN RECARGO</span>`}
        ${mensajePresupuesto}
      </li>
    `;
            }).join('');

            const transferenciaHTML = cuentaTransferencia ? `
    <hr style="margin: 20px 0;">
    <h5 style="margin-bottom: 10px;">🏦 Datos para Transferencia Bancaria:</h5>
    <ul style="list-style: none; padding-left: 0;">
      <li>
        <strong>Alias:</strong> ${cuentaTransferencia.alias}
        <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copiarAlPortapapeles('${cuentaTransferencia.alias}')">Copiar</button>
      </li>
      <li>
        <strong>CBU:</strong> ${cuentaTransferencia.cbu}
        <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copiarAlPortapapeles('${cuentaTransferencia.cbu}')">Copiar</button>
      </li>
      <li><strong>Banco:</strong> ${cuentaTransferencia.banco}</li>
      <li><strong>Nombre:</strong> ${cuentaTransferencia.cuenta}</li>
    </ul>
  ` : '';

            Swal.fire({
                title: '💰 Formas de Pago',
                html: `
      <ul style="text-align: left; padding-left: 20px; margin: 0;">
        ${listaFormasPago}
      </ul>
      ${transferenciaHTML}
    `,
                width: '600px',
                confirmButtonText: 'Cerrar',
                customClass: {
                    popup: 'text-start'
                }
            });
        }

        // Función auxiliar para copiar texto al portapapeles
        function copiarAlPortapapeles(texto) {
            navigator.clipboard.writeText(texto)
                .then(() => {
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'success',
                        title: 'Texto copiado al portapapeles',
                        showConfirmButton: false,
                        timer: 1500
                    });
                })
                .catch(err => {
                    Swal.fire('Error', 'No se pudo copiar al portapapeles.', 'error');
                });
        }

        function mostrarTiempoUltimaActualizacion() {
            const contenedor = document.getElementById('info-actualizacion');
            if (!contenedor) return;

            const timestamp = localStorage.getItem('configuracion_pagina_timestamp');
            if (!timestamp) {
                contenedor.textContent = "Configuración no ha sido cargada aún.";
                return;
            }

            const ahora = Date.now();
            const diffMs = ahora - Number(timestamp);
            const minutos = Math.floor(diffMs / 60000);
            const segundos = Math.floor((diffMs % 60000) / 1000);

            const intervaloActualizacionMs = 6 * 60 * 1000; // 6 minutos
            const msParaProxima = intervaloActualizacionMs - diffMs;
            const minutosFaltan = Math.max(0, Math.floor(msParaProxima / 60000));
            const segundosFaltan = Math.max(0, Math.floor((msParaProxima % 60000) / 1000));

            if (minutosFaltan === 0 && segundosFaltan === 0) {
                contenedor.innerHTML = `<button id="btnActualizar">🔄 Haz click para actualizar la página</button>`;
                document.getElementById('btnActualizar').addEventListener('click', () => location.reload());
            } else {
                if (minutosFaltan === 0 && segundosFaltan <= 15) {
                    contenedor.style.color = "red";
                } else {
                    contenedor.style.color = "";
                }
                contenedor.textContent = `🕒 Última actualización: hace ${minutos} min ${segundos} seg | ⏳ Próxima actualización en ${minutosFaltan} min ${segundosFaltan} seg`;
            }
        }

        // Actualizar cada segundo
        setInterval(mostrarTiempoUltimaActualizacion, 1000);

        // Mostrar al cargar
        mostrarTiempoUltimaActualizacion();


        //Funcion para Generar el Modal de filtro por Categoria:
        function generarListadoCategorias() {
            try {
                const configuracionPagina = localStorage.getItem('configuracion_pagina');
                if (!configuracionPagina) { /* ... (manejo de error igual) ... */ return document.createTextNode("..."); }

                const datosConfiguracion = JSON.parse(configuracionPagina);
                if (!datosConfiguracion.content || !Array.isArray(datosConfiguracion.content) || datosConfiguracion.content.length === 0) { /* ... (manejo de error igual) ... */ return document.createTextNode("..."); }

                // --- 👇 INICIO: Aplanar CON Padre 👇 ---
                const categoriasPadreOriginal = datosConfiguracion.content || [];
                const lst_producto = categoriasPadreOriginal.flatMap(padre =>
                    (padre.categorias || []).map(hija => ({
                        ...hija,
                        nombre_padre: padre.nombre_padre // Necesitamos el padre
                    }))
                );
                // --- 👆 FIN: Aplanar CON Padre 👆 ---

                const fragmento = document.createDocumentFragment();

                // Ordenar alfabéticamente las categorías hijas ANTES de crear los botones
                lst_producto.sort((a, b) => a.nombre.localeCompare(b.nombre));

                lst_producto.forEach(categoria => {
                    const li = document.createElement('li');
                    // Añadimos clase y data attribute al LI para facilitar el filtrado
                    li.className = 'list-group-item categoria-hija-item'; // Clase para seleccionar todos
                    li.setAttribute('data-categoria-padre', categoria.nombre_padre); // Atributo con el nombre del padre
                    li.style.display = 'block'; // Asegurarse que sean visibles por defecto

                    const boton = document.createElement('button');
                    boton.className = 'btn btn-link text-start w-100 d-flex align-items-center gap-2';
                    boton.setAttribute('onclick', `filtrarPorCategoria('${categoria.codigo}')`);

                    const spanIcono = document.createElement('span');
                    spanIcono.className = 'categoria-icono';
                    if (categoria.icono) {
                        spanIcono.innerHTML = categoria.icono;
                    }

                    const spanNombre = document.createElement('span');
                    spanNombre.className = 'categoria-nombre';
                    spanNombre.textContent = categoria.nombre;

                    boton.appendChild(spanIcono);
                    boton.appendChild(spanNombre);
                    li.appendChild(boton);
                    fragmento.appendChild(li);
                });

                return fragmento;
            } catch (error) {
                console.error("Ocurrió un error al generar el listado de categorías:", error);
                return document.createTextNode("No se pudieron cargar las categorías.");
            }
        }

        // Función que se encarga de actualizar los enlaces en el menú
        function actualizarMenu() {
            // Datos predeterminados si los enlaces no se encuentran
            const vista360URL = document.querySelector(".vista-360 a")?.href || "#";
            const correo = document.querySelector(".correo a")?.href.replace("mailto:", "") || "";
            const celular = document.querySelector(".celular a")?.href.replace("tel:", "") || "";
            const formularioClienteURL = document.querySelector(".formulario-cliente a")?.href || "#";
            const catalogodriveURL = document.querySelector(".catalogo-drive a")?.href || "#";

            // Verificación de los valores obtenidos
            console.log("Vista 360 URL:", vista360URL);
            console.log("Correo:", correo);
            console.log("Celular:", celular);
            console.log("Formulario Cliente URL:", formularioClienteURL);
            console.log("Catalogo Drive URL:", catalogodriveURL);

            // Actualización de los enlaces en el menú 
            const vista360Link = document.getElementById("vista360Link");
            if (vista360Link) vista360Link.href = vista360URL;

            const correoLink = document.getElementById("correoLink");
            if (correoLink) {
                correoLink.href = `mailto:${correo}`;
                correoLink.textContent = "Correo";
                correoLink.title = correo;

                // Reemplazar el comportamiento por uno más robusto
                correoLink.addEventListener("click", function (e) {
                    e.preventDefault(); // Previene la acción por defecto

                    const subject = encodeURIComponent("Consulta desde el sitio web");
                    const body = encodeURIComponent("Hola, me gustaría recibir más información sobre sus productos.");
                    window.location.href = `mailto:${correo}?subject=${subject}&body=${body}`;
                });
            }


            const celularLink = document.getElementById("celularLink");
            if (celularLink) {
                celularLink.href = `tel:${celular}`;
                celularLink.textContent = `Celular: ${celular}`;
            }

            const formularioClienteLink = document.getElementById("formularioClienteLink");
            if (formularioClienteLink) formularioClienteLink.href = formularioClienteURL;

            const catalogodriveLink = document.getElementById("catalogodriveLink");
            if (catalogodriveLink) catalogodriveLink.href = catalogodriveURL;
        }

        document.addEventListener("DOMContentLoaded", function () {
            const navbarCollapse = document.getElementById("navbarNavDropdown");

            // Instancia del colapsable de Bootstrap
            const bsCollapse = new bootstrap.Collapse(navbarCollapse, { toggle: false });

            // Seleccionar todos los enlaces del menú dentro del colapsable
            const navLinks = navbarCollapse.querySelectorAll(".nav-link");

            navLinks.forEach(link => {
                link.addEventListener("click", function () {
                    // Solo cerrar en vista móvil (Bootstrap md breakpoint)
                    if (window.innerWidth < 992) {
                        bsCollapse.hide();
                    }
                });
            });
        });

        window.highlightProductScroll = function (highlightedProduct) {
            const headerHeight = 150; // Ajusta según tu encabezado

            highlightedProduct.addClass('highlight');

            $('html, body').animate({
                scrollTop: highlightedProduct.offset().top - headerHeight
            }, 400, () => {
                setTimeout(() => {
                    highlightedProduct.removeClass('highlight');
                }, 4000);

                setTimeout(() => {
                    limpiarURL();
                }, 6000);
            });
        };

        function generarListadoCategoriasCarrusel() {
            try {
                const configuracionPagina = localStorage.getItem('configuracion_pagina');
                if (!configuracionPagina) {
                    console.error("No se encontró 'configuracion_pagina' en localStorage.");
                    return;
                }

                const datosConfiguracion = JSON.parse(configuracionPagina);
                if (!datosConfiguracion.content || !Array.isArray(datosConfiguracion.content) || datosConfiguracion.content.length === 0) {
                    console.warn("La lista de categorías está vacía o no es válida.");
                    return;
                }

                // --- INICIO: Leer y Aplanar (Añadiendo Padre) ---
                const categoriasPadreOriginal = datosConfiguracion.content || [];
                // Aplanamos, pero mantenemos la referencia al padre
                const categoriasHijasAplanadas = categoriasPadreOriginal.flatMap(padre =>
                    (padre.categorias || []).map(hija => ({
                        ...hija,
                        nombre_padre: padre.nombre_padre // Necesitamos esto para filtrar
                    }))
                );
                // --- FIN: Leer y Aplanar ---

                const listadoCategoriasCarrusel = document.getElementById('listadoCategoriasCarrusel');
                listadoCategoriasCarrusel.innerHTML = ''; // Limpiar carrusel previo

                // --- 👇 INICIO: Aplicar Filtro Padre y Búsqueda de Texto 👇 ---
                const filtroPadreSeleccionado = document.getElementById('filtroCategoriaPadre')?.value || '';
                const searchValue = $("#txt_search").val().toUpperCase(); // Búsqueda de texto

                let categoriasParaCarrusel = categoriasHijasAplanadas;

                // 1. Filtrar por Padre (si hay uno seleccionado)
                if (filtroPadreSeleccionado && filtroPadreSeleccionado !== '') {
                    categoriasParaCarrusel = categoriasParaCarrusel.filter(hija => hija.nombre_padre === filtroPadreSeleccionado);
                }

                // 2. Filtrar por Búsqueda de Texto (si hay texto) y verificar si tienen productos
                categoriasParaCarrusel = categoriasParaCarrusel.filter(categoria => {
                    const productosFiltrados = categoria.producto.filter(prod =>
                        prod.nombre.toUpperCase().includes(searchValue)
                    );
                    // Solo incluir si tiene productos que coincidan con la búsqueda
                    return productosFiltrados.length > 0;
                });
                // --- 👆 FIN: Aplicar Filtros 👆 ---


                // --- Generar HTML del Carrusel con las categorías filtradas ---
                if (categoriasParaCarrusel.length === 0) {
                    listadoCategoriasCarrusel.innerHTML = '<div class="carousel-item active"><span class="text-muted small p-2">No hay categorías que coincidan.</span></div>'; // Mensaje si no hay nada
                    // Forzar reinicio del carrusel si existe instancia
                    const carruselElement = document.getElementById('carouselCategorias');
                    const carruselInstance = bootstrap.Carousel.getInstance(carruselElement);
                    if (carruselInstance) {
                        carruselInstance.to(0); // Ir al primer slide (el mensaje)
                    }
                    return;
                }

                categoriasParaCarrusel.forEach((categoria, index) => {
                    // Re-calculamos la cantidad de productos que coinciden con la búsqueda de texto
                    // para mostrar el contador correcto en el botón.
                    const productosFiltrados = categoria.producto.filter(prod =>
                        prod.nombre.toUpperCase().includes(searchValue)
                    );
                    const cantidad = productosFiltrados.length;

                    const div = document.createElement('div');
                    // Solo el primer item filtrado debe ser 'active'
                    div.className = `carousel-item ${index === 0 ? 'active' : ''}`;

                    div.innerHTML = `
               <div class="d-flex flex-column justify-content-center align-items-center text-center p-2">
                 <button class="btn btn-link text-decoration-none" onclick="abrirAcordeonCategoria('${categoria.codigo}')">
                   <p class="mb-0 text-uppercase mt-1 categoria-nombre fw-bold d-inline">
                     ${categoria.nombre} <small class="text-muted">(${cantidad})</small>
                   </p>
                 </button>
               </div>
             `;
                    listadoCategoriasCarrusel.appendChild(div);
                });

                // Reiniciar el carrusel para que muestre el primer item correcto
                const carruselElement = document.getElementById('carouselCategorias');
                const carruselInstance = bootstrap.Carousel.getInstance(carruselElement);
                if (carruselInstance) {
                    carruselInstance.to(0); // Asegura empezar desde el primer slide filtrado
                    carruselInstance.cycle(); // Reinicia el ciclo si estaba pausado
                } else {
                    // Si no hay instancia, crearla (puede pasar en la carga inicial)
                    new bootstrap.Carousel(carruselElement);
                }


            } catch (error) {
                console.error("Ocurrió un error al generar el listado de categorías para el carrusel:", error);
            }
        }

        function abrirAcordeonCategoria(codigoCategoria) {
            try {
                const configuracionPagina = localStorage.getItem('configuracion_pagina');
                if (!configuracionPagina) {
                    console.error("No se encontró 'configuracion_pagina' en localStorage.");
                    return;
                }
                const datosConfiguracion = JSON.parse(configuracionPagina);

                // --- INICIO: Encontrar Categoría Hija Y SU PADRE ---
                const categoriasPadreOriginal = datosConfiguracion.content || [];
                let categoriaHijaEncontrada = null;
                let nombrePadreEncontrado = null;

                for (const padre of categoriasPadreOriginal) {
                    const hija = padre.categorias.find(c => c.codigo == codigoCategoria);
                    if (hija) {
                        categoriaHijaEncontrada = hija;
                        nombrePadreEncontrado = padre.nombre_padre;
                        break; // Salimos del bucle una vez encontrada
                    }
                }
                // --- FIN: Encontrar Categoría Hija Y SU PADRE ---

                if (!categoriaHijaEncontrada || !nombrePadreEncontrado) {
                    console.error("No se encontró la categoría hija o su padre con código:", codigoCategoria);
                    return;
                }

                // ⚠️ Verifica si estás en la vista de "Detalle pedido" (Tu código existente)
                if ($(".pedido_producto").is(":visible")) {
                    regresar_principal();
                    setTimeout(() => abrirAcordeonCategoria(codigoCategoria), 300);
                    return;
                }

                // --- 👇 INICIO: Actualizar Filtro Principal y Recargar Acordeones 👇 ---
                const selectPadrePrincipal = document.getElementById('filtroCategoriaPadre');
                let necesitaRecargar = false;

                if (selectPadrePrincipal) {
                    // Si el dropdown principal NO está mostrando el padre correcto (o "Todas")
                    if (selectPadrePrincipal.value !== nombrePadreEncontrado) {
                        // Si NO estaba en "Todas", marca para recargar
                        if (selectPadrePrincipal.value !== '') {
                            necesitaRecargar = true;
                        }
                        selectPadrePrincipal.value = nombrePadreEncontrado; // Actualiza el valor
                        console.log(`Dropdown principal actualizado a: ${nombrePadreEncontrado}`);
                        // ¡NO disparamos 'change' aquí! cargar_productos lo leerá.
                    } else {
                        console.log(`Dropdown principal ya estaba en: ${nombrePadreEncontrado}`);
                    }
                }

                // Si el dropdown cambió O si no estamos seguros de que el acordeón exista, recargamos.
                // Es más seguro recargar siempre que se hace clic en el carrusel si el filtro padre no estaba en "Todas".
                if (necesitaRecargar || selectPadrePrincipal.value !== '') {
                    console.log("Recargando acordeones para asegurar consistencia...");
                    cargar_productos(); // Llama a cargar_productos, que leerá el nuevo valor del dropdown
                }
                // --- 👆 FIN: Actualizar Filtro Principal y Recargar Acordeones 👆 ---


                // --- 👇 INICIO: Abrir Acordeón Específico (CON DELAY) 👇 ---
                // Usamos setTimeout para ASEGURARNOS de que cargar_productos (si se llamó)
                // haya terminado de reconstruir el DOM antes de intentar abrir el acordeón.
                setTimeout(() => {
                    const acordeon = document.getElementById(`flush-collapse-${categoriaHijaEncontrada.codigo}`);
                    const encabezado = document.querySelector(`[data-bs-target="#flush-collapse-${categoriaHijaEncontrada.codigo}"]`);

                    if (!acordeon || !encabezado) {
                        console.error(`No se encontró el acordeón o encabezado para #${categoriaHijaEncontrada.codigo} después de recargar.`);
                        return; // Salir si no se encuentra
                    }

                    // Cerrar otros acordeones (Bootstrap API)
                    const todosAcordeones = document.querySelectorAll('.accordion-collapse');
                    todosAcordeones.forEach(acc => {
                        const collapseInstance = bootstrap.Collapse.getInstance(acc);
                        if (collapseInstance && acc !== acordeon && acc.classList.contains('show')) {
                            collapseInstance.hide();
                        }
                    });

                    // Abrir el acordeón objetivo (Bootstrap API)
                    const acordeonInstance = bootstrap.Collapse.getInstance(acordeon) || new bootstrap.Collapse(acordeon);
                    // Solo intentar mostrar si no está ya mostrándose o en proceso
                    if (!acordeon.classList.contains('show')) {
                        // Usamos el listener 'shown' para el scroll y resaltado
                        acordeon.addEventListener('shown.bs.collapse', function onShownAfterClick() {
                            acordeon.removeEventListener('shown.bs.collapse', onShownAfterClick); // Limpiar listener

                            const offset = 135;
                            const posicionAcordeon = encabezado.getBoundingClientRect().top + window.pageYOffset; // Usar encabezado para el cálculo
                            window.scrollTo({
                                top: posicionAcordeon - offset,
                                behavior: 'smooth'
                            });

                            encabezado.classList.add('resaltado');
                            setTimeout(() => encabezado.classList.remove('resaltado'), 2000);

                            // Renderizar productos y generar filtros (tu código existente)
                            renderizarProductosPorCategoria(categoriaHijaEncontrada.codigo);
                            setTimeout(() => {
                                const productosCategoria = acordeon.querySelectorAll('.producto-item');
                                if (productosCategoria.length > 0) {
                                    generarOpcionesDeResaltadoFiltrado(productosCategoria, categoriaHijaEncontrada.codigo);
                                } else {
                                    console.warn("⚠️ No se encontraron productos...");
                                }
                            }, 100);

                        }, { once: true });

                        acordeonInstance.show(); // Iniciar la apertura
                    } else {
                        // Si ya estaba abierto, solo hacemos scroll y resaltado (sin esperar 'shown')
                        const offset = 135;
                        const posicionAcordeon = encabezado.getBoundingClientRect().top + window.pageYOffset;
                        window.scrollTo({
                            top: posicionAcordeon - offset,
                            behavior: 'smooth'
                        });
                        encabezado.classList.add('resaltado');
                        setTimeout(() => encabezado.classList.remove('resaltado'), 2000);
                        // Aseguramos renderizado y filtros por si acaso
                        renderizarProductosPorCategoria(categoriaHijaEncontrada.codigo);
                        setTimeout(() => {
                            const productosCategoria = acordeon.querySelectorAll('.producto-item');
                            if (productosCategoria.length > 0) {
                                generarOpcionesDeResaltadoFiltrado(productosCategoria, categoriaHijaEncontrada.codigo);
                            }
                        }, 100);
                    }


                }, 300); // Delay de 300ms para dar tiempo a cargar_productos
                // --- 👆 FIN: Abrir Acordeón Específico 👆 ---

            } catch (error) {
                console.error("Ocurrió un error al intentar abrir el acordeón de la categoría:", error);
            }
        }
        // Función de debounce para optimizar la validación
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Validación optimizada para el input
        const verificarEntrada = debounce(function () {
            const inputTexto = document.getElementById('txt_search');
            const searchValue = inputTexto.value.trim().toUpperCase();

            // Permite UniqueID (alfanumérico sin estructura fija)
            if (/^[A-Za-z0-9]+$/.test(searchValue) && !/^[A-Za-z]{4}\d{3}$/.test(searchValue)) {
                inputTexto.setCustomValidity('');
            }
            // Permite SKU completo (4 letras + 3 números) o solo las 4 primeras letras
            else if (/^[A-Za-z]{4}(\d{3})?$/.test(searchValue)) {
                inputTexto.setCustomValidity('');
            }
            else {
                // Mensaje de error genérico
                inputTexto.setCustomValidity('Ingrese un SKU válido o un identificador correcto.');
            }

            inputTexto.reportValidity();
        }, 300);

        // Llamar a la validación cada vez que el usuario escribe en el campo de búsqueda
        document.getElementById('txt_search').addEventListener('input', verificarEntrada);

        function buscarYResaltarProducto() {
            const searchValue = document.getElementById('txt_search').value.trim().toUpperCase();

            if (searchValue === '') {
                alert('Por favor, ingresa un término de búsqueda.');
                return;
            }

            // --- INICIO: Obtener y aplanar la lista para búsqueda ---
            const categoriasPadre = JSON.parse(localStorage.getItem('configuracion_pagina')).content;
            // Creamos una lista plana de categorías hijas para buscar más fácil
            const config = categoriasPadre.flatMap(padre => padre.categorias);
            // --- FIN: Aplanar lista ---

            let foundProduct = null;
            let foundCategoryCode = null;
            let productCode = null;

            for (let categoria of config) {
                const product = categoria.producto.find(p => p.nombre.toUpperCase().includes(searchValue));
                if (product) {
                    foundProduct = product;
                    foundCategoryCode = categoria.codigo;
                    productCode = product.codigo;
                    break;
                }
            }

            if (foundProduct) {
                const productID = `producto-${foundCategoryCode}-${productCode}`;
                const accordionToggle = $(`[data-bs-target="#flush-collapse-${foundCategoryCode}"]`);
                const accordionCollapse = $(`#flush-collapse-${foundCategoryCode}`);

                // Asegurarse que los productos están renderizados
                renderizarProductosPorCategoria(foundCategoryCode);

                if (!accordionCollapse.hasClass('show')) {
                    accordionCollapse.one('shown.bs.collapse', () => {
                        setTimeout(() => {
                            const highlightedProduct = $(`#${productID}`);
                            if (highlightedProduct.length > 0) {
                                highlightProductScroll(highlightedProduct);
                            }
                        }, 150);
                    });

                    accordionToggle.trigger('click');
                } else {
                    setTimeout(() => {
                        const highlightedProduct = $(`#${productID}`);
                        if (highlightedProduct.length > 0) {
                            highlightProductScroll(highlightedProduct);
                        }
                    }, 150);
                }

                document.getElementById('txt_search').value = '';
            } else {
                alert('Producto no encontrado. Por favor, verifica el nombre o código.');
            }
        }

        let ordenSeleccionado = 'upd'; // orden por defecto global

        function inicializarCarruselCuandoCargue(productoCodigo) {
            const carrusel = document.querySelector(`#carouselExampleControls_${productoCodigo}`);
            if (!carrusel || carrusel.dataset.initialized === "true") return;

            const imagenes = carrusel.querySelectorAll('img[src]');
            if (!imagenes.length) return;

            let cargadas = 0;

            function checkCargadas() {
                cargadas++;
                if (cargadas === imagenes.length) {
                    iniciarCarrusel(productoCodigo);
                }
            }

            imagenes.forEach(img => {
                if (img.complete) {
                    cargadas++;
                } else {
                    img.addEventListener('load', () => {
                        console.log(`🖼️ Imagen cargada para ${productoCodigo}`);
                        checkCargadas();
                    });
                    img.addEventListener('error', checkCargadas);
                }
            });

            if (cargadas === imagenes.length) {
                iniciarCarrusel(productoCodigo);
            }
        }

        function inicializarCarruselesPrecios() {
            document.querySelectorAll('.carousel-precios:not([data-initialized="true"])').forEach(carrusel => {
                new bootstrap.Carousel(carrusel, {
                    interval: 2000,
                    ride: 'carousel',
                    pause: false,
                    wrap: true
                });
                carrusel.setAttribute('data-initialized', 'true');
                console.log("💲 Carrusel de precios activado:", carrusel.id);
            });
        }


        function iniciarCarrusel(productoCodigo) {
            const carrusel = document.querySelector(`#carouselExampleControls_${productoCodigo}`);
            if (carrusel && carrusel.dataset.initialized === "false") {
                new bootstrap.Carousel(carrusel, {
                    interval: 3000,
                    ride: 'carousel'
                });
                carrusel.dataset.initialized = "true";
                console.log("🎠 Carrusel iniciado para:", productoCodigo);
            }
        }

        function obtenerColor(variedad) {
            const coloresVariedades = {
                "Corte": "#6854fa",
                "Fardo": "#9d38f2",
                "Caja": "#fa7d62",
                "Docena": "#33FF57",
                "Curva": "#FF5733",
                "Mayor": "#198754",
                "Combo": "#62fae5",
                "Pack x3": "#3357FF",
                "Menor": "#FF33A8"
            };
            return coloresVariedades[variedad] || `hsl(${Math.abs(variedad.length * 40) % 360}, 70%, 50%)`;
        }

        function ordenarListaProductos(productos, orden = 'upd') {
            return productos.sort((a, b) => {
                switch (orden) {
                    case 'ascendente':
                        return a.nombre.toUpperCase().localeCompare(b.nombre.toUpperCase());
                    case 'descendente':
                        return b.nombre.toUpperCase().localeCompare(a.nombre.toUpperCase());
                    case 'updo':
                        return new Date(a.upd) - new Date(b.upd);
                    case 'upd':
                    default:
                        return new Date(b.upd) - new Date(a.upd);
                }
            });
        }

        function ordenarProductos(valorSeleccionado) {
            if (valorSeleccionado === 'asc') {
                ordenSeleccionado = 'ascendente';
            } else if (valorSeleccionado === 'desc') {
                ordenSeleccionado = 'descendente';
            } else {
                ordenSeleccionado = valorSeleccionado; // 'upd' o 'updo'
            }

            // Volver a renderizar los productos visibles
            document.querySelectorAll('[data-renderizado="true"]').forEach(el => {
                el.removeAttribute('data-renderizado');
                el.innerHTML = '';
            });

            document.querySelectorAll(".accordion-collapse.show").forEach(acordeon => {
                const categoria = acordeon.getAttribute("data-categoria");
                renderizarProductosPorCategoria(categoria);
            });
        }

        function mostrarTallesyColores(boton) {
            const talles = JSON.parse(boton.dataset.talles.replace(/&apos;/g, "'"));
            const colores = JSON.parse(boton.dataset.colores.replace(/&apos;/g, "'"));

            // --- Contenedor principal con estilos para un mejor aspecto ---
            let contenidoHtml = '<div class="swal-product-details">';

            // --- Sección de Talles ---
            if (talles && talles.length > 0) {
                contenidoHtml += `
            <div class="swal-section">
                <h6 class="swal-section-title">Talles Disponibles</h6>
                <div class="swal-badges-container">
                    ${talles.map(t => `<span class="badge swal-badge-talle">${t}</span>`).join('')}
                </div>
            </div>
        `;
            }

            // --- Sección de Colores ---
            if (colores && colores.length > 0) {
                // Añadimos una línea divisoria si también había talles
                if (talles && talles.length > 0) {
                    contenidoHtml += '<hr class="swal-hr">';
                }

                contenidoHtml += `
            <div class="swal-section">
                <h6 class="swal-section-title">Colores Disponibles</h6>
                <div class="swal-badges-container">
                    ${colores.map(c => {
                    const isSurtido = c.nombre.toLowerCase().includes("surtido");
                    const estilo = isSurtido
                        ? "background: linear-gradient(to right, #ff0000, #00ff00, #0000ff); color: white;"
                        : `background: ${c.hex}; color: ${getContrastingTextColor(c.hex)};`;
                    return `<span class="badge swal-badge-color" style="${estilo}">${c.nombre}</span>`;
                }).join('')}
                </div>
            </div>
        `;
            }

            contenidoHtml += '</div>';

            // --- Disparamos el SweetAlert con clases personalizadas ---
            Swal.fire({
                title: 'Detalles del Producto',
                html: contenidoHtml,
                confirmButtonText: 'Cerrar',
                customClass: {
                    popup: 'swal-wide' // Una clase para hacer el modal un poco más ancho
                }
            });
        }

        const urlParams = new URLSearchParams(window.location.search);
        const highlightCategoria = urlParams.get('categoria') || '';
        const highlightProducto = urlParams.get('producto') || '';

        function crearProductoHTML(categoria, producto, modoCompacto = false) {
            if (modoCompacto || document.body.dataset.vista === 'compacta') {
                return crearProductoHTMLCompacto(categoria, producto);
            }

            const productoURL = `${location.origin}${location.pathname}?categoria=${categoria.codigo}&producto=${producto.codigo}`;
            const isHighlighted = highlightCategoria === categoria.codigo && highlightProducto === producto.codigo;
            const esAndroid = /Android/i.test(navigator.userAgent);

            const imagenesOrdenadas = Array.isArray(producto.imagen) && producto.imagen.length > 0
                ? (() => {
                    const portada = producto.imagen.find(img => img.portada);
                    const resto = producto.imagen.filter(img => img !== portada);
                    return portada ? [portada, ...resto] : [...producto.imagen];
                })()
                : [];

            const textoBotonCompra = producto.variedad.length > 1 ? "Elegir Variedad" : "🛒 Añadir al carrito";

            const botonesCarrusel = imagenesOrdenadas.length > 1 ? `
        <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleControls_${producto.codigo}" data-bs-slide="prev" style="background-color: rgb(220, 225, 240);">
            <span class="carousel-control-prev-icon"></span>
            <span class="visually-hidden">Anterior</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleControls_${producto.codigo}" data-bs-slide="next" style="background-color: rgb(220, 225, 240);">
            <span class="carousel-control-next-icon"></span>
            <span class="visually-hidden">Siguiente</span>
        </button>` : '';

            const preciosCarrusel = `
        <div id="carouselPrecios_${producto.codigo}" class="carousel slide" data-bs-ride="carousel" data-bs-interval="4000">
            <div class="carousel-inner text-center">
                ${producto.variedad.map((v, i) => `
                    <div class="carousel-item ${i === 0 ? 'active' : ''}">
                        <div style="font-size: 1.2rem; font-weight: bold;">${formatMoneda(v.precio * (v.minima || 1), v.moneda)}</div>
                        <div class="small mt-1" style="color: ${obtenerColor(v.variedad)}; font-weight: bold;">${v.variedad} (x${v.minima || 1})</div>
                    </div>`).join('')}
            </div>
            ${producto.variedad.length > 1 ? `
                <button class="carousel-control-prev" type="button" data-bs-target="#carouselPrecios_${producto.codigo}" data-bs-slide="prev" style="background: rgba(0,0,0,0.2); border-radius: 50%;">
                    <span class="carousel-control-prev-icon"></span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#carouselPrecios_${producto.codigo}" data-bs-slide="next" style="background: rgba(0,0,0,0.2); border-radius: 50%;">
                    <span class="carousel-control-next-icon"></span>
                </button>` : ''}
        </div>`;

            /**
             * Renderiza la descripción del producto con lógica condicional para móviles.
             */
            function renderDescripcion(descripcion, esDispositivoAndroid) {
                if (!descripcion || typeof descripcion !== "object") return "";

                // --- LÓGICA PARA MÓVILES (ANDROID) ---
                if (esDispositivoAndroid) {
                    const omitidas = ["stock", "ultima_actualizacion", "video", "whatsapp", "talles", "colores"];
                    let htmlGenerado = "";

                    // Renderiza los atributos normales (Modelo, Estilo, etc.)
                    htmlGenerado += Object.entries(descripcion)
                        .filter(([key]) => !omitidas.includes(key))
                        .map(([key, value]) => {
                            const label = value.label || key;
                            const icono = value.icono ? ` ${value.icono}` : "";
                            const valor = value.valor || "";
                            return `<div class="mb-1"><strong>${label}:</strong> ${valor}${icono}</div>`;
                        }).join("");

                    const hayTalles = descripcion.talles && Array.isArray(descripcion.talles.valores) && descripcion.talles.valores.length > 0;
                    const hayColores = descripcion.colores && Array.isArray(descripcion.colores.valores) && descripcion.colores.valores.length > 0;

                    // Si hay talles o colores, genera el botón para el modal de SweetAlert
                    if (hayTalles || hayColores) {
                        const tallesData = hayTalles ? JSON.stringify(descripcion.talles.valores).replace(/'/g, "&apos;") : "[]";
                        const coloresData = hayColores ? JSON.stringify(descripcion.colores.valores).replace(/'/g, "&apos;") : "[]";

                        htmlGenerado += `
                    <div class="mt-2">
                        <button class="btn btn-outline-secondary btn-sm w-100" onclick="mostrarTallesyColores(this)"
                            data-talles='${tallesData}'
                            data-colores='${coloresData}'>
                            Ver Talles y Colores
                        </button>
                    </div>
                `;
                    }
                    return `<div class="descripcion-detalle text-start mt-2">${htmlGenerado}</div>`;
                }

                // --- LÓGICA PARA ESCRITORIO (tu código original agrupado) ---
                const omitidasDesktop = ["stock", "ultima_actualizacion", "video", "whatsapp"];
                return `
          <div class="descripcion-detalle text-start mt-2">
            ${Object.entries(descripcion).filter(([key]) => !omitidasDesktop.includes(key)).map(([key, value]) => {
                    const label = value.label || key;
                    const icono = value.icono ? ` ${value.icono}` : "";
                    const valor = value.valor || "";
                    if (Array.isArray(value.valores)) {
                        if (key === "colores") {
                            return `
                    <div class="mb-1"><strong>${label}:</strong> 
                      ${value.valores.map(c => {
                                const isSurtido = c.nombre.toLowerCase().includes("surtido");
                                const estilo = isSurtido
                                    ? "background: linear-gradient(to right, #ff0000, #00ff00, #0000ff); color: white;"
                                    : `background: ${c.hex}; color: ${getContrastingTextColor(c.hex)};`;
                                return `<span class="badge me-1" style="${estilo} border:1px solid #ccc; padding:4px 8px; border-radius:6px;">${c.nombre}</span>`;
                            }).join('')}
                    </div>`;
                        } else { // Asumimos que es 'talles'
                            return `
                    <div class="mb-1"><strong>${label}:</strong> 
                      ${value.valores.map(v => `<span class="badge bg-light border text-dark me-1">${v.trim()}</span>`).join('')}
                    </div>`;
                        }
                    }
                    return `<div class="mb-1"><strong>${label}:</strong> ${valor}${icono}</div>`;
                }).join("")}
          </div>`;
            }

            // Obtenemos el mensaje original (sin cambios)
            let mensajeWhatsApp = producto.descripcion?.whatsapp?.mensaje || '';
            mensajeWhatsApp = mensajeWhatsApp.includes('https://hostingshop-v2.blogspot.com/')
                ? mensajeWhatsApp.replace(/https:\/\/hostingshop-v2\.blogspot\.com\/\?categoria=.*?&producto=.*?/g, productoURL)
                : `${mensajeWhatsApp}\n\nPodés verlo aquí: ${productoURL}`;
            const urlWhatsApp = producto.descripcion?.whatsapp?.telefono
                ? `https://wa.me/549${producto.descripcion.whatsapp.telefono}?text=${encodeURIComponent(mensajeWhatsApp)}`
                : '';

            return `
    <li class="list-group-item producto-item d-flex justify-content-between align-items-center ${isHighlighted ? 'highlight' : ''}" 
        id="producto-${categoria.codigo}-${producto.codigo}" 
        data-categoria="${categoria.codigo}"
        data-precio="${producto.precio}"
        data-variedades='${JSON.stringify(producto.variedad.map(v => v.variedad))}'
        data-variedad-principal='${producto.variedad[0]?.variedad || ''}'
        data-variedades_completo='${JSON.stringify(producto.variedad)}'
        data-json='${JSON.stringify(producto).replace(/'/g, "&apos;").replace(/"/g, "&quot;")}'>
      
      <div>
        <div class="producto_id fw-bold mb-1">Código ID: ${producto.codigo}</div>
    
        <div class="estrellas mb-2 text-start" id="estrellas-${producto.codigo}">
          ${[1, 2, 3, 4, 5].map(r => `
            <span class="estrella" data-value="${r}" onclick="registrarPuntuacion('${producto.codigo}', ${r})">
              <i class="fa fa-star-o"></i>
            </span>`).join('')}
        </div>
        <p class="resultado-puntuacion small text-center mb-2" id="resultado-puntuacion-${producto.codigo}" 
           style="display: none; color: #6c757d; font-style: italic;">
          Total votos: 0. Promedio: 0
        </p>
    
        <div 
          class="plato_nombre fw-bold fs-5 text-uppercase text-center mb-2" 
          data-producto='${JSON.stringify(producto).replace(/'/g, "&apos;")}' 
          data-categoria='${categoria.codigo}'
          onclick="copiarDatosProducto(this)">
          ${producto.nombre} 
          <span class="carrito-icono"><i class="fa fa-copy ms-2"></i></span>
        </div>
    
        <div class="plato_descripcion">
          ${renderDescripcion(producto.descripcion, esAndroid)}
        </div>
    
        <div class="small mt-2" style="color: #6c757d; font-size: 0.85rem;">
          <span><i class="fa fa-cubes"></i> Stock: ${producto.descripcion?.stock?.valor || "-"}</span>
          <span class="ms-2"><i class="fa fa-clock-o"></i> UPD: ${producto.descripcion?.ultima_actualizacion?.valor || "-"}</span>
        </div>
    
        <div class="separador mt-2"></div>
    
        <button class="btn btn-link btn-sm" id="toggle_button_${producto.codigo}" onclick="mostrarDetalleEnCarrito(${producto.codigo})">
          Mini carrito vacío <i class="fa fa-chevron-down"></i>
        </button>
      </div>
    
      <div class="image-parent position-relative">
        <div id="carouselExampleControls_${producto.codigo}" class="carousel slide" data-bs-ride="manual" data-initialized="false">
<div class="carousel-inner">
    ${imagenesOrdenadas.length
                    ? imagenesOrdenadas.map((img, i) => {
                        return `
                <div class="carousel-item ${i === 0 ? 'active' : ''}">
                    <a 
                        href="${img.url}" 
                        data-fancybox="gallery-${producto.nombre}" 
                        data-caption="${producto.nombre}" 
                        data-type="image" 
                        data-carpeta-id="${img.carpeta_id}" 
                        data-download-src="${img.url}" 
                        download="${producto.nombre}_imagen_${i + 1}.webp"
                    >
                        <img src="${img.url}" class="img-fluid lazyload" alt="imagen" loading="lazy"
                             onerror="this.src='https://placehold.co/250x300/0088f2/white?text=Imagen+No+Disponible';">
                    </a>
                    ${img.portada ? `<span class="sticker-portada">⭐ Portada</span>` : ''}
                </div>
            `;
                    }).join('')
                    : `<div class="carousel-item active">
               <img src="https://placehold.co/250x300/0088f2/white?text=No+Disponible" class="img-fluid">
           </div>`
                }
</div>
          ${botonesCarrusel}
        </div>
    
        <div class="carousel-caption">
          ${preciosCarrusel}
          <div class="mt-2">
            <button class="btn btn-success w-100 fw-bold py-2" onclick="mostrar_popuppedido('${categoria.codigo}', '${producto.codigo}')">
              ${textoBotonCompra}
            </button>
          </div>
        </div>
    
        <div class="acciones mt-2 px-2 pb-2">
          <div class="d-flex gap-2 mb-2">
            <button class="btn btn-outline-secondary btn-sm w-100" title="Compartir"
                    onclick="compartirProducto('${producto.nombre}', '${productoURL}')">
              ${!esAndroid ? 'Share ' : ''}<i class="fa fa-share-alt"></i>
            </button>
    
            ${urlWhatsApp
                    ? `<button class="btn btn-outline-info btn-sm w-100" title="Consulta por WhatsApp"
                    style="background-color: #25D366; color: white; font-weight: bold;"
                    onclick="window.open('${urlWhatsApp}', '_blank')">
                      ${!esAndroid ? 'Info ' : ''}<i class="fa fa-whatsapp"></i>
                  </button>`
                    : ''
                }
    
            ${producto.descripcion?.video?.url ? `
            <a class="btn btn-outline-danger btn-sm w-100" title="Ver Video" 
               data-fancybox 
               href="${producto.descripcion.video.url}"
               data-thumb="${producto.descripcion.video.thumbnail}">
              ${!esAndroid ? 'Ver ' : ''}<i class="fa fa-play-circle"></i>
            </a>` : ''}
          </div>
        </div>
      </div>
    </li>`;
        }

        function copiarDatosProducto(el) {
            try {
                const producto = JSON.parse(el.getAttribute('data-producto'));
                const categoriaCodigo = el.getAttribute('data-categoria');

                if (!producto || !categoriaCodigo) {
                    Swal.fire('Error', 'No se pudo obtener la información del producto.', 'error');
                    return;
                }

                mostrarOpcionesCopiar(producto, categoriaCodigo);

            } catch (e) {
                console.error(e);
                Swal.fire('Error', 'Error al procesar los datos del producto.', 'error');
            }
        }

        // --- Función para mostrar Swal con opciones ---
        function mostrarOpcionesCopiar(producto, categoriaCodigo) {
            Swal.fire({
                title: `Copiar datos de ${producto.nombre}`,
                showDenyButton: true,
                showCancelButton: true,
                confirmButtonText: `WhatsApp`,
                denyButtonText: `Texto Plano`,
                cancelButtonText: `Cancelar`,
                preConfirm: () => copiarDatosWhatsApp(producto, categoriaCodigo),
                preDeny: () => copiarDatosTextoPlano(producto, categoriaCodigo)
            });
        }

        // --- Copiar formato WhatsApp (con asteriscos) ---
        function copiarDatosWhatsApp(producto, categoriaCodigo) {
            const talles = producto.descripcion?.talles?.valores || [];
            const colores = producto.descripcion?.colores?.valores || [];

            // Intentar obtener nombres de categoría
            let nombrePadre = '-';
            let nombreHija = '-';
            try {
                const config = JSON.parse(localStorage.getItem('configuracion_pagina'));
                if (config && config.content) {
                    for (const padre of config.content) {
                        const hija = padre.categorias.find(c => c.codigo == categoriaCodigo);
                        if (hija) {
                            nombrePadre = padre.nombre_padre;
                            nombreHija = hija.nombre;
                            break;
                        }
                    }
                }
            } catch (e) {
                console.warn("No se pudo obtener info de categoría para copia", e);
            }

            const texto = `
*${producto.nombre}*
*Categoría:* ${nombrePadre}
*Variedad:* ${nombreHija}
*Modelo:* ${producto.descripcion?.modelo?.valor || '-'}
*Estilo:* ${producto.descripcion?.estilo?.valor || '-'}
*Marca:* ${producto.descripcion?.marca?.valor || '-'}
*Género:* ${producto.descripcion?.genero?.valor || '-'}
*Edad:* ${producto.descripcion?.grupo_edad?.valor || '-'}
*Material:* ${producto.descripcion?.material?.valor || '-'}
*Temporada:* ${producto.descripcion?.temporada?.valor || '-'}
*Talles:* ${talles.length ? talles.join(', ') : '-'}
*Colores:* ${colores.length ? colores.map(c => c.nombre || c).join(', ') : '-'}
*Precio:* ${formatMoneda(producto.variedad?.[0]?.precio || 0, producto.variedad?.[0]?.moneda || '$')}
*Stock:* ${producto.descripcion?.stock?.valor || '-'}
*Actualización:* ${producto.upd ? new Date(producto.upd).toLocaleDateString() : '-'}
*WhatsApp Pedidos:* ${producto.descripcion?.whatsapp?.telefono ? `https://wa.me/54${producto.descripcion.whatsapp.telefono}` : '-'}
*Video:* ${producto.descripcion?.video?.url || '-'}
*Imagen:* ${producto.imagen?.[0]?.url || '-'}
  `.trim();

            navigator.clipboard.writeText(texto).then(() => {
                Swal.fire('Copiado!', 'El texto para WhatsApp fue copiado.', 'success');
            });
        }

        // --- Copiar formato Texto Plano (sin asteriscos ni negrita) ---
        function copiarDatosTextoPlano(producto, categoriaCodigo) {
            const talles = producto.descripcion?.talles?.valores || [];
            const colores = producto.descripcion?.colores?.valores || [];

            const texto = `
${producto.nombre}
Modelo: ${producto.descripcion?.modelo?.valor || '-'}
Estilo: ${producto.descripcion?.estilo?.valor || '-'}
Marca: ${producto.descripcion?.marca?.valor || '-'}
Género: ${producto.descripcion?.genero?.valor || '-'}
Material: ${producto.descripcion?.material?.valor || '-'}
Temporada: ${producto.descripcion?.temporada?.valor || '-'}
Talles: ${talles.length ? talles.join(', ') : '-'}
Colores: ${colores.length ? colores.map(c => c.nombre || c).join(', ') : '-'}
Precio: ${formatMoneda(producto.variedad?.[0]?.precio || 0, producto.variedad?.[0]?.moneda || '$')}
Stock: ${producto.descripcion?.stock?.valor || '-'}
Actualización: ${producto.upd ? new Date(producto.upd).toLocaleDateString() : '-'}
WhatsApp Pedidos: ${producto.descripcion?.whatsapp?.telefono ? `https://wa.me/54${producto.descripcion.whatsapp.telefono}` : '-'}
Video: ${producto.descripcion?.video?.url || '-'}
Ver producto: ${location.origin + location.pathname}?categoria=${categoriaCodigo}&producto=${producto.codigo}
Imagen: ${producto.imagen?.[0]?.url || '-'}
  `.trim();

            navigator.clipboard.writeText(texto).then(() => {
                Swal.fire('Copiado!', 'El texto plano fue copiado.', 'success');
            });
        }

        // --- JS para asignar el evento a todos los elementos con clase .plato_nombre ---
        document.querySelectorAll('.plato_nombre').forEach(el => {
            el.addEventListener('click', () => {
                const productoJSON = el.getAttribute('data-producto');
                const categoriaCodigo = el.getAttribute('data-categoria');

                if (productoJSON) {
                    const producto = JSON.parse(productoJSON);
                    mostrarOpcionesCopiar(producto, categoriaCodigo);
                }
            });
        });

        function crearProductoHTMLCompacto(categoria, producto) {
            const productoURL = `${location.origin}${location.pathname} ? categoria = ${categoria.codigo} & producto=${producto.codigo}`;
            const esAndroid = /Android/i.test(navigator.userAgent);

            const imagenesOrdenadas = Array.isArray(producto.imagen) && producto.imagen.length > 0
                ? (() => {
                    const portada = producto.imagen.find(img => img.portada);
                    const resto = producto.imagen.filter(img => img !== portada);
                    return portada ? [portada, ...resto] : [...producto.imagen];
                })()
                : [];

            const textoBotonCompra = producto.variedad.length > 1 ? "Elegir Variedad" : "🛒 Añadir al carrito";

            const botonesCarrusel = imagenesOrdenadas.length > 1 ? `
            <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleControls_${producto.codigo}" data-bs-slide="prev" style="filter: invert(1);">
                <span class="carousel-control-prev-icon" aria-hidden="true" style="width: 1.5rem; height: 1.5rem;"></span>
                <span class="visually-hidden">Anterior</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleControls_${producto.codigo}" data-bs-slide="next" style="filter: invert(1);">
                <span class="carousel-control-next-icon" aria-hidden="true" style="width: 1.5rem; height: 1.5rem;"></span>
                <span class="visually-hidden">Siguiente</span>
            </button>` : '';

            const preciosCarrusel = `
        <div id="carouselPrecios_${producto.codigo}" class="carousel slide" data-bs-ride="carousel" data-bs-interval="4000">
            <div class="carousel-inner text-center">
                ${(producto.variedad || []).map((v, i) => `
                    <div class="carousel-item ${i === 0 ? 'active' : ''}">
                        <div style="font-size: 1.2rem; font-weight: bold;">${formatMoneda(v.precio * (v.minima || 1), v.moneda)}</div>
                        <div class="small mt-1" style="color: ${obtenerColor(v.variedad)}; font-weight: bold;">${v.variedad} (x${v.minima || 1})</div>
                    </div>`).join('')}
            </div>
             ${(producto.variedad || []).length > 1 ? `
            <button class="carousel-control-prev" type="button" data-bs-target="#carouselPrecios_${producto.codigo}" data-bs-slide="prev" style="filter: invert(1);">
                <span class="carousel-control-prev-icon" style="width: 1.5rem; height: 1.5rem;"></span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#carouselPrecios_${producto.codigo}" data-bs-slide="next" style="filter: invert(1);">
                <span class="carousel-control-next-icon" style="width: 1.5rem; height: 1.5rem;"></span>
            </button>` : ''}
        </div>`;

            // Obtenemos el mensaje original
            let mensajeWhatsApp = producto.descripcion?.whatsapp?.mensaje || '';

            // Reemplazamos solo si ya existe una URL dentro del mensaje original
            mensajeWhatsApp = mensajeWhatsApp.includes('https://hostingshop-v2.blogspot.com/')
                ? mensajeWhatsApp.replace(/https:\/\/hostingshop-v2\.blogspot\.com\/\?categoria=.*?&producto=.*?/g, productoURL)
                : `${mensajeWhatsApp} \n\nPodés verlo aquí: ${productoURL} `;

            // Generamos la URL de WhatsApp con el mensaje codificado
            const urlWhatsApp = producto.descripcion?.whatsapp?.telefono
                ? `https://wa.me/549${producto.descripcion.whatsapp.telefono}?text=${encodeURIComponent(mensajeWhatsApp)}`
                : '';

            return `
<li class="producto-item compacto col-6 col-md-4 col-lg-3 mb-3"
    id="producto-${categoria.codigo}-${producto.codigo}"
    data-categoria="${categoria.codigo}"
    data-precio="${producto.precio}"
    data-variedades='${JSON.stringify(producto.variedad.map(v => v.variedad))}'
    data-variedad-principal='${producto.variedad[0]?.variedad || ''}'
    data-variedades_completo='${JSON.stringify(producto.variedad)}'
    data-json='${JSON.stringify(producto).replace(/'/g, "&apos;").replace(/"/g, "&quot;")}'>
  <div class="card h-100 shadow-sm text-center">
    <div class="image-parent">
      <div class="plato_nombre" data-producto='${JSON.stringify(producto).replace(/'/g, "&apos;")}' style="display:none;"></div>
      <div id="carouselExampleControls_${producto.codigo}" class="carousel slide" data-bs-ride="manual" data-initialized="false">
<div class="carousel-inner">
    ${imagenesOrdenadas.length
                    ? imagenesOrdenadas.map((img, i) => {
                        return `
                <div class="carousel-item ${i === 0 ? 'active' : ''}">
                    <a 
                        href="${img.url}" 
                        data-fancybox="gallery-${producto.nombre}" 
                        data-caption="${producto.nombre}" 
                        data-type="image" 
                        data-carpeta-id="${img.carpeta_id}" 
                        data-download-src="${img.url}" 
                        download="${producto.nombre}_imagen_${i + 1}.webp"
                    >
                        <img src="${img.url}" class="img-fluid lazyload" style="object-fit: contain; max-height: 100%; width: 100%;" alt="imagen" loading="lazy"
                             onerror="this.src='https://placehold.co/250x300/0088f2/white?text=Imagen+No+Disponible';">
                    </a>
                    ${img.portada ? `<span class="sticker-portada">⭐ Portada</span>` : ''}
                </div>
            `;
                    }).join('')
                    : `<div class="carousel-item active">
               <img src="https://placehold.co/250x300/0088f2/white?text=No+Disponible" class="img-fluid">
           </div>`
                }
</div>
        ${botonesCarrusel}
      </div>

      <div class="carousel-caption">
        ${preciosCarrusel}
        <div class="mt-2">
          <button class="btn btn-success w-100 fw-bold py-2" onclick="mostrar_popuppedido('${categoria.codigo}', '${producto.codigo}')">
            ${textoBotonCompra}
          </button>
        </div>
      </div>

<div class="acciones mt-2 px-2 pb-2">
  <div class="d-flex gap-2 mb-2">
    <button class="btn btn-outline-secondary btn-sm w-100" title="Compartir"
            onclick="compartirProducto('${producto.nombre}', '${productoURL}')">
      ${!esAndroid ? 'Share ' : ''}<i class="fa fa-share-alt"></i>
    </button>

    ${urlWhatsApp
                    ? `<button class="btn btn-outline-info btn-sm w-100" title="Consulta por WhatsApp"
            style="background-color: #25D366; color: white; font-weight: bold;"
            onclick="window.open('${urlWhatsApp}', '_blank')">
              ${!esAndroid ? 'Info ' : ''}<i class="fa fa-whatsapp"></i>
          </button>`
                    : ''
                }

    ${producto.descripcion?.video?.url ? `
    <a class="btn btn-outline-danger btn-sm w-100" title="Ver Video" 
       data-fancybox 
       href="${producto.descripcion.video.url}"
       data-thumb="${producto.descripcion.video.thumbnail}">
      ${!esAndroid ? 'Ver ' : ''}<i class="fa fa-play-circle"></i>
    </a>` : ''}
  </div>
 </div>
</div>
</li>`;
        }

        function renderizarProductosPorCategoria(codigoCategoria) {
            const contenedor = document.getElementById(`contenedor-productos-${codigoCategoria}`);
            if (!contenedor || contenedor.dataset.renderizado === "true") return;

            // --- INICIO: Leer y Aplanar estructura DENTRO de renderizarProductosPorCategoria ---
            const configCompleta = JSON.parse(localStorage.getItem("configuracion_pagina"));
            const categoriasPadre = configCompleta?.content || [];
            const config = categoriasPadre.flatMap(padre => padre.categorias); // Aplanamos
            // --- FIN: Aplanar ---
            const categoria = config.find(cat => String(cat.codigo) === String(codigoCategoria));
            if (!categoria) return;

            const searchValue = $("#txt_search").val().toUpperCase();
            const productosFiltrados = categoria.producto.filter(prod =>
                prod.nombre.toUpperCase().includes(searchValue)
            );

            const productosOrdenados = ordenarListaProductos(productosFiltrados, ordenSeleccionado);
            contenedor.innerHTML = productosOrdenados.map(p => crearProductoHTML(categoria, p)).join('');
            contenedor.dataset.renderizado = "true";

            const productosCategoria = contenedor.querySelectorAll(".producto-item");
            productosCategoria.forEach(producto => {
                const codigo = producto.id.replace(/^producto-[^-]+-/, '');
                inicializarCarruselCuandoCargue(codigo);
                inicializarCarruselesPrecios();
            });

            // 🔁 Refrescar puntuaciones si existe función global
            if (typeof cargarPuntuaciones === 'function') cargarPuntuaciones();

            console.log(`✅ Productos renderizados para categoría: ${codigoCategoria}`);
        }

        function renderizarTodasLasCategorias() {
            // --- INICIO: Leer y Aplanar estructura DENTRO de renderizarTodasLasCategorias ---
            const configCompleta = JSON.parse(localStorage.getItem('configuracion_pagina'));
            const categoriasPadre = configCompleta?.content || [];
            const config = categoriasPadre.flatMap(padre => (padre.categorias || [])); // Aplanamos
            // --- FIN: Aplanar ---

            config.forEach(categoria => {
                const contenedor = document.getElementById(`contenedor-productos-${categoria.codigo}`);
                if (!contenedor) return;

                const searchValue = $("#txt_search").val().toUpperCase();
                const productosFiltrados = categoria.producto.filter(prod =>
                    prod.nombre.toUpperCase().includes(searchValue)
                );

                const productosOrdenados = ordenarListaProductos(productosFiltrados, ordenSeleccionado);

                contenedor.innerHTML = productosOrdenados.map(p => crearProductoHTML(categoria, p)).join('');
                contenedor.dataset.renderizado = "true";

                const productosCategoria = contenedor.querySelectorAll(".producto-item");
                productosCategoria.forEach(producto => {
                    const codigo = producto.id.replace(/^producto-[^-]+-/, '');
                    inicializarCarruselCuandoCargue(codigo);
                });

                if (typeof cargarPuntuaciones === 'function') cargarPuntuaciones();
            });

            console.log("🔁 Todas las categorías fueron re-renderizadas");
        }

        function filtrarPorCategoriaPadre(valorSeleccionado) {
            console.log(`Filtrando acordeones por Padre: ${valorSeleccionado || 'Todas'}`);

            // 1. Recargar los acordeones (esto ya estaba)
            cargar_productos();

            // 2. 👇 Regenerar el carrusel superior para que coincida 👇
            generarListadoCategoriasCarrusel();

            // 3. Opcional: Cerrar todos los acordeones (esto ya estaba)
            if (typeof $ !== 'undefined' && $.fn.collapse) {
                $(".accordion-collapse").collapse('hide');
            } else {
                console.warn("jQuery o Bootstrap Collapse no disponibles al intentar cerrar acordeones.");
            }
        }

        function cargar_productos(tipoFiltro = '', filtroTexto = '') {
            let lstProductos = '';

            // --- INICIO: Leer y Aplanar estructura DENTRO de cargar_productos (Esto ya lo tenías) ---
            const configCompleta = JSON.parse(localStorage.getItem('configuracion_pagina'));
            const categoriasPadreOriginal = configCompleta?.content || [];
            // Aplanamos, PERO AÑADIMOS el nombre_padre a cada hija
            let configAplanada = categoriasPadreOriginal.flatMap(padre =>
                (padre.categorias || []).map(hija => ({
                    ...hija, // Mantiene codigo, nombre, icono, producto, url_categoria
                    nombre_padre: padre.nombre_padre // Añade la referencia al padre
                }))
            );
            // --- FIN: Leer y Aplanar ---

            // <<< --- INICIO: Filtrar por Categoría Padre Seleccionada (PUNTO B) --- >>>
            const filtroPadreSeleccionado = document.getElementById('filtroCategoriaPadre')?.value || '';
            let configFiltrada = configAplanada; // Por defecto, usamos todas

            if (filtroPadreSeleccionado && filtroPadreSeleccionado !== '') {
                // Filtramos la lista aplanada para quedarnos solo con las hijas del padre seleccionado
                configFiltrada = configAplanada.filter(hija => hija.nombre_padre === filtroPadreSeleccionado);
                console.log(`🔎 Filtrando por Categoría Padre: "${filtroPadreSeleccionado}"`);
            } else {
                console.log("🔎 Mostrando Todas las Categorías Padre."); // Mensaje cuando no hay filtro
            }
            // <<< --- FIN: Filtrar por Categoría Padre (PUNTO B) --- >>>


            const categoriasFiltradasParaRender = []; // Renombramos la variable para claridad

            // --- MODIFICACIÓN: Iterar sobre configFiltrada en lugar de config ---
            // (Esta parte ya la tenías en tu código compartido)
            configFiltrada.forEach(categoria => { // <--- USA LA LISTA FILTRADA
                let productos = categoria.producto;

                // Aplicar filtro por nombre si se solicita (esto queda igual)
                if (tipoFiltro === "Nombre") {
                    const textoBusqueda = filtroTexto?.toUpperCase() || '';
                    productos = productos.filter(prod => prod.nombre.toUpperCase().includes(textoBusqueda));
                }

                // Si no hay productos luego del filtro, no mostrar esta categoría (esto queda igual)
                if (!productos.length) return;

                // Guardar esta categoría para renderizado inmediato (esto queda igual)
                categoriasFiltradasParaRender.push({ ...categoria, producto: productos });

                // Crear acordeón vacío (esto queda igual)
                lstProductos += `
        <div class="accordion-item">
          <h2 class="accordion-header" id="flush-heading-${categoria.codigo}">
            <div class="d-flex justify-content-between align-items-center">
              <button class="accordion-button collapsed text-center desplegar_acordeon" type="button"
                  data-bs-toggle="collapse" data-bs-target="#flush-collapse-${categoria.codigo}"
                  aria-expanded="false" aria-controls="flush-collapse-${categoria.codigo}"
                  data-categoria="${categoria.codigo}">
                <div class="categoria_contenedor">
                  <div class="categoria_icono">${categoria.icono || ''}</div>
                  <div class="categoria_nombre">
                    ${categoria.nombre}
                    <span class="contador_productos">${productos.length} Prod.</span>
                  </div>
                </div>
              </button>
             ${categoria.url_categoria ? `
             <a href="${categoria.url_categoria}" class="btn btn-success btn-sm ms-2 me-3 whatsapp-btn"
               target="_blank" onclick="event.stopPropagation();">
              <span class="whatsapp-text">📲 Comparte y vende "${categoria.nombre}" por WhatsApp <i class="fa fa-whatsapp me-1"></i></span>
              <span class="whatsapp-text-small">Vender por <i class="fa fa-whatsapp me-1"></i></span>
            </a>` : ''}
            </div>
          </h2>
          <div id="flush-collapse-${categoria.codigo}" class="accordion-collapse collapse"
              aria-labelledby="flush-heading-${categoria.codigo}"
              data-bs-parent="#accordionFlushExample" data-categoria="${categoria.codigo}">
            <div class="accordion-body">
              <div class="row gx-2 gy-3" id="contenedor-productos-${categoria.codigo}">
                </div>
            </div>
          </div>
        </div>`;
            }); // <--- FIN del forEach modificado

            document.getElementById('accordionFlushExample').innerHTML = lstProductos;

            // --- Renderizar las categorías filtradas inmediatamente ---
            // (Esta parte ya la tenías correcta, usando categoriasFiltradasParaRender)
            setTimeout(() => {
                categoriasFiltradasParaRender.forEach(cat => {
                    const contenedor = document.getElementById(`contenedor-productos-${cat.codigo}`);
                    if (!contenedor) return;

                    // --- (El resto de esta sección queda igual) ---
                    contenedor.innerHTML = ordenarListaProductos(cat.producto, ordenSeleccionado)
                        .map(p => crearProductoHTML(cat, p)).join('');
                    contenedor.dataset.renderizado = "true";

                    const productosCategoria = contenedor.querySelectorAll(".producto-item");
                    productosCategoria.forEach(producto => {
                        const codigo = producto.id.replace(/^producto-[^-]+-/, '');
                        inicializarCarruselCuandoCargue(codigo);
                    });

                    if (typeof cargarPuntuaciones === 'function') cargarPuntuaciones();
                });
            }, 50);

            // Establecer la vista por defecto
            const vistaGuardada = localStorage.getItem('modo_vista') || 'lista';
            document.body.dataset.vista = vistaGuardada;
            document.getElementById(`vista-${vistaGuardada}`).classList.add('active'); // ✅ aplicar estilo

            // ✅ Función con transición y recarga inteligente
            function cambiarVista(vista) {
                const contenedor = document.getElementById("accordionFlushExample");
                contenedor.classList.add("fade-out");

                setTimeout(() => {
                    localStorage.setItem("modo_vista", vista);
                    document.body.dataset.vista = vista;

                    // ✅ Cambiar estilo visual del botón activo
                    document.getElementById('vista-lista').classList.remove('active');
                    document.getElementById('vista-compacta').classList.remove('active');
                    document.getElementById(`vista-${vista}`).classList.add('active');

                    // 🔄 Limpiar productos
                    document.querySelectorAll('[id^="contenedor-productos-"]').forEach(el => {
                        el.innerHTML = "";
                        el.dataset.renderizado = "false";
                    });

                    renderizarTodasLasCategorias();

                    contenedor.classList.remove("fade-out");
                    contenedor.classList.add("fade-in");
                    setTimeout(() => contenedor.classList.remove("fade-in"), 300);
                }, 200);
            }

            // Listeners
            document.getElementById('vista-lista').addEventListener('click', () => cambiarVista('lista'));
            document.getElementById('vista-compacta').addEventListener('click', () => cambiarVista('compacta'));

            let isFirstScroll = true; // Bandera para controlar si es el primer scroll (por URL)

            // ✅ Función para limpiar parámetros de la URL (reutilizable y con estilo uniforme)
            function limpiarURL() {
                const url = new URL(window.location.href);
                const keysToDelete = [];

                url.searchParams.forEach((value, key) => {
                    keysToDelete.push(key);
                });

                keysToDelete.forEach(key => url.searchParams.delete(key));
                window.history.replaceState({}, '', url.pathname);
            }

            // Función para hacer el scroll al producto destacado
            function highlightProductScroll(highlightedProduct) {
                const headerHeight = 150; // Altura del encabezado fijo

                highlightedProduct.addClass('highlight');

                $('html, body').animate({
                    scrollTop: highlightedProduct.offset().top - headerHeight
                }, 400, () => {
                    // Eliminar el resaltado después de 4 segundos
                    setTimeout(() => {
                        highlightedProduct.removeClass('highlight');
                    }, 4000);

                    // ✅ Limpiar URL después del scroll (a los 6 segundos)
                    setTimeout(() => {
                        limpiarURL();
                    }, 6000);
                });
            }

            // Cargar los productos
            $("#accordionFlushExample").html(lstProductos);

            // ✅ Caso: categoría + producto → resalta producto
            if (highlightCategoria && highlightProducto) {
                const style = document.createElement('style');
                style.textContent = `
        .highlight {
            background-color: yellow;
            animation: fade 2s ease-out;
        }
        @keyframes fade {
            0% { background-color: yellow; }
            100% { background-color: transparent; }
        }`;
                document.head.appendChild(style);

                const $targetAccordion = $(`#flush-collapse-${highlightCategoria}`);

                // Esperamos a que el acordeón termine de abrirse
                $targetAccordion.one('shown.bs.collapse', function () {
                    // Renderizamos los productos
                    renderizarProductosPorCategoria(highlightCategoria);

                    // Esperamos un momento a que el DOM se actualice
                    setTimeout(() => {
                        const highlightedProduct = $(`#producto-${highlightCategoria}-${highlightProducto}`);

                        if (highlightedProduct.length && isFirstScroll) {
                            highlightProductScroll(highlightedProduct);
                            isFirstScroll = false;

                            const productosCategoria = $(`#flush-collapse-${highlightCategoria}`).find(".producto-item");
                            if (productosCategoria.length > 0) {
                                const categoria = productosCategoria[0].dataset.categoria || "sin-categoria";
                                generarOpcionesDeResaltadoFiltrado(Array.from(productosCategoria), categoria);
                            }
                        } else {
                            console.warn("⚠ Producto para resaltar no encontrado.");
                        }
                    }, 100); // Ajustable si tu DOM necesita más tiempo
                });

                // Disparar la apertura del acordeón (esto activa el .one de arriba)
                $targetAccordion.collapse('show');
            }

            else if (highlightCategoria && !highlightProducto) {
                filtrosAplicados = true; // ✅ Evitamos ejecución múltiple

                const allParams = new URLSearchParams(window.location.search);
                const tieneFiltros = Array.from(allParams.keys()).some(key => key !== 'categoria');

                if (tieneFiltros) {
                    // ⏳ Esperar breve tiempo para asegurar que Bootstrap procese los nuevos elementos
                    setTimeout(() => {
                        const targetCollapseId = `#flush-collapse-${highlightCategoria}`;
                        const $targetAccordion = $(targetCollapseId);

                        // Mostrar el acordeón
                        $targetAccordion.collapse('show');

                        // Esperamos a que el acordeón esté completamente desplegado para hacer scroll
                        $targetAccordion.one('shown.bs.collapse', function () {
                            const headerHeight = 100;
                            $("html, body").animate({
                                scrollTop: $targetAccordion.offset().top - headerHeight
                            }, 500);

                            // Activar filtros automáticamente
                            const productosCategoria = this.querySelectorAll(".producto-item");
                            if (productosCategoria.length > 0) {
                                const categoria = productosCategoria[0].dataset.categoria || "sin-categoria";
                                localStorage.setItem(`filtros_disponibles_${categoria}`, "true");
                                generarOpcionesDeResaltadoFiltrado(Array.from(productosCategoria), categoria);
                            }

                            // ✅ Limpiar URL después del scroll (a los 6 segundos)
                            setTimeout(() => {
                                limpiarURL();
                            }, 6000);

                            // Aplicamos el filtrado por opciones
                            aplicarResaltadoFiltradoPorOpciones();
                        });

                        // Activar los filtros desde los parámetros de la URL
                        allParams.forEach((value, key) => {
                            if (key !== 'categoria') {
                                const checkbox = document.querySelector(`.filtro-checkbox[data-clave="${decodeURIComponent(key)}"]`);
                                if (checkbox) {
                                    checkbox.checked = true;
                                    checkbox.dispatchEvent(new Event('change'));
                                }
                            }
                        });
                    }, 100); // 🔁 Ajusta el delay si es necesario (100ms suele ser suficiente)
                }
            }

            // Lógica para manejar el scroll automático al abrir el acordeón
            $(".desplegar_acordeon").on("click", function () {
                const targetId = $(this).attr("data-bs-target");
                const isOpen = $(this).attr("aria-expanded") === "true"; // Verifica si el acordeón está abierto
                const headerHeight = 100; // Altura del encabezado fijo

                setTimeout(() => {
                    if (isOpen) { // Solo realiza el scroll si el acordeón está abierto
                        const targetElement = $(targetId);
                        if (targetElement.length) {
                            // Realiza el scroll a la posición del acordeón abierto con ajuste por el encabezado
                            AppState.isProgrammaticScroll = true; // 🔥 Set flag 
                            $("html, body").animate({
                                scrollTop: targetElement.offset().top - headerHeight
                            }, 500, function () {
                                setTimeout(() => AppState.isProgrammaticScroll = false, 100); // Reset flag
                            });
                        }
                    }
                }, 300); // Ajusta el tiempo si es necesario
            });

            // Detectar si hay un acordeón desplegado y mostrar/ocultar el botón
            function toggleFloatingButton() {
                const anyOpen = $(".accordion-collapse.show").length > 0; // Verifica si hay acordeones abiertos
                const searchValue = $("#txt_search").val(); // Obtiene el valor del input de búsqueda
                const hasFilter = highlightCategoria || highlightProducto || searchValue.trim() !== ""; // Verifica si hay filtro activo
                const isPrincipalVisible = $(".principal").is(":visible"); // Verifica si la clase '.principal' está visible

                // Mostrar el botón solo si hay acordeones abiertos, NO hay filtro activo y la clase '.principal' está visible
                if (anyOpen && !hasFilter && isPrincipalVisible) {
                    $("#closeAllAccordions").fadeIn(); // Mostrar el botón
                } else {
                    $("#closeAllAccordions").fadeOut(); // Ocultar el botón
                }
            }

            // Evento para cerrar todos los acordeones
            $("#closeAllAccordions").on("click", function () {
                $(".accordion-collapse").collapse('hide');
            });

            function hayFiltrosOResaltadoAplicados() {
                const hayFiltrosEnLocalStorage = Object.keys(localStorage).some(key => key.startsWith("filtro_"));
                const haySelectsConValor = Array.from(document.querySelectorAll(".filtro-select")).some(select => select.value);
                const hayCheckboxesMarcados = document.querySelectorAll(".filtro-checkbox:checked").length > 0;
                const hayProductosResaltados = document.querySelectorAll(".producto-item.resaltado-filtro").length > 0;

                return hayFiltrosEnLocalStorage || haySelectsConValor || hayCheckboxesMarcados || hayProductosResaltados;
            }

            // Evento para manejar el cambio de estado de los acordeones
            $(".accordion-collapse").on("shown.bs.collapse hidden.bs.collapse", function (e) {
                if (toggleInProgress) return;

                toggleFloatingButton();

                const contenedor = this.querySelector(".list-group");
                const categoria = contenedor?.id?.replace("contenedor-productos-", "") || "sin-categoria";

                if (e.type === "shown") {
                    localStorage.setItem(`filtros_disponibles_${categoria}`, "true");
                    renderizarProductosPorCategoria(categoria);

                    const productosCategoria = this.querySelectorAll(".producto-item");
                    if (productosCategoria.length > 0) {
                        generarOpcionesDeResaltadoFiltrado(Array.from(productosCategoria), categoria);
                    } else {
                        console.warn("⚠️ Se abrió el acordeón pero los productos no están en el DOM aún.");
                    }
                }

                if (e.type === "hidden") {
                    localStorage.removeItem(`filtros_disponibles_${categoria}`);
                    resetearResaltadoFiltradoVisual();
                    if (hayFiltrosAplicados()) {
                        $("#btnLimpiarResaltado").click();
                    }
                    console.log(`🧼 Resaltado y filtros limpiados para categoría: ${categoria}`);
                }
            });

            // Evento para limpiar el resaltado
            $("#btnLimpiarResaltado").on("click", function () {
                if (!toggleInProgress) {
                    resetearResaltadoFiltradoVisual();
                }

                $(".accordion-collapse").collapse('hide');
                console.log("Resaltado limpiado y acordeones contraídos.");
            });

            // Después de cargar los productos, actualiza las puntuaciones
            cargarPuntuaciones();
        }

        let toggleInProgress = false; // Flag para controlar si toggleDetalle se está ejecutando

        // Función para manejar el toggle de detalles del mini carrito
        function toggleDetalle(id, isDelete = false) {
            toggleInProgress = true;

            const productosRelacionados = $(`#sidebarCarritoContenido [data-producto-id="${id}"]`);
            const cantidadItems = productosRelacionados.length;

            if (cantidadItems === 0) {
                actualizarEstadoBoton(id, true); // Actualiza a "Mini carrito vacío"
                if (!isDelete) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Sin productos',
                        text: 'No hay productos cargados en el mini carrito.',
                        confirmButtonText: 'Aceptar'
                    });
                }
                toggleInProgress = false;
                return;
            }

            productosRelacionados.each(function () {
                const bloque = $(this);

                // Scroll solo al primero
                if (productosRelacionados.index(bloque) === 0) {
                    $('#sidebarCarritoContenido').animate({
                        scrollTop: bloque.position().top + $('#sidebarCarritoContenido').scrollTop() - 100
                    }, 400);
                }

                // Resaltar todos los ítems relacionados
                bloque.addClass('resaltado-mini');
                setTimeout(() => bloque.removeClass('resaltado-mini'), 1500);
            });

            actualizarEstadoBoton(id, isDelete);
            toggleInProgress = false;

            // ✅ Después de terminar el toggle, si hay resaltados, limpiamos y regeneramos filtros
            if ($('.resaltado').length > 0) {
                limpiarFiltrosYResaltado();
                generarOpcionesResaltadoFiltrado();
            }
        }

        function actualizarEstadoBoton(id, isDelete = false) {
            const boton = $(`#toggle_button_${id}`);
            const productosRelacionados = $(`#sidebarCarritoContenido #contenedor_producto_${id} .detalle-cantidad-item`);
            const cantidadItems = productosRelacionados.length;

            if (cantidadItems === 0) {
                boton.html(`Mini carrito vacío <i class='fa fa-chevron-down'></i>`);
                return;
            }

            if (isDelete) {
                boton.html(`Mini <i class='fa fa-shopping-cart'></i> (${cantidadItems}) Modificado <i class='fa fa-refresh'></i>`);
            } else {
                boton.html(`Ver mini <i class='fa fa-shopping-cart'></i> (${cantidadItems}) <i class='fa fa-eye'></i>`);
            }

            boton.addClass('boton-actualizado');
            setTimeout(() => boton.removeClass('boton-actualizado'), 1500);
        }

        function toggleSidebarCarrito() {
            const sidebar = document.getElementById("sidebarCarrito");
            const overlay = document.getElementById("overlayCarrito");

            sidebar.classList.toggle("active");
            overlay.classList.toggle("active");

            // Cerrar filtros si están abiertos
            document.getElementById("sidebarFiltros").classList.remove("active");
            document.getElementById("overlayFiltros").classList.remove("active");
        }

        function closeSidebarCarrito() {
            document.getElementById("sidebarCarrito").classList.remove("active");
            document.getElementById("overlayCarrito").classList.remove("active");
        }

        function mostrarDetalleEnCarrito(idProducto) {
            const esMobile = window.innerWidth < 768;
            const sidebar = document.getElementById('sidebarCarrito');
            const overlay = document.getElementById('overlayCarrito');
            const sidebarAbierto = sidebar.classList.contains('active');

            const productosRelacionados = $(`#sidebarCarritoContenido [data-producto-id="${idProducto}"]`);
            const cantidadItems = productosRelacionados.length;

            if (cantidadItems === 0) {
                actualizarEstadoBoton(idProducto, true);
                Swal.fire({
                    icon: 'warning',
                    title: 'Sin productos',
                    text: 'No hay productos cargados en el mini carrito.',
                    confirmButtonText: 'Aceptar'
                });
                return;
            }

            // 👉 Expandir el acordeón si está cerrado
            const collapseGrupo = $(`#collapse_variedades_${idProducto}`);
            if (collapseGrupo.length && !collapseGrupo.hasClass('show')) {
                collapseGrupo.collapse('show');
            }

            // 👉 Resaltar encabezado también
            const encabezado = $(`#contenedor_producto_${idProducto} .producto-titulo`);
            encabezado.addClass('resaltado-mini');
            setTimeout(() => encabezado.removeClass('resaltado-mini'), 1500);

            if (esMobile && !sidebarAbierto) {
                sidebar.classList.add('active');
                overlay.classList.add('active');

                setTimeout(() => {
                    toggleDetalle(idProducto);
                }, 300);
            } else {
                // 👉 En escritorio: mostrar, expandir y centrar el grupo del producto
                if (!sidebarAbierto) {
                    sidebar.classList.add('active');
                    overlay.classList.add('active');
                }

                toggleDetalle(idProducto);

                // Centrar visualmente el grupo
                const contenedor = document.getElementById(`contenedor_producto_${idProducto}`);
                if (contenedor) {
                    contenedor.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }

        // Funciones para Puntuacion de Productos

        function generarPuntuacionFicticia(codigoProducto) {
            const votosFicticios = Math.floor(Math.random() * 100) + 1;
            const totalPuntosFicticios = ((Math.random() * 2 + 3) * votosFicticios).toFixed(1);

            let datosPuntuacion = JSON.parse(localStorage.getItem('puntuaciones')) || {};
            datosPuntuacion[codigoProducto] = {
                votos: votosFicticios,
                totalPuntos: parseFloat(totalPuntosFicticios)
            };
            localStorage.setItem('puntuaciones', JSON.stringify(datosPuntuacion));
        }

        function actualizarEstrellas(codigoProducto, promedio) {
            const estrellas = document.querySelectorAll(`#estrellas-${codigoProducto} .estrella i`);
            estrellas.forEach((estrella, index) => {
                estrella.className = index < promedio ? 'fa fa-star' : 'fa fa-star-o';
            });
        }

        function registrarPuntuacion(codigoProducto, valor) {
            let datosPuntuacion = JSON.parse(localStorage.getItem('puntuaciones')) || {};
            let votosUsuario = JSON.parse(localStorage.getItem('votosUsuario')) || {};

            if (!datosPuntuacion[codigoProducto]) {
                generarPuntuacionFicticia(codigoProducto); // Generar puntuación ficticia si no existe
                datosPuntuacion = JSON.parse(localStorage.getItem('puntuaciones'));
            }

            if (votosUsuario[codigoProducto]) {
                Swal.fire({
                    title: "Ya has puntuado este producto",
                    text: "¿Quieres actualizar tu puntuación?",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonText: "Sí, actualizar",
                    cancelButtonText: "No"
                }).then((result) => {
                    if (result.isConfirmed) {

                        let votosAnteriores = votosUsuario[codigoProducto];
                        datosPuntuacion[codigoProducto].totalPuntos -= votosAnteriores;
                        datosPuntuacion[codigoProducto].totalPuntos += valor;

                        votosUsuario[codigoProducto] = valor;

                        localStorage.setItem('votosUsuario', JSON.stringify(votosUsuario));
                        localStorage.setItem('puntuaciones', JSON.stringify(datosPuntuacion));

                        let promedio = (datosPuntuacion[codigoProducto].totalPuntos / datosPuntuacion[codigoProducto].votos).toFixed(1);
                        actualizarEstrellas(codigoProducto, promedio);

                        Swal.fire({
                            title: 'Puntuación actualizada!',
                            text: 'Tu puntuación ha sido actualizada.',
                            icon: 'success'
                        });
                    }
                });
                return;
            }

            // Si el usuario no ha votado antes, registramos su voto
            datosPuntuacion[codigoProducto].votos += 1;
            datosPuntuacion[codigoProducto].totalPuntos += valor;
            votosUsuario[codigoProducto] = valor;

            // Guardamos los datos actualizados
            localStorage.setItem('votosUsuario', JSON.stringify(votosUsuario));
            localStorage.setItem('puntuaciones', JSON.stringify(datosPuntuacion));

            // Calculamos el nuevo promedio
            let promedio = (datosPuntuacion[codigoProducto].totalPuntos / datosPuntuacion[codigoProducto].votos).toFixed(1);

            // Actualizamos las estrellas y mostramos el resultado
            actualizarEstrellas(codigoProducto, promedio);

            const resultadoPuntuacion = document.getElementById('resultado-puntuacion-' + codigoProducto);
            if (resultadoPuntuacion) {
                resultadoPuntuacion.style.display = 'block';
                resultadoPuntuacion.textContent = `Total votos: ${datosPuntuacion[codigoProducto].votos}. Promedio: ${promedio}`;
            }

            // Mostramos la alerta de agradecimiento
            Swal.fire({
                title: 'Gracias por tu puntuación!',
                text: 'Tu puntuación ha sido registrada.',
                icon: 'success'
            });
        }

        function cargarPuntuaciones() {
            let datosPuntuacion = JSON.parse(localStorage.getItem('puntuaciones')) || {};

            for (let codigoProducto in datosPuntuacion) {
                let promedio = (datosPuntuacion[codigoProducto].totalPuntos / datosPuntuacion[codigoProducto].votos).toFixed(1);

                // Actualiza las estrellas visualmente
                actualizarEstrellas(codigoProducto, promedio);

                // Actualiza el texto de resultados
                const resultadoPuntuacion = document.getElementById('resultado-puntuacion-' + codigoProducto);
                if (resultadoPuntuacion) {
                    resultadoPuntuacion.style.display = 'block';
                    resultadoPuntuacion.textContent = `Total votos: ${datosPuntuacion[codigoProducto].votos}. Promedio: ${promedio}`;
                }
            }
        }

        function compartirProducto(nombre, url) {
            Swal.fire({
                title: 'Compartir producto',
                html: `
            <p>Elige una red social para compartir:</p>
            <div class="d-flex flex-column align-items-stretch">
                <button class="btn btn-success mb-2" data-red="whatsapp">
                    <i class="fa fa-whatsapp"></i> WhatsApp
                </button>
                <button class="btn btn-primary mb-2" data-red="facebook">
                    <i class="fa fa-facebook"></i> Facebook
                </button>
                <button class="btn btn-info mb-2" data-red="twitter">
                    <i class="fa fa-twitter"></i> Twitter
                </button>
                <button class="btn btn-danger mb-2" data-red="email">
                    <i class="fa fa-envelope"></i> Correo Electrónico
                </button>
                <button class="btn btn-primary mb-2" style="background-color: #0077b5;" data-red="linkedin">
                    <i class="fa fa-linkedin"></i> LinkedIn
                </button>
                <button class="btn btn-warning mb-2" style="color: #e60023;" data-red="pinterest">
                    <i class="fa fa-pinterest"></i> Pinterest
                </button>
                <button class="btn btn-secondary mb-2" data-red="copiar">
                    <i class="fa fa-link"></i> Copiar Enlace
                </button>
                ${navigator.share ? `
                <button class="btn btn-dark mb-2" data-red="sistema">
                    <i class="fa fa-share-alt"></i> Compartir (Dispositivo)
                </button>
                ` : ''}
            </div>
        `,
                showCancelButton: true,
                cancelButtonText: 'Cerrar',
                showConfirmButton: false,
                customClass: {
                    popup: 'swal2-modal-custom'
                },
                didOpen: () => {
                    const botones = Swal.getPopup().querySelectorAll('[data-red]');
                    botones.forEach(btn => {
                        btn.addEventListener('click', () => {
                            const red = btn.getAttribute('data-red');
                            switch (red) {
                                case 'whatsapp':
                                    compartirWhatsApp(url, nombre);
                                    break;
                                case 'facebook':
                                    compartirFacebook(url);
                                    break;
                                case 'twitter':
                                    compartirTwitter(url, nombre);
                                    break;
                                case 'email':
                                    compartirEmail(url, nombre);
                                    break;
                                case 'linkedin':
                                    compartirLinkedIn(url, nombre);
                                    break;
                                case 'pinterest':
                                    compartirPinterest(url, nombre);
                                    break;
                                case 'copiar':
                                    copiarEnlace(url);
                                    break;
                                case 'sistema':
                                    compartirSistema(nombre, url);
                                    break;
                                default:
                                    break;
                            }
                        });
                    });
                }
            });
        }

        // Funciones de compartir en redes
        function compartirWhatsApp(url, nombre) {
            const texto = `¡Mira este producto! ${nombre}. Aquí tienes el enlace: ${url}`;
            const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(texto)}`;
            window.open(whatsappUrl, '_blank');
        }

        function compartirFacebook(url) {
            const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
            window.open(facebookUrl, '_blank');
        }

        function compartirTwitter(url, nombre) {
            const texto = `¡Descubre este increíble producto: ${nombre}! 👉 ${url}`;
            const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(texto)}`;
            window.open(twitterUrl, '_blank');
        }

        function compartirEmail(url, nombre) {
            const asunto = `Te recomiendo este producto: ${nombre}`;
            const cuerpo = `Hola,\n\nQuiero compartir contigo este producto que encontré: ${nombre}.\n\nPuedes verlo aquí: ${url}`;
            const emailUrl = `mailto:?subject=${encodeURIComponent(asunto)}&body=${encodeURIComponent(cuerpo)}`;
            window.open(emailUrl, '_blank');
        }

        function compartirLinkedIn(url, nombre) {
            const texto = `¡Echa un vistazo a este producto: ${nombre}!`;
            const linkedInUrl = `https://www.linkedin.com/shareArticle?mini=true&url=${encodeURIComponent(url)}&title=${encodeURIComponent(nombre)}&summary=${encodeURIComponent(texto)}`;
            window.open(linkedInUrl, '_blank');
        }

        function compartirPinterest(url, nombre) {
            const texto = `¡Revisa este producto: ${nombre}!`;
            const pinterestUrl = `https://www.pinterest.com/pin/create/button/?url=${encodeURIComponent(url)}&description=${encodeURIComponent(texto)}`;
            window.open(pinterestUrl, '_blank');
        }

        function copiarEnlace(url) {
            navigator.clipboard.writeText(url).then(() => {
                Swal.fire({
                    icon: 'success',
                    title: '¡Enlace copiado!',
                    text: 'El enlace se copió al portapapeles.',
                    timer: 2000,
                    showConfirmButton: false
                });
            }).catch(err => {
                console.error("Error al copiar:", err);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se pudo copiar el enlace.',
                });
            });
        }

        function compartirSistema(nombre, url) {
            navigator.share({
                title: 'Producto recomendado',
                text: `¡Mirá este producto: ${nombre}!`,
                url: url
            }).catch(error => {
                console.error("Error al compartir desde el sistema:", error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se pudo usar la función de compartir del sistema.',
                });
            });
        }

        // Variable global para el modo de búsqueda
        let modoBusqueda = "filtrar"; // valor por defecto

        function cambiarModoBusqueda(valor) {
            // Actualizar el modo de búsqueda
            modoBusqueda = valor;

            // Actualizar el título del sidebar
            actualizarTituloSidebar();

        }

        function actualizarTituloSidebar() {
            let sidebarFiltros = document.querySelector('#sidebarFiltros');
            if (!sidebarFiltros) return;

            let tituloSidebar = sidebarFiltros.querySelector('h4');
            if (!tituloSidebar) return;

            tituloSidebar.textContent = (modoBusqueda === "resaltar") ? "Resaltado de productos" : "Filtrado de productos";
        }

        function getContrastingBorderColor(hexColor) {
            const color = hexColor.startsWith("#") ? hexColor.slice(1) : hexColor;
            if (color.length !== 6) return "gray"; // fallback

            const r = parseInt(color.substr(0, 2), 16);
            const g = parseInt(color.substr(2, 2), 16);
            const b = parseInt(color.substr(4, 2), 16);
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;

            // Más contraste para colores muy claros u oscuros
            return brightness > 125 ? "rgba(0,0,0,0.3)" : "rgba(255,255,255,0.6)";
        }

        function generarOpcionesDeResaltadoFiltrado(productosCategoria, categoria) {
            if (!productosCategoria || typeof productosCategoria.forEach !== "function") {
                console.error("❌ productosCategoria no es un iterable válido:", productosCategoria);
                return;
            }

            const sidebarFiltros = document.querySelector('#sidebarFiltros');
            if (!sidebarFiltros) {
                console.error("⚠️ No se encontró el contenedor de filtros en la barra lateral.");
                return;
            }

            const tituloSidebar = sidebarFiltros.querySelector('h4');
            if (tituloSidebar) {
                tituloSidebar.textContent = (modoBusqueda === "resaltar") ? "Resaltar por" : "Filtrar por";
            }

            const resaltados = inicializarResaltados();
            const contadorResaltados = inicializarContadores(resaltados);
            const preciosFiltrado = [];

            // Recolectar descripciones y precios
            productosCategoria.forEach(producto => {
                const descripcion = obtenerDescripcionDesdeProducto(producto);
                agruparFiltrosPorDescripcion(descripcion, producto, resaltados, contadorResaltados, preciosFiltrado);

                // Extraer precio si existe
                const precioEl = producto.querySelector('.plato_precio');
                if (precioEl) {
                    let precioStr = precioEl.textContent.replace(/[^\d.,]/g, "").replace(",", ".");
                    let precio = parseFloat(precioStr);
                    if (!isNaN(precio)) preciosFiltrado.push(precio);
                }
            });

            localStorage.setItem(`filtros_disponibles_${categoria}`, JSON.stringify(resaltados));
            logResaltados(resaltados, categoria);

            const filtrosContainer = crearContenedorFiltros(sidebarFiltros);
            const btnLimpiar = crearBotonLimpiar(filtrosContainer);
            filtrosContainer.appendChild(btnLimpiar);

            // 🔽 Aquí agregamos el filtro de precio
            if (preciosFiltrado.length > 0) {
                const min = Math.min(...preciosFiltrado);
                const max = Math.max(...preciosFiltrado);

                const filtroPrecioDiv = document.createElement('div');
                filtroPrecioDiv.classList.add('filtro-precio');

                // Texto descriptivo, con formato local y moneda
                const textoPrecio = `Precios desde ${min.toLocaleString(undefined, { style: 'currency', currency: 'ARS' })} hasta ${max.toLocaleString(undefined, { style: 'currency', currency: 'ARS' })}`;

                filtroPrecioDiv.textContent = textoPrecio;

                filtrosContainer.appendChild(filtroPrecioDiv);
            }


            renderizarFiltrosVisuales(resaltados, contadorResaltados, filtrosContainer);
            actualizarVisibilidadBtnResaltadoFiltrado();
        }

        function inicializarResaltados() {
            return {
                "Variedad": new Set(),
                "Modelo": new Set(),
                "Estilo": new Set(),
                "Marca": new Set(),
                "Género": new Set(),
                "Material": new Set(),
                "Temporada": new Set(),
                "Talles": new Set(),
                "Color": new Set(),
                "video": new Set()
            };
        }

        function inicializarContadores(resaltados) {
            const contador = {};
            for (let key in resaltados) {
                contador[key] = {};
            }
            return contador;
        }

        function obtenerDescripcionDesdeProducto(producto) {
            let productoDataStr = producto.querySelector('.plato_nombre')?.getAttribute('data-producto');
            let descripcion = {};
            try {
                if (productoDataStr) {
                    let productoData = JSON.parse(productoDataStr.replace(/&apos;/g, "'"));
                    if (productoData && typeof productoData.descripcion === 'object') {
                        descripcion = productoData.descripcion;
                    }
                }
            } catch (e) {
                console.warn("⚠️ Error al parsear productoData:", e);
            }
            return descripcion;
        }

        function agruparFiltrosPorDescripcion(desc, producto, resaltados, contador, precios) {
            const camposDirectos = {
                "Modelo": desc.modelo?.valor,
                "Estilo": desc.estilo?.valor,
                "Marca": desc.marca?.valor,
                "Género": desc.genero?.valor,
                "Material": desc.material?.valor,
                "Temporada": desc.temporada?.valor
            };

            for (let [key, valor] of Object.entries(camposDirectos)) {
                if (valor) {
                    valor = valor.trim();
                    resaltados[key].add(valor);
                    contador[key][valor] = (contador[key][valor] || 0) + 1;
                }
            }

            if (Array.isArray(desc.talles?.valores)) {
                desc.talles.valores.forEach(talle => {
                    const limpio = talle.trim();
                    if (limpio) {
                        resaltados["Talles"].add(limpio);
                        contador.Talles[limpio] = (contador.Talles[limpio] || 0) + 1;
                    }
                });
            }

            if (Array.isArray(desc.colores?.valores)) {
                desc.colores.valores.forEach(c => {
                    const colorObj = {
                        nombre: c.nombre,
                        visual: c.nombre.toLowerCase() === "surtido"
                            ? "linear-gradient(45deg, red, yellow, green, blue)"
                            : c.hex || 'transparent'
                    };
                    resaltados["Color"].add(JSON.stringify(colorObj));
                    contador.Color[c.nombre] = (contador.Color[c.nombre] || 0) + 1;
                });
            }

            if (desc.video?.url) {
                resaltados["video"].add("on");
            }

            const variedadesRaw = producto.getAttribute('data-variedades');
            if (variedadesRaw) {
                try {
                    const variedades = JSON.parse(variedadesRaw);
                    variedades.forEach(v => {
                        const variedad = v.trim();
                        if (variedad) {
                            resaltados["Variedad"].add(variedad);
                            contador.Variedad[variedad] = (contador.Variedad[variedad] || 0) + 1;
                        }
                    });

                    const datos = JSON.parse(producto.getAttribute("data-variedades_completo") || "[]");
                    datos.forEach(item => {
                        if (item.precio) {
                            const precioCalculado = parseFloat(item.precio) * (item.minima || 1);
                            precios.push(precioCalculado);
                        }
                    });
                } catch (e) {
                    console.warn("⚠️ Error al parsear data-variedades:", e);
                }
            }
        }

        function crearContenedorFiltros(parent) {
            let contenedor = document.getElementById("filtrosDinamicos");
            if (!contenedor) {
                contenedor = document.createElement("div");
                contenedor.id = "filtrosDinamicos";
                parent.appendChild(contenedor);
            } else {
                contenedor.innerHTML = "";
            }
            return contenedor;
        }

        function crearBotonLimpiar(contenedor) {
            const btn = document.createElement("button");
            btn.textContent = "Limpiar Resaltado";
            btn.classList.add("btn", "btn-outline-danger", "mb-3", "w-100");
            btn.id = "btnLimpiarResaltado";

            btn.addEventListener("click", () => {
                document.querySelectorAll('.filtro-select').forEach(select => select.value = "");
                document.querySelectorAll('.filtro-checkbox').forEach(cb => cb.checked = false);

                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('filtro_')) localStorage.removeItem(key);
                });

                contenedor.innerHTML = "";

                document.querySelectorAll('.collapse.show').forEach(acordeon => {
                    $(acordeon).collapse('hide');
                });

                setTimeout(() => actualizarVisibilidadBtnResaltadoFiltrado(), 350);
                aplicarResaltadoFiltradoPorOpciones();
            });

            return btn;
        }

        function renderizarFiltrosVisuales(resaltados, contadorResaltados, contenedor) {
            for (let key in resaltados) {
                const valores = Array.from(resaltados[key]);
                if (valores.length === 0) continue;

                const filtroDiv = document.createElement("div");
                filtroDiv.classList.add("mt-3");

                const titulo = document.createElement("h5");
                titulo.textContent = key === "video" ? "Video:" : `${key}:`;
                filtroDiv.appendChild(titulo);

                if (key === "video") {
                    const label = document.createElement("label");
                    label.classList.add("d-block");

                    const checkbox = document.createElement("input");
                    checkbox.type = "checkbox";
                    checkbox.name = "video";
                    checkbox.classList.add("me-2", "filtro-checkbox");
                    checkbox.checked = localStorage.getItem("filtro_video") === "true";

                    checkbox.addEventListener("change", (e) => {
                        localStorage.setItem("filtro_video", e.target.checked);
                        aplicarResaltadoFiltradoPorOpciones();
                        actualizarVisibilidadBtnResaltadoFiltrado();
                    });

                    label.appendChild(checkbox);
                    label.appendChild(document.createTextNode("Mostrar solo productos con video"));
                    filtroDiv.appendChild(label);
                    contenedor.appendChild(filtroDiv);
                    continue;
                }

                if (key === "Modelo" && valores.length > 2) {

                    const select = document.createElement("select");
                    select.classList.add("form-select", "form-select-sm", "filtro-select");
                    select.dataset.filtro = key;
                    select.name = key.toLowerCase();

                    const opcionDefault = document.createElement("option");
                    opcionDefault.value = "";
                    opcionDefault.textContent = "Seleccionar modelo...";
                    select.appendChild(opcionDefault);

                    valores.forEach(valor => {
                        const option = document.createElement("option");
                        option.value = valor;
                        option.textContent = `${valor} (${contadorResaltados[key]?.[valor] || 0})`;
                        option.selected = localStorage.getItem(`filtro_${key}_${valor}`) === "true";
                        select.appendChild(option);
                    });

                    select.addEventListener("change", (e) => {
                        valores.forEach(v => localStorage.removeItem(`filtro_${key}_${v}`));

                        if (e.target.value) {
                            localStorage.setItem(`filtro_${key}_${e.target.value}`, "true");
                        }

                        aplicarResaltadoFiltradoPorOpciones();
                        actualizarVisibilidadBtnResaltadoFiltrado();
                    });

                    filtroDiv.appendChild(select);
                    contenedor.appendChild(filtroDiv);
                    continue;
                }

                if (key === "Color") {
                    resaltados["Color"] = new Map();
                    const colorGroup = document.createElement("div");
                    colorGroup.classList.add("d-flex", "flex-wrap", "gap-2");

                    valores.forEach(valorJSON => {
                        const colorObj = JSON.parse(valorJSON);
                        const colorNombre = colorObj.nombre;
                        const colorVisual = colorObj.visual || 'transparent';

                        resaltados["Color"].set(colorNombre.toLowerCase(), colorVisual);

                        const label = document.createElement("label");
                        label.style.cursor = "pointer";

                        const checkbox = document.createElement("input");
                        checkbox.type = "checkbox";
                        checkbox.classList.add("filtro-checkbox");
                        // ... (resto de la configuración del checkbox sin cambios) ...
                        checkbox.dataset.nombre = colorNombre;
                        checkbox.name = key;
                        checkbox.value = valorJSON;
                        checkbox.checked = localStorage.getItem(`filtro_${key}_${colorNombre}`) === "true";
                        checkbox.style.display = "none";

                        const colorSwatch = document.createElement("span");
                        colorSwatch.classList.add("badge", "me-1");

                        colorSwatch.style.background = colorVisual;
                        colorSwatch.style.padding = "6px 12px";
                        colorSwatch.style.borderRadius = "12px";
                        colorSwatch.style.display = "inline-block";
                        colorSwatch.style.transition = "all 0.2s ease";

                        // --- INICIO DE CAMBIOS ---

                        // 1. Obtenemos el conteo de productos para este color
                        const count = contadorResaltados.Color[colorNombre] || 0;

                        // 2. Añadimos el nombre Y el conteo al texto del badge
                        colorSwatch.textContent = `${colorNombre} (${count})`;

                        // --- FIN DE CAMBIOS ---

                        colorSwatch.style.color = getContrastingTextColor(colorVisual);

                        const bordeNormal = "1px solid rgba(0,0,0,0.2)";
                        const bordeSeleccionado = "2px solid #007bff";

                        colorSwatch.style.border = checkbox.checked ? bordeSeleccionado : bordeNormal;
                        colorSwatch.style.transform = checkbox.checked ? "scale(1.05)" : "scale(1)";

                        checkbox.addEventListener("change", (e) => {
                            localStorage.setItem(`filtro_${key}_${colorNombre}`, e.target.checked);

                            colorSwatch.style.border = e.target.checked ? bordeSeleccionado : bordeNormal;
                            colorSwatch.style.transform = e.target.checked ? "scale(1.05)" : "scale(1)";

                            aplicarResaltadoFiltradoPorOpciones();
                            actualizarVisibilidadBtnResaltadoFiltrado();
                        });

                        label.appendChild(checkbox);
                        label.appendChild(colorSwatch);
                        colorGroup.appendChild(label);
                    });

                    resaltados["Color"].set("surtido", "linear-gradient(45deg, red, yellow, green, blue)");
                    filtroDiv.appendChild(colorGroup);

                } else if (valores.length === 1) {
                    const textoPlano = valores[0].replace(/^.*?:\s*/, "");
                    const cantidad = contadorResaltados[key]?.[valores[0]] || 0;

                    const span = document.createElement("span");
                    span.textContent = `${textoPlano} (${cantidad})`;
                    span.classList.add("badge", "bg-secondary");
                    span.style.display = "block";
                    span.style.padding = "0.5rem";
                    span.style.marginBottom = "0.5rem";
                    span.style.wordBreak = "break-word";
                    span.style.whiteSpace = "normal";
                    span.style.borderRadius = "0.375rem";
                    span.style.fontSize = "0.85rem";

                    filtroDiv.appendChild(span);
                } else {
                    valores.forEach(valor => {
                        const label = document.createElement("label");
                        label.classList.add("d-block");
                        label.style.border = "1px solid rgb(204, 204, 204)";
                        label.style.borderRadius = "8px";
                        label.style.padding = "6px 10px";
                        label.style.marginBottom = "6px";
                        label.style.transition = "0.2s";
                        label.style.cursor = "pointer";

                        const checkbox = document.createElement("input");
                        checkbox.type = "checkbox";
                        checkbox.name = key.toLowerCase();
                        checkbox.value = valor;
                        checkbox.classList.add("me-2", "filtro-checkbox");
                        checkbox.checked = localStorage.getItem(`filtro_${key}_${valor}`) === "true";

                        const span = document.createElement("span");
                        span.textContent = ` (${contadorResaltados[key]?.[valor] || 0})`;
                        span.classList.add("badge", "bg-secondary", "ms-2");
                        span.style.fontSize = "0.75rem";

                        label.appendChild(checkbox);
                        label.appendChild(document.createTextNode(valor.replace(/^.*?:\s*/, "")));
                        label.appendChild(span);

                        checkbox.addEventListener("change", (e) => {
                            localStorage.setItem(`filtro_${key}_${valor}`, e.target.checked);
                            if (e.target.checked) {
                                label.style.backgroundColor = "#e7f1ff";
                                label.style.boxShadow = "0 0 6px rgba(0,123,255,0.3)";
                                label.style.border = "2px solid #007bff";
                            } else {
                                label.style.backgroundColor = "";
                                label.style.boxShadow = "none";
                                label.style.border = "1px solid rgb(204, 204, 204)";
                            }

                            aplicarResaltadoFiltradoPorOpciones();
                            actualizarVisibilidadBtnResaltadoFiltrado();
                        });

                        if (checkbox.checked) {
                            label.style.backgroundColor = "#e7f1ff";
                            label.style.boxShadow = "0 0 6px rgba(0,123,255,0.3)";
                            label.style.border = "2px solid #007bff";
                        }

                        filtroDiv.appendChild(label);
                    });
                }

                contenedor.appendChild(filtroDiv);
            }
        }

        function logResaltados(resaltados, categoria) {
            const categoriaLog = categoria && categoria !== "undefined" ? categoria : "sin-categoria";
            const resaltadosNoVacios = Object.fromEntries(
                Object.entries(resaltados).filter(([clave, set]) => set.size > 0)
            );

            if (Object.keys(resaltadosNoVacios).length > 0) {
                console.log(`🎯 Opciones de resaltado para ${categoriaLog}:`, resaltadosNoVacios);
            } else {
                console.log(`🎯 No hay opciones de resaltado activas para ${categoriaLog}`);
            }
        }

        function actualizarVisibilidadBtnResaltadoFiltrado() {
            const btnLimpiar = document.getElementById("btnLimpiarResaltado");
            const btnCompartir = document.getElementById("btn-copiar-url");

            const haySelect = [...document.querySelectorAll(".filtro-select")].some(s => s.value !== "");
            const hayChecks = [...document.querySelectorAll(".filtro-checkbox")].some(c => c.checked);

            if (haySelect || hayChecks) {
                if (btnLimpiar) {
                    btnLimpiar.style.display = "block";
                    btnLimpiar.textContent = (modoBusqueda === "resaltar") ? "Limpiar resaltado" : "Limpiar filtrado";
                }
                if (btnCompartir) {
                    btnCompartir.style.display = "inline-block"; // o "block"
                }
            } else {
                if (btnLimpiar) btnLimpiar.style.display = "none";
                if (btnCompartir) btnCompartir.style.display = "none";
            }
        }

        function aplicarResaltadoFiltradoPorOpciones() {
            let resaltadoAplicado = {};
            let filtrosActivos = false;

            // Eliminar clases de resaltado de todos los productos
            document.querySelectorAll('.producto-item').forEach(producto => {
                producto.classList.remove('resaltado-filtro', 'no-coincide', 'color-surtido');
                producto.style.display = "";
            });

            // Obtener filtros activos
            document.querySelectorAll(".filtro-select").forEach(select => {
                if (select.value) {
                    // Convertir a array para uniformizar
                    resaltadoAplicado[select.name] = [select.value];
                    filtrosActivos = true;
                }
            });

            document.querySelectorAll(".filtro-checkbox:checked").forEach(checkbox => {
                const valor = checkbox.value;
                if (!valor) return;

                if (valor.startsWith('{')) {
                    try {
                        const parsed = JSON.parse(valor);
                        if (!parsed.nombre || parsed.nombre.trim() === '') return;
                    } catch (e) {
                        console.warn('⚠️ Error al parsear valor JSON del checkbox:', valor);
                        return;
                    }
                }

                if (!resaltadoAplicado[checkbox.name]) {
                    resaltadoAplicado[checkbox.name] = [];
                }
                resaltadoAplicado[checkbox.name].push(valor);
                filtrosActivos = true;
            });

            // Si no hay filtros activos, mostrar todos los productos
            if (!filtrosActivos) {
                console.log("🔄 No hay filtros activos. Activando mostrar_todos...");
                resaltadoAplicado['mostrar_todos'] = true;
            } else {
                console.log("📌 Filtros activos encontrados. Desactivando mostrar_todos...");
                if (resaltadoAplicado['mostrar_todos']) {
                    delete resaltadoAplicado['mostrar_todos'];
                }
            }

            // Si no hay filtros activos ni la opción de mostrar todos, no hacer nada
            if (!filtrosActivos && !resaltadoAplicado['mostrar_todos']) {
                console.log("🚫 No se aplican filtros ni resaltar ya que no hay filtros activos.");
                return;
            }

            console.log("📌 Aplicando", (modoBusqueda === "resaltar" ? "resaltado" : "filtrado"), ":", resaltadoAplicado);

            resaltarFiltrarProductosCoincidentes(resaltadoAplicado);

            // Obtener el código de la categoría desde el acordeón activo
            const categoriaElemento = document.querySelector('.accordion-button:not(.collapsed)');

            if (categoriaElemento) {
                const categoriaID = categoriaElemento.dataset.categoria?.toString() || "";
                console.log("🧐 Categoria ID obtenida desde acordeón:", categoriaID); // Verificar qué valor obtenemos aquí

                // Generar la URL y actualizarla en el botón de copiar
                const urlCompartible = generarURLCompartible(resaltadoAplicado, categoriaID);

                // Actualizar la URL del botón de copiar
                const botonCopiar = document.querySelector("#btn-copiar-url");
                if (botonCopiar) {
                    botonCopiar.onclick = () => {
                        if (typeof Swal === "undefined") return;

                        Swal.fire({
                            title: "Compartir vista filtrada",
                            text: "¿Qué deseas hacer con este filtro?",
                            icon: "question",
                            showCancelButton: true,
                            confirmButtonText: "📎 Copiar enlace",
                            cancelButtonText: "❌ Cancelar",
                            showDenyButton: true,
                            denyButtonText: "💬 Enviar por WhatsApp"
                        }).then((result) => {
                            if (result.isConfirmed) {
                                navigator.clipboard.writeText(urlCompartible).then(() => {
                                    Swal.fire("¡Copiado!", "El enlace ha sido copiado al portapapeles.", "success");
                                });
                            } else if (result.isDenied) {
                                const whatsappURL = `https://wa.me/?text=${encodeURIComponent("¡Mirá estos productos filtrados! " + urlCompartible)}`;
                                window.open(whatsappURL, '_blank');
                            }
                        });
                    };

                }
            }

            // Actualiza la visibilidad del botón
            actualizarVisibilidadBtnResaltadoFiltrado();
        }

        function generarURLCompartible(resaltadoAplicado, categoriaID) {
            const baseUrl = window.location.origin + window.location.pathname;
            const params = new URLSearchParams();

            // ✅ Agregar la categoría al inicio
            console.log("🔍 Generando URL. Categoria ID:", categoriaID); // Log para depuración
            if (categoriaID) {
                params.set("categoria", categoriaID);  // Asegurándonos de que categoriaID es un valor adecuado
            } else {
                console.warn("⚠️ No se encontró categoriaID válido.");
            }

            // Agregar filtros guardados
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith("filtro_")) {
                    const valor = localStorage.getItem(key);
                    if (valor && valor !== "false") {
                        let partes = key.split("_");
                        partes.shift(); // Quitamos "filtro"
                        const clave = partes.join("_");
                        params.append(clave, valor);
                    }
                }
            });

            // Log para ver la URL generada
            const urlGenerada = `${baseUrl}?${params.toString()}`;
            console.log("🌐 URL Generada:", urlGenerada);  // Log para depuración

            return urlGenerada;
        }

        function resaltarFiltrarProductosCoincidentes(filtros) {
            const productos = document.querySelectorAll('.producto-item');

            function normalizarClave(clave) {
                return clave.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
            }

            // 🔁 Mapeo explícito de clave visible -> clave en el objeto descripción
            const campoDescripcionMap = {
                "Modelo": "modelo",
                "Estilo": "estilo",
                "Marca": "marca",
                "Género": "genero",
                "Material": "material",
                "Temporada": "temporada",
                "Talles": "talles",
                "Color": "colores",
                "Variedad": "variedad",
                "video": "video"
            };

            if (!filtros || Object.keys(filtros).length === 0 || filtros['mostrar_todos']) {
                productos.forEach(producto => {
                    producto.classList.remove('resaltado-filtro', 'no-coincide', 'color-surtido', 'oculto');
                    producto.style.display = "";
                });
                return;
            }

            productos.forEach(producto => {
                producto.classList.remove('resaltado-filtro', 'no-coincide', 'color-surtido', 'oculto');
                let coincide = true;

                const dataProductoStr = producto.querySelector('.plato_nombre')?.getAttribute('data-producto');
                let descripcion = {};
                if (dataProductoStr) {
                    try {
                        const parsed = JSON.parse(dataProductoStr.replace(/&apos;/g, "'"));
                        if (parsed.descripcion && typeof parsed.descripcion === 'object') {
                            descripcion = parsed.descripcion;
                        }
                    } catch (e) {
                        console.warn("⚠️ Error al parsear data-producto:", e);
                    }
                }

                for (let key in filtros) {
                    const valoresFiltro = filtros[key];
                    let textoElemento = "";

                    const claveNorm = normalizarClave(key);
                    const claveReal = campoDescripcionMap[key] || claveNorm;

                    if (claveNorm === 'variedad') {
                        let variedadesProducto = [];
                        const raw = producto.getAttribute('data-variedades');
                        if (raw) {
                            try {
                                variedadesProducto = JSON.parse(raw);
                            } catch (e) {
                                console.warn('Error parseando data-variedades', e);
                            }
                        }

                        const valoresFiltroArray = Array.isArray(valoresFiltro) ? valoresFiltro : [valoresFiltro];
                        const tieneVariedad = variedadesProducto.some(v =>
                            valoresFiltroArray.some(filtroVariedad =>
                                filtroVariedad.toLowerCase() === v.toLowerCase()
                            )
                        );
                        if (!tieneVariedad) {
                            coincide = false;
                            break;
                        }
                        continue;
                    }

                    if (claveNorm === 'color') {
                        const hayCoincidencia = productoCoincideConColores(producto, valoresFiltro);
                        if (!hayCoincidencia) {
                            coincide = false;
                        }
                        continue;
                    }

                    if (claveNorm === 'video') {
                        let json;
                        try {
                            json = JSON.parse(producto.dataset.json);
                        } catch (e) {
                            console.warn("No se pudo parsear el JSON del producto:", e);
                            coincide = false;
                            continue;
                        }

                        const tieneVideo = !!json.descripcion?.video?.url;
                        if (!tieneVideo) {
                            coincide = false;
                        }
                        continue;
                    }

                    if (claveReal === 'talles') {
                        textoElemento = [];
                        if (Array.isArray(descripcion?.[claveReal]?.valores)) {
                            textoElemento = descripcion[claveReal].valores
                                .map(t => t.trim().toLowerCase())
                                .filter(t => t.length > 0);
                        }
                    } else {
                        textoElemento = (descripcion?.[claveReal]?.valor || "").toLowerCase();
                    }

                    if (!coincide) break;

                    if (Array.isArray(valoresFiltro)) {
                        if (Array.isArray(textoElemento)) {
                            const tieneCoincidencia = valoresFiltro.some(valorFiltro =>
                                textoElemento.includes(valorFiltro.toLowerCase())
                            );
                            if (!tieneCoincidencia) {
                                coincide = false;
                                break;
                            }
                        } else {
                            const coincideTexto = valoresFiltro.some(valor =>
                                textoElemento.includes(valor.toLowerCase())
                            );
                            if (!coincideTexto) {
                                coincide = false;
                                break;
                            }
                        }
                    } else if (typeof valoresFiltro === 'string') {
                        if (Array.isArray(textoElemento)) {
                            const coincideTexto = textoElemento.some(valor =>
                                valor.includes(valoresFiltro.toLowerCase())
                            );
                            if (!coincideTexto) {
                                coincide = false;
                                break;
                            }
                        } else {
                            if (!textoElemento.includes(valoresFiltro.toLowerCase())) {
                                coincide = false;
                                break;
                            }
                        }
                    }
                }

                if (modoBusqueda === "resaltar") {
                    if (coincide) {
                        producto.classList.add('resaltado-filtro');
                    } else {
                        producto.classList.add('no-coincide');
                    }
                } else if (modoBusqueda === "filtrar") {
                    if (coincide) {
                        producto.classList.remove('oculto');
                    } else {
                        producto.classList.add('oculto');
                    }
                }

                aplicarVisibilidad(producto, coincide);
            });
        }

        function aplicarVisibilidad(producto, coincide) {
            if (modoBusqueda === "resaltar") {
                if (coincide) {
                    producto.classList.add('resaltado-filtro');
                } else {
                    producto.classList.add('no-coincide');
                }
            } else if (modoBusqueda === "filtrar") {
                if (coincide) {
                    producto.classList.remove('oculto');
                } else {
                    producto.classList.add('oculto');
                }
            }
        }

        function productoCoincideConColores(producto, valoresFiltro) {
            // ✅ Obtener JSON del producto desde el data-json
            let json;
            try {
                json = JSON.parse(producto.dataset.json);
            } catch (e) {
                console.warn("No se pudo parsear el JSON del producto:", e);
                return false;
            }

            // ✅ Extraer nombres de colores desde json.descripcion.colores.valores
            const nombresColoresProducto = new Set();

            const colores = json.descripcion?.colores?.valores;
            if (Array.isArray(colores)) {
                colores.forEach(c => {
                    if (c.nombre) {
                        const colorNombre = c.nombre.trim().toLowerCase();
                        nombresColoresProducto.add(colorNombre);

                        // 👇 Si el color es surtido, se puede agregar clase si querés
                        if (colorNombre === "surtido") {
                            producto.classList.add("color-surtido");
                        }
                    }
                });
            }

            // ✅ Convertir filtro en array normalizado
            let valoresFiltroArray = [];
            if (Array.isArray(valoresFiltro)) {
                valoresFiltroArray = valoresFiltro;
            } else if (typeof valoresFiltro === "string") {
                valoresFiltroArray = [valoresFiltro];
            }

            const nombresColoresFiltro = valoresFiltroArray.map(colorStr => {
                try {
                    return JSON.parse(colorStr).nombre.toLowerCase();
                } catch (e) {
                    return null;
                }
            }).filter(Boolean);

            // ✅ Comparar si alguno del filtro está en el set del producto
            return nombresColoresFiltro.some(nombreFiltro =>
                nombresColoresProducto.has(nombreFiltro)
            );
        }

        function resetearResaltadoFiltradoVisual() {
            const filtrosContainer = document.getElementById("filtrosDinamicos");
            if (filtrosContainer) filtrosContainer.innerHTML = ""; // Limpiar contenido de los filtros

            Object.keys(localStorage).forEach(key => {
                if (key.startsWith("filtro_")) localStorage.removeItem(key);
            });

            localStorage.removeItem("filtros_disponibles");

            console.log("🧽 Todos los filtros resaltados globales fueron eliminados.");

            // 🔵 Ahora también limpiamos los productos, ya sea resaltado o filtrado
            const productos = document.querySelectorAll('.producto-item');
            productos.forEach(producto => {
                producto.classList.remove('resaltado-filtro', 'no-coincide', 'color-surtido', 'oculto');
                producto.style.display = ""; // ← Restauramos visibilidad en caso de haber filtrado
            });
        }

        function toggleSidebarFiltros() {
            const sidebar = document.getElementById("sidebarFiltros");
            const overlay = document.getElementById("overlayFiltros");

            sidebar.classList.toggle("active");
            overlay.classList.toggle("active");

            // Cerrar carrito si está abierto
            document.getElementById("sidebarCarrito").classList.remove("active");
            document.getElementById("overlayCarrito").classList.remove("active");
        }

        function closeSidebarFiltros() {
            document.getElementById("sidebarFiltros").classList.remove("active");
            document.getElementById("overlayFiltros").classList.remove("active");
        }

        //FILTRO POR CATEGORIA

        function limpiarInput() {
            const inputTexto = document.getElementById('txt_search');
            if (inputTexto.value.trim()) { // Solo limpiar si hay texto
                inputTexto.value = '';
            }
        }

        function limpiarFiltros() {
            console.log('Limpiando filtros...');
            const filtroActivo = document.getElementById('txt_search').value.trim();

            if (filtroActivo) {
                limpiarInput();

                // Llamar a la función de búsqueda con un filtro vacío
                realizarBusquedaRestablecer();

                // Actualizar el estado del botón
                actualizarBotonEstado();

                console.log('Filtros limpiados y productos restablecidos.');
            } else {
                console.log('No hay filtros activos para limpiar.');
            }
        }

        // Función para realizar la búsqueda y restaurar acordeones
        function realizarBusquedaRestablecer() {
            // Guardar detalles antes de reiniciar
            guardarDetallesPedido();

            // Limpiar filtros y recargar productos
            cargar_productos('', '');

            // Esperar un poco para que los productos se carguen antes de regenerar filtros
            setTimeout(() => {
                let productos = document.querySelectorAll('.card-producto');
                generarOpcionesDeResaltadoFiltrado(productos, 'restablecido');

                // Restaurar detalles guardados (✅ AHORA es el momento correcto)
                restaurarDetallesPedido();

                // ✅ ACTUALIZAR ESTADO DE LOS BOTONES DEL MINICARRITO
                setTimeout(() => {
                    $('#sidebarCarritoContenido .detalle-cantidad-item').each(function () {
                        const idProducto = $(this).data('producto-id');
                        actualizarEstadoBoton(idProducto);
                    });
                }, 100); // Espera un poco más para asegurar que los detalles se hayan renderizado

                // Cerrar todos los acordeones (aunque ya no existan, por compatibilidad)
                const acordeones = document.querySelectorAll('.collapse');
                acordeones.forEach(acordeon => {
                    if (acordeon.classList.contains('show')) {
                        $(acordeon).collapse('hide');
                    }
                });

                console.log('Productos cargados, filtros reiniciados, acordeones cerrados y botones actualizados.');
            }, 300); // Ajustá este tiempo si cargar_productos tarda más
        }

        let categoriasCacheadas = null;

        window.mostrarFiltroYModal = function () {
            const contenedor = document.getElementById('listadoCategorias');

            // Cargar categorías solo si no están cacheadas
            if (!categoriasCacheadas) {
                categoriasCacheadas = generarListadoCategorias();
            }

            // Limpia el contenido del contenedor y agrega las categorías si está vacío
            if (contenedor.childElementCount === 0) {
                contenedor.innerHTML = ""; // Aseguramos que no haya duplicados
                contenedor.appendChild(categoriasCacheadas);
            }

            // Seleccionar el modal
            const modalBuscarElement = document.getElementById('modalBuscar');
            const modalBuscar = new bootstrap.Modal(modalBuscarElement, {});

            // Manejo del foco al mostrar el modal
            modalBuscarElement.addEventListener('shown.bs.modal', () => {
                const inputBuscar = document.getElementById('txt_search');
                if (inputBuscar) inputBuscar.focus();
            });

            // Restaurar foco al botón que abrió el modal al cerrarlo
            const btnAbrirModal = document.getElementById('btn_cars');
            modalBuscarElement.addEventListener('hidden.bs.modal', () => {
                if (btnAbrirModal) btnAbrirModal.focus();
            });

            // Mostrar el modal
            modalBuscar.show();
            actualizarBotonEstado();
        };

        // Actualiza el estado del botón dependiendo de la entrada de búsqueda
        window.actualizarBotonEstado = function () {
            const boton = document.getElementById('btn_cars');
            const inputBuscar = document.getElementById('txt_search');
            const iconoFiltro = document.getElementById('icon_filter'); // Icono que cambia
            const spinner = document.getElementById('spinner'); // El spinner

            // Verifica si el icono y el spinner existen antes de manipularlos
            if (iconoFiltro && spinner) {
                // Muestra el spinner cuando se inicia el proceso
                spinner.style.display = 'block'; // Mostrar el spinner

                // Lógica del botón según el estado de la búsqueda
                if (inputBuscar.value.trim()) {
                    boton.setAttribute('title', 'Limpiar Filtros');
                    iconoFiltro.classList.remove('fa-search'); // Remueve la lupa
                    iconoFiltro.classList.add('fa-times'); // Añade la "X" de limpiar
                    boton.classList.add('filtro-activo'); // Activa el color rojo

                    boton.onclick = function () {
                        limpiarFiltros();
                        // Una vez que se completa el proceso de limpiar filtros, ocultamos el spinner
                        setTimeout(function () {
                            spinner.style.display = 'none'; // Ocultar el spinner
                        }, 1000); // Ajusta el tiempo según el proceso real
                    };
                } else {
                    boton.setAttribute('title', 'Abrir Filtro');
                    iconoFiltro.classList.remove('fa-times'); // Remueve la "X"
                    iconoFiltro.classList.add('fa-search'); // Añade la lupa
                    boton.classList.remove('filtro-activo'); // Elimina el color rojo

                    boton.onclick = function () {
                        mostrarFiltroYModal();
                        // Si la lógica de abrir filtro tiene un proceso largo, podrías mostrar el spinner aquí también
                        setTimeout(function () {
                            spinner.style.display = 'none'; // Ocultar el spinner después de completar la acción
                        }, 1000); // Ajusta el tiempo según el proceso real
                    };
                }

                // Simula el proceso de búsqueda (puedes reemplazarlo con la lógica de búsqueda real)
                setTimeout(function () {
                    // Aquí iría el código de búsqueda y filtrado

                    // Una vez que el proceso termine, ocultamos el spinner
                    spinner.style.display = 'none'; // Ocultar el spinner
                }, 1000); // Ajusta el tiempo según el proceso real
            } else {
                console.error('El icono con id "icon_filter" o el spinner no existen en el DOM.');
            }
        };

        //===================================================================
        //== FUNCIÓN PARA FILTRAR BOTONES DEL MODAL POR CATEGORÍA PADRE   ==
        //===================================================================
        function filtrarModalPorCategoriaPadre(padreSeleccionado) {
            console.log(`Filtrando modal por Padre: ${padreSeleccionado || 'Todas'}`);
            const contenedorListado = document.getElementById('listadoCategorias');
            if (!contenedorListado) return;

            const itemsCategoriaHija = contenedorListado.querySelectorAll('.categoria-hija-item');

            itemsCategoriaHija.forEach(item => {
                const categoriaPadreDelItem = item.getAttribute('data-categoria-padre');

                // Si no hay padre seleccionado O si el padre del item coincide con el seleccionado
                if (!padreSeleccionado || padreSeleccionado === '' || categoriaPadreDelItem === padreSeleccionado) {
                    item.style.display = 'block'; // Mostrar
                } else {
                    item.style.display = 'none'; // Ocultar
                }
            });

            // Actualizar visibilidad del botón Limpiar Filtros del Modal
            const btnLimpiarModal = document.getElementById('btn_limpiar_filtros');
            if (btnLimpiarModal) {
                btnLimpiarModal.style.display = (padreSeleccionado && padreSeleccionado !== '') ? 'inline-block' : 'none';
            }
        }

        //===================================================================
        //== FUNCIÓN PARA LIMPIAR FILTROS DENTRO DEL MODAL                ==
        //===================================================================
        function limpiarFiltrosModal() {
            console.log('Limpiando filtros del modal...');
            const selectModal = document.getElementById('filtroModalCategoriaPadre');
            if (selectModal) {
                selectModal.value = ''; // Resetea el dropdown a "Mostrar Todas"
                // Dispara manualmente el evento 'change' para que se actualice la vista
                selectModal.dispatchEvent(new Event('change'));
            }
            // Opcional: También podrías limpiar el filtro de texto principal si quieres
            // limpiarInput();
            // realizarBusquedaRestablecer(); // Esto recargaría toda la página, quizás no sea lo ideal aquí
        }

        function filtrarPorCategoria(categoriaCodigo) {
            // --- INICIO: Aplanar para buscar categoría ---
            const configCompleta = JSON.parse(localStorage.getItem('configuracion_pagina'));
            const categoriasPadreOriginal = configCompleta?.content || [];
            const categoriasHijasAplanadas = categoriasPadreOriginal.flatMap(padre => padre.categorias);
            // --- FIN: Aplanar ---

            // Buscamos en la lista aplanada
            const categoriaEncontrada = categoriasHijasAplanadas.find(c => c.codigo == categoriaCodigo);
            const nombreParaBusqueda = categoriaEncontrada?.nombre || '';
            const nombreCorto = nombreParaBusqueda.slice(0, 4); // Manteniendo tu lógica original

            // --- (Setear inputs) ---
            // Si tienes un #filtro_select, descomenta o ajusta esta línea:
            // $("#filtro_select").val('Categoria');
            $("#txt_search").val(nombreCorto); // Pone el nombre corto en la búsqueda principal

            // --- Resetear filtro padre principal ---
            const selectPadrePrincipal = document.getElementById('filtroCategoriaPadre');
            if (selectPadrePrincipal && selectPadrePrincipal.value !== '') {
                selectPadrePrincipal.value = '';
                console.log("Resetendo filtro padre principal al filtrar por categoría hija.");
            }
            // --- FIN: Resetear filtro ---

            realizarBusqueda(); // Esto llama a cargar_productos, que AHORA leerá '' del dropdown padre
            $("#modalBuscar").modal('hide'); // Oculta el modal

            // --- 👇 INICIO: Lógica para abrir el acordeón correspondiente 👇 ---
            // Usamos setTimeout para dar tiempo a que 'realizarBusqueda' (y 'cargar_productos' dentro de ella)
            // terminen de reconstruir el DOM con los acordeones filtrados.
            setTimeout(() => {
                const acordeon = $(`#flush-collapse-${categoriaCodigo}`); // Volvemos a buscar el acordeón por si fue recreado
                if (acordeon.length > 0) { // Verificamos si jQuery encontró el elemento
                    if (!acordeon.hasClass("show")) {
                        acordeon.collapse("show"); // Usamos el método de Bootstrap para abrirlo
                        console.log(`Abriendo acordeón #${acordeon.attr('id')}`);

                        // Opcional: Scroll hacia el acordeón abierto
                        const encabezadoAcordeon = acordeon.prev('.accordion-header'); // Busca el encabezado hermano anterior
                        if (encabezadoAcordeon.length) {
                            const offset = 100; // Ajusta este valor según la altura de tu navbar fijo
                            $('html, body').animate({
                                scrollTop: encabezadoAcordeon.offset().top - offset
                            }, 500); // Animación suave
                        }

                    } else {
                        console.log(`Acordeón #${acordeon.attr('id')} ya estaba abierto.`);
                    }
                } else {
                    console.warn(`El acordeón #flush-collapse-${categoriaCodigo} no se encontró después de llamar a realizarBusqueda.`);
                }
            }, 500); // 500ms es un tiempo prudente, puedes ajustarlo si es necesario
            // --- 👆 FIN: Lógica para abrir el acordeón 👆 ---
        }

        function realizarBusqueda() {
            var filtro = document.getElementById('txt_search').value.trim();

            guardarDetallesPedido();
            cargar_productos('Nombre', filtro);

            setTimeout(function () {
                const producto = document.querySelector('.plato_nombre');
                if (producto) {
                    const acordeon = producto.closest('.collapse');
                    if (acordeon && !acordeon.classList.contains('show')) {
                        $(acordeon).collapse('show');
                    }
                    const encabezadoAcordeon = acordeon ? acordeon.previousElementSibling : null;
                    if (encabezadoAcordeon) {
                        encabezadoAcordeon.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }
                actualizarBotonEstado(); // Asegúrate de actualizar el estado al final de la búsqueda
            }, 500);

            const modal = bootstrap.Modal.getInstance(document.getElementById('modalBuscar'));
            if (modal) {
                modal.hide();
            }
        }

        function configurarPlaceholder() {
            // Si no existe el elemento, simplemente no hacemos nada
            const filtroSelect = document.getElementById("filtro_select");
            if (!filtroSelect) return;

            // Configuración adicional en caso de existir
            filtroSelect.value = "Codigo"; // O cualquier valor predeterminado
        }


        document.addEventListener('DOMContentLoaded', function () {
            const modalElement = document.getElementById('modalPedido'); // Modal
            const modalTrigger = document.querySelector('[data-bs-target="#modalPedido"]'); // Botón que abre el modal

            // ✅ Por defecto marcar "Sin Registro" si no hay nada seleccionado
            const seleccionado = document.querySelector('input[name="tipo_cliente"]:checked');
            if (!seleccionado) {
                const sinRegistro = document.getElementById('sin_registro');
                if (sinRegistro) {
                    sinRegistro.checked = true;
                    sinRegistro.dispatchEvent(new Event('change'));
                    localStorage.setItem('tipo_cliente', 'Sin Registro');

                    // ✅ También marcar tipo_compra = Retiro por defecto
                    const tipoCompraRadio = document.querySelector('input[name="tipo_compra"][value="Retiro"]');
                    if (tipoCompraRadio) {
                        tipoCompraRadio.checked = true;
                        tipoCompraRadio.dispatchEvent(new Event('change'));
                        localStorage.setItem('tipo_compra', 'Retiro');
                    }

                    // ✅ También forzar agencia = RETIRO TIENDA
                    const agenciaSelect = document.querySelector('#campo_agencia select');
                    if (agenciaSelect) {
                        agenciaSelect.value = 'RETIRO TIENDA';
                        localStorage.setItem('agencia_envio', 'RETIRO TIENDA'); // opcional
                        if (typeof cargarInfoAgenciaSeleccionada === 'function') {
                            setTimeout(() => {
                                agenciaSelect.dispatchEvent(new Event('change'));
                            }, 200);
                        }
                    }
                }
            }

            // ✅ Listener al cambiar tipo de cliente
            document.querySelectorAll('input[name="tipo_cliente"]').forEach(function (radio) {
                radio.addEventListener('change', function () {
                    const selectedValue = this.value;
                    localStorage.setItem('tipo_cliente', selectedValue);
                    handleClientTypeChange(selectedValue);
                });
            });

            // ✅ Listeners para tipo de envío (Retiro/Delivery)
            document.querySelectorAll('input[name="tipo_envio"]').forEach(function (radio) {
                radio.addEventListener('change', function () {
                    toggleDireccionFieldsBasedOnEnvio(this.value);
                });
            });

            modalElement.addEventListener('shown.bs.modal', function () {
                modalElement.removeAttribute('inert'); // ✅ Quitar bloqueo de interactividad


                const configGuardada = localStorage.getItem('configuracion_pagina');
                if (configGuardada) {
                    try {
                        const config = JSON.parse(configGuardada);
                        cargarInfoAgenciaSeleccionada(config);
                        cargarMetodosPagoYTransferencia(config);

                        setTimeout(() => {
                            const tipoCliente = localStorage.getItem('tipo_cliente');
                            const tipoCompraRadio = document.querySelector('input[name="tipo_compra"]:checked');

                            if (tipoCliente === 'Sin Registro' && tipoCompraRadio && tipoCompraRadio.value === 'Retiro') {
                                const campoAgencia = document.getElementById('campo_agencia');
                                const infoEnvioContainer = document.getElementById('info_envio_container');

                                if (campoAgencia) {
                                    campoAgencia.style.display = 'none';
                                }

                                if (infoEnvioContainer) {
                                    infoEnvioContainer.style.display = 'block';
                                }

                                const agenciaSelect = document.querySelector('#campo_agencia select');
                                if (agenciaSelect) {
                                    agenciaSelect.dispatchEvent(new Event('change'));
                                }
                            }
                        }, 100);
                    } catch (error) {
                        console.warn("Error al parsear configuración guardada:", error);
                    }
                }
            });

            // ✅ Evento al cerrar el modal
            modalElement.addEventListener('hidden.bs.modal', function () {
                modalElement.setAttribute('inert', 'true');
                if (modalTrigger) modalTrigger.focus();
            });

            configurarPlaceholder();
        });

        function cargarMetodosPagoYTransferencia(config) {
            const contenedorOpciones = document.getElementById('metodos_pago_opciones');
            const infoTransferencia = document.getElementById('info_transferencia');
            const aliasEl = document.getElementById('alias_transferencia');
            const cuentaEl = document.getElementById('cuenta_transferencia');
            const bancoEl = document.getElementById('banco_transferencia');
            const cbuEl = document.getElementById('cbu_transferencia');
            const recargoInfo = document.getElementById('recargo_info');
            const recargoValorEl = document.getElementById('recargo_valor');
            const descripcionPagoEl = document.getElementById('descripcion_pago'); // nuevo

            const tipoCliente = localStorage.getItem('tipo_cliente') || 'Sin Registro';
            const ventaActual = JSON.parse(localStorage.getItem('venta')) || {};
            const metodoSeleccionadoPrevio = ventaActual.forma_pago || 'Efectivo';

            contenedorOpciones.innerHTML = '';
            contenedorOpciones.className = 'row';

            const emojisPorPago = {
                "Efectivo": "💵",
                "Transferencia": "🏦",
                "Tarjeta Debito": "💳",
                "Tarjeta Credito": "💳",
                "Factura IVA": "🧾",
                "Presupuesto": "📋"
            };

            const metodosFiltrados = config.formas_pago.filter(f => {
                if (tipoCliente === 'Sin Registro') {
                    return ['Efectivo', 'Transferencia', 'Presupuesto'].includes(f.nombre);
                }
                return true;
            });

            metodosFiltrados.forEach((forma, index) => {
                const id = `pago_${index}`;
                const emoji = emojisPorPago[forma.nombre] || "💰";
                const checked = forma.nombre === metodoSeleccionadoPrevio ? 'checked' : '';

                const buttonHTML = `
      <div class="col-12 col-md-6">
        <input type="radio" class="btn-check" name="forma_pago" id="${id}" value="${forma.nombre}" data-recargo="${forma.recargo}" autocomplete="off" ${checked}>
        <label class="btn btn-outline-primary w-100 mb-2" for="${id}">
          ${emoji} ${forma.nombre}
        </label>
      </div>
    `;
                contenedorOpciones.insertAdjacentHTML('beforeend', buttonHTML);
            });

            document.getElementById('metodos_pago_container').style.display = 'block';

            // ✅ Registrar listener ANTES del disparo manual
            contenedorOpciones.addEventListener('change', function () {
                const selected = contenedorOpciones.querySelector('input[name="forma_pago"]:checked');
                if (!selected) return;

                const metodo = selected.value;
                const recargo = parseFloat(selected.dataset.recargo) || 0;

                let venta = JSON.parse(localStorage.getItem('venta')) || {};
                const totalSinRecargo = parseFloat(venta.total) || 0;
                const recargo_valor = +(totalSinRecargo * (recargo / 100)).toFixed(2);

                venta.forma_pago = metodo;
                venta.recargo_pago = recargo;
                venta.recargo_valor = recargo_valor;

                // Mostrar u ocultar datos de transferencia
                if (metodo === 'Transferencia') {
                    const cuenta = config.cuenta_transferencia_dia;

                    infoTransferencia.style.display = 'block';
                    aliasEl.textContent = cuenta.alias;
                    cbuEl.textContent = cuenta.cbu;
                    cuentaEl.textContent = cuenta.cuenta;
                    bancoEl.textContent = cuenta.banco;

                    venta.cuenta_transferencia_id = cuenta.id;
                    venta.cuenta_transferencia_alias = cuenta.alias;
                    venta.cuenta_transferencia_banco = cuenta.banco;
                    venta.cuenta_transferencia_cbu = cuenta.cbu;
                    venta.cuenta_transferencia_nombre = cuenta.cuenta;
                } else {
                    infoTransferencia.style.display = 'none';

                    venta.cuenta_transferencia_id = null;
                    venta.cuenta_transferencia_alias = "";
                    venta.cuenta_transferencia_banco = "";
                    venta.cuenta_transferencia_cbu = "";
                    venta.cuenta_transferencia_nombre = "";
                }

                // Mostrar recargo si aplica
                if (recargo > 0) {
                    recargoInfo.style.display = 'block';
                    recargoValorEl.textContent = `${recargo}%`;
                } else {
                    recargoInfo.style.display = 'none';
                }

                // ✅ Descripción dinámica según el método de pago
                let descripcion = "";
                switch (metodo) {
                    case 'Transferencia':
                        descripcionPagoEl.style.display = 'none';
                        break;
                    case 'Tarjeta Debito':
                        descripcion = `Pagás con tarjeta de débito al momento de recibir el pedido, se aplica un recargo del ${recargo}%. Requiere POS presencial.`;
                        break;
                    case 'Tarjeta Credito':
                        descripcion = `Pagás con tarjeta de crédito al recibir el pedido, se aplica un recargo del ${recargo}%. Requiere POS presencial.`;
                        break;
                    case 'Factura IVA':
                        descripcion = `Se genera factura A con IVA del ${recargo}%. Podés abonar con POS o transferencia.`;
                        break;
                    case 'Presupuesto':
                        descripcion = `Se genera un presupuesto sin obligación de pago. Podés confirmarlo luego.`;
                        break;
                    case 'Efectivo':
                    default:
                        descripcion = `Pagás en efectivo cuando retires el pedido. Sin recargo.`;
                        break;
                }

                if (descripcion) {
                    descripcionPagoEl.style.display = 'block';
                    descripcionPagoEl.textContent = descripcion;
                }

                localStorage.setItem('venta', JSON.stringify(venta));
                total_pedido();
            });

            // ✅ Disparar evento luego de registrar el listener
            setTimeout(() => {
                const radioPrevio = contenedorOpciones.querySelector(`input[value="${metodoSeleccionadoPrevio}"]`);
                if (radioPrevio) {
                    radioPrevio.checked = true;
                    radioPrevio.click(); // Más confiable que dispatchEvent('change')
                }
            }, 10);
        }

        function cargarInfoAgenciaSeleccionada(config) {
            const selectAgencia = document.getElementById('txt_agencia');

            // Elementos extendidos
            const infoExtendida = document.getElementById('info_envio_container');
            const descEl = document.getElementById('envio_agencia_descripcion');
            const costoAgenciaEl = document.getElementById('envio_agencia_costo');
            const horaEntregaEl = document.getElementById('envio_agencia_hora');
            const labelHora = document.getElementById('envio_agencia_hora_label');

            const moneda = config?.moneda || "$";

            if (!selectAgencia || !config?.contentagencia) return;

            if (!selectAgencia.dataset.listenerAgregado) {
                selectAgencia.addEventListener('change', function () {
                    const codigoSeleccionado = this.value;

                    if (!codigoSeleccionado) {
                        infoExtendida.style.display = 'none';
                        return;
                    }

                    const agencia = config.contentagencia.find(a => a.codigo === codigoSeleccionado);
                    if (!agencia) {
                        infoExtendida.style.display = 'none';
                        return;
                    }

                    const esRetiro = agencia.codigo.toUpperCase() === "RETIRO TIENDA";

                    // Mostrar info extendida
                    descEl.textContent = agencia.descripcion || '';
                    costoAgenciaEl.textContent = (agencia.costo_envio == 0)
                        ? "Sin costo"
                        : formatMoneda(agencia.costo_envio, moneda);

                    if (labelHora && horaEntregaEl) {
                        labelHora.childNodes[0].textContent = esRetiro
                            ? "Horario Límite de Retiro: "
                            : "Hora Estimada de Entrega: ";
                        horaEntregaEl.textContent = formatHora(agencia.hora_entrega);
                    }

                    infoExtendida.style.display = 'block';

                    // Guardar en localStorage
                    let venta = JSON.parse(localStorage.getItem('venta')) || {};

                    // Nuevos campos a guardar
                    venta.codigo_agencia = agencia.codigo || "";
                    venta.agencia_entrega = agencia.descripcion || agencia.codigo;
                    venta.costo_agencia = parseFloat(agencia.costo_envio) || 0;
                    venta.hora_entrega_agencia = agencia.hora_entrega || "";

                    localStorage.setItem('venta', JSON.stringify(venta));

                    total_pedido();
                });

                selectAgencia.dataset.listenerAgregado = 'true';
            }

            if (selectAgencia.value) {
                selectAgencia.dispatchEvent(new Event('change'));
            }
        }

        function formatHora(fechaISO) {
            if (!fechaISO) return '';
            const date = new Date(fechaISO);
            return date.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });
        }

        function handleTipoCompraChange() {
            const campoAgencia = document.getElementById('campo_agencia');
            const tipoEnvioSection = document.getElementById('tipo_envio_section');
            const infoEnvioContainer = document.getElementById('info_envio_container');

            if (this.value === 'Retiro') {
                campoAgencia.style.display = 'none';
                tipoEnvioSection.style.display = 'none';
                hideDireccionFields();

                // Ocultar detalle de agencia si estaba visible
                if (infoEnvioContainer) infoEnvioContainer.style.display = 'none';
            } else {
                campoAgencia.style.display = 'block';
                tipoEnvioSection.style.display = 'none';
                hideDireccionFields();

                // Mostrar detalle de agencia si corresponde
                const agenciaSelect = document.querySelector('#campo_agencia select');
                const config = JSON.parse(localStorage.getItem('configuracion_pagina') || '{}');
                if (agenciaSelect && agenciaSelect.value && typeof cargarInfoAgenciaSeleccionada === 'function') {
                    cargarInfoAgenciaSeleccionada(config);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', async function () {
            const selectProvincia = document.getElementById('txt_provincia');
            const selectMunicipio = document.getElementById('txt_municipio');
            const selectLocalidad = document.getElementById('txt_localidad');

            let UBIGEO = [];

            // 🔹 Cargar archivo JSON desde tu servidor
            try {
                const response = await fetch('https://www.castfer.com.ar/ubigeo_json.php');
                UBIGEO = await response.json();
                console.log(`✅ Ubigeo cargado (${UBIGEO.length} provincias)`);
            } catch (error) {
                console.error('❌ Error al cargar el archivo ubigeo.json:', error);
                return;
            }

            // 🔹 Cargar provincias
            let provOptions = '<option value="">Seleccione una provincia</option>';
            UBIGEO.forEach(p => {
                provOptions += `<option value="${p.id}">${p.nombre}</option>`;
            });
            selectProvincia.innerHTML = provOptions;
            selectProvincia.disabled = false;

            // 🔹 Al cambiar provincia → cargar municipios
            selectProvincia.addEventListener('change', function () {
                const provinciaId = this.value;
                const provincia = UBIGEO.find(p => p.id === provinciaId);

                selectMunicipio.innerHTML = '<option value="">Seleccione un municipio</option>';
                selectLocalidad.innerHTML = '<option value="">Seleccione una localidad</option>';
                selectMunicipio.disabled = !provincia;
                selectLocalidad.disabled = true;

                if (provincia) {
                    provincia.municipios.forEach(m => {
                        selectMunicipio.innerHTML += `<option value="${m.id}">${m.nombre}</option>`;
                    });
                }
            });

            // 🔹 Al cambiar municipio → cargar localidades
            selectMunicipio.addEventListener('change', function () {
                const provinciaId = selectProvincia.value;
                const municipioId = this.value;
                const provincia = UBIGEO.find(p => p.id === provinciaId);
                const municipio = provincia?.municipios.find(m => m.id === municipioId);

                selectLocalidad.innerHTML = '<option value="">Seleccione una localidad</option>';
                selectLocalidad.disabled = !municipio;

                if (municipio) {
                    municipio.localidades.forEach(l => {
                        // 🔸 Valor = ID | Texto visible = nombre
                        selectLocalidad.innerHTML += `<option value="${l.id}">${l.nombre}</option>`;
                    });
                }
            });

            console.log("🌎 Selector de ubicación inicializado correctamente.");
        });

        function handleClientTypeChange(selectedValue) {
            localStorage.setItem('tipo_cliente', selectedValue);

            const configGuardada = localStorage.getItem('configuracion_pagina');
            let config = null;
            if (configGuardada) {
                try {
                    config = JSON.parse(configGuardada);
                    cargarMetodosPagoYTransferencia(config);
                } catch (error) {
                    console.warn("Error al parsear configuración:", error);
                }
            }

            const nombreInput = document.getElementById('txt_nombre');
            const correoInput = document.getElementById('txt_correo');
            const telefonoInput = document.getElementById('txt_telefono');
            const direccionInput = document.getElementById('txt_direccion');
            const campoNombre = document.getElementById('campo_nombre');
            const campoCorreo = document.getElementById('campo_correo');
            const campoCelular = document.getElementById('campo_celular');
            const campoRut = document.getElementById('campo_rut');
            const campoAgencia = document.getElementById('campo_agencia');
            const tipoEnvioSection = document.getElementById('tipo_envio_section');
            const agenciaSelect = document.querySelector('#campo_agencia select');

            if (selectedValue === 'Registro') {
                document.getElementById('label_nombre').innerText = 'Nombre y Apellidos :';
                document.getElementById('small_nombre').innerText = 'Ingrese su nombre completo.';
                nombreInput.placeholder = 'Ingrese Nombre';
                nombreInput.required = true;
                nombreInput.maxLength = 30;
                nombreInput.removeAttribute('pattern');
                nombreInput.removeAttribute('title');

                campoNombre.style.display = 'block';
                campoCorreo.style.display = 'block';
                campoCelular.style.display = 'block';
                campoRut.style.display = 'block';
                correoInput.required = true;
                telefonoInput.required = true;
                direccionInput.required = true;

                document.getElementById('tipo_compra_section').style.display = 'block';
                document.querySelector('input[name="tipo_compra"][value="Retiro"]').checked = true;

                if (agenciaSelect) {
                    agenciaSelect.value = 'RETIRO TIENDA';

                    // Forzar evento change para mostrar info
                    if (typeof cargarInfoAgenciaSeleccionada === 'function' && config) {
                        setTimeout(() => {
                            agenciaSelect.dispatchEvent(new Event('change'));
                        }, 200);
                    }
                }

                campoAgencia.style.display = 'none';

                document.querySelectorAll('input[name="tipo_compra"]').forEach(function (radio) {
                    radio.removeEventListener('change', handleTipoCompraChange); // evitar duplicados
                    radio.addEventListener('change', handleTipoCompraChange);
                });

            } else if (selectedValue === 'Validar Datos') {
                campoNombre.style.display = 'block';
                campoCorreo.style.display = 'block';
                campoCelular.style.display = 'none';
                campoRut.style.display = 'none';
                campoAgencia.style.display = 'none';
                tipoEnvioSection.style.display = 'none';

                const infoEnvioContainer = document.getElementById('info_envio_container');
                if (infoEnvioContainer && selectedValue === 'Validar Datos') {
                    infoEnvioContainer.style.display = 'none';
                }

                document.getElementById('label_nombre').innerText = 'ID del Cliente :';
                document.getElementById('small_nombre').innerText = 'Si es cliente registrado, sino Registrese.';
                nombreInput.placeholder = 'Ingrese ID de Cliente';
                nombreInput.required = true;
                nombreInput.maxLength = 6;
                nombreInput.setAttribute('pattern', 'cli\\d{3}|CLI\\d{3}');
                nombreInput.setAttribute('title', 'El ID debe comenzar con "CLI" o "cli" seguido de 3 números.');
                correoInput.required = true;
                telefonoInput.required = false;
                direccionInput.required = false;

                document.querySelectorAll('.campo-extra').forEach(function (campo) {
                    campo.style.display = 'none';
                    campo.querySelector('input, select, textarea').required = false;
                });

                document.getElementById('tipo_compra_section').style.display = 'none';
                hideDireccionFields();

            } else {
                campoNombre.style.display = 'none';
                campoCorreo.style.display = 'none';
                campoCelular.style.display = 'none';
                campoRut.style.display = 'none';

                document.getElementById('label_nombre').innerText = 'Nombre * :';
                document.getElementById('small_nombre').innerText = 'Ingrese su nombre.';
                nombreInput.placeholder = 'Ingrese Nombre';
                nombreInput.required = false;
                nombreInput.maxLength = 20;
                nombreInput.removeAttribute('pattern');
                nombreInput.removeAttribute('title');

                correoInput.required = false;
                telefonoInput.required = false;
                direccionInput.required = false;

                document.querySelectorAll('.campo-extra').forEach(function (campo) {
                    campo.style.display = 'none';
                    campo.querySelector('input, select, textarea').required = false;
                });

                document.getElementById('tipo_compra_section').style.display = 'none';
                hideDireccionFields();
            }
        }

        //Ocultar los campos de dirección:
        function toggleDireccionFieldsBasedOnEnvio(tipoEnvio) {
            // Referencias a todos los campos de dirección
            var campoProvincia = document.getElementById('campo_provincia');
            var campoMunicipio = document.getElementById('campo_municipio'); // <-- ¡AÑADIDO!
            var campoLocalidad = document.getElementById('campo_localidad');
            var campoCodigoPostal = document.getElementById('campo_codigo_postal');
            var campoCalle = document.getElementById('campo_calle');
            var campoNumero = document.getElementById('campo_numero');
            var campoPiso = document.getElementById('campo_piso');
            var campoDepartamento = document.getElementById('campo_departamento');
            var campoObservacion = document.getElementById('campo_observacion');
            var direccionTipoEnvioContainer = document.getElementById('direccion_tipo_envio_container');

            // Primero, ocultamos todos los campos para empezar de cero
            hideDireccionFields();

            // Mostramos los campos necesarios según el tipo de envío
            if (tipoEnvio === 'Sucursal' || tipoEnvio === 'Domicilio') {
                if (direccionTipoEnvioContainer) direccionTipoEnvioContainer.style.display = 'block';
                if (campoProvincia) campoProvincia.style.display = 'block';
                if (campoMunicipio) campoMunicipio.style.display = 'block'; // <-- ¡AÑADIDO!
                if (campoLocalidad) campoLocalidad.style.display = 'block';
                if (campoCodigoPostal) campoCodigoPostal.style.display = 'block';
                if (campoCalle) campoCalle.style.display = 'block';
                if (campoNumero) campoNumero.style.display = 'block';
                if (campoObservacion) campoObservacion.style.display = 'block';

                if (tipoEnvio === 'Domicilio') {
                    if (campoPiso) campoPiso.style.display = 'block';
                    if (campoDepartamento) campoDepartamento.style.display = 'block';
                }

                // Llamamos a la función para cargar las provincias si es necesario
                if (typeof window.cargarProvincias === 'function') {
                    window.cargarProvincias();
                }
            }
        }

        //Actualizar dirección con los valores de los campos:
        function hideDireccionFields() {
            var direccionFields = [
                document.getElementById('campo_provincia'),
                document.getElementById('campo_municipio'),
                document.getElementById('campo_localidad'),
                document.getElementById('campo_codigo_postal'),
                document.getElementById('campo_calle'),
                document.getElementById('campo_numero'),
                document.getElementById('campo_piso'),
                document.getElementById('campo_departamento'),
                document.getElementById('campo_observacion'),
                document.getElementById('direccion_tipo_envio_container')
            ];

            direccionFields.forEach(function (field) {
                if (field) { // Comprobación de seguridad
                    field.style.display = 'none';
                }
            });
        }

        // --- INICIO: LÓGICA DE ACTUALIZACIÓN DE DIRECCIÓN (CON FORMATO PARA BACKEND) ---

        // Añadimos '#txt_municipio' al selector para que también active la función
        document.querySelectorAll('#txt_calle, #txt_numero, #txt_codigo_postal, #txt_localidad, #txt_provincia, #txt_municipio, #txt_piso, #txt_departamento, #txt_observacion')
            .forEach(function (input) {
                input.addEventListener('input', function () {

                    // --- 1. OBTENCIÓN DE VALORES CORREGIDA ---

                    // Para los <select>, obtenemos el TEXTO de la opción seleccionada.
                    // Esto corrige el error de mostrar el ID numérico ("06") en lugar del nombre.
                    const provinciaSelect = document.getElementById('txt_provincia');
                    const provincia = (provinciaSelect.selectedIndex > 0) ? provinciaSelect.options[provinciaSelect.selectedIndex].text : 'Sin especificar';

                    const municipioSelect = document.getElementById('txt_municipio');
                    const municipio = (municipioSelect.selectedIndex > 0) ? municipioSelect.options[municipioSelect.selectedIndex].text : 'Sin especificar';

                    const localidadSelect = document.getElementById('txt_localidad');
                    const localidad = (localidadSelect.selectedIndex > 0) ? localidadSelect.options[localidadSelect.selectedIndex].text : 'Sin especificar';

                    // Para los campos de texto, usamos el valor o un fallback
                    const calle = document.getElementById('txt_calle').value.trim() || 'Sin especificar';
                    const numero = document.getElementById('txt_numero').value.trim() || 'Sin especificar';
                    const codigoPostal = document.getElementById('txt_codigo_postal').value.trim() || 'Sin especificar';
                    const piso = document.getElementById('txt_piso').value.trim(); // Opcional
                    const departamento = document.getElementById('txt_departamento').value.trim(); // Opcional
                    const observacion = document.getElementById('txt_observacion').value.trim(); // Opcional

                    const tipoEnvio = document.querySelector('input[name="tipo_envio"]:checked') ?
                        document.querySelector('input[name="tipo_envio"]:checked').value :
                        'Sin especificar';

                    // --- 2. CONSTRUCCIÓN DE LA DIRECCIÓN CON EL FORMATO DEL BACKEND ---

                    // Empezamos con las partes obligatorias
                    let direccion = `${calle} - ${numero} - CP ${codigoPostal} - ${localidad} - ${municipio} - ${provincia}`;

                    // Añadimos las partes opcionales solo si existen, respetando el formato
                    if (tipoEnvio === 'Domicilio') {
                        direccion += ` - Piso: ${piso || 'N/A'} - Departamento: ${departamento || 'N/A'}`;
                    }

                    // Añadimos la observación (siempre, como en tu ejemplo)
                    direccion += ` - Observación: ${observacion || 'Sin especificar'}`;

                    // Añadimos el tipo de envío al final
                    direccion += ` - Tipo de Envío: ${tipoEnvio}`;

                    // --- 3. ACTUALIZAR LOS CAMPOS EN EL FORMULARIO ---
                    document.getElementById('txt_direccion').value = direccion;
                    document.getElementById('direccion_tipo_envio').textContent = `Tipo de Envío: ${tipoEnvio}`;
                });
            });


        document.querySelectorAll('input[name="tipo_cliente"]').forEach(function (radio) {
            radio.addEventListener('change', function () {
                handleClientTypeChange(this.value);
            });
        });

        document.querySelector('#campo_agencia select').addEventListener('change', function () {
            var tipoCompraSeleccionado = document.querySelector('input[name="tipo_compra"]:checked').value;
            if (tipoCompraSeleccionado === 'Envio' && this.value !== "") {
                document.getElementById('tipo_envio_section').style.display = 'block';
                hideDireccionFields(); // Ocultar dirección hasta seleccionar tipo de envío
            } else {
                document.getElementById('tipo_envio_section').style.display = 'none';
                hideDireccionFields();
            }
        });

        document.addEventListener('DOMContentLoaded', function () {
            const formPedido = document.getElementById('form_pedido');
            const btnConfirmar = document.getElementById('btn_confirmar');

            btnConfirmar.disabled = true; // Deshabilitar inicialmente

            // Muestra errores en los campos
            function marcarError(campo, mensaje = '') {
                let errorSpan = campo.nextElementSibling;
                if (!errorSpan || errorSpan.tagName !== 'SPAN') {
                    errorSpan = document.createElement('span');
                    errorSpan.classList.add('error-message');
                    campo.parentNode.insertBefore(errorSpan, campo.nextSibling);
                }
                campo.classList.toggle('is-invalid', Boolean(mensaje));
                errorSpan.textContent = mensaje;
            }

            // Validar dinámicamente
            function validarFormulario() {
                const tipoCliente = document.querySelector('input[name="tipo_cliente"]:checked')?.value || '';
                const tipoCompra = document.querySelector('input[name="tipo_compra"]:checked')?.value || '';
                const campos = {
                    nombre: document.getElementById('txt_nombre'),
                    correo: document.getElementById('txt_correo'),
                    celular: document.getElementById('txt_telefono'),
                    rut: document.getElementById('txt_rut'),
                    provincia: document.getElementById('txt_provincia'),
                    codigoPostal: document.getElementById('txt_codigo_postal'),
                    localidad: document.getElementById('txt_localidad'),
                    calle: document.getElementById('txt_calle'),
                    numero: document.getElementById('txt_numero'),
                };

                let valid = true;
                Object.keys(campos).forEach(key => marcarError(campos[key]));

                if (tipoCliente === 'Sin Registro') {
                    valid = true;
                } else if (tipoCliente === 'Validar Datos') {
                    const cliValid = /^cli\d{3}$/i.test(campos.nombre.value.trim());
                    const emailValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(campos.correo.value.trim());
                    valid = cliValid && emailValid;

                    marcarError(campos.nombre, cliValid ? '' : 'Requiere un ID de Cliente válido.');
                    marcarError(campos.correo, emailValid ? '' : 'Requiere un correo electrónico válido.');

                } else if (tipoCompra === 'Retiro') {
                    ['nombre', 'correo', 'celular', 'rut'].forEach(key => {
                        const campo = campos[key];
                        const esValido = Boolean(campo.value.trim());
                        valid = valid && esValido;
                        marcarError(campo, esValido ? '' : 'Requerido.');
                    });
                } else if (tipoCompra === 'Envio') {
                    Object.keys(campos).forEach(key => {
                        const campo = campos[key];
                        const esValido = Boolean(campo.value.trim());
                        valid = valid && esValido;
                        marcarError(campo, esValido ? '' : 'Requerido.');
                    });
                }

                btnConfirmar.disabled = !valid;
            }

            // Preseleccionar tipo de cliente
            document.querySelector('input[name="tipo_cliente"][value="Sin Registro"]').checked = true;
            validarFormulario();

            // Eventos
            formPedido.addEventListener('input', validarFormulario);
            formPedido.addEventListener('submit', function (event) {
                event.preventDefault();
                if (!btnConfirmar.disabled) {
                    alert('Formulario enviado correctamente.');
                    cerrarModal();
                }
            });

            function cerrarModal() {
                const modalElement = document.querySelector('#modalPedido');
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) modal.hide();
            }
        });

        //Funcion para Inciar una Nueva Venta

        function inicializarVenta() {
            var venta = {};
            venta.item = {};
            venta.item.total = 0.00;
            venta.item.precio = 0.00;
            venta.item.cantidad = 0.00;
            venta.item.talla = "";
            venta.item.color = "";
            venta.item.nombre = "";
            venta.item.descripcion = "";
            venta.item.codigo = "";
            venta.item.categoria = "";
            venta.item.precios = [];
            venta.detalle = [];
            localStorage.setItem('venta', JSON.stringify(venta));
            localStorage.removeItem('subvariedades_seleccionadas');
        }

        function sanitizeForId(value) {
            return value
                .trim()
                .replace(/\s+/g, "_")
                .replace(/[^a-zA-Z0-9-_]/g, "_");
        }

        function parseSubVariedades(data) {
            let parsedData;

            try {
                parsedData = typeof data === "string" ? JSON.parse(data) : data;
            } catch (e) {
                const items = data.includes(",") ? data.split(",").map(item => item.trim()) : [data.trim()];
                parsedData = Object.fromEntries(items.map(item => [item, { talles: [] }]));
            }

            return Object.entries(parsedData).map(([nombre, propiedades]) => {
                const nombreLimpio = nombre.trim();
                const color = propiedades.color || null;
                const rawTalles = propiedades.talles;

                let talles = [];

                if (typeof rawTalles === "string") {
                    try {
                        talles = JSON.parse(rawTalles);
                    } catch (e) {
                        talles = [];
                    }
                } else if (Array.isArray(rawTalles)) {
                    talles = rawTalles;
                }

                const tallesProcesados = Array.isArray(talles) && talles.length > 0
                    ? talles.map(talleObj => {
                        const valorTalle = typeof talleObj === "string" ? talleObj : talleObj.talle;
                        const stock = typeof talleObj === "object" && talleObj.stock ? talleObj.stock : "0"; // agrega stock

                        const identificadorUnico = valorTalle.trim();

                        const etiqueta = identificadorUnico.includes("-")
                            ? identificadorUnico.split("-")[1].trim()
                            : identificadorUnico;

                        return {
                            id: sanitizeForId(identificadorUnico),
                            etiqueta: etiqueta,
                            estilo: color
                                ? `background-color: ${color}; color: ${getContrastingTextColor(color)};`
                                : "",
                            stock: stock // ✅ se agrega aquí
                        };
                    })
                    : [];

                return {
                    nombre: nombreLimpio,
                    color: color,
                    id: sanitizeForId(nombreLimpio),
                    talles: tallesProcesados
                };
            });
        }

        // Utilidad: Genera un color de texto contrastante (blanco o negro)
        function getContrastingTextColor(hexColor) {
            // Removemos "#" si existe
            const color = hexColor.startsWith("#") ? hexColor.slice(1) : hexColor;
            const rgb = parseInt(color, 16); // Convierte el color a entero
            const r = (rgb >> 16) & 0xff; // Rojo
            const g = (rgb >> 8) & 0xff;  // Verde
            const b = rgb & 0xff;         // Azul

            // Calcula el brillo relativo
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
            return brightness > 125 ? "#000000" : "#FFFFFF"; // Blanco para colores oscuros, negro para claros
        }

        let evitarAutoSeleccion = false; // global

        /**
         * Genera y muestra un modal interactivo para la selección de variedades de un producto.
         * Optimizado para manejar múltiples precios con un acordeón de Bootstrap.
         *
         * @param {string} categoriaCodigo - El código de la categoría HIJA del producto. // Nombre corregido
         * @param {string} idProducto - El código del producto.
         * @param {boolean} [mostrarModal=true] - Si se debe mostrar el modal al final de la ejecución.
         */
        function mostrar_popuppedido(categoriaCodigo, idProducto, mostrarModal = true) { // <--- Parámetro corregido

            // --- 👇 INICIO: LEER Y APLANAR ESTRUCTURA CORRECTAMENTE 👇 ---
            let producto = null;
            let categoriaHija = null;
            try {
                const configCompleta = JSON.parse(localStorage.getItem('configuracion_pagina'));
                if (!configCompleta || !configCompleta.content) {
                    throw new Error("No se encontró 'configuracion_pagina' o '.content' en localStorage.");
                }
                const categoriasPadreOriginal = configCompleta.content || [];
                const categoriasHijasAplanadas = categoriasPadreOriginal.flatMap(padre => padre.categorias);

                categoriaHija = categoriasHijasAplanadas.find(cat => cat.codigo + "" === categoriaCodigo); // <--- Busca en lista aplanada

                if (!categoriaHija) {
                    throw new Error(`No se encontró la categoría hija con código: ${categoriaCodigo}`);
                }
                if (!categoriaHija.producto || !Array.isArray(categoriaHija.producto)) {
                    throw new Error(`La categoría hija ${categoriaCodigo} no tiene una lista de productos válida.`);
                }
                producto = categoriaHija.producto.find(prod => prod.codigo + "" === idProducto); // <--- Busca producto aquí

                if (!producto) {
                    throw new Error(`No se encontró el producto con código ${idProducto} en la categoría ${categoriaCodigo}`);
                }
            } catch (error) {
                console.error("❌ Error grave al buscar producto en mostrar_popuppedido:", error);
                Swal.fire('Error', 'No se pudo cargar la información del producto. Intenta recargar la página.', 'error');
                return;
            }
            // --- 👆 FIN: LEER Y APLANAR ESTRUCTURA CORRECTAMENTE 👆 ---


            // --- El resto de tu función continúa desde aquí ---
            const subvariedadesSeleccionadas = JSON.parse(localStorage.getItem('subvariedades_seleccionadas')) || {};
            const venta = JSON.parse(localStorage.getItem('venta'));
            const simbolo = venta?.moneda || "$";
            const simboloProducto = producto?.moneda || "$";

            let detalle = '';
            let opcionesDisponibles = false;

            if (mostrarModal) {
                $('#modalProducto').modal('hide');
                $('#modalProducto').attr('aria-hidden', 'true');
            }
            $('#btnAceptar').hide();

            // =================================================================================
            // BLOQUE 1: CASO DE PRODUCTO CON UNA SOLA VARIEDAD DE PRECIO (LÓGICA CORREGIDA)
            // =================================================================================
            if (producto.variedad.length === 1) {
                const unicaVariedad = producto.variedad[0];
                let detalle_variedad_filtrada = []; // Para guardar las subvariedades/talles disponibles

                // --- Filtrado inicial (igual que antes) ---
                if (unicaVariedad.sub_variedad) {
                    let detalle_variedad_parsed = parseSubVariedades(unicaVariedad.sub_variedad);
                    detalle_variedad_filtrada = detalle_variedad_parsed.map(subvar => {
                        const tallesDisponibles = (subvar.talles || []).filter(talle => {
                            const talleId = talle.id || talle.etiqueta || talle.talle || '';
                            const claveSeleccion = `${unicaVariedad.variedad} - ${subvar.nombre}${talleId ? ' - ' + talleId : ''}`;
                            return !subvariedadesSeleccionadas[idProducto]?.[claveSeleccion];
                        });
                        if (tallesDisponibles.length > 0 || (!subvar.talles || subvar.talles.length === 0)) {
                            if (!subvar.talles || subvar.talles.length === 0) {
                                const claveBase = `${unicaVariedad.variedad} - ${subvar.nombre}`;
                                if (subvariedadesSeleccionadas[idProducto]?.[claveBase]) return null;
                            }
                            return { ...subvar, talles: tallesDisponibles };
                        }
                        return null;
                    }).filter(Boolean);
                } else {
                    // Caso sin subvariedad (botón aceptar general)
                    if (!subvariedadesSeleccionadas[idProducto]?.[unicaVariedad.variedad]) {
                        detalle_variedad_filtrada = [{ nombre: unicaVariedad.variedad, talles: [] }];
                    }
                }
                // --- Fin Filtrado ---


                // --- Lógica Principal del Bloque 1 ---
                if (detalle_variedad_filtrada.length === 1) {
                    // *** CASO A: Queda UNA SOLA subvariedad (color o principal) ***
                    opcionesDisponibles = true;
                    const subvariedadActual = detalle_variedad_filtrada[0];
                    const tieneTalles = subvariedadActual.talles && subvariedadActual.talles.length > 0;
                    const tieneMultiplesTalles = tieneTalles && subvariedadActual.talles.length > 1;

                    const precioFormateado = formatMoneda(unicaVariedad.precio, unicaVariedad.moneda);
                    const minimo = unicaVariedad.minima || 1;
                    const minimoCompra = minimo * unicaVariedad.precio;
                    const minimoCompraFormateado = formatMoneda(minimoCompra, unicaVariedad.moneda);
                    // Mostrar nombre de subvariedad solo si existe (no en el caso sin sub_variedad)
                    const nombreMostrado = unicaVariedad.sub_variedad ? subvariedadActual.nombre : '';
                    const titulo = `<h5 class="text-center" style="font-weight: bold; color: #333;">${unicaVariedad.variedad}${nombreMostrado ? ' - ' + nombreMostrado : ''}</h5>`;

                    if (tieneMultiplesTalles) {
                        // ** Subcaso A1: Una subvariedad con MÚLTIPLES talles -> MOSTRAR BOTONES DE TALLE **
                        usarBotonAceptarGeneral = false;
                        detalle = `<div class="text-center">${titulo}<p class="small text-muted">Precio: ${precioFormateado} c/u - Mín: ${minimo} = ${minimoCompraFormateado}</p></div>`;
                        detalle += '<div class="row g-2 justify-content-center mt-2">'; // Contenedor para botones

                        subvariedadActual.talles.forEach(talle => {
                            const stock = parseInt(talle.stock || "0");
                            const textoStock = stock > 0 ? `(Stock: ${stock})` : `(Sin stock)`;
                            const talleIdONombre = (talle.id || talle.etiqueta || talle.talle || '').replace(/'/g, "\\'");
                            const esSurtido = subvariedadActual.nombre === "Surtido"; // Re-chequear aquí por si acaso
                            const colorFondo = esSurtido ? "" : subvariedadActual.color || "#ccc";
                            const colorTexto = esSurtido ? "#FFFFFF" : getContrastingTextColor(colorFondo);
                            const estiloColor = esSurtido
                                ? `background: linear-gradient(45deg, red, orange, yellow, green, blue, indigo, violet); color: white; border: 1px solid rgba(0,0,0,0.1);`
                                : `background-color: ${colorFondo}; color: ${colorTexto}; border: 1px solid rgba(0,0,0,0.1);`;

                            detalle += `<div class="talle-container col-6 col-md-4">
                                   <button class="btn btn-sm w-100 btn-talle" style="${estiloColor} font-size: 0.8rem; padding: 0.25rem 0.5rem;" ${stock === 0 ? 'disabled' : ''}
                                           onclick="seleccionarTalle('${categoriaCodigo.replace(/'/g, "\\'")}', '${idProducto.replace(/'/g, "\\'")}', '${unicaVariedad.variedad.replace(/'/g, "\\'")}', '${subvariedadActual.nombre.replace(/'/g, "\\'")}', '${unicaVariedad.precio}', '${unicaVariedad.moneda}', '${minimo}', 1, '${talleIdONombre}', '${stock}'); this.closest('.talle-container').remove(); verificarSiOcultarSubvariedad(this); cerrarModalvariableSiEsNecesario();">
                                       ${talle.etiqueta || talle.talle || ''} ${textoStock}
                                   </button>
                                 </div>`;
                        });
                        detalle += '</div>'; // Cerrar row

                    } else {
                        // ** Subcaso A2: Una subvariedad con UN talle o SIN talles -> BOTÓN ACEPTAR GENERAL **
                        usarBotonAceptarGeneral = true;
                        const talleUnico = tieneTalles ? subvariedadActual.talles[0] : null;
                        let stockDisponible = Infinity;
                        if (talleUnico) { stockDisponible = parseInt(talleUnico.stock || "Infinity"); }
                        else if (subvariedadActual.stock !== undefined) { stockDisponible = parseInt(subvariedadActual.stock || "Infinity"); }
                        if (isNaN(stockDisponible)) stockDisponible = Infinity;

                        const stockHtml = stockDisponible > 0 && isFinite(stockDisponible) ? `<p><small class="text-success">Stock: ${stockDisponible}</small></p>` : (stockDisponible <= 0 ? `<p><small class="text-danger">Sin stock</small></p>` : '<p><small>Stock no especificado</small></p>');
                        const contenidoExtra = `${stockHtml}<small class="text-muted">Compra mínima: ${minimo} un. (${minimoCompraFormateado})</small>`;
                        detalle = `<div class="text-center">${titulo}<p>Precio: <strong>${precioFormateado}</strong></p>${contenidoExtra}</div>`;

                        $('#btnAceptar').prop('disabled', stockDisponible === 0);
                        $('#btnAceptar').off('click').on('click', function () {
                            // Usar nombreMostrado que ya definimos antes
                            const nombreVariedadFinal = `${unicaVariedad.variedad}${nombreMostrado ? ' - ' + nombreMostrado : ''}`;
                            seleccionar_variedad(categoriaCodigo, idProducto, nombreVariedadFinal, unicaVariedad.precio, unicaVariedad.moneda, minimo, 1, talleUnico ? talleUnico.id : '', stockDisponible);
                            if (typeof cerrarModalvariable === 'function') cerrarModalvariable();
                        });
                    }
                } else if (detalle_variedad_filtrada.length > 1) {
                    // *** CASO B: Quedan MÚLTIPLES subvariedades (colores) ***
                    opcionesDisponibles = true;
                    usarBotonAceptarGeneral = false; // No usar botón general

                    // --- 👇 INICIO: Título Principal Centrado y Apilado 👇 ---
                    const precioFormateado = formatMoneda(unicaVariedad.precio, unicaVariedad.moneda);
                    const minimo = unicaVariedad.minima || 1;
                    const minimoCompra = minimo * unicaVariedad.precio;
                    const minimoCompraFormateado = formatMoneda(minimoCompra, unicaVariedad.moneda);

                    // Div contenedor centrado
                    detalle = `<div class="text-center mb-3">
                           <h5 class="mb-1">${unicaVariedad.variedad}</h5>
                           <div class="mb-1">${precioFormateado} p/unidad</div>
                           <div class="small text-muted" style="line-height: 1.2;">
                               <span>Compra mínima: ${minimo} un. (${minimoCompraFormateado})</span>
                           </div>
                        </div>`;
                    // --- 👆 FIN: Título Principal Centrado y Apilado 👆 ---

                    // --- Usar 'row g-2' para agrupar selects/botones (igual que antes) ---
                    detalle += '<div class="row g-2 justify-content-center">'; // g-2 añade espacio

                    detalle_variedad_filtrada.forEach(subvar => {
                        // Verificar si esta subvariedad tiene múltiples talles restantes
                        if (subvar.talles && subvar.talles.length > 1) {
                            // ** Subcaso B1: Múltiples colores, MÚLTIPLES talles -> USAR SELECT **
                            detalle += _crearHTMLParaSubvariedadConMultiplesTalles(subvar, unicaVariedad, categoriaCodigo, idProducto);
                        } else {
                            // ** Subcaso B2: Múltiples colores, UN talle o SIN talles -> USAR BOTÓN SIMPLE **
                            detalle += _crearHTMLParaSubvariedadSinTalles(subvar, unicaVariedad, categoriaCodigo, idProducto);
                        }
                    }); // Fin forEach subvar
                    detalle += '</div>'; // Cerrar row
                    // --- FIN: Usar 'row g-2' ---

                } else {
                    // *** CASO C: NO quedan subvariedades disponibles *** (Igual que antes)
                    opcionesDisponibles = false;
                }

                // --- Mostrar modal o alerta ---
                if (opcionesDisponibles) {
                    $('#detalle_modal_producto').html(detalle);
                    if (usarBotonAceptarGeneral) { $('#btnAceptar').show(); } else { $('#btnAceptar').hide(); }
                    if (mostrarModal) {
                        $('#modalProducto').modal('show');
                        $('#modalProducto').attr('aria-hidden', 'false');
                    }
                } else {
                    Swal.fire({ icon: 'warning', title: '¡Atención!', text: 'Ya has seleccionado todas las opciones disponibles para esta variedad/producto.', confirmButtonText: 'Aceptar' });
                }
                return; // Salir

            } // <-- Fin IF Variedad Única

            // =================================================================================
            // BLOQUE 2: CASO DE MÚLTIPLES VARIEDADES DE PRECIO (ACORDEÓN)
            // =================================================================================
            detalle = '<div class="accordion" id="accordionVariedades">';

            producto.variedad.forEach((variedad, index) => {
                const precioFormateado = formatMoneda(variedad.precio, variedad.moneda);
                const minimoCompra = (variedad.minima || 1) * variedad.precio; // Asegurar minima exista
                const minimoCompraFormateado = formatMoneda(minimoCompra, variedad.moneda);
                const idCollapse = `collapse-${sanitizeForId(idProducto)}-${sanitizeForId(variedad.variedad)}`;
                const isFirst = index === 0;
                const showClass = isFirst ? 'show' : '';
                const collapsedClass = isFirst ? '' : 'collapsed';

                if (!variedad.sub_variedad) {
                    // Caso simple sin sub-variedad
                    if (!subvariedadesSeleccionadas[idProducto] || !subvariedadesSeleccionadas[idProducto][variedad.variedad]) {
                        opcionesDisponibles = true;
                        // 👇 CORRECCIÓN: Usar categoriaCodigo 👇
                        detalle += `<div class="accordion-item"><div class="accordion-header p-2"><button type="button" onclick="seleccionar_variedad('${categoriaCodigo}','${idProducto}','${variedad.variedad}','${variedad.precio}','${variedad.moneda}','${variedad.minima}',1);" class="btn btn-dark w-100">${variedad.variedad} - ${precioFormateado}</button></div></div>`;
                    }
                } else {
                    // Caso con sub-variedades
                    let detalle_variedad = parseSubVariedades(variedad.sub_variedad);
                    // Filtro para quitar las ya seleccionadas (igual que antes)
                    detalle_variedad = detalle_variedad.filter(subvar =>
                        !subvariedadesSeleccionadas[idProducto] || !Object.keys(subvariedadesSeleccionadas[idProducto] || {}).some(key => key.startsWith(`${variedad.variedad} - ${subvar.nombre}`))
                    );

                    if (detalle_variedad.length > 0) {
                        opcionesDisponibles = true; // Marcar que hay opciones
                        detalle += `
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading-${idCollapse}">
                            <button class="accordion-button ${collapsedClass}" type="button" data-bs-toggle="collapse" data-bs-target="#${idCollapse}" aria-expanded="${isFirst}" aria-controls="${idCollapse}">
                                <div class="accordion-title-wrapper">
                                    <span class="fw-bold">${variedad.variedad}</span>
                                    <span>${precioFormateado} p/unidad</span>
                                </div>
                                <div class="accordion-min-purchase">
                                    <span>Compra mínima:</span><br>
                                    <span>${variedad.minima || 1} un. (${minimoCompraFormateado})</span>
                                </div>
                            </button>
                        </h2>
                        <div id="${idCollapse}" class="accordion-collapse collapse ${showClass}" aria-labelledby="heading-${idCollapse}" data-bs-parent="#accordionVariedades">
                            <div class="accordion-body">
                                <div class="row gx-2 gy-2" style="justify-content: center;">`;

                        detalle_variedad.forEach(subvariedad => {
                            // 👇 CORRECCIÓN: Pasar categoriaCodigo a las funciones auxiliares 👇
                            if (subvariedad.talles && Array.isArray(subvariedad.talles) && subvariedad.talles.length > 0) {
                                if (subvariedad.talles.length === 1) {
                                    detalle += _crearHTMLParaSubvariedadConTalleUnico(subvariedad, variedad, categoriaCodigo, idProducto);
                                } else {
                                    detalle += _crearHTMLParaSubvariedadConMultiplesTalles(subvariedad, variedad, categoriaCodigo, idProducto);
                                }
                            } else {
                                detalle += _crearHTMLParaSubvariedadSinTalles(subvariedad, variedad, categoriaCodigo, idProducto);
                            }
                        }); // <-- Fin forEach subvariedad
                        detalle += `</div></div></div></div>`; // <-- Cierre HTML Acordeón Item
                    } // <-- Fin if detalle_variedad.length > 0
                } // <-- Fin else con sub-variedades
            }); // <-- Fin forEach variedad
            detalle += '</div>'; // <-- Cierre div acordeón principal

            // --- Mostrar Modal o Alerta ---
            if (!opcionesDisponibles) {
                Swal.fire({ icon: 'warning', title: '¡Atención!', text: 'Ya has seleccionado todas las variedades disponibles para este producto.', confirmButtonText: 'Aceptar' });
                return; // Salir si no hay nada que mostrar
            }

            $("#detalle_modal_producto").html(detalle);

            // Asegurar que los botones dentro del acordeón funcionen (esta línea estaba bien)
            $(".modal-body .d-flex").css("justify-content", "center");

            if (mostrarModal) {
                $('#modalProducto').modal('show');
                $('#modalProducto').attr('aria-hidden', 'false');
            }
        }

        /**
         * Crea el HTML para una sub-variedad que no tiene talles (un botón simple).
         */
        function _crearHTMLParaSubvariedadSinTalles(subvariedad, variedad, categoria, idProducto) {
            const idSubvariedad = `${sanitizeForId(categoria)}-${sanitizeForId(idProducto)}-${sanitizeForId(variedad.variedad)}-${sanitizeForId(subvariedad.nombre)}`;

            return `
        <div class="col-12 col-sm-6 col-md-4">
            <a class="dropdown-item text-center" href="#" id="${idSubvariedad}"
                onclick="event.preventDefault(); seleccionar_variedad('${categoria}','${idProducto}','${variedad.variedad} - ${subvariedad.nombre}', '${variedad.precio}','${variedad.moneda}','${variedad.minima}',1); this.style.display = 'none';"
                style="background-color: ${subvariedad.color || '#ccc'}; color: ${getContrastingTextColor(subvariedad.color || '#ccc')}; font-weight: bold; border-radius: 6px; width: 100%;">
                ${subvariedad.nombre}
            </a>
        </div>`;
        }

        /**
         * Crea el HTML para una sub-variedad que tiene un único talle (un botón de talle).
         */
        function _crearHTMLParaSubvariedadConTalleUnico(subvariedad, variedad, categoria, idProducto) {
            const talleUnico = subvariedad.talles[0];
            const estilo = subvariedad.nombre === "Surtido" ?
                'background: linear-gradient(45deg, red, orange, yellow, green, blue, indigo, violet); color: white; font-weight: bold; padding: 5px 10px;' :
                `background-color: ${subvariedad.color || '#ccc'}; color: ${getContrastingTextColor(subvariedad.color || '#ccc')}; font-weight: bold; padding: 5px 10px;`;

            return `
        <div class="col-12 mt-2">
            <div class="d-flex flex-wrap align-items-center gap-2" style="justify-content: center;">
                <button class="btn btn-block" id="btn-${idProducto}-${sanitizeForId(variedad.variedad)}-${sanitizeForId(subvariedad.nombre)}"
                    style="${estilo}"
                    onclick="seleccionarTalle('${categoria}', '${idProducto}', '${variedad.variedad}', '${subvariedad.nombre}', '${variedad.precio}', '${variedad.moneda}', '${variedad.minima}', 1, '${talleUnico.id}', '${talleUnico.stock}'); this.style.display = 'none';">
                    ${talleUnico.etiqueta} (Stock: ${talleUnico.stock})
                </button>
            </div>
        </div>`;
        }

        /**
         * Crea el HTML para una sub-variedad con múltiples talles (un menú <select> interactivo).
         */
        function _crearHTMLParaSubvariedadConMultiplesTalles(subvariedad, variedad, categoria, idProducto) {
            const etiquetasTalles = subvariedad.talles.map(talle => talle.etiqueta).join(", ");
            const estilo = subvariedad.nombre === "Surtido" ?
                'background: linear-gradient(45deg, red, orange, yellow, green, blue, indigo, violet); color: white; font-weight: bold; padding: 5px 10px;' :
                `background-color: ${subvariedad.color || '#ccc'}; color: ${getContrastingTextColor(subvariedad.color || '#ccc')}; font-weight: bold; padding: 5px 10px;`;

            // La lógica del onchange se mantiene idéntica, pero ahora está encapsulada aquí.
            const onchangeLogic = `
        const talle = this.options[this.selectedIndex];
        const valorTalle = talle.value;
        if (!valorTalle) return;
        const stockTalle = parseInt(talle.dataset.stock, 10) || 0;
        const subvariedadNombre = '${subvariedad.nombre}';
        seleccionarTalle('${categoria}', '${idProducto}', '${variedad.variedad}', '${subvariedad.nombre}', '${variedad.precio}', '${variedad.moneda}', '${variedad.minima}', 1, valorTalle, stockTalle, subvariedadNombre);
        talle.style.display = 'none';
        const placeholder = this.options[0];
        const tallesVisibles = Array.from(this.options).slice(1).filter(opt => opt.style.display !== 'none').map(opt => opt.textContent.trim().split(' ')[0]);
        placeholder.textContent = 'Elegir talle (' + tallesVisibles.join(', ') + ') en ' + subvariedadNombre;
        if (tallesVisibles.length === 0) { this.style.display = 'none'; }
        this.selectedIndex = 0;
    `;

            const opcionesTalles = subvariedad.talles.map(talle =>
                `<option value="${talle.id}" data-stock="${talle.stock}" style="background-color: ${subvariedad.color || '#ccc'}; color: ${getContrastingTextColor(subvariedad.color || '#ccc')}">
            ${talle.etiqueta} (Stock: ${talle.stock})
        </option>`
            ).join('');

            return `
        <div class="col-12 mt-2">
            <div class="d-flex flex-wrap align-items-center gap-2" style="justify-content: center;">
                <select class="form-control" id="select-${idProducto}-${sanitizeForId(variedad.variedad)}-${sanitizeForId(subvariedad.nombre)}"
                    style="${estilo}"
                    onchange="${onchangeLogic.replace(/"/g, "&quot;").replace(/\n/g, '')}">
                    <option value="" disabled selected>Elegir el talle (${etiquetasTalles}) en ${subvariedad.nombre}</option>
                    ${opcionesTalles}
                </select>
            </div>
        </div>`;
        }

        // Función para cerrar el modal
        function cerrarModalvariable() {
            // Mover el foco fuera del modal (por ejemplo, a un botón u otro elemento visible)
            document.body.focus(); // Mueve el foco al body o a un elemento seguro fuera del modal

            // Ocultar el modal
            $('#modalProducto').modal('hide');
            $('#modalProducto').attr('aria-hidden', 'true');
        }

        $(document).on('click', '.dropdown-toggle', function () {
            const id = $(this).attr('data-id');
            toggleDropdown(id);
        });


        function hayFiltrosAplicados() {
            return Object.keys(localStorage).some(key => key.startsWith("filtro_"));
        }

        // Función de seleccionar variedad
        function seleccionar_variedad(categoria, id, variedad, precio, moneda, minima, cantidad, talle = null, stock = null) {
            // Verificar si 'categoria' está definido o es 'undefined' (string)
            if (!categoria || categoria === "undefined") {
                const productoItem = document.querySelector(`#producto-${id}`);
                if (productoItem) {
                    categoria = productoItem.dataset.categoria;
                    console.warn("⚠️ 'categoria' no fue pasada correctamente, se recuperó del DOM:", categoria);
                } else {
                    console.error("❌ No se pudo recuperar la categoría del DOM.");
                    categoria = "desconocida"; // Fallback en caso de que no se encuentre
                }
            }

            const subvariedadesSeleccionadas = JSON.parse(localStorage.getItem('subvariedades_seleccionadas')) || {};
            if (!subvariedadesSeleccionadas[id]) {
                subvariedadesSeleccionadas[id] = {};
            }

            const seleccionKey = variedad;
            subvariedadesSeleccionadas[id][seleccionKey] = true;
            localStorage.setItem('subvariedades_seleccionadas', JSON.stringify(subvariedadesSeleccionadas));

            // 🔍 Verificamos la clave generada
            console.log("🔹 Clave de selección:", seleccionKey);
            console.log("Stock recibido en seleccionar_variedad:", stock);

            const partesVariedad = variedad.split(' - ');
            const idUnicoSubvariedad = `${sanitizeForId(categoria)}-${sanitizeForId(id)}-${sanitizeForId(partesVariedad[0])}-${sanitizeForId(partesVariedad[1] || '')}`;

            if (talle) {
                const idUnicoConTalle = `${idUnicoSubvariedad}-${sanitizeForId(talle)}`;
                // 🔍 Verificamos el ID que se oculta
                console.log("🔸 ID que se oculta:", idUnicoConTalle);
                // Aseguramos que solo se oculta el talle seleccionado
                $(`#${idUnicoConTalle}`).css('display', 'none');
            } else {
                console.log("🔸 ID que se oculta (sin talle):", idUnicoSubvariedad);
                $(`#${idUnicoSubvariedad}`).css('display', 'none');
            }

            if (isProductoConUnaSubvariedad(id)) {
                seleccionarSubvariedadAutomaticamente(id);
            }

            // Desactivar temporalmente el resaltado y los eventos de acordeón durante el cambio
            $(".accordion-collapse").off("shown.bs.collapse hidden.bs.collapse");

            mostrar_cantidad_pedido(categoria, id, variedad, precio, moneda, minima, cantidad, stock);



            // Ejecutar toggleDetalle con el id
            toggleDetalle(id, false); // Mantener el `false` si no es eliminación

            // Rehabilitar el resaltado y los eventos después de completar el toggleDetalle
            setTimeout(function () {
                $(".accordion-collapse").on("shown.bs.collapse hidden.bs.collapse", function (e) {
                    // Evitar ejecución si se está procesando toggleDetalle
                    if (toggleInProgress) {
                        return;
                    }

                    if (e.type === "shown") {
                        // Dentro del acordeón expandido, buscá todos los productos visibles
                        const productosCategoria = this.querySelectorAll(".producto-item");

                        // Solo si hay productos visibles, generamos resaltado
                        if (productosCategoria.length > 0) {
                            generarOpcionesDeResaltadoFiltrado(Array.from(productosCategoria), categoria);
                        }
                    }


                    if (e.type === "hidden") {
                        // Si hay algún filtrado aplicado, simula el clic en el botón de "Limpiar Resaltado"
                        if (hayFiltrosAplicados()) {
                            $("#btnLimpiarResaltado").click();  // Simula el clic en el botón para limpiar el resaltado
                        }

                        // Limpiar los filtros visualmente
                        resetearResaltadoFiltradoVisual();

                    }
                });

            }, 500); // Rehabilitar después de medio segundo
        }


        // Función que verifica si el producto tiene solo una subvariedad
        function isProductoConUnaSubvariedad(id) {
            const subvariedadesSeleccionadas = JSON.parse(localStorage.getItem('subvariedades_seleccionadas')) || {};
            const subvariedades = subvariedadesSeleccionadas[id] || {};

            // Si hay solo una subvariedad para este producto
            return Object.keys(subvariedades).length === 1;
        }

        function seleccionarSubvariedadAutomaticamente(id) {
            const subvariedadesSeleccionadas = JSON.parse(localStorage.getItem('subvariedades_seleccionadas')) || {};
            const subvariedades = subvariedadesSeleccionadas[id] || {};

            const subvariedad = Object.keys(subvariedades)[0];
            const variedadId = sanitizeForId(subvariedad.split(' - ')[0]);
            const subvariedadId = sanitizeForId(subvariedad.split(' - ')[1]);

            $(`#subvariedad-${variedadId}-${subvariedadId}`).css('display', 'none');
            subvariedadesSeleccionadas[id][subvariedad] = true;
            localStorage.setItem('subvariedades_seleccionadas', JSON.stringify(subvariedadesSeleccionadas));
        }

        function seleccionarTalle(categoria, id, variedad, nombreVariedad, precio, moneda, minima, cantidad, talleSeleccionado, stock = null) {
            // 🛑 Validar que haya stock disponible antes de continuar
            const stockNumerico = parseInt(stock || "0");
            if (stockNumerico <= 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'Sin stock',
                    text: 'Este talle no tiene stock disponible.',
                    confirmButtonText: 'Aceptar'
                });
                return; // Salir sin seguir con la selección
            }

            const subvariedadesSeleccionadas = JSON.parse(localStorage.getItem('subvariedades_seleccionadas')) || {};

            if (talleSeleccionado) {
                const seleccionKey = `${variedad} - ${nombreVariedad} - ${talleSeleccionado}`;

                if (!subvariedadesSeleccionadas[id]) {
                    subvariedadesSeleccionadas[id] = {};
                }

                subvariedadesSeleccionadas[id][seleccionKey] = true;
                localStorage.setItem('subvariedades_seleccionadas', JSON.stringify(subvariedadesSeleccionadas));

                seleccionar_variedad(categoria, id, seleccionKey, precio, moneda, minima, cantidad, talleSeleccionado, stock);
            } else if (variedad.toLowerCase() === "surtido") {
                console.log("Subvariedad 'Surtido' seleccionada, no hay talles asociados.");
                seleccionar_variedad(categoria, id, variedad, precio, moneda, minima, cantidad, null, null);
            } else {
                console.error("Error: No se seleccionó un talle válido.");
            }
        }

        /**
         * Añade una variedad seleccionada al mini-carrito con un formato enriquecido.
         */
        function mostrar_cantidad_pedido(categoria, id, variedad, precio, moneda, minima, cantidad_producto, stock) {
            stock = parseInt(stock, 10);
            if (isNaN(stock)) {
                stock = Infinity;
            }

            if (!minima) minima = 1;
            if (!cantidad_producto || cantidad_producto < minima) cantidad_producto = minima;

            const key_variedad = (variedad.replace(/\s+/g, '') + precio).replace(/[^\w\-]/g, '');
            const key_completo = id + key_variedad;

            const contenedor_detalle = $('#sidebarCarritoContenido');

            // Obtenemos la info completa del producto para usar el SKU (nombre) y la imagen
            const productoCard = $(`#producto-${categoria}-${id}`);
            let productoData = {};
            let imagenURL = 'https://placehold.co/60x60/0088f2/white?text=Img';

            if (productoCard.length) {
                try {
                    productoData = JSON.parse(productoCard.attr('data-json').replace(/&quot;/g, '"'));
                    if (productoData.imagen && productoData.imagen.length > 0) {
                        const imagenPortada = productoData.imagen.find(img => img.portada);
                        imagenURL = imagenPortada ? imagenPortada.url : productoData.imagen[0].url;
                    }
                } catch (e) {
                    console.error("Error al parsear data-json del producto:", e);
                }
            }

            let contenedor_producto = contenedor_detalle.find(`#contenedor_producto_${id}`);
            if (contenedor_producto.length === 0) {
                const sku = productoData.nombre || ''; // Obtenemos el SKU
                const bloqueProducto = `
        <div class="contenedor-producto-sidebar mb-3" id="contenedor_producto_${id}" data-producto-id="${id}">
            <hr class="my-2">
            <div class="producto-titulo text-center fw-bold text-uppercase">
                <button class="btn btn-link text-dark text-decoration-none w-100" type="button"
                    data-bs-toggle="collapse" data-bs-target="#collapse_variedades_${id}"
                    aria-expanded="true" aria-controls="collapse_variedades_${id}">
                    Código: #${id} (${sku}) <i class="fa fa-chevron-up"></i>
                </button>
            </div>
            <div id="collapse_variedades_${id}" class="collapse show contenedor-variedades mt-2"></div>
        </div>
        `;
                contenedor_detalle.append(bloqueProducto);
                contenedor_producto = contenedor_detalle.find(`#contenedor_producto_${id}`);

                // --- CÓDIGO CORREGIDO (SIN EMOJIS) ---
                // Actualizamos también los eventos para que mantengan el SKU
                $(`#collapse_variedades_${id}`).on('shown.bs.collapse', function () {
                    $(`[data-bs-target="#collapse_variedades_${id}"]`).html(`Código: #${id} (${sku}) <i class="fa fa-chevron-up"></i>`);
                }).on('hidden.bs.collapse', function () {
                    $(`[data-bs-target="#collapse_variedades_${id}"]`).html(`Código: #${id} (${sku}) <i class="fa fa-chevron-down"></i>`);
                });
            }

            const contenedor_variedades = contenedor_producto.find('.contenedor-variedades');

            // ---INICIO DE LA MODIFICACIÓN DEL HTML ---
            // 2. Construir el nuevo HTML enriquecido para el item del carrito.
            const subtotalInicial = parseFloat(precio * cantidad_producto).toFixed(2);
            const lstProductos = `
    <div class="detalle-cantidad-item" id="detalle_cantidad_row_${key_completo}" data-producto-id="${id}">
        
        <img src="${imagenURL}" alt="Imagen de ${productoData.nombre || 'producto'}" class="carrito-item-imagen">
        
        <div class="carrito-item-info">
            <span class="plato-descripcion">${variedad}</span>
            <span class="precio-unitario">${formatMoneda(precio, moneda)} c/u</span>
        </div>
        
        <div class="carrito-item-controles">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-secondary btn-sm"
                    id="restar_${key_completo}"
                    ${cantidad_producto > minima ? '' : 'style="display:none;"'}
                    onclick="mostrar_cantidad('restar', 'id_cantidad_${key_completo}', '${minima}', false);">-</button>
                
                <span id="id_cantidad_${key_completo}" class="btn btn-light btn-sm" style="pointer-events: none;">${cantidad_producto}</span>
                
                <button type="button" id="agregar_${key_completo}" class="btn btn-secondary btn-sm"
                    onclick="mostrar_cantidad('agregar', 'id_cantidad_${key_completo}', '${minima}', false, '${stock}');"
                    ${cantidad_producto >= stock ? 'disabled' : ''}>+</button>

                <button type="button" class="btn btn-danger btn-sm ms-2"
                    onclick="eliminar_detalle('${key_completo}', false, '${categoria}', '${id}')">
                    <i class="fa fa-trash"></i>
                </button>

                <button type="button" id="agregar_carrito${key_completo}" class="d-none"
                    onclick="mostrar_detalle('${categoria}', '${id}', '${variedad}', '${precio}', '${minima}', '${stock}');">
                </button>
            </div>
            <div class="subtotal-item" id="subtotal_${key_completo}">${formatMoneda(subtotalInicial, moneda)}</div>
        </div>
    </div>`;
            // --- FIN DE LA MODIFICACIÓN DEL HTML ---

            contenedor_variedades.append(lstProductos);
            $(`#agregar_carrito${key_completo}`).click();
            mostrarDetalleEnCarrito(id);
        }

        function mostrar_cantidad(tipo, id, minima, cambiarVista = true, stock = Infinity) {
            var valor = 0;
            try {
                valor = parseInt($('#' + id).text());
                minima = parseInt(minima);
            } catch (e) { }

            if (tipo === "agregar") {
                if (valor + minima <= stock) {
                    valor += minima;
                } else {
                    valor = stock;

                    if (typeof Swal !== 'undefined') {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Stock máximo alcanzado',
                            text: `No hay más unidades disponibles. Stock máximo: ${stock}`,
                            timer: 2000,
                            showConfirmButton: false
                        });
                    } else {
                        console.warn("SweetAlert2 no está cargado");
                    }
                }
            } else if (tipo === "restar") {
                valor = Math.max(valor - minima, minima);
            } else {
                valor = 0;
            }

            if (valor < minima) {
                valor = minima;
            }

            $('#' + id).text(valor);

            var key = id.replace("id_cantidad_", "");
            var venta = JSON.parse(localStorage.getItem('venta'));
            var item = venta.detalle.find(det => det.key_completo === key);
            if (item) {
                item.cantidad = valor;
                item.total = parseFloat(item.precio * item.cantidad).toFixed(2);
                localStorage.setItem('venta', JSON.stringify(venta));
                total_pedido();
                $(document).trigger('cantidadActualizada', { key: key, cantidad: valor });

                let botonAgregar = $('#agregar_' + key);
                let botonRestar = $('#restar_' + key);

                if (valor === minima) {
                    botonRestar.hide();
                } else {
                    botonRestar.show();
                }

                botonAgregar.prop('disabled', valor >= stock);
                $('#subtotal_' + key).text(formatMoneda(item.total, item.moneda));

                if (cambiarVista) {
                    mostrar_pedido();
                }
            }
        }

        $(document).on('cantidadActualizada', function (event, data) {

            $('#id_cantidad_' + data.key).text(data.cantidad);
            var venta = JSON.parse(localStorage.getItem('venta'));
            var item = venta.detalle.find(det => det.key_completo === data.key);
            if (item) {
                var subtotalFormateado = formatMoneda(item.total, item.moneda);
                $('#subtotal_' + data.key).text(subtotalFormateado);
            }
        });

        const simboloAMoneda = {
            "$": "ARS",     // Pesos argentinos
            "USD": "USD",   // Dólar estadounidense
            "MX$": "MXN",   // Pesos mexicanos
            "R$": "BRL",    // Reales brasileños
            "₡": "CRC",     // Colones costarricenses
            "L": "HNL",     // Lempiras hondureños
            "C$": "NIO",    // Córdobas nicaragüenses
            "B/.": "PAB",   // Balboas panameños
            "Gs": "PYG",    // Guaraníes paraguayos
            "S/": "PEN",    // Soles peruanos
            "$U": "UYU",    // Pesos uruguayos
            "Bs.": "VES"    // Bolívares venezolanos
        };
        const locales = {
            'ARS': 'es-AR',
            'USD': 'en-US',
            'MXN': 'es-MX',
            'BRL': 'pt-BR',
            'CRC': 'es-CR',
            'HNL': 'es-HN',
            'NIO': 'es-NI',
            'PAB': 'es-PA',
            'PYG': 'es-PY',
            'PEN': 'es-PE',
            'UYU': 'es-UY',
            'VES': 'es-VE'
        };

        function formatMoneda(valor, simbolo) {
            let moneda = simboloAMoneda[simbolo] || 'ARS';
            let locale = locales[moneda] || 'es-AR';
            let valorNumerico = parseFloat(valor);
            if (isNaN(valorNumerico)) {
                console.error("El valor proporcionado no es un número válido:", valor);
                return valor;
            }
            try {
                let formatter = new Intl.NumberFormat(locale, {
                    style: 'currency',
                    currency: moneda,
                    currencyDisplay: 'symbol',
                    minimumFractionDigits: 2
                });
                let valorFormateado = formatter.format(valorNumerico);
                if (!valorFormateado.includes(simbolo)) {
                    valorFormateado = simbolo + " " + valorFormateado.replace(/[^\d,.-]/g, '');
                }
                return valorFormateado;
            } catch (error) {
                console.warn(`Error al formatear con la moneda '${moneda}', usando ARS por defecto.`);
                return simbolo + " " + valorNumerico.toLocaleString('es-AR', { style: 'currency', currency: 'ARS' });
            }
        }

        function mostrar_detalle(categoriaCodigo, id, variante, precio, minima, stock) { // <-- Cambiado nombre parámetro

            // --- 👇 INICIO: LEER Y APLANAR ESTRUCTURA CORRECTAMENTE 👇 ---
            let producto = null;
            let categoriaHija = null;
            try {
                const configCompleta = JSON.parse(localStorage.getItem('configuracion_pagina'));
                if (!configCompleta || !configCompleta.content) {
                    throw new Error("No se encontró 'configuracion_pagina' o '.content' en localStorage.");
                }
                const categoriasPadreOriginal = configCompleta.content || [];
                // Aplanamos para buscar la categoría hija
                const categoriasHijasAplanadas = categoriasPadreOriginal.flatMap(padre => padre.categorias);

                // 1. Encontrar la categoría hija correcta usando el código
                categoriaHija = categoriasHijasAplanadas.find(cat => cat.codigo + "" === categoriaCodigo); // <--- Busca en la lista aplanada

                if (!categoriaHija) {
                    throw new Error(`No se encontró la categoría hija con código: ${categoriaCodigo}`);
                }

                // 2. Encontrar el producto DENTRO de esa categoría hija
                if (!categoriaHija.producto || !Array.isArray(categoriaHija.producto)) {
                    throw new Error(`La categoría hija ${categoriaCodigo} no tiene una lista de productos válida.`);
                }
                producto = categoriaHija.producto.find(prod => prod.codigo + "" === id); // <--- Busca el producto aquí

                if (!producto) {
                    throw new Error(`No se encontró el producto con código ${id} en la categoría ${categoriaCodigo}`);
                }

            } catch (error) {
                console.error("❌ Error grave al buscar producto en mostrar_detalle:", error);
                // Opcional: Mostrar un error al usuario
                Swal.fire('Error', 'No se pudo obtener la información del producto para añadir al carrito.', 'error');
                return; // Salir si no se encuentra
            }
            // --- 👆 FIN: LEER Y APLANAR ESTRUCTURA CORRECTAMENTE 👆 ---


            // --- El resto de tu función continúa desde aquí ---
            var venta = JSON.parse(localStorage.getItem('venta'));
            var key_variante = variante.replaceAll(" ", "") + "" + precio;

            // Usar optional chaining ?. para seguridad
            var simboloMoneda = producto?.variedad?.[0]?.moneda || "$"; // Usamos $ como fallback

            // Verificar que venta exista, si no, inicializarla
            if (!venta) {
                venta = { item: {}, detalle: [] };
                console.warn("Objeto 'venta' no encontrado en localStorage, inicializando uno nuevo.");
            }
            if (!venta.item) venta.item = {}; // Asegurar que venta.item exista

            venta.item = {}; // Limpiar/Resetear venta.item antes de llenarlo
            venta.item.nombre = producto.nombre + " ( " + variante + " ) ";
            venta.item.descripcion = producto.descripcion; // Puede ser undefined si no existe
            venta.item.codigo = producto.codigo;
            venta.item.idcategoria = categoriaCodigo; // <-- Usar el parámetro corregido
            venta.item.categoria = categoriaHija.nombre; // <-- Usar el nombre de la categoría hija encontrada
            venta.item.moneda = simboloMoneda;
            venta.item.imagen = producto.imagen; // Puede ser undefined
            venta.item.cantidad = 0; // Se actualizará después
            venta.item.minima = minima;
            venta.item.key_completo = id + key_variante + "";
            venta.item.stock = stock; // <---- Aquí asignás el stock

            try {
                // Asegurarse que el elemento exista antes de intentar leerlo
                const cantidadElement = $('#id_cantidad_' + id + key_variante);
                if (cantidadElement.length > 0) {
                    venta.item.cantidad = parseInt(cantidadElement.text());
                } else {
                    console.warn(`Elemento #id_cantidad_${id}${key_variante} no encontrado para leer cantidad.`);
                    // Decidir qué hacer: ¿usar 'minima'? ¿dejar 0?
                    venta.item.cantidad = parseInt(minima) || 1; // Usar minima como fallback si no se encuentra
                }

            } catch (e) {
                console.error("Error al leer cantidad:", e);
                venta.item.cantidad = parseInt(minima) || 1; // Usar minima como fallback en caso de error
            }
            // Asegurarse que cantidad no sea NaN
            if (isNaN(venta.item.cantidad)) venta.item.cantidad = parseInt(minima) || 1;


            venta.item.precio = precio;
            venta.item.variante = variante;
            venta.item.total = parseFloat(parseFloat(venta.item.precio) * parseFloat(venta.item.cantidad)).toFixed(2);

            localStorage.setItem('venta', JSON.stringify(venta));
            agregar_pedido(); // Llamar a la siguiente función
        }

        function agregar_pedido() {
            var venta = JSON.parse(localStorage.getItem('venta'));

            if (parseFloat(venta.item.total) == 0) {
                Swal.fire("Warning!", "Agregar cantidad al producto", "warning");
            } else {
                // Aquí verificamos que cada item tenga un valor de moneda válido
                var temporal_venta = venta.detalle.filter(prod => prod.key_completo !== venta.item.key_completo);
                venta.item.moneda = venta.item.moneda || "$";  // Asegura que siempre haya un valor de moneda

                temporal_venta.push(venta.item);
                venta.detalle = temporal_venta;
                localStorage.setItem('venta', JSON.stringify(venta));
                total_pedido();
            }
        }

        /**
         * Calcula todos los totales del pedido y actualiza la interfaz completa del carrito.
         * (Título, pie de carrito, modal de pago y footer principal)
         * INCLUYE FIX para 'undefined' de moneda.
         */
        function total_pedido() {
            var venta = JSON.parse(localStorage.getItem('venta'));
            if (!venta || !venta.detalle) {
                // Si no hay venta o detalle, asegurémonos de limpiar todo
                $('#carrito-item-contador').text('0');
                $('#sidebarCarritoFooter').hide();
                $(".venta_detalle_total").html(formatMoneda(0, "$")); // Usa '$' por defecto
                const recargoInfo = document.getElementById('recargo_info');
                if (recargoInfo) recargoInfo.style.display = 'none';
                return;
            }

            // --- ⭐ FIX: OBTENER EL SÍMBOLO CORRECTO ---
            // Obtenemos el símbolo del primer item del carrito, con un fallback seguro a "$"
            var simbolo = (venta.detalle.length > 0 && venta.detalle[0].moneda) ? venta.detalle[0].moneda : "$";

            // --- 1. CÁLCULOS ---
            const itemCount = venta.detalle.length; // N° de Items (variedades) para el TÍTULO
            var subtotal = 0.0;
            var cantidadTotalProductos = 0; // N° de Cantidades totales para el FOOTER

            for (var i = 0; i < venta.detalle.length; i++) {
                subtotal += parseFloat(venta.detalle[i].total);
                cantidadTotalProductos += parseInt(venta.detalle[i].cantidad, 10);
            }

            var costoEnvio = parseFloat(venta.costo_agencia) || 0;
            var baseConEnvio = subtotal + costoEnvio;
            var recargoPorcentaje = parseFloat(venta.recargo_pago) || 0;
            var montoRecargo = (baseConEnvio * recargoPorcentaje) / 100;
            var totalFinal = baseConEnvio + montoRecargo;

            // --- 2. GUARDAR EN LOCALSTORAGE ---
            venta.subtotal = subtotal.toFixed(2);
            venta.costo_envio = costoEnvio;
            venta.recargo_valor = montoRecargo;
            venta.total = totalFinal.toFixed(2);
            venta.total_venta = totalFinal; // Aseguramos que este también se guarde si lo usas
            venta.moneda = simbolo; // ¡Ahora guardamos el símbolo correcto!
            localStorage.setItem('venta', JSON.stringify(venta));

            // --- 3. ACTUALIZAR TODA LA UI ---

            // A. Título del mini-carrito
            $('#carrito-item-contador').text(itemCount);

            const carritoFooter = $('#sidebarCarritoFooter');
            const resumenTotalDiv = $('#carrito_resumen_total');

            if (itemCount > 0) {
                // B. Pie del MINI-CARRITO
                let resumenHTML = '';
                resumenHTML += `<div><strong>Productos:</strong> <span>${cantidadTotalProductos}</span></div>`;
                resumenHTML += `<div><strong>Subtotal:</strong> ${formatMoneda(subtotal, simbolo)}</div>`;
                if (costoEnvio > 0) {
                    resumenHTML += `<div><strong>Envío:</strong> ${formatMoneda(costoEnvio, simbolo)}</div>`;
                }
                if (recargoPorcentaje > 0) {
                    resumenHTML += `<div><strong>Recargo (${recargoPorcentaje}%):</strong> ${formatMoneda(montoRecargo, simbolo)}</div>`;
                }
                resumenHTML += `<div class="mt-2 fs-5 text-primary"><strong>Total: ${formatMoneda(totalFinal, simbolo)}</strong></div>`;

                resumenTotalDiv.html(resumenHTML);
                carritoFooter.show();

                // C. MODAL DE CONFIRMACIÓN
                const recargoInfo = document.getElementById('recargo_info');
                const recargoValor = document.getElementById('recargo_valor');
                if (recargoInfo && recargoValor) {
                    let modalResumenHTML = '';
                    if (recargoPorcentaje > 0) {
                        modalResumenHTML = `
                    <div><strong>Subtotal:</strong> ${formatMoneda(subtotal, simbolo)}</div>
                    <div><strong>Envío:</strong> ${formatMoneda(costoEnvio, simbolo)}</div>
                    <div><strong>Recargo (${recargoPorcentaje}%):</strong> ${formatMoneda(montoRecargo, simbolo)}</div>
                    <div class="mt-2 fs-5 text-primary"><strong>Total: ${formatMoneda(totalFinal, simbolo)}</strong></div>
                `;
                    } else {
                        modalResumenHTML = `
                    <div><strong>Subtotal:</strong> ${formatMoneda(subtotal, simbolo)}</div>
                    <div><strong>Envío:</strong> ${formatMoneda(costoEnvio, simbolo)}</div>
                    <div class="mt-2 fs-5 text-primary"><strong>Total: ${formatMoneda(totalFinal, simbolo)}</strong></div>
                `;
                    }
                    recargoInfo.style.display = 'block';
                    recargoValor.innerHTML = modalResumenHTML;
                }

                // D. FOOTER PRINCIPAL
                $(".venta_detalle_total").html(formatMoneda(totalFinal, simbolo));

            } else {
                // Ocultar si el carrito está vacío
                carritoFooter.hide();
                $(".venta_detalle_total").html(formatMoneda(0, simbolo));
                const recargoInfo = document.getElementById('recargo_info');
                if (recargoInfo) recargoInfo.style.display = 'none';
            }

            // Actualizar botones de pie de página
            if (typeof actualizarEstadoBotones === 'function') {
                actualizarEstadoBotones();
            }
        }

        function actualizarEstadoBotones() {
            var venta = JSON.parse(localStorage.getItem('venta'));
            var tieneProductos = venta && venta.detalle && venta.detalle.length > 0;

            // Cambiar clases de los botones dependiendo de si hay productos en el carrito
            if (tieneProductos) {
                $("#btn_nuevo").removeClass('button-disabled').addClass('button-active');
                $("#btn_edicion").removeClass('button-disabled').addClass('button-active');
                $("#btn_cars 2").removeClass('button-disabled').addClass('button-active');
            } else {
                $("#btn_nuevo").removeClass('button-active').addClass('button-disabled');
                $("#btn_edicion").removeClass('button-active').addClass('button-disabled');
                $("#btn_cars 2").removeClass('button-active').addClass('button-disabled');
            }
        }

        // Llamar a la función al cargar el documento
        $(document).ready(function () {
            actualizarEstadoBotones();
        });

        // Función para mostrar el pedido en Otra vista de Datatables
        function mostrar_pedido() {
            $("#btn_nuevo").hide();
            $("#btn_edicion").show();
            $(".principal").hide();
            $(".pedido_producto").show();
            $("#btn_cars").hide();
            $("#closeAllAccordions").fadeOut();
            $("#btn_regresar").show();
            $("#btn_cars").removeClass("button-active").addClass("button-inactive");
            $("#btn_regresar").removeClass("button-inactive").addClass("button-active");
            actualizarBotonProductos();
            var venta = JSON.parse(localStorage.getItem('venta'));
            let detalle_pedido = `
            <div style="text-align:center; font-size:1.3rem; font-weight:bold; margin-bottom:10px;">🛒 DATATABLE DEL PEDIDO</div>`;
            detalle_pedido += '<table id="tabla_pedido" class="display compact" style="width:100%">';
            detalle_pedido += ' <thead>';
            detalle_pedido += ' <tr>';
            detalle_pedido += ' <th>ID</th>';
            detalle_pedido += ' <th>SKU</th>';
            detalle_pedido += ' <th>Variable</th>';
            detalle_pedido += ' <th>Variacion (Color - Talle)</th>';
            detalle_pedido += ' <th>Cantidad</th>';
            detalle_pedido += ' <th>Precio</th>';
            detalle_pedido += ' <th>Sub-Total</th>';
            detalle_pedido += ' <th>Imagen</th>';
            detalle_pedido += ' <th>Accion</th>';
            detalle_pedido += ' </tr>';
            detalle_pedido += ' </thead>';
            detalle_pedido += ' <tbody>';
            for (let i = 0; i < venta.detalle.length; i++) {
                const item = venta.detalle[i];

                const cantidad = parseInt(item.cantidad);
                const minima = parseInt(item.minima || 1);

                let variable = item.variante.split(' - ')[0] || 'N/A';

                if (variable === "Corte") {
                    variable = cantidad + " Unidad" + (cantidad > 1 ? "es(Corte)" : " Corte");
                } else if (variable === "Fardo") {
                    variable = cantidad + " Unidad" + (cantidad > 1 ? "es(Fardo)" : " Fardo");
                } else if (variable === "Caja") {
                    variable = cantidad + " Unidad" + (cantidad > 1 ? "es(Caja)" : " Caja");
                } else if (variable === "Docena" && minima === 12 && cantidad % 12 === 0) {
                    variable = (cantidad / 12) + " Docena" + ((cantidad / 12) > 1 ? "s" : "");
                } else if (variable === "Curva" && cantidad % minima === 0) {
                    variable = (cantidad / minima) + " Curva" + ((cantidad / minima) > 1 ? "s" : "");
                } else if (variable === "Mayor" && minima === 1) {
                    variable = cantidad + " Unidad" + (cantidad > 1 ? "es(Mayor)" : "(Mayor)");
                } else if (variable === "Combo") {
                    variable = "Combo especial de " + cantidad + " producto" + (cantidad > 1 ? "s" : "");
                } else if (minima === 3) {
                    variable = (cantidad / 3) + " Pack x3";
                } else if (variable === "Menor" && minima === 1) {
                    variable = cantidad + " Unidad" + (cantidad > 1 ? "es(Menor)" : "(Menor)");
                } else {
                    variable = "N/A";
                }

                // Imágenes en formato JSON
                let primeraImagen = '';
                if (Array.isArray(item.imagen) && item.imagen.length > 0) {
                    const portada = item.imagen.find(img => img.portada);
                    primeraImagen = (portada || item.imagen[0]).url;
                } else {
                    primeraImagen = 'https://placehold.co/100x120?text=Sin+Imagen';
                }

                // ... y luego reemplazás `venta.detalle[i]` por `item` en el resto del código
                detalle_pedido += `<tr>
        <td>${item.codigo || ''}</td>
        <td>${item.nombre.split(' (')[0]}</td>
        <td>${variable}</td>`;

                // Variación (talle - color)
                const partes = item.variante.split(" - ");
                let resultado = "N/A";
                if (partes.length === 2) {
                    resultado = partes[1];
                } else if (partes.length === 3) {
                    resultado = partes.slice(1).join(" - ");
                } else if (partes.length > 3) {
                    resultado = partes[1] + " - " + partes[partes.length - 1];
                }

                detalle_pedido += `<td>${resultado}</td>`;

                detalle_pedido += `<td>
        <button onclick="mostrar_cantidad('restar', 'id_cantidad_${item.key_completo}', ${minima})">-</button>
        <span id="id_cantidad_${item.key_completo}">${cantidad}</span>
        <button onclick="mostrar_cantidad('agregar', 'id_cantidad_${item.key_completo}', ${minima}, true, ${item.stock || 0})">+</button>
    </td>`;

                detalle_pedido += `<td>${formatMoneda(item.precio, venta.moneda)}</td>
        <td>${formatMoneda((parseFloat(item.precio) * cantidad).toFixed(2), venta.moneda)}</td>
        <td>
            <a href="${primeraImagen}" data-fancybox="gallery-${i}" data-caption="${item.nombre}">
                <div style="width: 24px; height: 24px; text-align: center;">
                    <i class="fa fa-image" aria-label="Ver imagen del producto"></i>
                </div>
            </a>
        </td>
        <td>
            <button onclick="eliminar_detalle('${item.key_completo}');" class="btn btn-danger">
                <i class="fa fa-trash"></i>
            </button>
        </td>
    </tr>`;
            }

            detalle_pedido += ' </tbody>';
            detalle_pedido += ' </table>';

            $("#detalle_pedido").html(detalle_pedido);
            var table = $('#tabla_pedido').DataTable({
                responsive: true,
                dom: 'Bfrtip',
                language: {
                    "lengthMenu": "Mostrar _MENU_ registros por página",
                    "zeroRecords": "No se encontraron resultados",
                    "info": "Mostrando página _PAGE_ de _PAGES_",
                    "infoEmpty": "No hay registros disponibles",
                    "infoFiltered": "(filtrado de _MAX_ registros en total)",
                    "search": "Buscar:",
                    "paginate": {
                        "first": "Primero",
                        "last": "Último",
                        "next": "Siguiente",
                        "previous": "Anterior"
                    }
                },
                buttons: [
                    {
                        extend: 'print',
                        text: 'Imprimir🖨',
                        title: 'Detalle del Pedido',
                        action: function (e, dt, button, config) {
                            var venta = JSON.parse(localStorage.getItem('venta'));
                            if (!venta || venta.detalle.length === 0) {
                                Swal.fire("Warning!", "Debe agregar productos al pedido!", "warning");
                                return;
                            }
                            // Llamamos la acción por defecto si pasa la validación
                            $.fn.dataTable.ext.buttons.print.action.call(this, e, dt, button, config);
                        },
                        exportOptions: {
                            columns: ':not(:nth-last-child(-n+2))',
                            format: {
                                body: function (data, row, column) {
                                    if (column === 4) {
                                        var cantidadMatch = data.match(/<span[^>]*>(\d+)<\/span>/);
                                        return cantidadMatch ? cantidadMatch[1] : '';
                                    }
                                    if (column === 5 || column === 6) {
                                        return data.replace(/&nbsp;/g, '').replace(/<[^>]+>/g, '');
                                    }
                                    return data;
                                }
                            }
                        },
                        customize: function (win) {
                            var venta = JSON.parse(localStorage.getItem('venta'));
                            var moneda = simboloAMoneda[venta.moneda] || 'ARS';
                            var totalFormateado = new Intl.NumberFormat('es-AR', {
                                style: 'currency',
                                currency: moneda,
                                minimumFractionDigits: 2
                            }).format(venta.total_venta);
                            $(win.document.body).find('table').append(
                                `<tr><td colspan="6" style="text-align:left; font-weight:bold;">Total del Pedido:</td><td style="text-align:left; font-weight:bold;">${totalFormateado}</td></tr>`
                            );
                        }
                    },
                    {
                        extend: 'excelHtml5',
                        text: 'Exportar a Excel💹',
                        action: function (e, dt, button, config) {
                            var venta = JSON.parse(localStorage.getItem('venta'));
                            if (!venta || venta.detalle.length === 0) {
                                Swal.fire("Warning!", "Debe agregar productos al pedido!", "warning");
                                return;
                            }
                            // Llamamos la acción por defecto si pasa la validación
                            $.fn.dataTable.ext.buttons.excelHtml5.action.call(this, e, dt, button, config);
                        },
                        exportOptions: {
                            columns: ':not(:nth-last-child(-n+2))',
                            format: {
                                body: function (data, row, column) {
                                    if (column === 4) {
                                        var cantidadMatch = data.match(/<span[^>]*>(\d+)<\/span>/);
                                        return cantidadMatch ? cantidadMatch[1] : '';
                                    }
                                    if (column === 5 || column === 6) {
                                        return data.replace(/&nbsp;/g, '').replace(/<[^>]+>/g, '');
                                    }
                                    return data;
                                }
                            }
                        },
                        customize: function (xlsx) {
                            var sheet = xlsx.xl.worksheets['sheet1.xml'];
                            var venta = JSON.parse(localStorage.getItem('venta'));
                            var moneda = simboloAMoneda[venta.moneda] || 'ARS';
                            var totalFormateado = new Intl.NumberFormat('es-AR', {
                                style: 'currency',
                                currency: moneda,
                                minimumFractionDigits: 2
                            }).format(venta.total_venta);
                            $('row', sheet).last().after(`
                <row>
                    <c t="inlineStr" s="2"><is><t></t></is></c>
                    <c t="inlineStr" s="2"><is><t></t></is></c>
                    <c t="inlineStr" s="2"><is><t></t></is></c>
                    <c t="inlineStr" s="2"><is><t></t></is></c>
                    <c t="inlineStr" s="2"><is><t>Total del Pedido:</t></is></c>
                    <c t="inlineStr" s="2"><is><t>${totalFormateado}</t></is></c>
                </row>
            `);
                        }
                    },
                    {
                        extend: 'pdfHtml5',
                        text: 'Exportar a PDF📄',
                        action: function (e, dt, button, config) {
                            var venta = JSON.parse(localStorage.getItem('venta'));
                            if (!venta || venta.detalle.length === 0) {
                                Swal.fire("Warning!", "Debe agregar productos al pedido!", "warning");
                                return;
                            }
                            // Llamamos la acción por defecto si pasa la validación
                            $.fn.dataTable.ext.buttons.pdfHtml5.action.call(this, e, dt, button, config);
                        },
                        exportOptions: {
                            columns: ':not(:nth-last-child(-n+2))',
                            format: {
                                body: function (data, row, column) {
                                    if (column === 4) {
                                        var cantidadMatch = data.match(/<span[^>]*>(\d+)<\/span>/);
                                        return cantidadMatch ? cantidadMatch[1] : '';
                                    }
                                    if (column === 5 || column === 6) {
                                        return data.replace(/&nbsp;/g, '').replace(/<[^>]+>/g, '');
                                    }
                                    return data;
                                }
                            }
                        },
                        customize: function (doc) {
                            var venta = JSON.parse(localStorage.getItem('venta'));
                            var moneda = simboloAMoneda[venta.moneda] || 'ARS';
                            var totalFormateado = new Intl.NumberFormat('es-AR', {
                                style: 'currency',
                                currency: moneda,
                                minimumFractionDigits: 2
                            }).format(venta.total_venta);
                            doc.content[1].table.body.push([
                                { text: 'Total del Pedido:', colSpan: 6, alignment: 'left', bold: true },
                                {}, {}, {}, {}, {},
                                { text: totalFormateado, alignment: 'right', bold: true }
                            ]);
                        }
                    }
                ]

            });
            adjustTableVisibility(table);
            actualizarEncabezadosSegunDispositivoMovil();
            $(window).on('resize', function () {
                adjustTableVisibility(table);
            });
        }
        function adjustTableVisibility(table) {
            if ($(window).width() < 768) {
                table.column(1).visible(false); // Ocultar SKU
                table.column(2).visible(false); // Ocultar Variable
                table.column(3).visible(false); // Ocultar Variación
            } else {
                table.column(1).visible(true);
                table.column(2).visible(true);
                table.column(3).visible(true);
            }
        }

        function actualizarEncabezadosSegunDispositivoMovil() {
            var isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
            if (isMobile) {
                var table = $('#tabla_pedido').DataTable();
                table.columns(0).header().to$().text('ID');
                table.columns(4).header().to$().text('Cantidad');
                table.columns(5).header().to$().text('Precio');
                table.columns(6).header().to$().text('Subtotal');
                table.columns(7).header().to$().text('📷');
                table.columns(8).header().to$().text('🆑');
            }
        }

        // Función para regresar a la vista principal
        function regresar_principal() {
            AppState.estaEnVistaDetalle = false; // 👈 UPDATE STATE
            $(".principal").show();
            $(".pedido_producto").hide();
            $("#btn_cars").show();
            $("#btn_regresar").hide();
            $("#btn_cars2").removeClass("button-inactive").addClass("button-active");
            $("#btn_regresar").removeClass("button-active").addClass("button-inactive");
            $("#btn_edicion").hide();
            $("#btn_nuevo").show();
            $("#closeAllAccordions").fadeIn();
            actualizarBotonProductos(); // Asegurarse de actualizar el botón al regresar a la vista principal
        }

        // Verifica la vista actual y actualiza el botón "Productos"
        function actualizarBotonProductos() {
            const linkElement = document.getElementById("productos-link");

            if ($(".pedido_producto").is(":visible")) {
                // Estamos en la vista de detalle de pedido
                linkElement.setAttribute("href", "javascript:void(0);");
                linkElement.setAttribute("onclick", "regresar_principal();");
            } else {
                // Estamos en la vista principal
                linkElement.setAttribute("href", "#productos-container");
                linkElement.removeAttribute("onclick");
            }
        }

        // Configuración inicial y eventos para actualizar el botón según la vista
        $(document).ready(function () {
            // Al cargar la página, verifica la vista actual
            actualizarBotonProductos();

            // Escucha los eventos para cambiar de vista
            $("#btn_edicion").on("click", function () {
                AppState.estaEnVistaDetalle = true; // 👈 UPDATE STATE
                $(".principal").hide();
                $(".pedido_producto").show();
                actualizarBotonProductos();
            });

            $("#btn_regresar").on("click", function () {
                regresar_principal();
            });
        });

        function eliminar_detalle(key_completo, cambiarVista = true, categoria = null, idProducto = null) {
            var venta = JSON.parse(localStorage.getItem('venta'));

            if (!venta || !venta.detalle) {
                return;
            }

            // Si no se proporciona idProducto, intentar deducirlo de key_completo
            if (!idProducto) {
                const match = key_completo.match(/^(\d+)[A-Za-z]+/);
                idProducto = match ? match[1] : null;
            }

            if (!idProducto) {
                return;
            }

            for (var i = 0; i < venta.detalle.length; i++) {
                if (venta.detalle[i].key_completo === key_completo) {
                    venta.detalle.splice(i, 1);
                    localStorage.setItem('venta', JSON.stringify(venta));

                    console.log(`Eliminando y restableciendo key-variedad: ${key_completo}`);

                    // Eliminar visualmente
                    $(`#detalle_cantidad_row_${key_completo}`).remove();
                    $(`#detalle_item_${key_completo}`).css({ 'background-color': '#F6F8FC' });

                    // 🔍 Verificar si quedan variedades del producto
                    const variedadesRestantes = $(`#contenedor_producto_${idProducto} .detalle-cantidad-item`);
                    if (variedadesRestantes.length === 0) {
                        // Eliminar completamente el contenedor del producto si ya no hay detalles
                        $(`#contenedor_producto_${idProducto}`).remove();
                    }

                    Swal.fire({
                        icon: 'success',
                        title: 'Eliminado',
                        text: 'El detalle Variedad del producto ha sido eliminado.',
                        confirmButtonText: 'Aceptar'
                    });

                    total_pedido(); // Actualizar totales

                    // ✅ Asegurar actualización de estado del botón
                    if (idProducto) {
                        toggleDetalle(idProducto, true);
                        resetearSubvariedadesSeleccionadas(idProducto, key_completo);
                    }

                    if (categoria && idProducto) {
                        evitarAutoSeleccion = true;
                        mostrar_popuppedido(categoria, idProducto, false);
                    }

                    if (cambiarVista) {
                        mostrar_pedido();
                    }

                    return;
                }
            }
        }

        function resetearSubvariedadesSeleccionadas(idProducto, key_completo) {
            // Recuperamos las subvariedades seleccionadas desde el localStorage
            let subvariedadesSeleccionadas = JSON.parse(localStorage.getItem('subvariedades_seleccionadas')) || {};

            // Verificamos si hay subvariedades asociadas al producto
            if (subvariedadesSeleccionadas[idProducto]) {
                // Extraemos la subvariedad específica a partir de la key_completo
                const subvariedadKey = Object.keys(subvariedadesSeleccionadas[idProducto]).find(subvariedad => {
                    return key_completo.includes(subvariedad.replace(/\s+/g, '').replace(/[^\w\-]/g, ''));
                });

                // Si encontramos la subvariedad específica, la eliminamos
                if (subvariedadKey) {
                    delete subvariedadesSeleccionadas[idProducto][subvariedadKey];
                }

                // Si no quedan más subvariedades para este producto, eliminamos el producto del objeto
                if (Object.keys(subvariedadesSeleccionadas[idProducto]).length === 0) {
                    delete subvariedadesSeleccionadas[idProducto];
                }
            }

            // Actualizamos el localStorage con el nuevo estado de las subvariedades
            localStorage.setItem('subvariedades_seleccionadas', JSON.stringify(subvariedadesSeleccionadas));
        }

        //]]>
    </script>
</body>

</html>