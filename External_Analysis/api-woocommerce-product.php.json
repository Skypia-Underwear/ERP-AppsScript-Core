{
    "content": "<?php\n/**\n * API Proxy WooCommerce: Crear/Actualizar Producto va REST API\n * Recibe JSON desde Apps Script y devuelve siempre JSON limpio\n *\n * Versin 7.6 (FIX DEFINITIVO ERROR 401 - AUTH POR URL)\n *\n * FUNCIONALIDAD:\n * - MANTIENE TODA TU LGICA DE NEGOCIO ORIGINAL.\n * - CAMBIO TCNICO: Enva las claves (ck_ y cs_) en la URL (?consumer_key=...)\n * en lugar de usar cabeceras HTTP. Esto soluciona el bloqueo de DonWeb/Hostings.\n */\n\nheader(\"Content-Type: application/json; charset=utf-8\");\nset_time_limit(300);\n\n// --- 1. SEGURIDAD (AGREGADO) ---\n$CLAVE_SECRETA = 'CASTFER2025';\n$api_key_recibida = isset($_POST['apiKey']) ? $_POST['apiKey'] : '';\n\nif ($api_key_recibida !== $CLAVE_SECRETA) {\n    http_response_code(403);\n    echo json_encode([\"status\" => \"error\", \"message\" => \"Acceso denegado: Clave API invalida.\"]);\n    exit();\n}\n\n// --- Configuracin REST API WooCommerce ---\n$WC_SITE_URL = \"https://castfer.com.ar\";\n\n// ASEGRATE DE QUE ESTAS CLAVES TENGAN PERMISOS \"LEER/ESCRIBIR\" EN WOOCOMMERCE\n$WC_CONSUMER_KEY = \"ck_2f32b23fa4afd30a37556c8dfca74e8823b3a6f6\";\n$WC_CONSUMER_SECRET = \"cs_e20d5a3016f2ab43aba73fb50069858443fcdac2\";\n\n$LOG_FILE = __DIR__ . \"/woocommerce_sync_error.log\";\n\n// --- INICIO V5.8: Mapa de Traduccin de Atributos ---\n$ATTRIBUTE_SLUG_MAP = [\n    \"Color\" => \"pa_color\",\n    \"Talle\" => \"pa_talle\",\n    \"Precio\" => \"pa_precio\",\n];\n\n// --- Buffer de logs ---\n$LOG_BUFFER = [];\n$ATTRIBUTE_ID_CACHE = []; \n\n// --- Funcin helper para loguear ---\nfunction log_error($mensaje) {\n    global $LOG_FILE, $LOG_BUFFER;\n    $logEntryFile = date(\"[Y-m-d H:i:s] \") . $mensaje . PHP_EOL;\n    file_put_contents($LOG_FILE, $logEntryFile, FILE_APPEND);\n    if (strpos($mensaje, \"Array\") === 0) {\n        $logMessageBuffer = \"POST recibido (ver log detallado)\";\n    } else {\n        $logMessageBuffer = preg_replace(\"/\\s+/\", \" \", $mensaje);\n    }\n    $LOG_BUFFER[] = date(\"[H:i:s] \") . $logMessageBuffer;\n}\n\n// --- Loguear inicio ---\nlog_error(\"POST recibido: \" . print_r($_POST, true));\n\n// --- Validacin POST ---\nif ($_SERVER[\"REQUEST_METHOD\"] !== \"POST\") {\n    http_response_code(405);\n    echo json_encode([\"status\" => \"error\", \"message\" => \"Solo se aceptan POST\", \"server_logs\" => $LOG_BUFFER], JSON_INVALID_UTF8_IGNORE);\n    exit();\n}\n\n// --- Validacin de datos ---\n$producto_json = $_POST[\"producto\"] ?? \"\";\nif (!$producto_json) {\n    log_error(\"No se recibi JSON del producto.\");\n    http_response_code(400);\n    echo json_encode([\"status\" => \"error\", \"message\" => \"No se recibi el JSON del producto\", \"server_logs\" => $LOG_BUFFER], JSON_INVALID_UTF8_IGNORE);\n    exit();\n}\n\n$data = json_decode($producto_json, true);\nif (!$data) {\n    log_error(\"JSON invlido recibido.\");\n    http_response_code(400);\n    echo json_encode([\"status\" => \"error\", \"message\" => \"JSON invlido\", \"server_logs\" => $LOG_BUFFER], JSON_INVALID_UTF8_IGNORE);\n    exit();\n}\n\n$sku = $data[\"SKU\"] ?? \"\";\nif (!$sku) {\n    log_error(\"Falta SKU.\");\n    http_response_code(400);\n    echo json_encode([\"status\" => \"error\", \"message\" => \"Falta SKU\", \"server_logs\" => $LOG_BUFFER], JSON_INVALID_UTF8_IGNORE);\n    exit();\n}\n\n// --- Helper REST API (MODIFICADO PARA FIX 401) ---\nfunction wc_request($method, $endpoint, $data = null)\n{\n    global $WC_SITE_URL, $WC_CONSUMER_KEY, $WC_CONSUMER_SECRET;\n    \n    // 1. Construir URL base\n    $url = rtrim($WC_SITE_URL, \"/\") . \"/wp-json/wc/v3/\" . ltrim($endpoint, \"/\");\n    \n    // 2. TRUCO ANTI-BLOQUEO: Pegar credenciales en la URL en vez de Header\n    $separator = (strpos($url, '?') === false) ? '?' : '&';\n    $url .= $separator . 'consumer_key=' . $WC_CONSUMER_KEY . '&consumer_secret=' . $WC_CONSUMER_SECRET;\n\n    $ch = curl_init($url);\n    \n    // NOTA: Ya no usamos CURLOPT_USERPWD porque lo pasamos por URL\n    // curl_setopt($ch, CURLOPT_USERPWD, $WC_CONSUMER_KEY . \":\" . $WC_CONSUMER_SECRET);\n    \n    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);\n    curl_setopt($ch, CURLOPT_HTTPHEADER, [\"Content-Type: application/json\"]);\n    curl_setopt($ch, CURLOPT_CUSTOMREQUEST, strtoupper($method));\n    curl_setopt($ch, CURLOPT_TIMEOUT, 120);\n    // Ignorar verificacin SSL si da problemas en servidor local/dev (Opcional)\n    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false); \n\n    if ($data) {\n        curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data, JSON_INVALID_UTF8_IGNORE));\n    }\n    \n    $response = curl_exec($ch);\n    $httpcode = curl_getinfo($ch, CURLINFO_HTTP_CODE);\n    $error = curl_error($ch);\n    curl_close($ch);\n    \n    if ($error) {\n        log_error(\"cURL Error: $error | URL: $url\"); // La URL tendr las claves, cuidado al compartir logs\n    }\n    return [\"httpcode\" => $httpcode, \"response\" => $response, \"error\" => $error];\n}\n\n// --- Helpers de Categoras y Atributos ---\nfunction _get_category_id($name, $parent_id = 0)\n{\n    global $LOG_BUFFER;\n    $name = trim($name);\n    $slug = str_replace(\" \", \"-\", strtolower($name));\n    \n    $search = wc_request(\"GET\", \"products/categories?slug=\" . urlencode($slug) . \"&parent=$parent_id\");\n    if (!empty($search[\"response\"])) {\n        $cats = json_decode($search[\"response\"], true);\n        if (!empty($cats)) return $cats[0][\"id\"];\n    }\n\n    $create = wc_request(\"POST\", \"products/categories\", [\"name\" => $name, \"parent\" => $parent_id, \"slug\" => $slug]);\n    if (!empty($create[\"response\"])) {\n        $new_cat = json_decode($create[\"response\"], true);\n        if (isset($new_cat[\"id\"])) return $new_cat[\"id\"];\n        if (isset($new_cat[\"code\"]) && $new_cat[\"code\"] === \"term_exists\") {\n            return $new_cat[\"data\"][\"resource_id\"] ?? null;\n        }\n    }\n    return null;\n}\n\nfunction _get_attribute_id($slug_con_prefijo)\n{\n    global $ATTRIBUTE_ID_CACHE;\n    if (empty($ATTRIBUTE_ID_CACHE)) {\n        $result = wc_request(\"GET\", \"products/attributes?per_page=100\");\n        if (!empty($result[\"response\"])) {\n            $attrs = json_decode($result[\"response\"], true);\n            if (is_array($attrs)) {\n                foreach ($attrs as $attr) {\n                    if (isset($attr['slug']) && isset($attr['id'])) {\n                        $slug_limpio = str_replace('pa_', '', $attr['slug']);\n                        $slug_full = 'pa_' . $slug_limpio;\n                        $ATTRIBUTE_ID_CACHE[$slug_limpio] = $attr['id'];\n                        $ATTRIBUTE_ID_CACHE[$slug_full] = $attr['id'];\n                    }\n                }\n            }\n        }\n    }\n    return $ATTRIBUTE_ID_CACHE[$slug_con_prefijo] ?? null;\n}\n\nfunction getStockData($data)\n{\n    $stockData = [];\n    $qty = $data[\"Stock\"] ?? \"\";\n    if ($qty !== \"\" && is_numeric($qty)) {\n        $stockData[\"manage_stock\"] = true;\n        $stockData[\"stock_quantity\"] = (int) $qty;\n        $stockData[\"stock_status\"] = (int) $qty > 0 ? \"instock\" : \"outofstock\";\n    } else {\n        $stockData[\"manage_stock\"] = false;\n        $stockData[\"stock_quantity\"] = null;\n        $stockData[\"stock_status\"] = ($data[\"In stock?\"] ?? \"0\") === \"1\" ? \"instock\" : \"outofstock\";\n    }\n    return $stockData;\n}\n\n// --- Mapeo JSON a Woo ---\nfunction mapWooJSON($data)\n{\n    global $ATTRIBUTE_SLUG_MAP;\n    $stock = getStockData($data);\n    $wcData = [\n        \"name\" => $data[\"Name\"] ?? \"\",\n        \"type\" => $data[\"Type\"] ?? \"simple\",\n        \"sku\" => $data[\"SKU\"] ?? \"\",\n        \"status\" => ($data[\"Published\"] ?? \"0\") === \"1\" ? \"publish\" : \"draft\",\n        \"description\" => $data[\"Description\"] ?? \"\",\n        \"short_description\" => $data[\"Short description\"] ?? \"\",\n        \"regular_price\" => $data[\"Regular price\"] ?? \"\",\n        \"sale_price\" => $data[\"Sale price\"] ?? \"\",\n        \"manage_stock\" => $stock[\"manage_stock\"],\n        \"stock_quantity\" => $stock[\"stock_quantity\"],\n        \"stock_status\" => $stock[\"stock_status\"],\n        \"tags\" => [],\n        \"categories\" => [],\n        \"attributes\" => [],\n        \"default_attributes\" => []\n    ];\n\n    if (!empty($data[\"Categories\"])) {\n        $cats = explode(\">\", $data[\"Categories\"]);\n        $parent = 0;\n        foreach ($cats as $catName) {\n            $catName = trim($catName);\n            if ($catName) {\n                $id = _get_category_id($catName, $parent);\n                if ($id) {\n                    $wcData[\"categories\"][] = [\"id\" => $id];\n                    $parent = $id;\n                }\n            }\n        }\n    }\n\n    if (!empty($data[\"Tags\"])) {\n        foreach (explode(\",\", $data[\"Tags\"]) as $t) {\n            $wcData[\"tags\"][] = [\"name\" => trim($t)];\n        }\n    }\n\n    $temp_id_map = []; \n    for ($i = 1; $i <= 3; $i++) {\n        $name = $data[\"Attribute {$i} name\"] ?? \"\";\n        $vals = $data[\"Attribute {$i} value(s)\"] ?? \"\";\n        if ($name) {\n            $slug = $ATTRIBUTE_SLUG_MAP[$name] ?? $name;\n            $id = _get_attribute_id($slug);\n            $options = array_map(\"trim\", explode(\",\", $vals));\n            $visible = ($data[\"Attribute {$i} visible\"] ?? \"0\") === \"1\";\n            \n            if ($id) {\n                $temp_id_map[$slug] = $id;\n                $wcData[\"attributes\"][] = [\"id\" => $id, \"options\" => $options, \"visible\" => $visible, \"variation\" => true];\n            } else {\n                $wcData[\"attributes\"][] = [\"name\" => $slug, \"options\" => $options, \"visible\" => $visible, \"variation\" => true];\n            }\n\n            $default = $data[\"Attribute {$i} default\"] ?? \"\";\n            if ($default && $id) {\n                $wcData[\"default_attributes\"][] = [\"id\" => $id, \"option\" => str_replace(\" \", \"-\", strtolower($default))];\n            }\n        }\n    }\n\n    if (!empty($data[\"variations\"]) && $wcData[\"type\"] === \"variable\") {\n        $wcData[\"variations_data\"] = [];\n        foreach ($data[\"variations\"] as $var) {\n            $vStock = getStockData($var);\n            $vData = [\n                \"sku\" => $var[\"SKU\"] ?? \"\",\n                \"regular_price\" => $var[\"Regular price\"] ?? \"\",\n                \"sale_price\" => $var[\"Sale price\"] ?? \"\",\n                \"manage_stock\" => $vStock[\"manage_stock\"],\n                \"stock_quantity\" => $vStock[\"stock_quantity\"],\n                \"stock_status\" => $vStock[\"stock_status\"],\n                \"attributes\" => []\n            ];\n            for ($i = 1; $i <= 3; $i++) {\n                $name = $var[\"Attribute {$i} name\"] ?? \"\";\n                $val = $var[\"Attribute {$i} value(s)\"] ?? \"\";\n                if ($name) {\n                    $slug = $ATTRIBUTE_SLUG_MAP[$name] ?? $name;\n                    $vData[\"attributes\"][] = [\"name\" => $slug, \"option\" => str_replace(\" \", \"-\", strtolower($val))];\n                }\n            }\n            $wcData[\"variations_data\"][] = $vData;\n        }\n    }\n    return $wcData;\n}\n\n// --- Lgica Principal ---\ntry {\n    $wcReadyData = mapWooJSON($data);\n    $variationsData = $wcReadyData[\"variations_data\"] ?? null;\n    unset($wcReadyData[\"variations_data\"], $wcReadyData[\"variations\"]);\n\n    $check = wc_request(\"GET\", \"products?sku=\" . urlencode($sku));\n    $checkData = json_decode($check[\"response\"], true);\n    \n    $product_id = null;\n    $status = \"\";\n\n    if (!empty($checkData) && isset($checkData[0][\"id\"])) {\n        $product_id = $checkData[0][\"id\"];\n        $existingProductData = wc_request(\"GET\", \"products/$product_id\");\n        $existingProduct = json_decode($existingProductData[\"response\"], true);\n        $mergedData = array_merge($existingProduct, $wcReadyData);\n        $mergedData[\"sku\"] = $sku;\n        $mergedData[\"type\"] = $wcReadyData[\"type\"] ?? \"simple\";\n        \n        $result = wc_request(\"PUT\", \"products/$product_id\", $mergedData);\n        $status = \"updated\";\n    } else {\n        $result = wc_request(\"POST\", \"products\", $wcReadyData);\n        $status = \"created\";\n    }\n\n    $respData = json_decode($result[\"response\"], true);\n    if (isset($respData[\"id\"])) {\n        $product_id = $respData[\"id\"];\n    } else {\n        throw new Exception(\"Error al crear/actualizar: \" . substr($result[\"response\"], 0, 200));\n    }\n\n    if ($product_id && $wcReadyData[\"type\"] === \"variable\") {\n        if (empty($variationsData)) {\n            wc_request(\"PUT\", \"products/$product_id\", [\"status\" => \"draft\"]);\n            $cVars = wc_request(\"GET\", \"products/$product_id/variations?per_page=100\");\n            $cVarsData = json_decode($cVars[\"response\"], true);\n            if (!empty($cVarsData)) {\n                $ids = array_column($cVarsData, 'id');\n                if ($ids) wc_request(\"POST\", \"products/$product_id/variations/batch\", [\"delete\" => $ids]);\n            }\n        } else {\n            $eVars = wc_request(\"GET\", \"products/$product_id/variations?per_page=100\");\n            $eVarsData = json_decode($eVars[\"response\"], true);\n            $existingSKUs = [];\n            $allExistingIDs = [];\n            if (is_array($eVarsData)) {\n                foreach ($eVarsData as $v) {\n                    if (isset($v[\"id\"])) $allExistingIDs[] = $v[\"id\"];\n                    if (!empty($v[\"sku\"])) $existingSKUs[$v[\"sku\"]] = $v[\"id\"];\n                }\n            }\n\n            $batchData = [\"create\" => [], \"update\" => [], \"delete\" => []];\n            $keptIDs = [];\n\n            foreach ($variationsData as $var) {\n                // FILTRO PRECIOS 0\n                if (empty($var['regular_price']) || floatval($var['regular_price']) == 0) continue;\n                if (empty($var[\"sku\"])) continue;\n\n                if (isset($existingSKUs[$var[\"sku\"]])) {\n                    $id = $existingSKUs[$var[\"sku\"]];\n                    $var[\"id\"] = $id;\n                    $batchData[\"update\"][] = $var;\n                    $keptIDs[] = $id;\n                } else {\n                    $batchData[\"create\"][] = $var;\n                }\n            }\n\n            $deleteIDs = array_diff($allExistingIDs, $keptIDs);\n            if (!empty($deleteIDs)) $batchData[\"delete\"] = array_values($deleteIDs);\n\n            if (!empty($batchData[\"create\"]) || !empty($batchData[\"update\"]) || !empty($batchData[\"delete\"])) {\n                wc_request(\"POST\", \"products/$product_id/variations/batch\", $batchData);\n            }\n        }\n    }\n\n    echo json_encode([\n        \"status\" => $status,\n        \"message\" => \"Producto procesado correctamente.\",\n        \"sku\" => $sku,\n        \"product_id\" => $product_id,\n        \"product_url\" => $respData[\"permalink\"] ?? \"\",\n        \"server_logs\" => $LOG_BUFFER\n    ], JSON_INVALID_UTF8_IGNORE);\n\n} catch (Exception $e) {\n    log_error(\"CRITICAL: \" . $e->getMessage());\n    http_response_code(500);\n    echo json_encode([\"status\" => \"error\", \"message\" => $e->getMessage(), \"server_logs\" => $LOG_BUFFER], JSON_INVALID_UTF8_IGNORE);\n}\n?>"
}